<!doctype html>
<html lang="en" class="h-full bg-gray-900 text-white">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nightingale CMS (React)</title>
    <!-- React DevTools Detection -->
    <meta name="react-devtools" content="enabled" />
    <meta name="application-name" content="Nightingale CMS" />
    <meta name="framework" content="React" />
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: file:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://unpkg.com chrome-extension: moz-extension: edge-extension: data: blob:; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com chrome-extension: moz-extension: edge-extension:; font-src https://fonts.gstatic.com data:; connect-src 'self' https: chrome-extension: moz-extension: edge-extension: data: blob: file:; img-src 'self' data: blob: chrome-extension: moz-extension: edge-extension:; frame-src 'self' chrome-extension: moz-extension: edge-extension:;"
    />

    <!-- DevTools CORS Override - Must run before any other scripts -->
    <script>
      (function () {
        'use strict';

        if (window.location.protocol === 'file:') {
          console.log('ðŸ”§ Initializing DevTools CORS override for file:// protocol');

          // Enhanced fetch override with better pattern matching
          const originalFetch = window.fetch;
          window.fetch = function (url, options) {
            console.log('Fetch intercepted:', url); // Debug log

            if (typeof url === 'string') {
              if (
                url.includes('%3Canonymous%3E') ||
                url.includes('<anonymous>') ||
                url.includes('anonymous') ||
                url.includes('chrome-extension://') ||
                url.includes('moz-extension://') ||
                url.includes('edge-extension://') ||
                url.includes('fileFetcher.js') ||
                url.includes('transformScriptTags') ||
                url.includes('hook.js') ||
                url.startsWith('file:///C:/Projects/Nightingale/App/%3C') ||
                url.match(/file:\/\/.*\/(undefined|null|%3C|%3E)/)
              ) {
                // Return empty response instead of logging to reduce console noise
                return Promise.resolve(
                  new Response('// Blocked', {
                    status: 200,
                    statusText: 'OK',
                    headers: { 'Content-Type': 'application/javascript' },
                  })
                );
              }
            }

            return originalFetch
              ? originalFetch.apply(this, arguments)
              : Promise.reject(new Error('Fetch not available'));
          };

          // Also override XMLHttpRequest as a fallback
          const originalXHR = window.XMLHttpRequest;
          window.XMLHttpRequest = function () {
            const xhr = new originalXHR();
            const originalOpen = xhr.open;

            xhr.open = function (method, url, async, user, password) {
              if (
                typeof url === 'string' &&
                (url.includes('%3Canonymous%3E') ||
                  url.includes('<anonymous>') ||
                  url.includes('anonymous') ||
                  url.includes('fileFetcher.js'))
              ) {
                console.log('ðŸš« Blocked XHR request:', url);
                // Create a mock successful request
                Object.defineProperty(xhr, 'status', {
                  writable: true,
                  value: 200,
                });
                Object.defineProperty(xhr, 'responseText', {
                  writable: true,
                  value: '// DevTools source placeholder',
                });
                Object.defineProperty(xhr, 'readyState', {
                  writable: true,
                  value: 4,
                });

                setTimeout(() => {
                  if (xhr.onload) xhr.onload();
                  if (xhr.onreadystatechange) xhr.onreadystatechange();
                }, 0);

                return;
              }

              return originalOpen.apply(this, arguments);
            };

            return xhr;
          };

          // Enhanced error suppression for DevTools CORS errors
          const originalConsoleError = console.error;
          console.error = function (...args) {
            const message = args.join(' ');
            if (
              message.includes('Access to fetch') &&
              (message.includes('%3Canonymous%3E') || message.includes('fileFetcher.js')) &&
              message.includes('CORS policy')
            ) {
              console.warn('ðŸ”‡ Suppressed DevTools CORS error (handled by override)');
              return;
            }
            return originalConsoleError.apply(this, args);
          };

          // Global error handler for unhandled CORS errors
          window.addEventListener('error', function (e) {
            if (
              e.message &&
              e.message.includes('Access to fetch') &&
              (e.message.includes('%3Canonymous%3E') || e.message.includes('fileFetcher.js'))
            ) {
              console.warn('ðŸ”‡ Suppressed DevTools CORS error via global handler');
              e.preventDefault();
              return false;
            }
          });

          // Catch unhandled promise rejections from fetch
          window.addEventListener('unhandledrejection', function (e) {
            if (
              e.reason &&
              e.reason.message &&
              e.reason.message.includes('net::ERR_FAILED') &&
              e.reason.stack &&
              e.reason.stack.includes('fileFetcher.js')
            ) {
              console.warn('ðŸ”‡ Suppressed DevTools fetch rejection');
              e.preventDefault();
              return false;
            }
          });
        }
      })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

    <!-- React and Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Nightingale Core Services -->
    <script src="js/services/nightingale.utils.js"></script>
    <script src="js/services/nightingale.parsers.js"></script>
    <script src="js/services/nightingale.fileservice.js"></script>
    <script src="js/services/nightingale.search.js"></script>
    <script src="js/services/nightingale.toast.js"></script>

    <!-- Nightingale Component Library - Layered Architecture -->
    <script src="js/components/index.js"></script>

    <!-- Components will be loaded automatically by the layered architecture:
         🎨 UI Layer: Button, Badge, DataTable, FormComponents, SearchBar, Modal, StepperModal
         🏢 Business Layer: CaseCreationModal (with integrated steps), PersonCreationModal
    -->

    <!-- Day.js for date management -->
    <script src="lib/dayjs.min.js"></script>
    <script src="lib/dayjs-relativeTime.min.js"></script>
    <script src="lib/dayjs-customParseFormat.min.js"></script>
    <script src="js/services/nightingale.dayjs.js"></script>

    <!-- Lodash for reliable utility functions -->
    <script src="https://unpkg.com/lodash@4.17.21/lodash.min.js"></script>

    <script>
      // Initialize Day.js plugins
      if (typeof dayjs !== 'undefined') {
        dayjs.extend(window.dayjs_plugin_relativeTime);
        dayjs.extend(window.dayjs_plugin_customParseFormat);
      }
    </script>

    <!-- Fuse.js for search -->
    <script src="lib/fuse.min.js"></script>

    <style>
      html {
        font-family: 'Inter', sans-serif;
      }

      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #1f2937;
      }
      ::-webkit-scrollbar-thumb {
        background: #4b5563;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #6b7280;
      }

      /* Sidebar transitions */
      .sidebar {
        transition: width 0.3s ease-in-out;
      }

      /* List item hover effects */
      .list-item {
        transition:
          transform 0.2s ease-in-out,
          box-shadow 0.2s ease-in-out,
          background-color 0.2s ease-in-out;
        cursor: pointer;
      }
      .list-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        background-color: #374151;
      }

      /* Input focus styles */
      input:focus,
      select:focus,
      textarea:focus {
        --tw-ring-color: rgba(96, 165, 250, 0.5);
      }

      /* Toast container */
      #toast-container {
        position: fixed;
        bottom: 1.5rem;
        right: 1.5rem;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      .toast {
        padding: 0.75rem 1.25rem;
        border-radius: 0.5rem;
        color: white;
        box-shadow:
          0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
        opacity: 0;
        transform: translateX(100%);
        transition:
          opacity 0.3s ease,
          transform 0.3s ease;
      }
      .toast.show {
        opacity: 1;
        transform: translateX(0);
      }
      .toast.success {
        background-color: #16a34a;
      }
      .toast.warning {
        background-color: #ea580c;
      }
      .toast.error {
        background-color: #dc2626;
      }

      /* Error styles */
      .input-error {
        border-color: #ef4444 !important;
        --tw-ring-color: rgba(239, 68, 68, 0.5);
      }
      .error-message {
        color: #f87171;
        font-size: 0.75rem;
        margin-top: 0.25rem;
      }

      /* Modal styles */
      .modal-backdrop {
        backdrop-filter: blur(2px);
      }

      /* Search dropdown z-index layering */
      .search-dropdown-container {
        position: relative;
        z-index: 1100;
      }

      .search-dropdown-client {
        z-index: 1110 !important;
      }

      .search-dropdown-spouse {
        z-index: 1100 !important;
      }

      .search-dropdown-rep {
        z-index: 1090 !important;
      }

      /* Ensure dropdowns appear above other form elements */
      .case-creation-step {
        position: relative;
      }

      .case-creation-step:nth-child(1) {
        z-index: 1020;
      }

      .case-creation-step:nth-child(2) {
        z-index: 1010;
      }

      .case-creation-step:nth-child(3) {
        z-index: 1000;
      }

      /* Full viewport reset */
      * {
        box-sizing: border-box;
      }

      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
      }

      #root {
        width: 100vw;
        height: 100vh;
      }
    </style>
  </head>

  <body class="h-full w-full m-0 p-0">
    <div id="root" class="h-full w-full flex m-0 p-0"></div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- React DevTools Integration & Enhanced Debugging -->
    <script>
      // DevTools Integration Helper
      window.NightingaleDevTools = {
        // Data inspection utilities
        inspectData: (data) => {
          console.group('ðŸ” Nightingale Data Inspector');
          console.log('Full Data:', data);
          console.log('Cases:', data?.cases?.length || 0);
          console.log('People:', data?.people?.length || 0);
          console.log('Organizations:', data?.organizations?.length || 0);
          console.log('VR Requests:', data?.vrRequests?.length || 0);
          console.groupEnd();
        },

        // Component state debugger
        debugComponent: (componentName, state) => {
          console.group(`ðŸŽ¯ Component Debug: ${componentName}`);
          console.log('State:', state);
          console.groupEnd();
        },

        // Data flow logger
        logDataFlow: (action, details) => {
          console.log(`ðŸ“Š Data Flow: ${action}`);
          console.log('Timestamp:', new Date().toISOString());
          console.log('Data:', details);
        },

        // Connection checker
        checkDevToolsConnection: () => {
          console.group('ðŸ”Œ React DevTools Connection Status');
          console.log('DevTools Hook Available:', !!window.__REACT_DEVTOOLS_GLOBAL_HOOK__);
          console.log('React Available:', !!window.React);
          console.log('ReactDOM Available:', !!window.ReactDOM);
          console.log('React Version:', window.React?.version || 'Unknown');
          console.log('File Protocol:', window.location.protocol === 'file:');
          console.log('DevTools Renderers:', window.__REACT_DEVTOOLS_GLOBAL_HOOK__?.renderers?.size || 0);
          console.log('DevTools Operations:', typeof window.__REACT_DEVTOOLS_GLOBAL_HOOK__?.onCommitFiberRoot);
          console.groupEnd();
        },

        // Quick debugging shortcuts
        debugCases: () => window.NightingaleDevTools.inspectData(window.nightingaleData?.cases),
        debugActiveView: () => console.log('Active View:', window.nightingaleActiveView),
      };

      // Global test functions
      window.testDataIntegrityBroadcast = function () {
        const channel = new BroadcastChannel('nightingale_suite');
        channel.postMessage({
          type: 'data_updated',
          source: 'cms-react',
          timestamp: new Date().toISOString(),
        });
        channel.close();
        console.log('ðŸ“¤ Test broadcast sent');
      };

      // Test financial item migration
      window.testFinancialMigration = function () {
        console.group('ðŸ§ª Testing Financial Item Migration');

        const legacyFinancialItem = {
          id: 1,
          type: 'Checking Account', // Legacy field
          value: 1500.0, // Legacy field
          source: 'Bank Statement', // Legacy field
          location: 'Bank of America',
          accountNumber: '1234',
          verificationStatus: 'Verified',
          owner: 'applicant',
        };

        console.log('Legacy Item:', legacyFinancialItem);

        // Simulate migration
        const migratedItem = {
          ...legacyFinancialItem,
          description: legacyFinancialItem.type,
          amount: legacyFinancialItem.value,
          verificationSource: legacyFinancialItem.source,
          frequency: 'monthly',
        };

        console.log('Migrated Item:', migratedItem);
        console.log('âœ… Migration test completed - both type/description and value/amount fields preserved');
        console.groupEnd();
      };

      window.checkAppStatus = function () {
        console.group('ðŸ“Š CMS React App Status');
        console.log('Root Element:', document.getElementById('root'));
        console.log('React Loaded:', !!window.React);
        console.log('Babel Loaded:', !!window.Babel);
        console.log('File Service Available:', !!window.FileSystemService);
        console.log('Utils Available:', !!window.sanitize);
        console.groupEnd();
      };
    </script>

    <script type="text/babel">
      // Main app React hooks
      const { useState, useEffect, useMemo, useCallback } = React;
      const { createRoot } = ReactDOM;
      const e = React.createElement;

      // Component variables - will be assigned during initialization
      let PrimaryButton, SecondaryButton, Modal, SearchBar;
      // Note: DataTable is loaded separately from the component library

      // --- SHARED COMPONENTS ---

      function Stepper({
        steps,
        currentStep,
        onStepClick,
        allowBackward = true,
        showProgress = true,
        isClickable: customIsClickable,
      }) {
        const getStepStatus = (stepIndex) => {
          if (stepIndex < currentStep) return 'completed';
          if (stepIndex === currentStep) return 'active';
          return 'pending';
        };

        const getStepColor = (status) => {
          switch (status) {
            case 'completed':
              return 'bg-green-600 text-green-100 border-green-600';
            case 'active':
              return 'bg-blue-600 text-blue-100 border-blue-600';
            case 'pending':
              return 'bg-gray-600 text-gray-400 border-gray-600';
            default:
              return 'bg-gray-600 text-gray-400 border-gray-600';
          }
        };

        const isClickable = (stepIndex) => {
          if (customIsClickable) {
            return onStepClick && customIsClickable(stepIndex);
          }
          return onStepClick && (allowBackward || stepIndex <= currentStep);
        };

        return e(
          'div',
          { className: 'w-full' },

          // Progress bar (optional)
          showProgress &&
            e(
              'div',
              { className: 'mb-8' },
              e(
                'div',
                { className: 'flex items-center justify-between mb-2' },
                e('span', { className: 'text-sm text-gray-400' }, 'Progress'),
                e(
                  'span',
                  { className: 'text-sm text-gray-400' },
                  `${Math.round(((currentStep + 1) / steps.length) * 100)}%`
                )
              ),
              e(
                'div',
                { className: 'w-full bg-gray-700 rounded-full h-2' },
                e('div', {
                  className: 'bg-blue-600 h-2 rounded-full transition-all duration-300',
                  style: {
                    width: `${((currentStep + 1) / steps.length) * 100}%`,
                  },
                })
              )
            ),

          // Steps
          e(
            'div',
            { className: 'flex items-center justify-between' },
            steps.map((step, index) => {
              const status = getStepStatus(index);
              const clickable = isClickable(index);

              return e(
                React.Fragment,
                { key: index },

                // Step container
                e(
                  'div',
                  { className: 'flex flex-col items-center relative' },

                  // Step circle
                  e(
                    clickable ? 'button' : 'div',
                    {
                      className: `relative z-10 w-10 h-10 rounded-full border-2 flex items-center justify-center font-medium text-sm transition-all duration-200 ${getStepColor(
                        status
                      )} ${clickable ? 'hover:scale-105 cursor-pointer' : ''}`,
                      onClick: clickable ? () => onStepClick(index) : undefined,
                      disabled: !clickable,
                    },
                    status === 'completed'
                      ? e(
                          'svg',
                          {
                            className: 'w-5 h-5',
                            fill: 'none',
                            viewBox: '0 0 24 24',
                            stroke: 'currentColor',
                          },
                          e('path', {
                            strokeLinecap: 'round',
                            strokeLinejoin: 'round',
                            strokeWidth: 2,
                            d: 'M5 13l4 4L19 7',
                          })
                        )
                      : e('span', null, index + 1)
                  ),

                  // Step label
                  e(
                    'div',
                    { className: 'mt-3 text-center' },
                    e(
                      'div',
                      {
                        className: `text-sm font-medium ${
                          status === 'active'
                            ? 'text-blue-400'
                            : status === 'completed'
                              ? 'text-green-400'
                              : 'text-gray-400'
                        }`,
                      },
                      step.title
                    ),
                    step.description && e('div', { className: 'text-xs text-gray-500 mt-1' }, step.description)
                  )
                )
              );
            })
          )
        );
      }

      function Sidebar({ activeTab, onTabChange, onSettingsClick, caseViewMode, onCaseBackToList }) {
        const tabs = [
          {
            id: 'dashboard',
            label: 'Dashboard',
            icon: 'M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z',
          },
          {
            id: 'cases',
            label: 'Cases',
            icon: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z',
          },
          {
            id: 'people',
            label: 'People',
            icon: 'M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z',
          },
          {
            id: 'organizations',
            label: 'Organizations',
            icon: 'M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4',
          },
          {
            id: 'eligibility',
            label: 'Eligibility',
            icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z',
          },
        ];

        return e(
          'div',
          {
            className: 'w-16 bg-gray-800 border-r border-gray-700 flex flex-col',
          },
          e(
            'div',
            { className: 'p-4 border-b border-gray-700' },
            e('h1', { className: 'text-blue-400 font-bold text-sm text-center' }, 'CMS')
          ),
          e(
            'nav',
            { className: 'flex-1 p-2 space-y-2' },
            tabs.map((tab) => {
              // Special handling for Cases tab when in details view
              if (tab.id === 'cases' && activeTab === 'cases' && caseViewMode === 'details') {
                return e(
                  'button',
                  {
                    key: tab.id,
                    onClick: () => onCaseBackToList(),
                    className:
                      'w-full p-3 rounded-md transition-all duration-200 group relative bg-blue-600 text-white',
                    title: 'Back to Cases List',
                  },
                  e(
                    'svg',
                    {
                      className: 'w-5 h-5 mx-auto',
                      fill: 'none',
                      viewBox: '0 0 24 24',
                      stroke: 'currentColor',
                      strokeWidth: 2,
                    },
                    e('path', {
                      strokeLinecap: 'round',
                      strokeLinejoin: 'round',
                      d: 'M10 19l-7-7m0 0l7-7m-7 7h18',
                    })
                  ),
                  // Tooltip
                  e(
                    'div',
                    {
                      className:
                        'absolute left-full ml-2 px-2 py-1 bg-gray-900 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-50',
                    },
                    'Back to Cases List'
                  )
                );
              }

              // Regular tab rendering
              return e(
                'button',
                {
                  key: tab.id,
                  onClick: () => onTabChange(tab.id),
                  className: `w-full p-3 rounded-md transition-all duration-200 group relative ${
                    activeTab === tab.id ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-700 hover:text-white'
                  }`,
                  title: tab.label,
                },
                e(
                  'svg',
                  {
                    className: 'w-5 h-5 mx-auto',
                    fill: 'none',
                    viewBox: '0 0 24 24',
                    stroke: 'currentColor',
                    strokeWidth: 2,
                  },
                  e('path', {
                    strokeLinecap: 'round',
                    strokeLinejoin: 'round',
                    d: tab.icon,
                  })
                ),
                // Tooltip
                e(
                  'div',
                  {
                    className:
                      'absolute left-full ml-2 px-2 py-1 bg-gray-900 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-50',
                  },
                  tab.label
                )
              );
            })
          ),
          // Settings button
          e(
            'div',
            { className: 'p-2 border-t border-gray-700' },
            e(
              'button',
              {
                onClick: onSettingsClick,
                className:
                  'w-full p-3 rounded-md text-gray-400 hover:bg-gray-700 hover:text-white transition-all duration-200 group relative',
                title: 'Settings',
              },
              e(
                'svg',
                {
                  className: 'w-5 h-5 mx-auto',
                  fill: 'none',
                  viewBox: '0 0 24 24',
                  stroke: 'currentColor',
                  strokeWidth: 2,
                },
                e('path', {
                  strokeLinecap: 'round',
                  strokeLinejoin: 'round',
                  d: 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94 1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z',
                }),
                e('path', {
                  strokeLinecap: 'round',
                  strokeLinejoin: 'round',
                  d: 'M15 12a3 3 0 11-6 0 3 3 0 016 0z',
                })
              ),
              // Tooltip
              e(
                'div',
                {
                  className:
                    'absolute left-full ml-2 px-2 py-1 bg-gray-900 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-50',
                },
                'Settings'
              )
            )
          )
        );
      }

      function Header({ fileStatus, onSave, isDirty }) {
        return e(
          'div',
          {
            className: 'flex items-center justify-between bg-gray-800 p-2 shadow-md flex-shrink-0',
          },
          e(
            'div',
            { className: 'flex items-center' },
            e(
              'svg',
              {
                xmlns: 'http://www.w3.org/2000/svg',
                className: 'h-6 w-6 mr-2 text-blue-400',
                fill: 'none',
                viewBox: '0 0 24 24',
                stroke: 'currentColor',
              },
              e('path', {
                strokeLinecap: 'round',
                strokeLinejoin: 'round',
                strokeWidth: 2,
                d: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z',
              })
            ),
            e('span', { className: 'font-bold text-white' }, 'Nightingale CMS - React')
          ),
          e(
            'div',
            { className: 'flex items-center space-x-3' },
            // Auto-refresh status indicator
            e(
              'div',
              {
                className: 'flex items-center space-x-1',
                title: 'Auto-refresh active - data syncs when window becomes active',
              },
              e(
                'svg',
                {
                  xmlns: 'http://www.w3.org/2000/svg',
                  className: 'h-3 w-3 text-green-400',
                  fill: 'none',
                  viewBox: '0 0 24 24',
                  stroke: 'currentColor',
                },
                e('path', {
                  strokeLinecap: 'round',
                  strokeLinejoin: 'round',
                  strokeWidth: 2,
                  d: 'M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15',
                })
              ),
              e('span', { className: 'text-xs text-gray-400' }, 'Auto')
            ),
            // File Status
            e(
              'div',
              { className: 'text-sm' },
              e(
                'span',
                {
                  className: `px-2 py-1 rounded text-xs font-medium ${
                    fileStatus === 'connected'
                      ? 'bg-green-600 text-green-100'
                      : fileStatus === 'disconnected'
                        ? 'bg-red-600 text-red-100'
                        : 'bg-yellow-600 text-yellow-100'
                  }`,
                },
                fileStatus === 'connected'
                  ? 'ðŸŸ¢ Connected'
                  : fileStatus === 'disconnected'
                    ? 'ðŸ”´ Disconnected'
                    : 'ðŸŸ¡ Connecting...'
              )
            ),
            // Save Status
            e(
              'div',
              {
                className: `flex items-center space-x-1.5 ${isDirty ? '' : 'hidden'}`,
                title: 'Save status',
              },
              e(
                'svg',
                {
                  xmlns: 'http://www.w3.org/2000/svg',
                  className: `h-4 w-4 transition-colors duration-500 ${isDirty ? 'text-yellow-400' : 'text-gray-400'}`,
                  viewBox: '0 0 20 20',
                  fill: 'currentColor',
                },
                e('path', {
                  fillRule: 'evenodd',
                  d: 'M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z',
                  clipRule: 'evenodd',
                })
              ),
              e('span', { className: 'text-xs text-gray-400' }, isDirty ? 'Unsaved' : 'Saved')
            ),
            // Save Button
            e(PrimaryButton, {
              children: isDirty ? 'Save' : 'Saved',
              onClick: onSave,
              disabled: !isDirty,
              icon: ButtonIcons.save,
              size: 'sm',
            }),
            // Status lights (matching original CMS)
            e(
              'div',
              { className: 'flex space-x-2' },
              e('div', { className: 'w-3 h-3 bg-yellow-400 rounded-full' }),
              e('div', { className: 'w-3 h-3 bg-green-400 rounded-full' }),
              e('div', { className: 'w-3 h-3 bg-red-400 rounded-full' })
            )
          )
        );
      }

      // --- TAB CONTENT COMPONENTS ---

      function DashboardTab({ fullData }) {
        const stats = useMemo(() => {
          if (!fullData)
            return {
              totalCases: 0,
              totalVrRequests: 0,
              activeCases: 0,
              pendingVr: 0,
            };

          const activeCases = fullData.cases?.filter((c) => c.status !== 'Closed' && c.status !== 'Denied').length || 0;
          const pendingVr = fullData.vrRequests?.filter((vr) => vr.status === 'Pending').length || 0;

          return {
            totalCases: fullData.cases?.length || 0,
            totalVrRequests: fullData.vrRequests?.length || 0,
            activeCases,
            pendingVr,
          };
        }, [fullData]);

        return e(
          'div',
          { className: 'w-full space-y-4' },
          e(
            'div',
            { className: 'w-full' },
            e('h2', { className: 'text-3xl font-bold text-blue-300 mb-2' }, 'Welcome to Nightingale CMS'),
            e('p', { className: 'text-gray-400 text-lg' }, 'Case Management System - Cases & Eligibility Focus')
          ),
          e(
            'div',
            {
              className: 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 w-full',
            },
            [
              {
                label: 'Total Cases',
                value: stats.totalCases,
                icon: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z',
                color: 'blue',
              },
              {
                label: 'Active Cases',
                value: stats.activeCases,
                icon: 'M13 10V3L4 14h7v7l9-11h-7z',
                color: 'green',
              },
              {
                label: 'VR Requests',
                value: stats.totalVrRequests,
                icon: 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z',
                color: 'orange',
              },
              {
                label: 'Pending VRs',
                value: stats.pendingVr,
                icon: 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z',
                color: 'yellow',
              },
            ].map((stat, index) =>
              e(
                'div',
                {
                  key: index,
                  className: 'bg-gray-800 rounded-lg p-6 border border-gray-700',
                },
                e(
                  'div',
                  { className: 'flex items-center justify-between' },
                  e(
                    'div',
                    null,
                    e('p', { className: 'text-gray-400 text-sm font-medium' }, stat.label),
                    e('p', { className: 'text-3xl font-bold text-white' }, stat.value)
                  ),
                  e(
                    'div',
                    { className: `bg-${stat.color}-500/20 p-3 rounded-lg` },
                    e(
                      'svg',
                      {
                        className: `w-6 h-6 text-${stat.color}-400`,
                        fill: 'none',
                        viewBox: '0 0 24 24',
                        stroke: 'currentColor',
                        strokeWidth: 2,
                      },
                      e('path', {
                        strokeLinecap: 'round',
                        strokeLinejoin: 'round',
                        d: stat.icon,
                      })
                    )
                  )
                )
              )
            )
          ),
          e(
            'div',
            { className: 'bg-gray-800 rounded-lg p-6 border border-gray-700' },
            e('h3', { className: 'text-lg font-semibold text-white mb-4' }, 'Quick Actions'),
            e(
              'div',
              { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },
              [
                {
                  label: 'Create New Case',
                  description: 'Start a new case workflow',
                  action: 'createCase',
                },
                {
                  label: 'Search Cases',
                  description: 'Find and manage existing cases',
                  action: 'searchCases',
                },
              ].map((action, index) =>
                e(
                  'button',
                  {
                    key: index,
                    className: 'text-left p-4 bg-gray-700 rounded-lg hover:bg-gray-600 transition-colors',
                    onClick: () => {
                      if (action.action === 'createCase') {
                        // Will implement case creation modal
                        showToast('Case creation coming soon!', 'info');
                      } else if (action.action === 'searchCases') {
                        // Switch to cases tab
                        window.location.hash = '#cases';
                      }
                    },
                  },
                  e('h4', { className: 'font-medium text-white mb-1' }, action.label),
                  e('p', { className: 'text-sm text-gray-400' }, action.description)
                )
              )
            )
          )
        );
      }

      // Financial Management Section Component
      function FinancialManagementSection({ caseData, fullData, onUpdateData }) {
        const [expandedSections, setExpandedSections] = useState({});
        const [isFinancialModalOpen, setIsFinancialModalOpen] = useState(false);
        const [modalItemType, setModalItemType] = useState('');
        const [editingItem, setEditingItem] = useState(null);
        const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
        const [itemToDelete, setItemToDelete] = useState(null);
        const [confirmingDelete, setConfirmingDelete] = useState(null); // Store item ID being confirmed
        const isSimpCase = caseData.appDetails?.caseType === 'SIMP';

        // Ensure financials structure exists
        if (!caseData.financials) {
          caseData.financials = {
            resources: [],
            income: [],
            expenses: [],
          };
        }

        const toggleSection = (section) => {
          setExpandedSections((prev) => ({
            ...prev,
            [section]: !prev[section],
          }));
        };

        const addFinancialItem = (type, owner = 'applicant') => {
          setEditingItem(null);
          setModalItemType(type);
          setIsFinancialModalOpen(true);
        };

        const removeFinancialItem = (type, itemId) => {
          const updatedCase = {
            ...caseData,
            financials: {
              ...caseData.financials,
              [type]: caseData.financials[type].filter((item) => item.id !== itemId),
            },
          };

          const updatedCases = fullData.cases.map((c) => (c.id === caseData.id ? updatedCase : c));

          onUpdateData({ ...fullData, cases: updatedCases });
        };

        const confirmDelete = (type, item) => {
          setConfirmingDelete(item.id);
        };

        const handleDeleteConfirm = (type, itemId) => {
          removeFinancialItem(type, itemId);
          setConfirmingDelete(null);
        };

        const handleDeleteCancel = () => {
          setConfirmingDelete(null);
        };

        const updateFinancialItem = (type, itemId, updates) => {
          setEditingItem(caseData.financials[type].find((item) => item.id === itemId));
          setModalItemType(type);
          setIsFinancialModalOpen(true);
        };

        const renderFinancialTable = (type, items, title) => {
          const isExpanded = expandedSections[type];
          const displayItems = isExpanded ? items : items.slice(0, 3);

          return e(
            'div',
            { className: 'bg-gray-800 p-4 rounded-lg shadow-lg' },

            // Header
            e(
              'div',
              { className: 'flex justify-between items-center mb-3' },
              e('h4', { className: 'text-md font-bold text-blue-400' }, title),
              e(
                'div',
                { className: 'flex items-center space-x-2' },
                e(
                  'button',
                  {
                    onClick: () => addFinancialItem(type),
                    className: 'bg-green-600 hover:bg-green-700 text-white text-xs px-3 py-1 rounded-md',
                  },
                  'Add'
                )
              )
            ),

            // Items List
            e(
              'div',
              { className: 'space-y-2' },
              displayItems.length === 0
                ? e('p', { className: 'text-gray-500 text-sm text-center py-4' }, `No ${type} items`)
                : displayItems.map((item) =>
                    e(
                      'div',
                      {
                        key: item.id,
                        className:
                          'bg-gray-700 p-3 pl-8 rounded border border-gray-600 hover:border-blue-500 transition-colors cursor-pointer group',
                        onClick: () => updateFinancialItem(type, item.id),
                      },
                      e(
                        'div',
                        { className: 'flex justify-between items-start' },

                        // Left Side: Description, Location, Account Number
                        e(
                          'div',
                          { className: 'flex-1 space-y-1' },
                          e(
                            'div',
                            { className: 'text-white font-medium' },
                            item.description || item.type || 'Untitled Item'
                          ),
                          item.location && e('div', { className: 'text-sm text-gray-400' }, item.location),
                          item.accountNumber &&
                            e('div', { className: 'text-xs text-gray-500' }, `Acct: ${item.accountNumber}`)
                        ),

                        // Right Side: Amount + Frequency, Verification Status
                        e(
                          'div',
                          {
                            className: 'flex flex-col items-end space-y-1 ml-4',
                          },
                          e(
                            'div',
                            { className: 'text-white font-medium' },
                            `$${item.amount || item.value || 0}${
                              item.frequency
                                ? ` ${
                                    item.frequency === 'monthly'
                                      ? '/mo'
                                      : item.frequency === 'yearly'
                                        ? '/yr'
                                        : item.frequency === 'weekly'
                                          ? '/wk'
                                          : item.frequency === 'daily'
                                            ? '/day'
                                            : item.frequency === 'one-time'
                                              ? ' (1x)'
                                              : ''
                                  }`
                                : ''
                            }`
                          ),
                          e('div', {}), // Empty div for spacing
                          e(Badge, {
                            status: item.verificationStatus || 'Needs VR',
                            variant: 'verification',
                            size: 'sm',
                          })
                        ),

                        // Delete Button with Inline Confirmation (only visible on hover)
                        confirmingDelete === item.id
                          ? e(
                              'div',
                              { className: 'flex items-center space-x-2 ml-2' },
                              // Confirm (Green Check) - requires mouse movement
                              e(
                                'button',
                                {
                                  onClick: (e) => {
                                    e.stopPropagation();
                                    handleDeleteConfirm(type, item.id);
                                  },
                                  className: 'text-green-400 hover:text-green-300',
                                },
                                e(
                                  'svg',
                                  {
                                    className: 'w-4 h-4',
                                    fill: 'none',
                                    viewBox: '0 0 24 24',
                                    stroke: 'currentColor',
                                  },
                                  e('path', {
                                    strokeLinecap: 'round',
                                    strokeLinejoin: 'round',
                                    strokeWidth: 2,
                                    d: 'M5 13l4 4L19 7',
                                  })
                                )
                              ),
                              // Cancel (Red X) - takes place of original button
                              e(
                                'button',
                                {
                                  onClick: (e) => {
                                    e.stopPropagation();
                                    handleDeleteCancel();
                                  },
                                  className: 'text-red-400 hover:text-red-300',
                                },
                                e(
                                  'svg',
                                  {
                                    className: 'w-4 h-4',
                                    fill: 'none',
                                    viewBox: '0 0 24 24',
                                    stroke: 'currentColor',
                                  },
                                  e('path', {
                                    strokeLinecap: 'round',
                                    strokeLinejoin: 'round',
                                    strokeWidth: 2,
                                    d: 'M6 18L18 6M6 6l12 12',
                                  })
                                )
                              )
                            )
                          : e(
                              'button',
                              {
                                onClick: (e) => {
                                  e.stopPropagation();
                                  confirmDelete(type, item);
                                },
                                className:
                                  'text-red-400 hover:text-red-300 ml-2 opacity-0 group-hover:opacity-100 transition-opacity',
                              },
                              e(
                                'svg',
                                {
                                  className: 'w-4 h-4',
                                  fill: 'none',
                                  viewBox: '0 0 24 24',
                                  stroke: 'currentColor',
                                },
                                e('path', {
                                  strokeLinecap: 'round',
                                  strokeLinejoin: 'round',
                                  strokeWidth: 2,
                                  d: 'M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16',
                                })
                              )
                            )
                      )
                    )
                  )
            ),

            // Show More/Less Button
            items.length > 3 &&
              e(
                'button',
                {
                  onClick: () => toggleSection(type),
                  className: 'w-full mt-3 py-2 bg-gray-700 hover:bg-gray-600 text-gray-300 text-sm rounded',
                },
                isExpanded ? `Show Less (${items.length - 3} hidden)` : `Show More (${items.length - 3} more)`
              )
          );
        };

        const renderSimpAccordionSection = (title, owner, financials) => {
          const sectionKey = `${owner}_accordion`;
          const isExpanded = expandedSections[sectionKey];

          const ownerFinancials = {
            resources: financials.resources?.filter((item) => item.owner === owner) || [],
            income: financials.income?.filter((item) => item.owner === owner) || [],
            expenses: financials.expenses?.filter((item) => item.owner === owner) || [],
          };

          const totalItems =
            ownerFinancials.resources.length + ownerFinancials.income.length + ownerFinancials.expenses.length;

          return e(
            'div',
            { className: 'bg-gray-800 rounded-lg overflow-hidden' },
            e(
              'button',
              {
                onClick: () => toggleSection(sectionKey),
                className: 'w-full p-4 text-left bg-gray-700 hover:bg-gray-600 flex justify-between items-center',
              },
              e(
                'div',
                {},
                e('h4', { className: 'text-lg font-semibold text-blue-400' }, title),
                e('p', { className: 'text-sm text-gray-400' }, `${totalItems} items`)
              ),
              e(
                'svg',
                {
                  className: `w-5 h-5 transform transition-transform ${isExpanded ? 'rotate-180' : ''}`,
                  fill: 'none',
                  viewBox: '0 0 24 24',
                  stroke: 'currentColor',
                },
                e('path', {
                  strokeLinecap: 'round',
                  strokeLinejoin: 'round',
                  strokeWidth: 2,
                  d: 'M19 9l-7 7-7-7',
                })
              )
            ),
            isExpanded &&
              e(
                'div',
                { className: 'p-4 space-y-4' },
                e(
                  'div',
                  { className: 'grid grid-cols-1 md:grid-cols-3 gap-4' },
                  renderFinancialTable('resources', ownerFinancials.resources, 'Resources'),
                  renderFinancialTable('income', ownerFinancials.income, 'Income'),
                  renderFinancialTable('expenses', ownerFinancials.expenses, 'Expenses')
                )
              )
          );
        };

        return e(
          React.Fragment,
          {},
          e(
            'div',
            { className: 'bg-gray-800 p-6 rounded-lg' },

            isSimpCase
              ? // SIMP Case - Accordion Layout
                e(
                  'div',
                  { className: 'space-y-4' },
                  renderSimpAccordionSection('Applicant Financials', 'applicant', caseData.financials),
                  renderSimpAccordionSection('Joint Financials', 'joint', caseData.financials),
                  renderSimpAccordionSection('Spouse Financials', 'spouse', caseData.financials)
                )
              : // Regular Case - Grid Layout
                e(
                  'div',
                  { className: 'grid grid-cols-1 md:grid-cols-3 gap-6' },
                  renderFinancialTable('resources', caseData.financials.resources || [], 'Resources'),
                  renderFinancialTable('income', caseData.financials.income || [], 'Income'),
                  renderFinancialTable('expenses', caseData.financials.expenses || [], 'Expenses')
                )
          ),

          // Financial Item Modal
          e(FinancialItemModal, {
            isOpen: isFinancialModalOpen,
            onClose: () => {
              setIsFinancialModalOpen(false);
              setEditingItem(null);
              setModalItemType('');
            },
            caseData,
            fullData,
            onUpdateData,
            itemType: modalItemType,
            editingItem,
          })
        );
      }

      // Notes Management Section Component
      function NotesManagementSection({ caseData, fullData, onUpdateData }) {
        const [isNotesExpanded, setIsNotesExpanded] = useState(false);
        const [newNoteText, setNewNoteText] = useState('');
        const [isAddingNote, setIsAddingNote] = useState(false);

        const notes = caseData.notes || [];

        const addNote = () => {
          if (!newNoteText.trim()) return;

          const newNote = {
            id: Date.now(),
            text: newNoteText.trim(),
            timestamp: new Date().toISOString(),
            author: 'Current User', // In a real app, this would be the logged-in user
          };

          const updatedCase = {
            ...caseData,
            notes: [...notes, newNote],
          };

          const updatedCases = fullData.cases.map((c) => (c.id === caseData.id ? updatedCase : c));

          onUpdateData({ ...fullData, cases: updatedCases });
          setNewNoteText('');
          setIsAddingNote(false);
        };

        const deleteNote = (noteId) => {
          const updatedCase = {
            ...caseData,
            notes: notes.filter((note) => note.id !== noteId),
          };

          const updatedCases = fullData.cases.map((c) => (c.id === caseData.id ? updatedCase : c));

          onUpdateData({ ...fullData, cases: updatedCases });
        };

        const formatNoteTimestamp = (timestamp) => {
          if (!window.dateUtils || !window.dateUtils.format) return timestamp;
          return window.dateUtils.format(timestamp, 'MM/DD/YYYY hh:mm A');
        };

        return e(
          'div',
          {
            className: 'bg-gray-800 rounded-lg overflow-hidden',
            'data-section': 'notes',
          },

          // Notes Header
          e(
            'div',
            { className: 'p-4 bg-gray-700 flex justify-between items-center' },
            e(
              'div',
              { className: 'flex items-center space-x-3' },
              e('h3', { className: 'text-lg font-semibold text-blue-400' }, 'Case Notes'),
              e('span', { className: 'text-sm text-gray-400' }, `${notes.length} notes`)
            ),
            e(
              'div',
              { className: 'flex items-center space-x-2' },
              e(
                'button',
                {
                  onClick: () => setIsAddingNote(true),
                  className:
                    'bg-green-600 hover:bg-green-700 text-white rounded-full h-8 w-8 flex items-center justify-center',
                  title: 'Add New Note',
                },
                e(
                  'svg',
                  {
                    className: 'h-4 w-4',
                    fill: 'none',
                    viewBox: '0 0 24 24',
                    stroke: 'currentColor',
                  },
                  e('path', {
                    strokeLinecap: 'round',
                    strokeLinejoin: 'round',
                    strokeWidth: 2,
                    d: 'M12 4v16m8-8H4',
                  })
                )
              ),
              e(
                'button',
                {
                  onClick: () => setIsNotesExpanded(!isNotesExpanded),
                  className: 'text-gray-400 hover:text-white',
                },
                e(
                  'svg',
                  {
                    className: `w-5 h-5 transform transition-transform ${isNotesExpanded ? 'rotate-180' : ''}`,
                    fill: 'none',
                    viewBox: '0 0 24 24',
                    stroke: 'currentColor',
                  },
                  e('path', {
                    strokeLinecap: 'round',
                    strokeLinejoin: 'round',
                    strokeWidth: 2,
                    d: 'M19 9l-7 7-7-7',
                  })
                )
              )
            )
          ),

          // Notes Content
          e(
            'div',
            {
              className: `transition-all duration-300 overflow-hidden ${isNotesExpanded ? 'max-h-96' : 'max-h-32'}`,
            },
            e(
              'div',
              { className: 'p-4 space-y-3 overflow-y-auto max-h-80' },

              // Add Note Form
              isAddingNote &&
                e(
                  'div',
                  {
                    className: 'bg-gray-700 p-3 rounded border border-blue-500',
                  },
                  e('textarea', {
                    value: newNoteText,
                    onChange: (e) => setNewNoteText(e.target.value),
                    placeholder: 'Enter your note here...',
                    className: 'w-full bg-gray-600 text-white p-2 rounded resize-none',
                    rows: 3,
                    autoFocus: true,
                  }),
                  e(
                    'div',
                    { className: 'flex justify-end space-x-2 mt-2' },
                    e(
                      'button',
                      {
                        onClick: () => {
                          setIsAddingNote(false);
                          setNewNoteText('');
                        },
                        className: 'px-3 py-1 bg-gray-600 hover:bg-gray-500 text-white text-sm rounded',
                      },
                      'Cancel'
                    ),
                    e(
                      'button',
                      {
                        onClick: addNote,
                        disabled: !newNoteText.trim(),
                        className:
                          'px-3 py-1 bg-blue-600 hover:bg-blue-700 disabled:bg-gray-600 disabled:cursor-not-allowed text-white text-sm rounded',
                      },
                      'Add Note'
                    )
                  )
                ),

              // Notes List
              notes.length === 0
                ? e('p', { className: 'text-gray-500 text-center py-8' }, 'No notes for this case.')
                : notes.map((note) =>
                    e(
                      'div',
                      {
                        key: note.id,
                        className: 'bg-gray-700 p-3 rounded border border-gray-600',
                      },
                      e(
                        'div',
                        { className: 'flex justify-between items-start mb-2' },
                        e(
                          'div',
                          { className: 'text-xs text-gray-400' },
                          `${note.author || 'Unknown'} â€¢ ${formatNoteTimestamp(note.timestamp)}`
                        ),
                        e(
                          'button',
                          {
                            onClick: () => deleteNote(note.id),
                            className: 'text-red-400 hover:text-red-300 text-xs',
                          },
                          e(
                            'svg',
                            {
                              className: 'w-4 h-4',
                              fill: 'none',
                              viewBox: '0 0 24 24',
                              stroke: 'currentColor',
                            },
                            e('path', {
                              strokeLinecap: 'round',
                              strokeLinejoin: 'round',
                              strokeWidth: 2,
                              d: 'M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16',
                            })
                          )
                        )
                      ),
                      e('p', { className: 'text-white text-sm whitespace-pre-wrap' }, note.text)
                    )
                  )
            )
          )
        );
      }

      // Helper function to find person by ID with flexible matching
      function findPersonById(people, personId) {
        if (!people || !personId) return null;

        return people.find((p) => {
          // Convert both to strings and try exact match
          if (String(p.id) === String(personId)) return true;
          // Try with zero-padding (legacy format)
          if (String(p.id) === String(personId).padStart(2, '0')) return true;
          // Try reverse: personId might be zero-padded
          if (String(p.id).padStart(2, '0') === String(personId)) return true;
          // Try numeric comparison
          if (Number(p.id) === Number(personId)) return true;
          return false;
        });
      }

      // Helper functions for Case Details actions
      function generateCaseSummary(caseData) {
        // Generate summary functionality - similar to OldCMS
        const summaryData = {
          caseName: caseData.mcn || 'Unknown',
          applicant: caseData.personId,
          caseType: caseData.appDetails?.caseType,
          status: caseData.status,
          financialItems: {
            resources: caseData.financials?.resources?.length || 0,
            income: caseData.financials?.income?.length || 0,
            expenses: caseData.financials?.expenses?.length || 0,
          },
          notes: caseData.notes?.length || 0,
        };

        console.log('Generating summary for case:', summaryData);
        showToast('Case summary generation feature coming soon', 'info');
      }

      function openVRApp(caseData) {
        // Open VR App with case context - similar to OldCMS
        const vrUrl = `NightingaleCorrespondence.html?mcn=${encodeURIComponent(caseData.mcn || '')}`;
        window.open(vrUrl, '_blank');
      }

      function scrollToNotes() {
        // Scroll to notes section
        const notesSection = document.querySelector('[data-section="notes"]');
        if (notesSection) {
          notesSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
      }

      function copyMCN(mcn) {
        // Copy MCN to clipboard
        if (!mcn) {
          showToast('No MCN to copy', 'error');
          return;
        }

        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard
            .writeText(mcn)
            .then(() => {
              showToast(`MCN ${mcn} copied to clipboard`, 'success');
            })
            .catch(() => {
              fallbackCopyTextToClipboard(mcn);
            });
        } else {
          fallbackCopyTextToClipboard(mcn);
        }
      }

      function fallbackCopyTextToClipboard(text) {
        // Fallback copy method for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.top = '0';
        textArea.style.left = '0';
        textArea.style.position = 'fixed';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
          document.execCommand('copy');
          showToast(`MCN ${text} copied to clipboard`, 'success');
        } catch (err) {
          showToast('Failed to copy MCN', 'error');
        }

        document.body.removeChild(textArea);
      }

      // Financial Item Management Modal Component
      function FinancialItemModal({ isOpen, onClose, caseData, fullData, onUpdateData, itemType, editingItem = null }) {
        const [formData, setFormData] = useState({
          id: editingItem?.id || null,
          description: editingItem?.description || editingItem?.type || '', // Migrate type â†’ description
          location: editingItem?.location || '',
          accountNumber: editingItem?.accountNumber || '',
          amount: editingItem?.amount || editingItem?.value || 0, // Migrate value â†’ amount
          frequency: editingItem?.frequency || 'monthly',
          owner: editingItem?.owner || 'applicant',
          verificationStatus: editingItem?.verificationStatus || 'Needs VR',
          verificationSource: editingItem?.verificationSource || editingItem?.source || '', // Migrate source â†’ verificationSource
          notes: editingItem?.notes || '',
          dateAdded: editingItem?.dateAdded || new Date().toISOString(),
        });
        const [addAnother, setAddAnother] = useState(false);
        const [errors, setErrors] = useState({});

        const isSimpCase = caseData.appDetails?.caseType === 'SIMP';
        const isEditing = !!editingItem;

        // Reset form when modal opens/closes or editing item changes
        useEffect(() => {
          if (isOpen && editingItem) {
            setFormData({
              id: editingItem.id,
              description: editingItem.description || editingItem.type || '', // Handle legacy type field
              location: editingItem.location || '',
              accountNumber: editingItem.accountNumber || '',
              amount: editingItem.amount || editingItem.value || 0, // Handle legacy value field
              frequency: editingItem.frequency || 'monthly',
              owner: editingItem.owner || 'applicant',
              verificationStatus: editingItem.verificationStatus || 'Needs VR',
              verificationSource: editingItem.verificationSource || editingItem.source || '', // Handle legacy source field
              notes: editingItem.notes || '',
              dateAdded: editingItem.dateAdded || new Date().toISOString(),
            });
          } else if (isOpen && !editingItem) {
            setFormData({
              id: null,
              description: '',
              location: '',
              accountNumber: '',
              amount: 0,
              frequency: 'monthly',
              owner: 'applicant',
              verificationStatus: 'Needs VR',
              verificationSource: '',
              notes: '',
              dateAdded: new Date().toISOString(),
            });
          }
          setErrors({});
          setAddAnother(false);
        }, [isOpen, editingItem]);

        const updateFormData = (field, value) => {
          setFormData((prev) => ({ ...prev, [field]: value }));
          // Clear error when user starts typing
          if (errors[field]) {
            setErrors((prev) => ({ ...prev, [field]: null }));
          }
        };

        const validateForm = () => {
          const newErrors = {};

          if (!formData.description.trim()) {
            newErrors.description = 'Description is required';
          }

          if (formData.amount < 0) {
            newErrors.amount = 'Amount cannot be negative';
          }

          if (formData.verificationStatus === 'Verified' && !formData.verificationSource.trim()) {
            newErrors.verificationSource = 'Verification source is required when status is Verified';
          }

          setErrors(newErrors);
          return Object.keys(newErrors).length === 0;
        };

        const handleSave = () => {
          if (!validateForm()) return;

          const itemData = {
            ...formData,
            id: formData.id || Date.now(),
            amount: parseFloat(formData.amount) || 0,
            // Store both description and type for backward compatibility
            description: formData.description,
            type: formData.description, // Ensure CMSOld compatibility
            // Store both amount and value for backward compatibility
            value: parseFloat(formData.amount) || 0, // Ensure CMSOld compatibility
            // Store both verificationSource and source for backward compatibility
            source: formData.verificationSource, // Ensure CMSOld compatibility
          };

          // Update the case data
          const updatedFinancials = { ...caseData.financials };
          if (!updatedFinancials[itemType]) {
            updatedFinancials[itemType] = [];
          }

          if (isEditing) {
            // Update existing item
            updatedFinancials[itemType] = updatedFinancials[itemType].map((item) =>
              item.id === itemData.id ? itemData : item
            );
          } else {
            // Add new item
            updatedFinancials[itemType].push(itemData);
          }

          const updatedCase = {
            ...caseData,
            financials: updatedFinancials,
          };

          const updatedCases = fullData.cases.map((c) => (c.id === caseData.id ? updatedCase : c));

          onUpdateData({ ...fullData, cases: updatedCases });

          if (addAnother && !isEditing) {
            // Reset form for another item
            setFormData({
              id: null,
              description: '',
              location: '',
              accountNumber: '',
              amount: 0,
              frequency: 'monthly',
              owner: 'applicant',
              verificationStatus: 'Needs VR',
              verificationSource: '',
              notes: '',
              dateAdded: new Date().toISOString(),
            });
            setErrors({});
            showToast(`${itemType} item saved. Add another.`, 'success');
          } else {
            showToast(`${itemType} item ${isEditing ? 'updated' : 'saved'} successfully.`, 'success');
            onClose();
          }
        };

        const getPlaceholders = () => {
          const placeholders = {
            resources: {
              description: 'e.g., Checking Account, Savings Account, CD',
              location: 'e.g., Bank of America, Wells Fargo',
            },
            income: {
              description: 'e.g., Social Security, Pension, Employment',
              location: 'e.g., SSA, ABC Company, State Retirement',
            },
            expenses: {
              description: 'e.g., Medicare Part B, Rent, Utilities',
              location: 'e.g., Medicare, Landlord Name, Electric Company',
            },
          };
          return placeholders[itemType] || placeholders.resources;
        };

        const placeholders = getPlaceholders();

        const footerContent = e(
          React.Fragment,
          {},
          e(
            'button',
            {
              onClick: onClose,
              className: 'px-4 py-2 bg-gray-600 hover:bg-gray-500 text-white rounded-lg',
            },
            'Cancel'
          ),
          e(
            'button',
            {
              onClick: handleSave,
              className: 'px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg',
            },
            isEditing ? 'Update Item' : 'Save Item'
          )
        );

        return Modal({
          isOpen,
          onClose,
          title: `${isEditing ? 'Edit' : 'Add'} ${itemType.charAt(0).toUpperCase() + itemType.slice(1)} Item`,
          size: 'large',
          footerContent,
          children: e(
            'div',
            { className: 'space-y-6' },

            // Form Grid
            e(
              'div',
              { className: 'space-y-4' },

              // Row 1: Description and Location/Institution
              e(
                'div',
                { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },

                // Description
                e(
                  'div',
                  {},
                  e(
                    'label',
                    {
                      className: 'block text-sm font-medium text-gray-400 mb-2',
                    },
                    'Item Name *'
                  ),
                  e('input', {
                    type: 'text',
                    value: formData.description,
                    onChange: (e) => updateFormData('description', e.target.value),
                    placeholder: placeholders.description,
                    className: `w-full bg-gray-700 border rounded-md px-3 py-2 text-white ${
                      errors.description ? 'border-red-500' : 'border-gray-600'
                    }`,
                  }),
                  errors.description && e('p', { className: 'text-red-400 text-sm mt-1' }, errors.description)
                ),

                // Location/Institution
                e(
                  'div',
                  {},
                  e(
                    'label',
                    {
                      className: 'block text-sm font-medium text-gray-400 mb-2',
                    },
                    'Location/Institution'
                  ),
                  e('input', {
                    type: 'text',
                    value: formData.location,
                    onChange: (e) => updateFormData('location', e.target.value),
                    placeholder: placeholders.location,
                    className: 'w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white',
                  })
                )
              ),

              // Row 2: Account Number, Amount, and Frequency (conditional)
              e(
                'div',
                {
                  className: 'grid gap-4',
                  style: {
                    gridTemplateColumns: itemType === 'income' || itemType === 'expenses' ? '3fr 3fr 1fr' : '1fr 1fr',
                  },
                },

                // Account Number (for resources, income, and expenses)
                (itemType === 'resources' || itemType === 'income' || itemType === 'expenses') &&
                  e(
                    'div',
                    {},
                    e(
                      'label',
                      {
                        className: 'block text-sm font-medium text-gray-400 mb-2',
                      },
                      'Account Number'
                    ),
                    e('input', {
                      type: 'text',
                      value: formData.accountNumber,
                      onChange: (e) => updateFormData('accountNumber', e.target.value),
                      placeholder: 'Last 4 digits: 1234',
                      className: 'w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white',
                    })
                  ),

                // Amount
                e(
                  'div',
                  {},
                  e(
                    'label',
                    {
                      className: 'block text-sm font-medium text-gray-400 mb-2',
                    },
                    'Amount'
                  ),
                  e('input', {
                    type: 'number',
                    value: formData.amount,
                    onChange: (e) => updateFormData('amount', e.target.value),
                    min: '0',
                    step: '0.01',
                    className: `w-full bg-gray-700 border rounded-md px-3 py-2 text-white ${
                      errors.amount ? 'border-red-500' : 'border-gray-600'
                    }`,
                  }),
                  errors.amount && e('p', { className: 'text-red-400 text-sm mt-1' }, errors.amount)
                ),

                // Frequency (for income/expenses)
                (itemType === 'income' || itemType === 'expenses') &&
                  e(
                    'div',
                    {},
                    e(
                      'label',
                      {
                        className: 'block text-sm font-medium text-gray-400 mb-2',
                      },
                      'Freq'
                    ),
                    e(
                      'select',
                      {
                        value: formData.frequency,
                        onChange: (e) => updateFormData('frequency', e.target.value),
                        className: 'w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white text-sm',
                      },
                      e('option', { value: 'monthly' }, '/mo'),
                      e('option', { value: 'yearly' }, '/yr'),
                      e('option', { value: 'weekly' }, '/wk'),
                      e('option', { value: 'daily' }, '/day'),
                      e('option', { value: 'one-time' }, '1x')
                    )
                  )
              ),

              // Row 3: Verification Status and Verification Source (conditional)
              e(
                'div',
                { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },

                // Verification Status
                e(
                  'div',
                  {},
                  e(
                    'label',
                    {
                      className: 'block text-sm font-medium text-gray-400 mb-2',
                    },
                    'Verification Status'
                  ),
                  e(
                    'select',
                    {
                      value: formData.verificationStatus,
                      onChange: (e) => updateFormData('verificationStatus', e.target.value),
                      className: 'w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white',
                    },
                    e('option', { value: 'Needs VR' }, 'Needs VR'),
                    e('option', { value: 'VR Pending' }, 'VR Pending'),
                    e('option', { value: 'AVS Pending' }, 'AVS Pending'),
                    e('option', { value: 'Verified' }, 'Verified')
                  )
                ),

                // Verification Source (conditional)
                e(
                  'div',
                  {},
                  e(
                    'label',
                    {
                      className: 'block text-sm font-medium text-gray-400 mb-2',
                    },
                    'Verification Source'
                  ),
                  e('input', {
                    type: 'text',
                    value: formData.verificationSource,
                    onChange: (e) => updateFormData('verificationSource', e.target.value),
                    placeholder: 'e.g., Bank Statement 05/2025, Award Letter',
                    disabled: formData.verificationStatus !== 'Verified',
                    className: `w-full border rounded-md px-3 py-2 ${
                      formData.verificationStatus !== 'Verified'
                        ? 'bg-gray-600 text-gray-400 cursor-not-allowed'
                        : 'bg-gray-700 text-white'
                    } ${errors.verificationSource ? 'border-red-500' : 'border-gray-600'}`,
                  }),
                  errors.verificationSource &&
                    e('p', { className: 'text-red-400 text-sm mt-1' }, errors.verificationSource)
                )
              ),

              // Additional fields for specific types
              isSimpCase &&
                e(
                  'div',
                  { className: 'grid grid-cols-1 md:grid-cols-2 gap-4' },

                  // Owner (for SIMP cases)
                  e(
                    'div',
                    {},
                    e(
                      'label',
                      {
                        className: 'block text-sm font-medium text-gray-400 mb-2',
                      },
                      'Owner'
                    ),
                    e(
                      'select',
                      {
                        value: formData.owner,
                        onChange: (e) => updateFormData('owner', e.target.value),
                        className: 'w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white',
                      },
                      e('option', { value: 'applicant' }, 'Applicant'),
                      e('option', { value: 'spouse' }, 'Spouse'),
                      e('option', { value: 'joint' }, 'Joint')
                    )
                  ),
                  e('div', {}) // Empty div to maintain grid
                ),

              // Notes (full width)
              e(
                'div',
                {},
                e('label', { className: 'block text-sm font-medium text-gray-400 mb-2' }, 'Item Notes'),
                e('textarea', {
                  value: formData.notes,
                  onChange: (e) => updateFormData('notes', e.target.value),
                  placeholder: 'Additional notes about this item...',
                  rows: 3,
                  className: 'w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 text-white',
                })
              ),

              // Add Another (for new items only)
              !isEditing &&
                e(
                  'div',
                  {},
                  e(
                    'label',
                    { className: 'flex items-center' },
                    e('input', {
                      type: 'checkbox',
                      checked: addAnother,
                      onChange: (e) => setAddAnother(e.target.checked),
                      className: 'h-4 w-4 rounded mr-3',
                    }),
                    e('span', { className: 'text-gray-300' }, 'Add another item after saving')
                  )
                )
            )
          ),
        });
      }

      // Person and Application Details Modal Component
      function PersonApplicationDetailsModal({ isOpen, onClose, caseData, fullData, onUpdateData }) {
        const [editingField, setEditingField] = useState(null);
        const [editValues, setEditValues] = useState({});
        const [errors, setErrors] = useState({});

        const person = findPersonById(fullData?.people, caseData?.personId);
        const spouse = caseData?.spouseId ? findPersonById(fullData?.people, caseData.spouseId) : null;
        const organization = caseData?.organizationId
          ? fullData?.organizations?.find((o) => o.id === String(caseData.organizationId).padStart(2, '0'))
          : null;

        useEffect(() => {
          if (isOpen) {
            setEditingField(null);
            setEditValues({});
            setErrors({});
          }
        }, [isOpen]);

        const formatDate = (dateString) => {
          if (!dateString) return 'Not set';
          if (!window.dateUtils || !window.dateUtils.format) return dateString;
          return window.dateUtils.format(dateString);
        };

        const handleStartEdit = (field, currentValue, dataType = 'case') => {
          setEditingField(`${dataType}.${field}`);
          setEditValues({ [field]: currentValue || '' });
          setErrors({});
        };

        const handleCancelEdit = () => {
          setEditingField(null);
          setEditValues({});
          setErrors({});
        };

        const validateField = (field, value) => {
          const newErrors = {};

          // Person validation
          if (field === 'name' && !value.trim()) {
            newErrors[field] = 'Name is required';
          }

          if (field === 'email' && value && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value)) {
            newErrors[field] = 'Invalid email format';
          }

          if (field === 'phone' && value && !/^\(\d{3}\) \d{3}-\d{4}$/.test(value)) {
            newErrors[field] = 'Phone must be in format (123) 456-7890';
          }

          // Case validation
          if (field === 'mcn' && !value.trim()) {
            newErrors[field] = 'MCN is required';
          }

          if (field === 'applicationDate' && !value) {
            newErrors[field] = 'Application date is required';
          }

          return newErrors;
        };

        const handleSaveEdit = async () => {
          const [dataType, field] = editingField.split('.');
          const value = editValues[field];

          const fieldErrors = validateField(field, value);
          if (Object.keys(fieldErrors).length > 0) {
            setErrors(fieldErrors);
            return;
          }

          try {
            if (dataType === 'person') {
              // Handle nested address fields
              const addressFields = ['street', 'city', 'state', 'zip'];
              if (addressFields.includes(field)) {
                const updatedPerson = {
                  ...person,
                  address: {
                    ...(person.address || {}),
                    [field]: value,
                  },
                };
                const updatedPeople = fullData.people.map((p) => (p.id === person.id ? updatedPerson : p));
                onUpdateData({ ...fullData, people: updatedPeople });
              } else {
                // Update regular person field
                const updatedPerson = { ...person, [field]: value };
                const updatedPeople = fullData.people.map((p) => (p.id === person.id ? updatedPerson : p));
                onUpdateData({ ...fullData, people: updatedPeople });
              }
            } else if (dataType === 'case') {
              // Update case data
              const updatedCase = { ...caseData, [field]: value };
              const updatedCases = fullData.cases.map((c) => (c.id === caseData.id ? updatedCase : c));
              onUpdateData({ ...fullData, cases: updatedCases });
            }

            showToast(`${field} updated successfully`, 'success');
            setEditingField(null);
            setEditValues({});
            setErrors({});
          } catch (error) {
            console.error('Save error:', error);
            showToast('Error saving changes', 'error');
          }
        };

        const formatPhoneInput = (value) => {
          const numbers = value.replace(/[^\d]/g, '');
          if (numbers.length <= 3) return numbers;
          if (numbers.length <= 6) return `(${numbers.slice(0, 3)}) ${numbers.slice(3)}`;
          return `(${numbers.slice(0, 3)}) ${numbers.slice(3, 6)}-${numbers.slice(6, 10)}`;
        };

        const renderEditableField = (
          label,
          field,
          value,
          dataType = 'case',
          type = 'text',
          options = null,
          customClass = 'text-white text-sm'
        ) => {
          const fieldKey = `${dataType}.${field}`;
          const isEditing = editingField === fieldKey;
          const currentValue = isEditing ? editValues[field] : value;
          const hasError = errors[field];

          return isEditing
            ? e(
                'div',
                { className: 'flex flex-col space-y-2' },
                type === 'select'
                  ? e(
                      'select',
                      {
                        value: currentValue,
                        onChange: (e) =>
                          setEditValues({
                            ...editValues,
                            [field]: e.target.value,
                          }),
                        className: `w-full bg-gray-600 border rounded px-2 py-1 text-white text-sm ${
                          hasError ? 'border-red-500' : 'border-gray-500'
                        }`,
                      },
                      options?.map((option) => e('option', { key: option.value, value: option.value }, option.label))
                    )
                  : e('input', {
                      type,
                      value: currentValue,
                      onChange: (e) => {
                        let newValue = e.target.value;
                        if (field === 'phone') {
                          newValue = formatPhoneInput(newValue);
                        }
                        setEditValues({ ...editValues, [field]: newValue });
                      },
                      className: `w-full bg-gray-600 border rounded px-2 py-1 text-white text-sm ${
                        hasError ? 'border-red-500' : 'border-gray-500'
                      }`,
                      placeholder: type === 'date' ? 'YYYY-MM-DD' : `Enter ${field}`,
                    }),
                hasError && e('p', { className: 'text-red-400 text-xs' }, hasError),
                e(
                  'div',
                  { className: 'flex gap-2' },
                  e(
                    'button',
                    {
                      onClick: handleSaveEdit,
                      className: 'px-2 py-1 bg-green-600 hover:bg-green-700 text-white text-xs rounded',
                    },
                    'Save'
                  ),
                  e(
                    'button',
                    {
                      onClick: handleCancelEdit,
                      className: 'px-2 py-1 bg-gray-600 hover:bg-gray-700 text-white text-xs rounded',
                    },
                    'Cancel'
                  )
                )
              )
            : e(
                'span',
                {
                  onClick: () => handleStartEdit(field, value, dataType),
                  className: `${customClass} cursor-pointer hover:text-blue-300 transition-colors`,
                },
                type === 'date' ? formatDate(value) : value || 'Not set'
              );
        };

        if (!isOpen || !caseData) return null;

        return e(
          Modal,
          {
            isOpen,
            onClose,
            title: 'Client & Application Details',
            size: 'large',
            footerContent: e(
              'button',
              {
                onClick: onClose,
                className: 'px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg',
              },
              'Close'
            ),
          },
          e(
            'div',
            { className: 'space-y-6' },

            // Two-card grid layout (similar to CasePreviewModal)
            e(
              'div',
              { className: 'grid grid-cols-1 md:grid-cols-2 gap-6' },

              // Left Card: Client Details
              e(
                'div',
                { className: 'bg-gray-700 rounded-lg p-4' },
                e('h4', { className: 'text-lg font-medium text-blue-300 mb-4' }, 'Client Details'),
                e(
                  'div',
                  { className: 'space-y-4' },

                  // Client Name
                  e(
                    'div',
                    { className: 'flex flex-col space-y-1' },
                    e(
                      'span',
                      { className: 'text-gray-300 text-xs font-medium uppercase tracking-wide' },
                      'Client Name'
                    ),
                    e('div', { className: 'text-white text-sm font-medium' }, person?.name || 'Not set')
                  ),

                  // Spouse Name (for SIMP cases only)
                  caseData.caseType === 'SIMP' &&
                    e(
                      'div',
                      { className: 'flex flex-col space-y-1' },
                      e(
                        'span',
                        { className: 'text-gray-300 text-xs font-medium uppercase tracking-wide' },
                        'Spouse Name'
                      ),
                      e('div', { className: 'text-white text-sm font-medium' }, spouse?.name || 'Not set')
                    ),

                  // Authorized Representatives Section
                  e(
                    'div',
                    { className: 'border-t border-gray-600 pt-4' },
                    e(
                      'div',
                      { className: 'flex items-center justify-between mb-3' },
                      e(
                        'span',
                        { className: 'text-gray-300 text-xs font-medium uppercase tracking-wide' },
                        'Authorized Representatives'
                      ),
                      e(
                        'button',
                        {
                          onClick: () => {
                            // TODO: Add representative functionality
                            showToast('Add representative functionality coming soon', 'info');
                          },
                          className: 'px-2 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded font-medium',
                        },
                        'Add'
                      )
                    ),
                    // Representatives List
                    caseData.authorizedReps && caseData.authorizedReps.length > 0
                      ? e(
                          'div',
                          { className: 'space-y-2' },
                          caseData.authorizedReps.map((repId) => {
                            const rep = fullData?.people?.find((p) => p.id === String(repId || '').padStart(2, '0'));
                            return e(
                              'div',
                              {
                                key: repId,
                                className: 'bg-gray-600 rounded p-2 hover:bg-gray-550 transition-colors cursor-pointer',
                                onClick: () => {
                                  // TODO: Edit representative functionality
                                  showToast('Edit representative functionality coming soon', 'info');
                                },
                              },
                              e(
                                'div',
                                { className: 'text-white text-sm font-medium' },
                                rep?.name || 'Unknown Representative'
                              ),
                              rep?.phone && e('div', { className: 'text-gray-400 text-xs mt-1' }, rep.phone)
                            );
                          })
                        )
                      : e(
                          'div',
                          {
                            className: 'text-gray-400 text-center py-2 text-sm',
                          },
                          'No authorized representatives'
                        )
                  )
                )
              ),

              // Right Card: Application Details
              e(
                'div',
                { className: 'bg-gray-700 rounded-lg p-4' },
                e('h4', { className: 'text-lg font-medium text-blue-300 mb-4' }, 'Application Details'),

                // Application fields in vertical layout
                e(
                  'div',
                  { className: 'space-y-4' },

                  // Application Type
                  e(
                    'div',
                    { className: 'flex flex-col space-y-1' },
                    e(
                      'span',
                      { className: 'text-gray-300 text-xs font-medium uppercase tracking-wide' },
                      'Application Type'
                    ),
                    renderEditableField(
                      '',
                      'applicationType',
                      caseData.applicationType,
                      'case',
                      'select',
                      [
                        { value: '', label: 'Select...' },
                        { value: 'Initial', label: 'Initial' },
                        { value: 'Renewal', label: 'Renewal' },
                        { value: 'Change Report', label: 'Change Report' },
                      ],
                      'text-white text-sm font-medium'
                    )
                  ),

                  // Application Date
                  e(
                    'div',
                    { className: 'flex flex-col space-y-1' },
                    e(
                      'span',
                      { className: 'text-gray-300 text-xs font-medium uppercase tracking-wide' },
                      'Application Date'
                    ),
                    renderEditableField(
                      '',
                      'applicationDate',
                      caseData.applicationDate,
                      'case',
                      'date',
                      null,
                      'text-white text-sm font-medium'
                    )
                  ),

                  // Case Type
                  e(
                    'div',
                    { className: 'flex flex-col space-y-1' },
                    e('span', { className: 'text-gray-300 text-xs font-medium uppercase tracking-wide' }, 'Case Type'),
                    renderEditableField(
                      '',
                      'caseType',
                      caseData.caseType,
                      'case',
                      'select',
                      [
                        { value: '', label: 'Select...' },
                        { value: 'MED', label: 'MED' },
                        { value: 'SIMP', label: 'SIMP' },
                        { value: 'LTC', label: 'LTC' },
                      ],
                      'text-white text-sm font-medium'
                    )
                  ),

                  // AVS Consent Date
                  e(
                    'div',
                    { className: 'flex flex-col space-y-1' },
                    e(
                      'span',
                      { className: 'text-gray-300 text-xs font-medium uppercase tracking-wide' },
                      'AVS Consent Date'
                    ),
                    renderEditableField(
                      '',
                      'avsConsentDate',
                      caseData.avsConsentDate,
                      'case',
                      'date',
                      null,
                      'text-white text-sm font-medium'
                    )
                  )
                )
              )
            )
          )
        );
        e(
          'div',
          { className: 'space-y-3' },
          e('h4', { className: 'text-lg font-medium text-white mb-2' }, 'Person Information'),

          // Combined Person Information
          e(
            'div',
            { className: 'bg-gray-600 rounded-lg p-4 space-y-4' },
            e('h5', { className: 'text-md font-medium text-blue-300 mb-3' }, 'Person Information'),

            // Client Name
            e(
              'div',
              { className: 'flex flex-col space-y-1' },
              e('span', { className: 'text-gray-300 text-xs font-medium uppercase tracking-wide' }, 'Client Name'),
              e('div', { className: 'text-white text-sm font-medium' }, person?.name || 'Not set')
            ),

            // Spouse Name (for SIMP cases only)
            caseData.caseType === 'SIMP' &&
              e(
                'div',
                { className: 'flex flex-col space-y-1' },
                e('span', { className: 'text-gray-300 text-xs font-medium uppercase tracking-wide' }, 'Spouse Name'),
                e('div', { className: 'text-white text-sm font-medium' }, spouse?.name || 'Not set')
              )
          ),

          // Authorized Representatives
          e(
            'div',
            { className: 'bg-gray-600 rounded-lg p-4' },
            e(
              'div',
              { className: 'flex items-center justify-between mb-3' },
              e('h5', { className: 'text-md font-medium text-blue-300' }, 'Authorized Representatives'),
              e(
                'button',
                {
                  onClick: () => {
                    // TODO: Add representative functionality
                    showToast('Add representative functionality coming soon', 'info');
                  },
                  className: 'px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white text-xs rounded font-medium',
                },
                'Add Rep'
              )
            ),
            // Representatives List
            caseData.authorizedReps && caseData.authorizedReps.length > 0
              ? e(
                  'div',
                  { className: 'space-y-2' },
                  caseData.authorizedReps.map((repId) => {
                    const rep = fullData?.people?.find((p) => p.id === String(repId || '').padStart(2, '0'));
                    return e(
                      'div',
                      {
                        key: repId,
                        className: 'bg-gray-700 rounded p-3 hover:bg-gray-650 transition-colors cursor-pointer',
                        onClick: () => {
                          // TODO: Edit representative functionality
                          showToast('Edit representative functionality coming soon', 'info');
                        },
                      },
                      e('div', { className: 'text-white text-sm font-medium' }, rep?.name || 'Unknown Representative'),
                      rep?.phone && e('div', { className: 'text-gray-400 text-xs mt-1' }, rep.phone)
                    );
                  })
                )
              : e(
                  'div',
                  {
                    className: 'text-gray-400 text-center py-3 text-sm',
                  },
                  'No authorized representatives added'
                )
          )
        );
      }

      // Case Details View Component
      function CaseDetailsView({ caseId, fullData, onUpdateData, onBackToList }) {
        const [isPersonModalOpen, setIsPersonModalOpen] = useState(false);

        const caseData = fullData?.cases?.find((c) => c.id === caseId);
        const person = findPersonById(fullData?.people, caseData?.personId);
        const spouse = caseData?.spouseId ? findPersonById(fullData?.people, caseData.spouseId) : null;
        const organization = caseData?.organizationId
          ? fullData?.organizations?.find((o) => o.id === String(caseData.organizationId || '').padStart(2, '0'))
          : null;

        // Update case field helper
        const updateCaseField = (field, value) => {
          const updatedCase = { ...caseData, [field]: value };
          const updatedCases = fullData.cases.map((c) => (c.id === caseData.id ? updatedCase : c));
          onUpdateData({ ...fullData, cases: updatedCases });
        };

        if (!caseData) {
          return e(
            'div',
            { className: 'w-full p-8 text-center' },
            e('p', { className: 'text-gray-400 text-lg' }, 'Case not found'),
            e(
              'button',
              {
                onClick: onBackToList,
                className: 'mt-4 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700',
              },
              'Back to Cases'
            )
          );
        }

        return e(
          'div',
          { className: 'w-full space-y-6' },

          // Header with Back Button and Case Info (CMSOld styling with background container)
          e(
            'div',
            {
              className: 'bg-gray-800 rounded-lg p-6 border border-gray-700 shadow-lg',
            },
            e(
              'div',
              { className: 'flex justify-between items-start' },
              e(
                'div',
                {},
                e(
                  'h1',
                  {
                    className:
                      'text-3xl font-bold text-blue-300 clickable-header flex items-center gap-x-2 cursor-pointer hover:text-blue-200 transition-colors',
                    title: 'Click to view/edit client and application details',
                    onClick: () => setIsPersonModalOpen(true),
                  },
                  person?.name || 'Unknown',
                  ' ',
                  e(
                    'svg',
                    {
                      xmlns: 'http://www.w3.org/2000/svg',
                      className: 'h-5 w-5 text-gray-500 group-hover:text-blue-300 transition-colors',
                      viewBox: '0 0 20 20',
                      fill: 'currentColor',
                    },
                    e('path', {
                      d: 'M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z',
                    }),
                    e('path', {
                      fillRule: 'evenodd',
                      d: 'M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z',
                      clipRule: 'evenodd',
                    })
                  )
                ),
                e(
                  'p',
                  {
                    className: 'text-gray-400 copy-mcn-header cursor-pointer hover:text-blue-400 transition-colors',
                    onClick: () => copyMCN(caseData.mcn),
                    title: 'Click to copy MCN',
                  },
                  `MCN: ${caseData.mcn || 'Not set'}`
                ),
                e(
                  'div',
                  { className: 'flex items-center gap-4 mt-3' },
                  e(
                    'div',
                    { className: 'flex items-center gap-2' },
                    e(
                      'select',
                      {
                        value: caseData.status || '',
                        onChange: (e) => updateCaseField('status', e.target.value),
                        className: 'bg-gray-700 border border-gray-600 rounded-md py-1 px-2 text-sm',
                      },
                      e('option', { value: '' }, '-- No Status --'),
                      e('option', { value: 'Pending' }, 'Pending'),
                      e('option', { value: 'In Progress' }, 'In Progress'),
                      e('option', { value: 'Approved' }, 'Approved'),
                      e('option', { value: 'Denied' }, 'Denied'),
                      e('option', { value: 'Closed' }, 'Closed')
                    )
                  ),
                  e(
                    'div',
                    { className: 'flex items-center gap-2' },
                    e('label', { className: 'text-sm text-gray-400' }, 'Priority:'),
                    e('input', {
                      type: 'checkbox',
                      checked: caseData.priority || false,
                      onChange: (e) => updateCaseField('priority', e.target.checked),
                      className: 'h-4 w-4 rounded',
                    })
                  ),
                  e(
                    'div',
                    { className: 'flex items-center gap-2' },
                    e('label', { className: 'text-sm text-gray-400' }, 'Retro:'),
                    e('input', {
                      type: 'checkbox',
                      checked: caseData.retroStatus || false,
                      onChange: (e) => updateCaseField('retroStatus', e.target.checked),
                      className: 'h-4 w-4 rounded',
                    })
                  )
                )
              ),
              e(
                'div',
                { className: 'flex items-center gap-3 self-start pt-8' },
                e(
                  'button',
                  {
                    onClick: () => generateCaseSummary(caseData),
                    className: 'bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-md',
                  },
                  'Generate Summary'
                ),
                e(
                  'button',
                  {
                    onClick: () => openVRApp(caseData),
                    className: 'bg-orange-600 hover:bg-orange-700 text-white py-2 px-4 rounded-md',
                  },
                  'Open VR App'
                )
              )
            )
          ),

          // Financial Management Section
          FinancialManagementSection({ caseData, fullData, onUpdateData }),

          // Person and Application Details Modal
          e(PersonApplicationDetailsModal, {
            isOpen: isPersonModalOpen,
            onClose: () => setIsPersonModalOpen(false),
            caseData,
            fullData,
            onUpdateData,
          })
        );
      }

      function CasesTab({ fullData, onUpdateData, fileService, onViewModeChange, onBackToList }) {
        const [searchTerm, setSearchTerm] = useState('');
        const [selectedCase, setSelectedCase] = useState(null);
        const [isDetailsModalOpen, setIsDetailsModalOpen] = useState(false);
        const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);
        const [editingRowId, setEditingRowId] = useState(null);
        const [editValues, setEditValues] = useState({});
        const [viewMode, setViewMode] = useState('list'); // 'list' or 'details'
        const [detailsCaseId, setDetailsCaseId] = useState(null);
        const [confirmingCaseDelete, setConfirmingCaseDelete] = useState(null); // Store case ID being confirmed

        // Back to list function that can be called externally
        const backToList = () => {
          setViewMode('list');
          setDetailsCaseId(null);
          onViewModeChange?.('list');
        };

        // Expose the back function to parent
        React.useEffect(() => {
          if (onBackToList) {
            onBackToList(() => backToList);
          }
        }, [onBackToList]);

        // Filter cases (DataTable handles sorting)
        const filteredCases = useMemo(() => {
          if (!fullData?.cases) return [];

          let filtered = fullData.cases;

          // Apply search filter only (DataTable component handles sorting)
          if (searchTerm.trim()) {
            const term = searchTerm.toLowerCase();
            filtered = filtered.filter((caseItem) => {
              const person = findPersonById(fullData.people, caseItem.personId);
              const personName = person?.name?.toLowerCase() || '';

              return (
                caseItem.mcn?.toLowerCase().includes(term) ||
                personName.includes(term) ||
                caseItem.status?.toLowerCase().includes(term) ||
                caseItem.applicationDate?.includes(term)
              );
            });
          }

          return filtered;
        }, [fullData, searchTerm]);

        const handleCaseClick = (caseItem) => {
          setSelectedCase(caseItem);
          setIsDetailsModalOpen(true);
        };

        const handleViewSummary = (caseItem, e) => {
          e.stopPropagation();
          // Open the case preview modal for summary view
          setSelectedCase(caseItem);
          setIsDetailsModalOpen(true);
        };

        const handleOpenCaseDetails = (caseItem, e) => {
          e.stopPropagation();
          setDetailsCaseId(caseItem.id);
          setViewMode('details');
          onViewModeChange?.('details');
        };

        const handleDeleteCase = (caseItem, e) => {
          e.stopPropagation();
          setConfirmingCaseDelete(caseItem.id);
        };

        const confirmCaseDelete = (caseItem) => {
          const updatedData = { ...fullData };
          updatedData.cases = updatedData.cases.filter((c) => c.id !== caseItem.id);
          onUpdateData(updatedData);
          showToast(`Case ${caseItem.mcn} deleted successfully`, 'success');
          setConfirmingCaseDelete(null);
        };

        const cancelCaseDelete = () => {
          setConfirmingCaseDelete(null);
        };

        const handleStartEdit = (caseItem) => {
          setEditingRowId(caseItem.id);
          setEditValues({
            mcn: caseItem.mcn || '',
            personId: caseItem.personId || '',
          });
        };

        const handleCancelEdit = () => {
          setEditingRowId(null);
          setEditValues({});
        };

        const handleSaveEdit = async (caseItem) => {
          try {
            const updatedData = { ...fullData };
            const caseIndex = updatedData.cases.findIndex((c) => c.id === caseItem.id);
            if (caseIndex !== -1) {
              updatedData.cases[caseIndex] = {
                ...updatedData.cases[caseIndex],
                mcn: editValues.mcn,
                personId: editValues.personId,
              };
              await fileService.writeFile(updatedData);
              onUpdateData(updatedData);
              setEditingRowId(null);
              setEditValues({});
              showToast('Case updated successfully!', 'success');
            }
          } catch (error) {
            console.error('Error saving case:', error);
            showToast('Error saving case', 'error');
          }
        };

        const formatDate = (dateString) => {
          return dateUtils.format(dateString);
        };

        // Conditional rendering based on view mode
        if (viewMode === 'details' && detailsCaseId) {
          return e(CaseDetailsView, {
            caseId: detailsCaseId,
            fullData,
            onUpdateData,
            onBackToList: backToList,
          });
        }

        return e(
          'div',
          { className: 'w-full space-y-4' },
          // Compact Header Bar
          e(
            'div',
            {
              className: 'flex items-center justify-between bg-gray-800 p-3 rounded-lg shadow-md',
            },
            e(
              'div',
              { className: 'flex items-center' },
              e(
                'svg',
                {
                  xmlns: 'http://www.w3.org/2000/svg',
                  className: 'h-5 w-5 mr-2 text-blue-400',
                  fill: 'none',
                  viewBox: '0 0 24 24',
                  stroke: 'currentColor',
                },
                e('path', {
                  strokeLinecap: 'round',
                  strokeLinejoin: 'round',
                  strokeWidth: 2,
                  d: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z',
                })
              ),
              e('span', { className: 'font-bold text-white' }, 'Cases Management'),
              e('span', { className: 'ml-3 text-sm text-gray-400' }, `${filteredCases.length} cases`)
            ),
            e(
              'button',
              {
                onClick: () => setIsCreateModalOpen(true),
                className:
                  'bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg transition-colors text-sm',
              },
              'Create New Case'
            )
          ),

          // Search Bar
          e(
            'div',
            {
              className: 'bg-gray-800 rounded-lg p-4 border border-gray-700 w-full',
            },
            e(
              'div',
              { className: 'flex items-center space-x-4' },
              e(
                'div',
                { className: 'flex-1' },
                e(SearchBar, {
                  value: searchTerm,
                  onChange: (e) => setSearchTerm(e.target.value),
                  placeholder: 'Search cases by MCN, name, status, or date...',
                  className: 'w-full',
                  size: 'md',
                  showClearButton: true,
                  onClear: () => setSearchTerm(''),
                })
              )
            )
          ),

          // Cases Table with DataTable Component
          e(DataTable, {
            data: filteredCases,
            columns: [
              {
                field: 'mcn',
                label: 'MCN',
                sortable: true,
                width: '120px',
                render: (value) => e('span', { className: 'font-medium text-blue-400' }, value || 'N/A'),
              },
              {
                field: 'personName',
                label: 'Client Name',
                sortable: true,
                render: (value, row) => {
                  if (!row || !fullData?.people) return 'Unknown';
                  const person = findPersonById(fullData.people, row.personId);
                  return person?.name || 'Unknown';
                },
              },
              {
                field: 'applicationDate',
                label: 'Application Date',
                sortable: true,
                render: (value) => dateUtils.format(value),
              },
              {
                field: 'status',
                label: 'Status',
                sortable: true,
                width: '140px',
                render: (value) =>
                  e(Badge, {
                    status: value || 'Unknown',
                    variant: 'status',
                    size: 'sm',
                  }),
              },
            ],
            searchTerm: searchTerm,
            onRowClick: handleCaseClick,
            rowActions: [
              {
                label: 'View Summary',
                icon: e(
                  'svg',
                  {
                    className: 'w-4 h-4',
                    fill: 'none',
                    viewBox: '0 0 24 24',
                    stroke: 'currentColor',
                    strokeWidth: 2,
                  },
                  e('path', {
                    strokeLinecap: 'round',
                    strokeLinejoin: 'round',
                    d: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z',
                  })
                ),
                onClick: (row, index) => {
                  handleViewSummary(row, new Event('click'));
                },
                className:
                  'p-2 text-blue-400 hover:text-blue-300 hover:bg-gray-700 rounded-lg transition-all duration-200',
              },
              {
                label: 'Open Case Details',
                icon: e(
                  'svg',
                  {
                    className: 'w-4 h-4',
                    fill: 'none',
                    viewBox: '0 0 24 24',
                    stroke: 'currentColor',
                    strokeWidth: 2,
                  },
                  e('path', {
                    strokeLinecap: 'round',
                    strokeLinejoin: 'round',
                    d: 'M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14',
                  })
                ),
                onClick: (row, index) => {
                  handleOpenCaseDetails(row, new Event('click'));
                },
                className:
                  'p-2 text-green-400 hover:text-green-300 hover:bg-gray-700 rounded-lg transition-all duration-200',
              },
              {
                label: 'Delete Case',
                icon: e(
                  'svg',
                  {
                    className: 'w-4 h-4',
                    fill: 'none',
                    viewBox: '0 0 24 24',
                    stroke: 'currentColor',
                    strokeWidth: 2,
                  },
                  e('path', {
                    strokeLinecap: 'round',
                    strokeLinejoin: 'round',
                    d: 'M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1H9a1 1 0 00-1 1v3M4 7h16',
                  })
                ),
                onClick: (row, index) => {
                  handleDeleteCase(row, new Event('click'));
                },
                className:
                  'p-2 text-red-400 hover:text-red-300 hover:bg-gray-700 rounded-lg transition-all duration-200',
              },
            ],
            sortable: true,
            paginated: true,
            pageSize: 25,
            hover: true,
            variant: 'dark',
            density: 'normal',
            emptyMessage: searchTerm ? `No cases found matching "${searchTerm}"` : 'No cases available',
            className: 'w-full',
          }),

          // Case Preview Modal
          selectedCase &&
            e(CasePreviewModal, {
              isOpen: isDetailsModalOpen,
              onClose: () => {
                setIsDetailsModalOpen(false);
                setSelectedCase(null);
              },
              caseData: selectedCase,
              fullData,
              onUpdateData,
              fileService,
            }),

          // Create Case Modal with Stepper
          e(CaseCreationModal, {
            isOpen: isCreateModalOpen,
            onClose: () => setIsCreateModalOpen(false),
            fullData,
            onCaseCreated: (newCase) => {
              const updatedData = { ...fullData };
              updatedData.cases = [...(updatedData.cases || []), newCase];
              onUpdateData(updatedData);
              setIsCreateModalOpen(false);
              showToast('Case created successfully!', 'success');
            },
            fileService,
          })
        );
      }

      function PeopleTab({ fullData, onUpdateData, fileService, onViewModeChange, onBackToList }) {
        const [searchTerm, setSearchTerm] = useState('');
        const [selectedPerson, setSelectedPerson] = useState(null);
        const [isDetailsModalOpen, setIsDetailsModalOpen] = useState(false);
        const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);
        const [editingRowId, setEditingRowId] = useState(null);
        const [editValues, setEditValues] = useState({});
        const [viewMode, setViewMode] = useState('list'); // 'list' or 'details'
        const [detailsPersonId, setDetailsPersonId] = useState(null);
        const [confirmingPersonDelete, setConfirmingPersonDelete] = useState(null);

        // Back to list function that can be called externally
        const backToList = () => {
          setViewMode('list');
          setDetailsPersonId(null);
          onViewModeChange?.('list');
        };

        // Expose the back function to parent
        React.useEffect(() => {
          if (onBackToList) {
            onBackToList(() => backToList);
          }
        }, [onBackToList]);

        // Filter people (DataTable handles sorting)
        const filteredPeople = useMemo(() => {
          if (!fullData?.people) return [];

          let filtered = fullData.people;

          // Apply search filter only (DataTable component handles sorting)
          if (searchTerm.trim()) {
            const term = searchTerm.toLowerCase();
            filtered = filtered.filter((person) => {
              return (
                person.name?.toLowerCase().includes(term) ||
                person.email?.toLowerCase().includes(term) ||
                person.phone?.includes(term) ||
                person.address?.toLowerCase().includes(term) ||
                person.status?.toLowerCase().includes(term)
              );
            });
          }

          return filtered;
        }, [fullData, searchTerm]);

        const handlePersonClick = (person) => {
          setSelectedPerson(person);
          setIsDetailsModalOpen(true);
        };

        const handleViewSummary = (person, e) => {
          e.stopPropagation();
          setSelectedPerson(person);
          setIsDetailsModalOpen(true);
        };

        const handleOpenPersonDetails = (person, e) => {
          e.stopPropagation();
          setDetailsPersonId(person.id || person.name);
          setViewMode('details');
          onViewModeChange?.('details');
        };

        const handleDeletePerson = (person, e) => {
          e.stopPropagation();
          setConfirmingPersonDelete(person.id || person.name);
        };

        const confirmPersonDelete = (person) => {
          const updatedData = { ...fullData };
          updatedData.people = updatedData.people.filter((p) => (p.id || p.name) !== (person.id || person.name));
          onUpdateData(updatedData);
          showToast(`Person ${person.name} deleted successfully`, 'success');
          setConfirmingPersonDelete(null);
        };

        const cancelPersonDelete = () => {
          setConfirmingPersonDelete(null);
        };

        const handleStartEdit = (person) => {
          setEditingRowId(person.id || person.name);
          setEditValues({
            name: person.name || '',
            email: person.email || '',
            phone: person.phone || '',
          });
        };

        const handleCancelEdit = () => {
          setEditingRowId(null);
          setEditValues({});
        };

        const handleSaveEdit = async (person) => {
          try {
            const updatedData = { ...fullData };
            const personIndex = updatedData.people.findIndex((p) => (p.id || p.name) === (person.id || person.name));
            if (personIndex !== -1) {
              updatedData.people[personIndex] = {
                ...updatedData.people[personIndex],
                name: editValues.name,
                email: editValues.email,
                phone: editValues.phone,
              };
              await fileService.writeFile(updatedData);
              onUpdateData(updatedData);
              setEditingRowId(null);
              setEditValues({});
              showToast('Person updated successfully!', 'success');
            }
          } catch (error) {
            console.error('Error saving person:', error);
            showToast('Error saving person', 'error');
          }
        };

        const formatDate = (dateString) => {
          return dateUtils.format(dateString);
        };

        // Conditional rendering based on view mode
        if (viewMode === 'details' && detailsPersonId) {
          return e(PersonDetailsView, {
            personId: detailsPersonId,
            fullData,
            onUpdateData,
            onBackToList: backToList,
          });
        }

        return e(
          'div',
          { className: 'w-full space-y-4' },
          // Compact Header Bar
          e(
            'div',
            {
              className: 'flex items-center justify-between bg-gray-800 p-3 rounded-lg shadow-md',
            },
            e(
              'div',
              { className: 'flex items-center' },
              e(
                'svg',
                {
                  xmlns: 'http://www.w3.org/2000/svg',
                  className: 'h-5 w-5 mr-2 text-green-400',
                  fill: 'none',
                  viewBox: '0 0 24 24',
                  stroke: 'currentColor',
                },
                e('path', {
                  strokeLinecap: 'round',
                  strokeLinejoin: 'round',
                  strokeWidth: 2,
                  d: 'M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z',
                })
              ),
              e('span', { className: 'font-bold text-white' }, 'People Management'),
              e('span', { className: 'ml-3 text-sm text-gray-400' }, `${filteredPeople.length} people`)
            ),
            e(PrimaryButton, {
              onClick: () => setIsCreateModalOpen(true),
              icon: 'add',
              children: 'Add New Person',
            })
          ),

          // Search Bar
          e(
            'div',
            {
              className: 'bg-gray-800 rounded-lg p-4 border border-gray-700 w-full',
            },
            e(
              'div',
              { className: 'flex items-center space-x-4' },
              e(
                'div',
                { className: 'flex-1' },
                e(SearchBar, {
                  value: searchTerm,
                  onChange: (e) => setSearchTerm(e.target.value),
                  placeholder: 'Search people by name, email, phone, or address...',
                  className: 'w-full',
                  size: 'md',
                  showClearButton: true,
                  onClear: () => setSearchTerm(''),
                })
              )
            )
          ),

          // People Table with DataTable Component
          e(DataTable, {
            data: filteredPeople,
            columns: [
              {
                field: 'name',
                label: 'Name',
                sortable: true,
                render: (value, person) =>
                  editingRowId === (person?.id || person?.name)
                    ? e('input', {
                        type: 'text',
                        value: editValues.name,
                        onChange: (e) => setEditValues({ ...editValues, name: e.target.value }),
                        className: 'bg-gray-700 text-white px-2 py-1 rounded border border-gray-600',
                      })
                    : e('div', { className: 'font-medium text-white' }, person?.name || 'N/A'),
              },
              {
                field: 'email',
                label: 'Email',
                sortable: true,
                render: (value, person) =>
                  editingRowId === (person?.id || person?.name)
                    ? e('input', {
                        type: 'email',
                        value: editValues.email,
                        onChange: (e) => setEditValues({ ...editValues, email: e.target.value }),
                        className: 'bg-gray-700 text-white px-2 py-1 rounded border border-gray-600',
                      })
                    : e('div', { className: 'text-gray-300' }, person?.email || 'N/A'),
              },
              {
                field: 'phone',
                label: 'Phone',
                sortable: true,
                render: (value, person) =>
                  editingRowId === (person?.id || person?.name)
                    ? e('input', {
                        type: 'tel',
                        value: editValues.phone,
                        onChange: (e) => setEditValues({ ...editValues, phone: e.target.value }),
                        className: 'bg-gray-700 text-white px-2 py-1 rounded border border-gray-600',
                      })
                    : e('div', { className: 'text-gray-300' }, person?.phone || 'N/A'),
              },
              {
                field: 'status',
                label: 'Status',
                sortable: true,
                render: (value, person) => {
                  const status = person?.status || 'active';
                  const statusColors = {
                    active: 'bg-green-900 text-green-300',
                    inactive: 'bg-gray-600 text-gray-300',
                    pending: 'bg-yellow-900 text-yellow-300',
                  };
                  return e(Badge, {
                    variant: status === 'active' ? 'success' : status === 'pending' ? 'warning' : 'secondary',
                    children: status.charAt(0).toUpperCase() + status.slice(1),
                  });
                },
              },
              {
                header: 'Actions',
                accessor: 'actions',
                render: (person) =>
                  editingRowId === (person.id || person.name)
                    ? e(
                        'div',
                        { className: 'flex space-x-2' },
                        e(SuccessButton, {
                          onClick: () => handleSaveEdit(person),
                          size: 'xs',
                          icon: 'save',
                          children: 'Save',
                        }),
                        e(SecondaryButton, {
                          onClick: handleCancelEdit,
                          size: 'xs',
                          children: 'Cancel',
                        })
                      )
                    : e(
                        'div',
                        { className: 'flex space-x-2' },
                        e(SecondaryButton, {
                          onClick: (e) => handleViewSummary(person, e),
                          size: 'xs',
                          icon: 'view',
                          children: 'View',
                        }),
                        e(PrimaryButton, {
                          onClick: (e) => handleOpenPersonDetails(person, e),
                          size: 'xs',
                          icon: 'edit',
                          children: 'Details',
                        }),
                        e(DangerButton, {
                          onClick: (e) => handleDeletePerson(person, e),
                          size: 'xs',
                          icon: 'delete',
                          children: 'Delete',
                        })
                      ),
              },
            ],
            onRowClick: handlePersonClick,
            className: 'w-full',
            emptyMessage: 'No people found',
          }),

          // Delete Confirmation Modal
          confirmingPersonDelete &&
            e(ConfirmationModal, {
              isOpen: true,
              onClose: cancelPersonDelete,
              onConfirm: () => {
                const person = fullData.people.find((p) => p.id === confirmingPersonDelete);
                confirmPersonDelete(person);
              },
              title: 'Delete Person',
              message: `Are you sure you want to delete this person? This action cannot be undone.`,
              confirmText: 'Delete',
              cancelText: 'Cancel',
              variant: 'danger',
            }),

          // Person Details Modal
          isDetailsModalOpen &&
            selectedPerson &&
            e(PersonDetailsModal, {
              isOpen: isDetailsModalOpen,
              onClose: () => setIsDetailsModalOpen(false),
              person: selectedPerson,
              fullData,
            }),

          // Create Person Modal
          isCreateModalOpen &&
            e(PersonCreationModal, {
              isOpen: isCreateModalOpen,
              onClose: () => setIsCreateModalOpen(false),
              fullData,
              fileService,
              onPersonCreated: (newPersonData) => {
                onUpdateData(newPersonData);
                setIsCreateModalOpen(false);
              },
            })
        );
      }

      function OrganizationsTab({ fullData, onUpdateData, fileService, onViewModeChange, onBackToList }) {
        const [searchTerm, setSearchTerm] = useState('');
        const [selectedOrganization, setSelectedOrganization] = useState(null);
        const [isDetailsModalOpen, setIsDetailsModalOpen] = useState(false);
        const [isCreateModalOpen, setIsCreateModalOpen] = useState(false);
        const [editingRowId, setEditingRowId] = useState(null);
        const [editValues, setEditValues] = useState({});
        const [viewMode, setViewMode] = useState('list'); // 'list' or 'details'
        const [detailsOrganizationId, setDetailsOrganizationId] = useState(null);
        const [confirmingOrganizationDelete, setConfirmingOrganizationDelete] = useState(null);

        // Back to list function that can be called externally
        const backToList = () => {
          setViewMode('list');
          setDetailsOrganizationId(null);
          onViewModeChange?.('list');
        };

        // Expose the back function to parent
        React.useEffect(() => {
          if (onBackToList) {
            onBackToList(() => backToList);
          }
        }, [onBackToList]);

        // Filter organizations (DataTable handles sorting)
        const filteredOrganizations = useMemo(() => {
          if (!fullData?.organizations) return [];

          let filtered = fullData.organizations;

          // Apply search filter only (DataTable component handles sorting)
          if (searchTerm.trim()) {
            const term = searchTerm.toLowerCase();
            filtered = filtered.filter((org) => {
              return (
                org.name?.toLowerCase().includes(term) ||
                org.type?.toLowerCase().includes(term) ||
                org.email?.toLowerCase().includes(term) ||
                org.phone?.includes(term) ||
                org.address?.toLowerCase().includes(term) ||
                org.status?.toLowerCase().includes(term)
              );
            });
          }

          return filtered;
        }, [fullData, searchTerm]);

        const handleOrganizationClick = (organization) => {
          setSelectedOrganization(organization);
          setIsDetailsModalOpen(true);
        };

        const handleViewSummary = (organization, e) => {
          e.stopPropagation();
          setSelectedOrganization(organization);
          setIsDetailsModalOpen(true);
        };

        const handleOpenOrganizationDetails = (organization, e) => {
          e.stopPropagation();
          setDetailsOrganizationId(organization.id);
          setViewMode('details');
          onViewModeChange?.('details');
        };

        const handleDeleteOrganization = (organization, e) => {
          e.stopPropagation();
          setConfirmingOrganizationDelete(organization.id);
        };

        const confirmOrganizationDelete = (organization) => {
          const updatedData = { ...fullData };
          updatedData.organizations = updatedData.organizations.filter((o) => o.id !== organization.id);
          onUpdateData(updatedData);
          showToast(`Organization ${organization.name} deleted successfully`, 'success');
          setConfirmingOrganizationDelete(null);
        };

        const cancelOrganizationDelete = () => {
          setConfirmingOrganizationDelete(null);
        };

        const handleStartEdit = (organization) => {
          setEditingRowId(organization.id);
          setEditValues({
            name: organization.name || '',
            type: organization.type || '',
            email: organization.email || '',
            phone: organization.phone || '',
          });
        };

        const handleCancelEdit = () => {
          setEditingRowId(null);
          setEditValues({});
        };

        const handleSaveEdit = async (organization) => {
          try {
            const updatedData = { ...fullData };
            const orgIndex = updatedData.organizations.findIndex((o) => o.id === organization.id);
            if (orgIndex !== -1) {
              updatedData.organizations[orgIndex] = {
                ...updatedData.organizations[orgIndex],
                name: editValues.name,
                type: editValues.type,
                email: editValues.email,
                phone: editValues.phone,
              };
              await fileService.writeFile(updatedData);
              onUpdateData(updatedData);
              setEditingRowId(null);
              setEditValues({});
              showToast('Organization updated successfully!', 'success');
            }
          } catch (error) {
            console.error('Error saving organization:', error);
            showToast('Error saving organization', 'error');
          }
        };

        const formatDate = (dateString) => {
          return dateUtils.format(dateString);
        };

        // Conditional rendering based on view mode
        if (viewMode === 'details' && detailsOrganizationId) {
          return e(OrganizationDetailsView, {
            organizationId: detailsOrganizationId,
            fullData,
            onUpdateData,
            onBackToList: backToList,
          });
        }

        return e(
          'div',
          { className: 'w-full space-y-4' },
          // Compact Header Bar
          e(
            'div',
            {
              className: 'flex items-center justify-between bg-gray-800 p-3 rounded-lg shadow-md',
            },
            e(
              'div',
              { className: 'flex items-center' },
              e(
                'svg',
                {
                  xmlns: 'http://www.w3.org/2000/svg',
                  className: 'h-5 w-5 mr-2 text-purple-400',
                  fill: 'none',
                  viewBox: '0 0 24 24',
                  stroke: 'currentColor',
                },
                e('path', {
                  strokeLinecap: 'round',
                  strokeLinejoin: 'round',
                  strokeWidth: 2,
                  d: 'M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4',
                })
              ),
              e('span', { className: 'font-bold text-white' }, 'Organizations Management'),
              e('span', { className: 'ml-3 text-sm text-gray-400' }, `${filteredOrganizations.length} organizations`)
            ),
            e(PrimaryButton, {
              onClick: () => setIsCreateModalOpen(true),
              icon: 'add',
              children: 'Add New Organization',
            })
          ),

          // Search Bar
          e(
            'div',
            {
              className: 'bg-gray-800 rounded-lg p-4 border border-gray-700 w-full',
            },
            e(
              'div',
              { className: 'flex items-center space-x-4' },
              e(
                'div',
                { className: 'flex-1' },
                e(SearchBar, {
                  value: searchTerm,
                  onChange: (e) => setSearchTerm(e.target.value),
                  placeholder: 'Search organizations by name, type, email, or phone...',
                  className: 'w-full',
                  size: 'md',
                  showClearButton: true,
                  onClear: () => setSearchTerm(''),
                })
              )
            )
          ),

          // Organizations Table with DataTable Component
          e(DataTable, {
            data: filteredOrganizations,
            columns: [
              {
                field: 'name',
                label: 'Organization Name',
                sortable: true,
                render: (value, org) =>
                  editingRowId === org?.id
                    ? e('input', {
                        type: 'text',
                        value: editValues.name,
                        onChange: (e) => setEditValues({ ...editValues, name: e.target.value }),
                        className: 'bg-gray-700 text-white px-2 py-1 rounded border border-gray-600',
                      })
                    : e('div', { className: 'font-medium text-white' }, org?.name || 'N/A'),
              },
              {
                field: 'type',
                label: 'Type',
                sortable: true,
                render: (value, org) =>
                  editingRowId === org?.id
                    ? e(
                        'select',
                        {
                          value: editValues.type,
                          onChange: (e) => setEditValues({ ...editValues, type: e.target.value }),
                          className: 'bg-gray-700 text-white px-2 py-1 rounded border border-gray-600',
                        },
                        e('option', { value: '' }, 'Select Type'),
                        e('option', { value: 'healthcare' }, 'Healthcare'),
                        e('option', { value: 'insurance' }, 'Insurance'),
                        e('option', { value: 'government' }, 'Government'),
                        e('option', { value: 'nonprofit' }, 'Nonprofit'),
                        e('option', { value: 'legal' }, 'Legal'),
                        e('option', { value: 'other' }, 'Other')
                      )
                    : e(
                        'div',
                        { className: 'text-gray-300' },
                        org?.type ? org.type.charAt(0).toUpperCase() + org.type.slice(1) : 'N/A'
                      ),
              },
              {
                field: 'email',
                label: 'Email',
                sortable: true,
                render: (value, org) =>
                  editingRowId === org?.id
                    ? e('input', {
                        type: 'email',
                        value: editValues.email,
                        onChange: (e) => setEditValues({ ...editValues, email: e.target.value }),
                        className: 'bg-gray-700 text-white px-2 py-1 rounded border border-gray-600',
                      })
                    : e('div', { className: 'text-gray-300' }, org?.email || 'N/A'),
              },
              {
                field: 'phone',
                label: 'Phone',
                sortable: true,
                render: (value, org) =>
                  editingRowId === org?.id
                    ? e('input', {
                        type: 'tel',
                        value: editValues.phone,
                        onChange: (e) => setEditValues({ ...editValues, phone: e.target.value }),
                        className: 'bg-gray-700 text-white px-2 py-1 rounded border border-gray-600',
                      })
                    : e('div', { className: 'text-gray-300' }, org?.phone || 'N/A'),
              },
              {
                header: 'Status',
                accessor: 'status',
                sortable: true,
                render: (org) => {
                  const status = org.status || 'active';
                  return e(Badge, {
                    variant: status === 'active' ? 'success' : status === 'pending' ? 'warning' : 'secondary',
                    children: status.charAt(0).toUpperCase() + status.slice(1),
                  });
                },
              },
              {
                header: 'Actions',
                accessor: 'actions',
                render: (org) =>
                  editingRowId === org.id
                    ? e(
                        'div',
                        { className: 'flex space-x-2' },
                        e(SuccessButton, {
                          onClick: () => handleSaveEdit(org),
                          size: 'xs',
                          icon: 'save',
                          children: 'Save',
                        }),
                        e(SecondaryButton, {
                          onClick: handleCancelEdit,
                          size: 'xs',
                          children: 'Cancel',
                        })
                      )
                    : e(
                        'div',
                        { className: 'flex space-x-2' },
                        e(SecondaryButton, {
                          onClick: (e) => handleViewSummary(org, e),
                          size: 'xs',
                          icon: 'view',
                          children: 'View',
                        }),
                        e(PrimaryButton, {
                          onClick: (e) => handleOpenOrganizationDetails(org, e),
                          size: 'xs',
                          icon: 'edit',
                          children: 'Details',
                        }),
                        e(DangerButton, {
                          onClick: (e) => handleDeleteOrganization(org, e),
                          size: 'xs',
                          icon: 'delete',
                          children: 'Delete',
                        })
                      ),
              },
            ],
            onRowClick: handleOrganizationClick,
            className: 'w-full',
            emptyMessage: 'No organizations found',
          }),

          // Delete Confirmation Modal
          confirmingOrganizationDelete &&
            e(ConfirmationModal, {
              isOpen: true,
              onClose: cancelOrganizationDelete,
              onConfirm: () => {
                const org = fullData.organizations.find((o) => o.id === confirmingOrganizationDelete);
                confirmOrganizationDelete(org);
              },
              title: 'Delete Organization',
              message: `Are you sure you want to delete this organization? This action cannot be undone.`,
              confirmText: 'Delete',
              cancelText: 'Cancel',
              variant: 'danger',
            }),

          // Organization Details Modal
          isDetailsModalOpen &&
            selectedOrganization &&
            e(OrganizationDetailsModal, {
              isOpen: isDetailsModalOpen,
              onClose: () => setIsDetailsModalOpen(false),
              organization: selectedOrganization,
              fullData,
            }),

          // Create Organization Modal
          isCreateModalOpen &&
            e(OrganizationCreationModal, {
              isOpen: isCreateModalOpen,
              onClose: () => setIsCreateModalOpen(false),
              fullData,
              onOrganizationCreated: (newOrganizationData) => {
                onUpdateData(newOrganizationData);
                setIsCreateModalOpen(false);
              },
            })
        );
      }

      function SimpleEditModal({ isOpen, onClose, caseData, fullData, onCaseUpdated }) {
        const [editData, setEditData] = useState({
          mcn: '',
          personId: '',
        });
        const [errors, setErrors] = useState({});

        useEffect(() => {
          if (isOpen && caseData) {
            setEditData({
              mcn: caseData.mcn || '',
              personId: caseData.personId || '',
            });
            setErrors({});
          }
        }, [isOpen, caseData]);

        const handleSave = () => {
          const newErrors = {};

          if (!editData.mcn.trim()) {
            newErrors.mcn = 'MCN is required';
          }

          if (!editData.personId) {
            newErrors.personId = 'Person is required';
          }

          // Check if MCN is unique (excluding current case)
          const existingCase = fullData?.cases?.find((c) => c.mcn === editData.mcn && c.id !== caseData.id);
          if (existingCase) {
            newErrors.mcn = 'MCN already exists for another case';
          }

          setErrors(newErrors);

          if (Object.keys(newErrors).length === 0) {
            const updatedCase = {
              ...caseData,
              mcn: editData.mcn,
              personId: editData.personId,
              updatedDate: new Date().toISOString(),
            };
            onCaseUpdated(updatedCase);
          }
        };

        const availablePeople = fullData?.people || [];
        const currentPerson = findPersonById(availablePeople, editData.personId);

        if (!isOpen || !caseData) return null;

        return e(
          'div',
          { className: 'fixed inset-0 z-50 overflow-y-auto' },
          e('div', {
            className: 'fixed inset-0 bg-black bg-opacity-50',
            onClick: onClose,
          }),
          e(
            'div',
            {
              className: 'relative min-h-screen flex items-center justify-center p-4',
            },
            e(
              'div',
              {
                className: 'relative bg-gray-800 rounded-lg shadow-xl max-w-md w-full border border-gray-700',
              },

              // Header
              e(
                'div',
                {
                  className: 'flex items-center justify-between p-6 border-b border-gray-700',
                },
                e('h3', { className: 'text-lg font-semibold text-white' }, 'Edit Case Details'),
                e(
                  'button',
                  {
                    onClick: onClose,
                    className: 'text-gray-400 hover:text-white transition-colors',
                  },
                  e(
                    'svg',
                    {
                      className: 'w-5 h-5',
                      fill: 'none',
                      viewBox: '0 0 24 24',
                      stroke: 'currentColor',
                    },
                    e('path', {
                      strokeLinecap: 'round',
                      strokeLinejoin: 'round',
                      strokeWidth: 2,
                      d: 'M6 18L18 6M6 6l12 12',
                    })
                  )
                )
              ),

              // Body
              e(
                'div',
                { className: 'p-6 space-y-4' },

                e(
                  'p',
                  { className: 'text-gray-400 text-sm mb-4' },
                  'Update the MCN and assigned person for this case.'
                ),

                // MCN Field
                e(
                  'div',
                  null,
                  e('label', { className: 'block text-sm font-medium text-white mb-2' }, 'MCN'),
                  e('input', {
                    type: 'text',
                    value: editData.mcn,
                    onChange: (e) => {
                      setEditData((prev) => ({ ...prev, mcn: e.target.value }));
                      if (errors.mcn) setErrors((prev) => ({ ...prev, mcn: undefined }));
                    },
                    className: `w-full px-3 py-2 border rounded-lg bg-gray-700 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                      errors.mcn ? 'border-red-500' : 'border-gray-600'
                    }`,
                    placeholder: 'Enter MCN',
                  }),
                  errors.mcn && e('p', { className: 'text-red-400 text-sm mt-1' }, errors.mcn)
                ),

                // Person Selection
                e(
                  'div',
                  null,
                  e('label', { className: 'block text-sm font-medium text-white mb-2' }, 'Assigned Person'),
                  e(
                    'select',
                    {
                      value: editData.personId,
                      onChange: (e) => {
                        setEditData((prev) => ({
                          ...prev,
                          personId: e.target.value,
                        }));
                        if (errors.personId)
                          setErrors((prev) => ({
                            ...prev,
                            personId: undefined,
                          }));
                      },
                      className: `w-full px-3 py-2 border rounded-lg bg-gray-700 text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent ${
                        errors.personId ? 'border-red-500' : 'border-gray-600'
                      }`,
                    },
                    [
                      e('option', { value: '' }, 'Select a person...'),
                      ...availablePeople.map((person) =>
                        e('option', { key: person.id, value: person.id }, person.name || `Person ${person.id}`)
                      ),
                    ]
                  ),
                  errors.personId && e('p', { className: 'text-red-400 text-sm mt-1' }, errors.personId),
                  currentPerson &&
                    e('p', { className: 'text-gray-400 text-xs mt-1' }, `Currently: ${currentPerson.name}`)
                )
              ),

              // Footer
              e(
                'div',
                {
                  className: 'flex justify-end space-x-3 p-6 border-t border-gray-700',
                },
                e(
                  'button',
                  {
                    onClick: onClose,
                    className: 'px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors',
                  },
                  'Cancel'
                ),
                e(
                  'button',
                  {
                    onClick: handleSave,
                    className: 'px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors',
                  },
                  'Save Changes'
                )
              )
            )
          )
        );
      }

      function CasePreviewModal({ isOpen, onClose, caseData, fullData, onUpdateData, fileService }) {
        const [activeTab, setActiveTab] = useState('overview');
        const [isEditModalOpen, setIsEditModalOpen] = useState(false);

        // Initialize when modal opens
        useEffect(() => {
          if (isOpen && caseData) {
            setActiveTab('overview');
            setIsEditModalOpen(false);
          }
        }, [isOpen, caseData]);

        const person = findPersonById(fullData?.people, caseData?.personId);
        const caseNotes = fullData?.notes?.filter((n) => n.caseId === caseData?.id) || [];

        const formatDate = (dateString) => {
          return dateUtils.format(dateString);
        };

        const tabs = [
          { id: 'overview', label: 'Overview' },
          { id: 'history', label: 'History' },
        ];

        if (!isOpen || !caseData) return null;

        return e(
          'div',
          { className: 'fixed inset-0 z-50 overflow-y-auto' },
          e('div', {
            className: 'fixed inset-0 bg-black bg-opacity-50',
            onClick: onClose,
          }),
          e(
            'div',
            {
              className: 'relative min-h-screen flex items-center justify-center p-4',
            },
            e(
              'div',
              {
                className:
                  'relative bg-gray-800 rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-hidden border border-gray-700',
              },

              // Header
              e(
                'div',
                {
                  className: 'flex items-center justify-between p-6 border-b border-gray-700',
                },
                e(
                  'div',
                  { className: 'flex-1' },
                  e('h3', { className: 'text-xl font-semibold text-white' }, 'Case Preview'),
                  e(
                    'div',
                    { className: 'flex items-center space-x-4 mt-2' },
                    e(
                      'p',
                      { className: 'text-gray-400 text-sm' },
                      `MCN: ${caseData.mcn || 'N/A'} â€¢ ${person?.name || 'Unknown Client'}`
                    ),
                    e(Badge, {
                      status: caseData.status || 'Unknown',
                      variant: 'status',
                      size: 'sm',
                    })
                  )
                ),
                e(
                  'div',
                  { className: 'flex space-x-3' },
                  e(
                    'button',
                    {
                      onClick: () => setIsEditModalOpen(true),
                      className:
                        'px-3 py-1 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm font-medium transition-colors',
                    },
                    'Edit'
                  ),
                  e(
                    'button',
                    {
                      onClick: onClose,
                      className: 'text-gray-400 hover:text-gray-300',
                    },
                    e(
                      'svg',
                      {
                        className: 'w-6 h-6',
                        fill: 'none',
                        viewBox: '0 0 24 24',
                        stroke: 'currentColor',
                      },
                      e('path', {
                        strokeLinecap: 'round',
                        strokeLinejoin: 'round',
                        strokeWidth: 2,
                        d: 'M6 18L18 6M6 6l12 12',
                      })
                    )
                  )
                )
              ),

              // Tabs
              e(
                'div',
                { className: 'border-b border-gray-700' },
                e(
                  'nav',
                  { className: 'flex space-x-8 px-6' },
                  tabs.map((tab) =>
                    e(
                      'button',
                      {
                        key: tab.id,
                        onClick: () => setActiveTab(tab.id),
                        className: `py-2 px-1 border-b-2 font-medium text-sm transition-colors ${
                          activeTab === tab.id
                            ? 'border-blue-500 text-blue-400'
                            : 'border-transparent text-gray-400 hover:text-gray-300'
                        }`,
                      },
                      tab.label
                    )
                  )
                )
              ),

              // Content
              e(
                'div',
                { className: 'p-6 overflow-y-auto max-h-[60vh]' },

                // Overview Tab
                activeTab === 'overview' &&
                  e(
                    'div',
                    { className: 'space-y-6' },
                    e(
                      'div',
                      { className: 'grid grid-cols-1 md:grid-cols-2 gap-6' },

                      // Basic Information
                      e(
                        'div',
                        { className: 'bg-gray-700 rounded-lg p-4' },
                        e('h4', { className: 'text-lg font-medium text-white mb-3' }, 'Basic Information'),
                        e(
                          'div',
                          { className: 'space-y-3' },
                          [
                            {
                              label: 'Application Date',
                              field: 'applicationDate',
                              editable: true,
                              type: 'date',
                            },
                            {
                              label: 'Case Type',
                              field: 'caseType',
                              editable: true,
                            },
                            {
                              label: 'Living Arrangement',
                              field: 'livingArrangement',
                              editable: true,
                            },
                            {
                              label: 'Organization/Address',
                              field: 'organizationAddress',
                              editable: true,
                            },
                          ].map((item) =>
                            e(
                              'div',
                              { key: item.field || item.label },
                              e(
                                'label',
                                {
                                  className: 'block text-sm font-medium text-gray-300',
                                },
                                item.label
                              ),
                              e(
                                'p',
                                { className: 'mt-1 text-sm text-gray-400' },
                                item.type === 'date'
                                  ? formatDate(caseData[item.field])
                                  : item.value || caseData[item.field] || 'N/A'
                              )
                            )
                          )
                        )
                      ),

                      // Recent Notes Section
                      e(
                        'div',
                        { className: 'bg-gray-700 rounded-lg p-4' },
                        e('h4', { className: 'text-lg font-medium text-white mb-3' }, 'Recent Notes'),
                        caseNotes.length > 0
                          ? e(
                              'div',
                              {
                                className: 'space-y-3 max-h-48 overflow-y-auto',
                              },
                              caseNotes.slice(0, 3).map((note) =>
                                e(
                                  'div',
                                  {
                                    key: note.id,
                                    className: 'bg-gray-600 rounded p-3',
                                  },
                                  e(
                                    'div',
                                    {
                                      className: 'flex items-center justify-between mb-2',
                                    },
                                    e(
                                      'span',
                                      {
                                        className: 'text-sm font-medium text-blue-400',
                                      },
                                      note.type || 'General'
                                    ),
                                    e('span', { className: 'text-xs text-gray-400' }, dateUtils.format(note.date))
                                  ),
                                  e('p', { className: 'text-gray-300 text-sm' }, note.content || 'No content')
                                )
                              ),
                              caseNotes.length > 3 &&
                                e(
                                  'p',
                                  {
                                    className: 'text-sm text-gray-400 text-center pt-2',
                                  },
                                  `... and ${caseNotes.length - 3} more notes`
                                )
                            )
                          : e(
                              'div',
                              { className: 'text-center py-8 text-gray-500' },
                              e('p', null, 'No notes available for this case')
                            )
                      )
                    )
                  ),

                // History Tab
                activeTab === 'history' &&
                  e(
                    'div',
                    { className: 'space-y-4' },
                    e('h4', { className: 'text-lg font-medium text-white' }, 'Case History'),
                    e(
                      'p',
                      { className: 'text-gray-400 text-center py-8' },
                      'Case history tracking will be implemented in a future update.'
                    )
                  )
              )
            )
          ),

          // Simple Edit Modal
          e(SimpleEditModal, {
            isOpen: isEditModalOpen,
            onClose: () => setIsEditModalOpen(false),
            caseData: caseData,
            fullData,
            onCaseUpdated: (updatedCase) => {
              const updatedData = { ...fullData };
              const caseIndex = updatedData.cases.findIndex((c) => c.id === updatedCase.id);
              if (caseIndex !== -1) {
                updatedData.cases[caseIndex] = updatedCase;
                onUpdateData(updatedData);
                setIsEditModalOpen(false);
                showToast('Case updated successfully!', 'success');
              }
            },
          })
        );
      }

      function EligibilityTab({ fullData }) {
        return e(
          'div',
          { className: 'space-y-6' },
          e('h2', { className: 'text-2xl font-bold text-white' }, 'Eligibility Management'),
          e(
            'div',
            { className: 'bg-gray-800 rounded-lg p-6 border border-gray-700' },
            e('p', { className: 'text-gray-400' }, 'Eligibility functionality will be implemented here...')
          )
        );
      }

      function SettingsModal({ isOpen, onClose, fileService, onDataLoaded }) {
        const [isConnecting, setIsConnecting] = useState(false);
        const [connectionStatus, setConnectionStatus] = useState('disconnected');
        const [loadingData, setLoadingData] = useState(false);

        const handleConnect = async () => {
          setIsConnecting(true);
          try {
            const connected = await fileService.connect();
            if (connected) {
              setConnectionStatus('connected');
              showToast('Directory connected successfully!', 'success');
            } else {
              setConnectionStatus('disconnected');
              showToast('Failed to connect to directory', 'error');
            }
          } catch (error) {
            console.error('Connection error:', error);
            setConnectionStatus('disconnected');
            showToast('Error connecting to directory', 'error');
          } finally {
            setIsConnecting(false);
          }
        };

        const handleLoadData = async () => {
          setLoadingData(true);
          try {
            const data = await fileService.readFile();
            if (data) {
              const normalizedData = await normalizeDataMigrations(data);
              onDataLoaded(normalizedData);
              showToast(`Data loaded successfully! Found ${normalizedData.cases?.length || 0} cases`, 'success');
              onClose();
            } else {
              showToast('No data file found', 'warning');
            }
          } catch (error) {
            console.error('Load data error:', error);
            showToast('Error loading data file', 'error');
          } finally {
            setLoadingData(false);
          }
        };

        const handleCreateSample = async () => {
          try {
            const sampleData = {
              cases: [
                {
                  id: 'case-001',
                  mcn: 'MCN-2025-001',
                  personId: 'person-001',
                  status: 'Pending',
                  applicationDate: '2025-08-01',
                  description: 'Sample case for testing',
                  caseType: 'VR',
                  priority: 'Normal',
                  address: '123 Main St',
                  city: 'Springfield',
                  state: 'IL',
                  zipCode: '62701',
                  organizationId: 'org-001',
                  authorizedReps: [],
                },
                {
                  id: 'case-002',
                  mcn: 'MCN-2025-002',
                  personId: 'person-002',
                  status: 'Approved',
                  applicationDate: '2025-08-05',
                  description: 'Another sample case',
                  caseType: 'LTC',
                  priority: 'High',
                  address: '456 Oak Ave',
                  city: 'Springfield',
                  state: 'IL',
                  zipCode: '62702',
                  organizationId: 'org-002',
                  authorizedReps: [],
                },
              ],
              people: [
                {
                  id: 'person-001',
                  name: 'John Doe',
                  email: 'john.doe@example.com',
                  phone: '(555) 123-4567',
                  address: '123 Main St, Springfield, IL 62701',
                  status: 'active',
                  dateAdded: new Date().toISOString(),
                },
                {
                  id: 'person-002',
                  name: 'Jane Smith',
                  email: 'jane.smith@example.com',
                  phone: '(555) 234-5678',
                  address: '789 Pine St, Springfield, IL 62703',
                  status: 'active',
                  dateAdded: new Date().toISOString(),
                },
              ],
              organizations: [
                {
                  id: 'org-001',
                  name: 'Springfield Community Services',
                  type: 'Non-Profit',
                  contactPerson: 'Mary Wilson',
                  email: 'info@springfieldcs.org',
                  phone: '(555) 987-6543',
                  address: '100 Community Drive, Springfield, IL 62701',
                  status: 'active',
                  dateAdded: new Date().toISOString(),
                },
                {
                  id: 'org-002',
                  name: 'Regional Health Center',
                  type: 'Healthcare',
                  contactPerson: 'Dr. Sarah Davis',
                  email: 'contact@regionalhc.org',
                  phone: '(555) 876-5432',
                  address: '200 Medical Plaza, Springfield, IL 62702',
                  status: 'active',
                  dateAdded: new Date().toISOString(),
                },
              ],
              financials: [
                {
                  id: 'fin-001',
                  caseId: 'case-001',
                  amount: 1250.0,
                  description: 'VR Services',
                  category: 'Training',
                },
              ],
              notes: [
                {
                  id: 'note-001',
                  caseId: 'case-001',
                  content: 'Initial assessment completed',
                  date: '2025-08-02',
                  type: 'Assessment',
                },
              ],
              vrRequests: [
                {
                  id: 'vr-001',
                  caseId: 'case-001',
                  status: 'Pending',
                  requestDate: '2025-08-01',
                },
              ],
            };

            await fileService.writeFile(sampleData);
            onDataLoaded(sampleData);
            showToast('Sample data created and loaded!', 'success');
            onClose();
          } catch (error) {
            console.error('Create sample error:', error);
            showToast('Error creating sample data', 'error');
          }
        };

        if (!isOpen) return null;

        return e(
          Modal,
          {
            isOpen,
            onClose,
            title: 'Settings & Data Management',
            footerContent: e(
              'div',
              { className: 'flex space-x-3' },
              e(
                'button',
                {
                  onClick: onClose,
                  className: 'px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors',
                },
                'Close'
              )
            ),
          },
          e(
            'div',
            { className: 'space-y-6' },

            // File System Connection
            e(
              'div',
              { className: 'space-y-4' },
              e('h3', { className: 'text-lg font-semibold text-white' }, 'File System Connection'),
              e(
                'p',
                { className: 'text-gray-400 text-sm' },
                'Connect to your project directory to load and save case data.'
              ),
              e(
                'div',
                { className: 'flex items-center space-x-4' },
                e(
                  'button',
                  {
                    onClick: handleConnect,
                    disabled: isConnecting,
                    className: `px-4 py-2 rounded-lg font-medium transition-colors ${
                      isConnecting
                        ? 'bg-gray-600 text-gray-400 cursor-not-allowed'
                        : 'bg-blue-600 hover:bg-blue-700 text-white'
                    }`,
                  },
                  isConnecting ? 'Connecting...' : 'Connect to Directory'
                ),
                e(
                  'div',
                  {
                    className: `px-3 py-1 rounded-full text-xs font-medium ${
                      connectionStatus === 'connected' ? 'bg-green-600 text-green-100' : 'bg-red-600 text-red-100'
                    }`,
                  },
                  connectionStatus === 'connected' ? 'Connected' : 'Disconnected'
                )
              )
            ),

            // Data Management
            e(
              'div',
              { className: 'space-y-4' },
              e('h3', { className: 'text-lg font-semibold text-white' }, 'Data Management'),
              e('p', { className: 'text-gray-400 text-sm' }, 'Load existing data or create sample data for testing.'),
              e(
                'div',
                { className: 'grid grid-cols-1 md:grid-cols-2 gap-3' },
                e(
                  'button',
                  {
                    onClick: handleLoadData,
                    disabled: loadingData || connectionStatus !== 'connected',
                    className: `px-4 py-3 rounded-lg font-medium transition-colors ${
                      loadingData || connectionStatus !== 'connected'
                        ? 'bg-gray-600 text-gray-400 cursor-not-allowed'
                        : 'bg-green-600 hover:bg-green-700 text-white'
                    }`,
                  },
                  loadingData ? 'Loading...' : 'Load Data File'
                ),
                e(
                  'button',
                  {
                    onClick: handleCreateSample,
                    disabled: connectionStatus !== 'connected',
                    className: `px-4 py-3 rounded-lg font-medium transition-colors ${
                      connectionStatus !== 'connected'
                        ? 'bg-gray-600 text-gray-400 cursor-not-allowed'
                        : 'bg-orange-600 hover:bg-orange-700 text-white'
                    }`,
                  },
                  'Create Sample Data'
                )
              )
            ),

            // Instructions
            e(
              'div',
              { className: 'space-y-2 p-4 bg-gray-700 rounded-lg' },
              e('h4', { className: 'font-medium text-white' }, 'Instructions:'),
              e(
                'ol',
                {
                  className: 'text-sm text-gray-300 space-y-1 list-decimal list-inside',
                },
                e('li', null, "Click 'Connect to Directory' and select your Nightingale project folder"),
                e('li', null, "Use 'Load Data File' to load existing nightingale-data.json"),
                e('li', null, "Or use 'Create Sample Data' to generate test cases for development")
              )
            )
          )
        );
      }

      // ErrorBoundary Component for graceful error handling
      class ErrorBoundary extends React.Component {
        constructor(props) {
          super(props);
          this.state = { hasError: false, error: null, errorInfo: null };
        }

        static getDerivedStateFromError(error) {
          return { hasError: true };
        }

        componentDidCatch(error, errorInfo) {
          this.setState({
            error: error,
            errorInfo: errorInfo,
          });
          console.error('ErrorBoundary caught an error:', error, errorInfo);
        }

        render() {
          if (this.state.hasError) {
            return e(
              'div',
              {
                className: 'h-full w-full flex items-center justify-center bg-gray-900 text-white p-8',
              },
              e(
                'div',
                { className: 'max-w-2xl text-center' },
                e('h1', { className: 'text-3xl font-bold mb-4' }, 'Something went wrong'),
                e(
                  'p',
                  { className: 'text-gray-300 mb-6' },
                  "The application encountered an error and couldn't recover."
                ),
                e(
                  'button',
                  {
                    className: 'bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded text-white font-medium',
                    onClick: () => window.location.reload(),
                  },
                  'Reload Application'
                ),
                this.state.error &&
                  e(
                    'details',
                    { className: 'mt-6 text-left' },
                    e('summary', { className: 'cursor-pointer text-gray-400' }, 'Technical Details'),
                    e(
                      'pre',
                      { className: 'mt-2 text-sm bg-gray-800 p-4 rounded overflow-auto' },
                      this.state.error.toString() + '\n' + this.state.errorInfo.componentStack
                    )
                  )
              )
            );
          }

          return this.props.children;
        }
      }

      // Main App Component

      function NightingaleCMSApp() {
        const [fullData, setFullData] = useState(null);
        const [activeTab, setActiveTab] = useState('dashboard');
        const [fileStatus, setFileStatus] = useState('disconnected');
        const [isDirty, setIsDirty] = useState(false);
        const [isSettingsOpen, setIsSettingsOpen] = useState(false);
        const [caseViewMode, setCaseViewMode] = useState('list'); // Track if we're in case details view
        const [caseBackFunction, setCaseBackFunction] = useState(null); // Function to go back from case details
        const [peopleViewMode, setPeopleViewMode] = useState('list'); // Track if we're in person details view
        const [peopleBackFunction, setPeopleBackFunction] = useState(null); // Function to go back from person details
        const [organizationsViewMode, setOrganizationsViewMode] = useState('list'); // Track if we're in organization details view
        const [organizationsBackFunction, setOrganizationsBackFunction] = useState(null); // Function to go back from organization details

        // File service initialization
        const fileService = useMemo(
          () =>
            new FileSystemService({
              tabId: `cms-react-tab-${Date.now()}`,
              errorCallback: showToast,
              sanitizeFn: typeof sanitize !== 'undefined' ? sanitize : (str) => str,
            }),
          []
        );

        // Data update handler with immediate save + broadcast
        const handleUpdateData = useCallback(async (newData) => {
          // Use custom DevTools helper for better debugging
          if (window.NightingaleDevTools) {
            window.NightingaleDevTools.logDataFlow('Data Update', {
              hasCases: !!newData?.cases,
              caseCount: newData?.cases?.length || 0,
              hasPeople: !!newData?.people,
              peopleCount: newData?.people?.length || 0,
            });
          }

          console.log('handleUpdateData called with:', {
            hasCases: !!newData?.cases,
            caseCount: newData?.cases?.length || 0,
          });
          setFullData(newData);
          setIsDirty(true);
          console.log('Set isDirty to true');
        }, []);

        const handleSave = async () => {
          if (!fullData) {
            console.error('No fullData available for saving');
            showToast('No data to save.', 'error');
            return;
          }

          console.log('Attempting to save data...', {
            isDirty,
            fullDataExists: !!fullData,
          });

          try {
            const success = await fileService.writeFile(fullData);
            if (success) {
              setIsDirty(false);
              showToast('Data saved successfully.', 'success');

              // Send data integrity broadcast to notify other apps
              const integrityChannel = new BroadcastChannel('nightingale_suite');
              integrityChannel.postMessage({
                type: 'data_updated',
                source: 'cms-react',
                timestamp: new Date().toISOString(),
              });
              integrityChannel.close();
              console.log('Sent data integrity broadcast: data updated');
            } else {
              console.error('FileService.writeFile returned false');
              showToast('Failed to save data.', 'error');
            }
          } catch (error) {
            console.error('Error during save:', error);
            showToast(`Save failed: ${error.message}`, 'error');
          }
        };

        // Data loading handler for settings modal
        const handleDataLoaded = useCallback((newData) => {
          setFullData(newData);
          setFileStatus('connected');
          setIsDirty(false);
          console.log('Data loaded successfully:', {
            cases: newData?.cases?.length || 0,
            people: newData?.people?.length || 0,
          });
        }, []);

        // Initialize file system and load data
        useEffect(() => {
          async function initializeApp() {
            try {
              console.log('ðŸš€ Nightingale CMS React App Starting...');
              console.log('ðŸ“± React DevTools Available');

              setFileStatus('connecting');

              // Check for existing file system access
              const { handle, permission } = await fileService.restoreLastDirectoryAccess();
              if (handle && permission === 'granted') {
                setFileStatus('connected');
                const data = await fileService.readFile();
                if (data) {
                  // Apply any necessary data migrations
                  const normalizedData = await normalizeDataMigrations(data);
                  setFullData(normalizedData);
                  console.log('Data loaded successfully');
                }
              } else {
                setFileStatus('disconnected');
                showToast('Please connect to your data file to continue.', 'warning');
              }
            } catch (error) {
              console.error('App initialization error:', error);
              setFileStatus('disconnected');
              showToast(`Initialization failed: ${error.message}`, 'error');
            }
          }

          initializeApp();
        }, [fileService]);

        // Cross-app communication listener
        useEffect(() => {
          const channel = new BroadcastChannel('nightingale-app-communication');

          channel.addEventListener('message', (event) => {
            console.log('Received broadcast message:', event.data);

            if (event.data.type === 'show_case' && event.data.mcn) {
              // Handle show case request from other apps
              console.log(`Received request to show case: ${event.data.mcn}`);
              setActiveTab('cases');
              showToast(`Loading case ${event.data.mcn}...`, 'info');
            }
          });

          return () => channel.close();
        }, []);

        // React DevTools setup
        useEffect(() => {
          if (window.NightingaleDevTools) {
            console.log('ðŸ› ï¸ Nightingale DevTools Commands Available');
            console.log('ðŸ“ Debug Data: window.NightingaleDevTools.inspectData(data)');
            console.log('ðŸŽ¯ Debug Component: window.NightingaleDevTools.debugComponent(name, state)');
            console.log('ðŸ”Œ Check DevTools Connection: window.NightingaleDevTools.checkDevToolsConnection()');
            console.log('ðŸ“¤ Test Broadcast: window.testDataIntegrityBroadcast()');
            console.log('ðŸ“Š App Status: window.checkAppStatus()');
            console.log('ðŸ’¡ Open React DevTools to inspect component state and props!');

            window.NightingaleDevTools.checkDevToolsConnection();
          }
        }, []);

        // Render content based on active tab
        const renderContent = () => {
          switch (activeTab) {
            case 'dashboard':
              return e(DashboardTab, { fullData });
            case 'cases':
              return e(CasesTab, {
                fullData,
                onUpdateData: handleUpdateData,
                fileService,
                onViewModeChange: setCaseViewMode,
                onBackToList: setCaseBackFunction,
              });
            case 'people':
              return e(PeopleTab, {
                fullData,
                onUpdateData: handleUpdateData,
                fileService,
                onViewModeChange: setPeopleViewMode,
                onBackToList: setPeopleBackFunction,
              });
            case 'organizations':
              return e(OrganizationsTab, {
                fullData,
                onUpdateData: handleUpdateData,
                fileService,
                onViewModeChange: setOrganizationsViewMode,
                onBackToList: setOrganizationsBackFunction,
              });
            case 'eligibility':
              return e(EligibilityTab, { fullData });
            default:
              return e(DashboardTab, { fullData });
          }
        };

        return e(
          'div',
          { className: 'h-screen w-screen flex' },
          e(Sidebar, {
            activeTab,
            onTabChange: setActiveTab,
            onSettingsClick: () => setIsSettingsOpen(true),
            caseViewMode,
            onCaseBackToList: () => {
              if (caseBackFunction) {
                caseBackFunction();
              }
            },
          }),
          e(
            'div',
            { className: 'flex-1 flex flex-col min-w-0 w-full' },
            e(Header, { fileStatus, onSave: handleSave, isDirty }),
            e('main', { className: 'flex-1 p-4 overflow-auto bg-gray-900 w-full' }, renderContent())
          ),
          // Settings Modal
          e(SettingsModal, {
            isOpen: isSettingsOpen,
            onClose: () => setIsSettingsOpen(false),
            fileService,
            onDataLoaded: handleDataLoaded,
          })
        );
      }

      // --- APP INITIALIZATION ---

      console.log('ðŸš€ Nightingale CMS React - Foundation Setup Complete');

      // Wait for components to load before rendering React app
      async function initializeApp() {
        try {
          // Wait for components to be available (index.js auto-loads them)
          if (window.NightingaleComponentLibrary) {
            // Wait for auto-loading to complete by checking if components are registered
            let attempts = 0;
            while (attempts < 50) {
              // Max 5 seconds
              if (window.NightingaleComponentLibrary.getComponent('PrimaryButton')) {
                console.log('âœ… Components loaded, initializing React app');
                break;
              }
              await new Promise((resolve) => setTimeout(resolve, 100));
              attempts++;
            }

            if (attempts >= 50) {
              console.warn('âš ï¸ Components took too long to load, proceeding anyway');
            }

            // Extract components from the library for use in the app
            if (window.NightingaleComponentLibrary) {
              PrimaryButton =
                window.NightingaleComponentLibrary.getComponent('PrimaryButton') || (() => e('button', {}, 'Button'));
              SecondaryButton =
                window.NightingaleComponentLibrary.getComponent('SecondaryButton') || (() => e('button', {}, 'Button'));
              // DataTable is globally available from the component library
              Modal = window.NightingaleComponentLibrary.getComponent('Modal') || (() => e('div', {}, 'Modal'));
              SearchBar = window.NightingaleComponentLibrary.getComponent('SearchBar') || (() => e('input', {}, ''));
              console.log('âœ… Components extracted from library');
            } else {
              // Fallback components if library is not available
              PrimaryButton = (props) =>
                e('button', { ...props, className: 'bg-blue-600 text-white px-4 py-2 rounded' }, props.children);
              SecondaryButton = (props) =>
                e('button', { ...props, className: 'bg-gray-600 text-white px-4 py-2 rounded' }, props.children);
              Modal = (props) => e('div', { ...props }, props.children);
              SearchBar = (props) => e('input', { ...props, type: 'text', placeholder: 'Search...' });
              console.log('âš ï¸ Using fallback components');
            }
          } else {
            console.warn('âš ï¸ Component library not found, proceeding with basic initialization');
          }

          const root = createRoot(document.getElementById('root'));
          root.render(e(NightingaleCMSApp));

          // Store app instance globally for debugging
          window.nightingaleCMSApp = root;
        } catch (error) {
          console.error('âŒ Failed to initialize app:', error);
          // Fallback - render anyway
          const root = createRoot(document.getElementById('root'));
          root.render(e(NightingaleCMSApp));
          window.nightingaleCMSApp = root;
        }
      }

      // Initialize when DOM is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initializeApp);
      } else {
        initializeApp();
      }

      // Helper function for data migrations (comprehensive)
      async function normalizeDataMigrations(data) {
        if (!data) return data;

        console.log('ðŸ”„ Running data migrations for CMS React compatibility...');

        // Normalize case data structure
        if (data.cases) {
          data.cases = data.cases.map((caseItem) => {
            const normalizedCase = { ...caseItem };

            // Ensure MCN field consistency - map both directions
            // Legacy field migration: masterCaseNumber -> mcn
            if (caseItem.masterCaseNumber && !caseItem.mcn) {
              normalizedCase.mcn = caseItem.masterCaseNumber;
            }

            // Map appDetails.appDate to applicationDate
            if (caseItem.appDetails?.appDate && !caseItem.applicationDate) {
              normalizedCase.applicationDate = caseItem.appDetails.appDate;
            }

            // Map appDetails.caseType to caseType if missing
            if (caseItem.appDetails?.caseType && !caseItem.caseType) {
              normalizedCase.caseType = caseItem.appDetails.caseType;
            }

            // Add default values for new fields if they don't exist
            if (!normalizedCase.livingArrangement) {
              normalizedCase.livingArrangement = 'Not specified';
            }

            if (!normalizedCase.organizationAddress) {
              normalizedCase.organizationAddress = 'Not specified';
            }

            // FINANCIAL ITEMS MIGRATION: type â†’ description, value â†’ amount
            if (normalizedCase.financials) {
              ['resources', 'income', 'expenses'].forEach((financialType) => {
                if (normalizedCase.financials[financialType]) {
                  normalizedCase.financials[financialType] = normalizedCase.financials[financialType].map((item) => {
                    const migratedItem = { ...item };

                    // Migrate type â†’ description (CMSOld uses "type", React uses "description")
                    if (item.type && !item.description) {
                      migratedItem.description = item.type;
                      console.log(`ðŸ“ Migrated financial item type "${item.type}" â†’ description`);
                    }

                    // Migrate value â†’ amount (CMSOld uses "value", React uses "amount")
                    if (item.value !== undefined && item.amount === undefined) {
                      migratedItem.amount = item.value;
                      console.log(`ðŸ’° Migrated financial item value ${item.value} â†’ amount`);
                    }

                    // Ensure backward compatibility: keep both fields
                    if (item.description && !item.type) {
                      migratedItem.type = item.description;
                    }
                    if (item.amount !== undefined && item.value === undefined) {
                      migratedItem.value = item.amount;
                    }

                    // Add missing fields with defaults
                    if (!migratedItem.frequency) {
                      migratedItem.frequency = 'monthly'; // Default frequency for new React model
                    }

                    if (!migratedItem.dateAdded) {
                      migratedItem.dateAdded = new Date().toISOString();
                    }

                    // Ensure verificationSource instead of just source
                    if (item.source && !item.verificationSource) {
                      migratedItem.verificationSource = item.source;
                    }

                    return migratedItem;
                  });
                }
              });
            }

            return normalizedCase;
          });
        }

        // Normalize people data structure
        if (data.people) {
          data.people = data.people.map((person, index) => {
            const normalizedPerson = { ...person };

            // Ensure every person has an ID
            if (!normalizedPerson.id) {
              normalizedPerson.id = `person-${Date.now()}-${index}`;
            }

            // Ensure default values for required fields
            if (!normalizedPerson.name) {
              normalizedPerson.name = 'Unknown Person';
            }

            if (!normalizedPerson.status) {
              normalizedPerson.status = 'active';
            }

            if (!normalizedPerson.dateAdded) {
              normalizedPerson.dateAdded = new Date().toISOString();
            }

            return normalizedPerson;
          });
        }

        // Normalize organizations data structure
        if (data.organizations) {
          data.organizations = data.organizations.map((org, index) => {
            const normalizedOrg = { ...org };

            // Ensure every organization has an ID
            if (!normalizedOrg.id) {
              normalizedOrg.id = `org-${Date.now()}-${index}`;
            }

            // Ensure default values for required fields
            if (!normalizedOrg.name) {
              normalizedOrg.name = 'Unknown Organization';
            }

            if (!normalizedOrg.status) {
              normalizedOrg.status = 'active';
            }

            if (!normalizedOrg.dateAdded) {
              normalizedOrg.dateAdded = new Date().toISOString();
            }

            return normalizedOrg;
          });
        }

        console.log('âœ… Data migration completed successfully');
        return data;
      }

      // Initialize the app
      document.addEventListener('DOMContentLoaded', function () {
        const container = document.getElementById('root');
        if (container) {
          const root = ReactDOM.createRoot(container);
          root.render(React.createElement(ErrorBoundary, null, React.createElement(NightingaleCMSApp)));
          console.log('âœ… App initialized successfully with ErrorBoundary');
        } else {
          console.error('âŒ Could not find #root container');
        }
      });
    </script>
  </body>
</html>
