<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-900 text-white">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Case Management System</title>
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com; connect-src 'self';"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Day.js for enhanced date management -->
    <script src="lib/dayjs.min.js"></script>
    <script src="lib/dayjs-relativeTime.min.js"></script>
    <script src="lib/dayjs-customParseFormat.min.js"></script>
    <script>
      // Initialize Day.js plugins
      if (typeof dayjs !== "undefined") {
        dayjs.extend(window.dayjs_plugin_relativeTime);
        dayjs.extend(window.dayjs_plugin_customParseFormat);
      }
    </script>
    <script src="js/nightingale.utils.js"></script>
    <script src="js/nightingale.dayjs.js"></script>
    <script src="js/nightingale.parsers.js"></script>
    <script src="js/nightingale.fileservice.js"></script>
    <script src="lib/fuse.min.js"></script>
    <script src="js/nightingale.search.js"></script>
    <script>
      // Production warning suppression - using CDN for standalone deployment
      if (window.tailwind && window.tailwind.config) {
        window.tailwind.config = { ...window.tailwind.config, devtools: false };
      }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      html {
        font-family: "Inter", sans-serif;
      }
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #1f2937;
      }
      ::-webkit-scrollbar-thumb {
        background: #4b5563;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #6b7280;
      }

      /* Draggable handle for modals */
      .drag-handle {
        cursor: move;
      }

      /* Prevents bullets from rendering in lists */
      #case-list,
      #person-list,
      #contact-list {
        list-style-type: none;
        padding-left: 0;
      }

      /* Hide number input spinners */
      input[type="number"]::-webkit-inner-spin-button,
      input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type="number"] {
        appearance: textfield;
        -moz-appearance: textfield;
      }

      /* Transitions */
      #sidebar {
        transition: width 0.3s ease-in-out;
      }
      .list-item {
        transition:
          transform 0.2s ease-in-out,
          box-shadow 0.2s ease-in-out,
          background-color 0.2s ease-in-out;
        cursor: pointer;
      }
      .list-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        background-color: #374151;
      }

      /* Lift/shadow effect for financial item cards */
      .edit-financial-item {
        transition:
          transform 0.2s ease-in-out,
          box-shadow 0.2s ease-in-out,
          background-color 0.2s ease-in-out;
      }
      .edit-financial-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        background-color: #374151; /* gray-700 */
      }

      /* Sidebar always collapsed state */
      #sidebar {
        width: 3.5rem;
      }

      #sidebar .sidebar-text {
        display: none;
      }

      #sidebar .tab-button,
      #sidebar #open-settings-modal-btn {
        justify-content: center;
      }

      #sidebar .tab-button > svg {
        margin-right: 0;
      }

      /* Tooltip styling for collapsed sidebar */
      .tooltip {
        position: absolute;
        left: 100%;
        top: 50%;
        transform: translateY(-50%);
        margin-left: 12px;
        background-color: #1f2937;
        color: #f3f4f6;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition:
          opacity 0.2s ease,
          visibility 0.2s ease;
        z-index: 1000;
        border: 1px solid #374151;
        box-shadow:
          0 4px 6px -1px rgba(0, 0, 0, 0.1),
          0 2px 4px -1px rgba(0, 0, 0, 0.06);
        pointer-events: none;
      }

      .tooltip::before {
        content: "";
        position: absolute;
        right: 100%;
        top: 50%;
        transform: translateY(-50%);
        border: 6px solid transparent;
        border-right-color: #1f2937;
      }

      /* Show tooltips on hover for all sidebar buttons */
      #sidebar .tab-button:hover .tooltip,
      #sidebar #open-settings-modal-btn:hover .tooltip {
        opacity: 1;
        visibility: visible;
      }

      /* Ensure tooltips are positioned relative to their parent button */
      .tab-button,
      #open-settings-modal-btn {
        position: relative;
      }

      /* Scrollable container */
      .notes-container {
        overflow-y: auto;
      }

      /* Note text display improvements */
      .note-text-short {
        display: block;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .note-text-full {
        display: block;
      }

      /* Softer focus ring */
      input:focus,
      select:focus,
      textarea:focus {
        --tw-ring-color: rgba(96, 165, 250, 0.5);
      }

      /* --- Look & Feel Styles --- */
      #modal-layer {
        pointer-events: none;
      }
      .modal {
        pointer-events: auto;
      }

      /* Defensive CSS to ensure backdrop is hidden when no modals exist */
      body:not(:has(.modal)) #modal-backdrop {
        opacity: 0 !important;
        pointer-events: none !important;
      }
      #toast-container {
        position: fixed;
        bottom: 1.5rem;
        right: 1.5rem;
        z-index: 2000;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
      }
      .toast {
        padding: 0.75rem 1.25rem;
        border-radius: 0.5rem;
        color: white;
        box-shadow:
          0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
        opacity: 0;
        transform: translateX(100%);
        transition:
          opacity 0.3s ease,
          transform 0.3s ease;
      }
      .toast.show {
        opacity: 1;
        transform: translateX(0);
      }
      .toast.success {
        background-color: #16a34a;
      } /* green-600 */
      .toast.warning {
        background-color: #ea580c;
      } /* orange-600 */
      .toast.error {
        background-color: #dc2626;
      } /* red-600 */
      .input-error {
        border-color: #ef4444 !important; /* red-500 */
        --tw-ring-color: rgba(239, 68, 68, 0.5); /* red-500 with 50% opacity */
      }
      .error-message {
        color: #f87171; /* red-400 */
        font-size: 0.75rem;
        margin-top: 0.25rem;
      }
      .fade-transition {
        transition: opacity 0.15s ease-in-out;
      }
      .financial-items-container {
        max-height: 275px; /* Default scrollable height */
        overflow-y: auto;
        transition: max-height 0.3s ease-in-out;
      }
      .financial-items-container.expanded {
        max-height: 1000px; /* A large value to accommodate all items */
      }
      .toggle-financial-list-btn {
        padding: 0.25rem;
        color: #9ca3af; /* text-gray-400 */
        border-radius: 9999px;
        transition:
          background-color 0.2s,
          color 0.2s;
      }
      .toggle-financial-list-btn:hover {
        background-color: #374151; /* gray-700 */
        color: #e5e7eb; /* text-gray-200 */
      }
      .toggle-financial-list-btn svg {
        transition: transform 0.3s ease-in-out;
      }
      .financial-items-container.expanded
        + .toggle-container
        .toggle-financial-list-btn
        svg {
        transform: rotate(180deg);
      }

      /* Enhanced sorting controls */
      #case-sort-toggle {
        transition: background-color 0.2s ease;
      }
      #priority-filter-toggle {
        transition: background-color 0.2s ease;
        font-weight: 600;
      }
      .priority-filter-text {
        font-size: 0.875rem;
      }

      .case-info-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem 1.5rem; /* row-gap column-gap */
      }
      .case-info-item {
        display: flex;
        flex-direction: column;
      }
      .case-info-label {
        font-size: 0.75rem; /* text-xs */
        color: #9ca3af; /* text-gray-400 */
        margin-bottom: 0.25rem;
      }
      .case-info-value {
        font-size: 0.875rem; /* text-sm */
        font-weight: 500;
      }
      .clickable-text {
        cursor: pointer;
        text-decoration: none;
        color: #e5e7eb; /* text-gray-200 */
        transition: color 0.2s ease-in-out;
      }
      .clickable-text:hover {
        color: #93c5fd; /* text-blue-300 */
      }

      /* Styles for the new accordion financial cards */
      .accordion-header {
        cursor: pointer;
        transition: background-color 0.2s ease;
      }
      .accordion-header:hover {
        background-color: #374151; /* gray-700 */
      }
      .accordion-icon {
        transition: transform 0.3s ease;
      }
      .accordion-header.open .accordion-icon {
        transform: rotate(90deg);
      }
      .accordion-content {
        max-height: 0;
        overflow: hidden;
        transition:
          max-height 0.3s ease-in-out,
          padding 0.3s ease-in-out;
        padding-top: 0;
        padding-bottom: 0;
        background-color: #1f2937; /* gray-800 */
      }
      .accordion-content.open {
        max-height: 1000px; /* Large enough to not clip content */
        padding-top: 1rem;
        padding-bottom: 1rem;
      }
      .copy-label,
      .copy-financials-header {
        cursor: pointer;
        transition: color 0.2s ease-in-out;
      }
      .copy-label:hover,
      .copy-financials-header:hover,
      .copy-mcn-header:hover {
        color: #93c5fd; /* text-blue-300 */
        cursor: pointer;
      }
      .autocomplete-input {
        background-color: transparent !important;
      }
      .tab-hint {
        display: inline-block;
        margin-left: 8px;
        padding: 1px 5px;
        border: 1px solid #4b5563; /* gray-600 */
        border-radius: 4px;
        background-color: #374151; /* gray-700 */
        font-size: 0.7rem;
        line-height: 1;
        color: #9ca3af; /* gray-400 */
        font-family: monospace;
        opacity: 0.7;
        vertical-align: middle;
      }
      .clickable-header {
        cursor: pointer;
        transition: color 0.2s ease-in-out;
      }
      .clickable-header:hover {
        color: #93c5fd; /* text-blue-300 */
      }
      .notes-drawer {
        width: 0;
        background-color: #1f2937; /* gray-800 */
        box-shadow: -10px 0 20px rgba(0, 0, 0, 0.3);
        transition: width 0.3s ease-in-out;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        height: 100%;
        flex-shrink: 0;
        border-left: 1px solid #374151; /* gray-700 */
      }
      .notes-drawer.open {
        width: 500px;
      }
      .note-item .note-edit-view {
        display: none;
      }
      .note-item.editing .note-display-view {
        display: none;
      }
      .note-item.editing .note-edit-view {
        display: block;
      }
      .note-item.editing {
        background-color: #374151; /* gray-700 */
        box-shadow: 0 0 0 2px #60a5fa; /* A blue ring to indicate active edit */
      }
    </style>
  </head>
  <body class="h-full flex flex-col">
    <div
      id="app-container"
      class="flex flex-col h-screen bg-gray-900 text-gray-200"
    >
      <div
        id="title-bar"
        class="flex items-center justify-between bg-gray-800 p-2 shadow-md flex-shrink-0"
      >
        <div class="flex items-center">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6 mr-2 text-blue-400"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
            />
          </svg>
          <span id="app-title-text" class="font-bold"></span>
        </div>
        <div class="flex items-center space-x-3">
          <!-- Auto-refresh status indicator -->
          <div
            class="flex items-center space-x-1"
            title="Auto-refresh active - data syncs when window becomes active"
          >
            <svg
              id="auto-refresh-icon"
              xmlns="http://www.w3.org/2000/svg"
              class="h-3 w-3 text-green-400"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
              />
            </svg>
            <span id="auto-refresh-status" class="text-xs text-gray-400"
              >Auto</span
            >
          </div>

          <div
            id="save-status-container"
            class="flex items-center space-x-1.5 ml-3 hidden"
            title="Last auto-save time"
          >
            <svg
              id="save-status-icon"
              xmlns="http://www.w3.org/2000/svg"
              class="h-4 w-4 text-gray-400 transition-colors duration-500"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                clip-rule="evenodd"
              />
            </svg>
            <span id="save-status-text" class="text-xs text-gray-400"></span>
          </div>

          <!-- Status lights -->
          <div class="flex space-x-2">
            <div class="w-3 h-3 bg-yellow-400 rounded-full"></div>
            <div class="w-3 h-3 bg-green-400 rounded-full"></div>
            <div class="w-3 h-3 bg-red-400 rounded-full"></div>
          </div>
        </div>
      </div>

      <div class="flex flex-grow overflow-hidden">
        <div
          id="sidebar"
          class="bg-gray-800 p-2 flex-shrink-0 flex flex-col justify-between"
        >
          <nav class="flex flex-col space-y-2">
            <button
              data-tab="dashboard"
              data-title="Dashboard"
              class="tab-button bg-blue-500 text-white flex items-center p-2 rounded-md transition-all duration-200 hover:bg-blue-600"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 mr-3 flex-shrink-0"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"
                />
              </svg>
              <span class="sidebar-text font-semibold">Dashboard</span>
              <div class="tooltip">Dashboard</div>
            </button>
            <button
              data-tab="case-management"
              data-title="Cases"
              class="tab-button bg-gray-700 text-gray-300 flex items-center p-2 rounded-md transition-all duration-200 hover:bg-gray-600"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 mr-3 flex-shrink-0"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" />
                <path
                  fill-rule="evenodd"
                  d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z"
                  clip-rule="evenodd"
                />
              </svg>
              <span class="sidebar-text font-semibold">Cases</span>
              <div class="tooltip">Cases</div>
            </button>
            <button
              data-tab="person-details"
              data-title="People"
              class="tab-button bg-gray-700 text-gray-300 flex items-center p-2 rounded-md transition-all duration-200 hover:bg-gray-600"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 mr-3 flex-shrink-0"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  fill-rule="evenodd"
                  d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z"
                  clip-rule="evenodd"
                />
              </svg>
              <span class="sidebar-text font-semibold">People</span>
              <div class="tooltip">People</div>
            </button>
            <button
              data-tab="organizations"
              data-title="Organizations"
              class="tab-button bg-gray-700 text-gray-300 flex items-center p-2 rounded-md transition-all duration-200 hover:bg-gray-600"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 mr-3 flex-shrink-0"
                viewBox="0 0 20 20"
                fill="currentColor"
              >
                <path
                  d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"
                />
              </svg>
              <span class="sidebar-text font-semibold">Organizations</span>
              <div class="tooltip">Organizations</div>
            </button>
            <button
              data-tab="eligibility"
              data-title="Eligibility"
              class="tab-button bg-gray-700 text-gray-300 flex items-center p-2 rounded-md transition-all duration-200 hover:bg-gray-600"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 mr-3 flex-shrink-0"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
              <span class="sidebar-text font-semibold">Eligibility</span>
              <div class="tooltip">Eligibility</div>
            </button>
            <button
              id="open-settings-modal-btn"
              class="bg-gray-700 text-gray-300 flex items-center p-2 rounded-md transition-all duration-200 hover:bg-gray-600"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-5 w-5 flex-shrink-0"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
                stroke-width="2"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066 2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.096 2.572-1.065z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                />
              </svg>
              <span class="sidebar-text font-semibold">Settings</span>
              <div class="tooltip">Settings</div>
            </button>
          </nav>
        </div>

        <main class="flex-grow p-6 bg-gray-900 overflow-auto">
          <div
            id="permission-prompt"
            class="hidden text-center p-10 bg-gray-800 border border-yellow-500 rounded-xl shadow-lg my-6"
          >
            <h2 class="text-2xl font-bold mb-4 text-yellow-300">
              Permission Required
            </h2>
            <p class="mb-6 text-gray-300">
              This app needs persistent access to its folder to load and save
              your data. Please grant permission to continue.
            </p>
            <button
              id="grant-access-btn"
              class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700"
            >
              Grant Access
            </button>
            <p id="permission-denied-message" class="hidden mt-4 text-red-400">
              Permission was denied. You may need to grant access via your
              browser's site settings.
            </p>
          </div>

          <!-- Dashboard Tab Content -->
          <div id="dashboard" class="tab-content">
            <div class="max-w-7xl mx-auto">
              <!-- Header Section -->
              <div class="mb-8">
                <h1 class="text-4xl font-bold text-blue-300 mb-2">
                  Welcome to Nightingale CMS
                </h1>
                <p class="text-gray-400 text-lg">
                  Case Management System Dashboard
                </p>
              </div>

              <!-- Stats Cards -->
              <div
                class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8"
              >
                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-gray-400 text-sm font-medium">
                        Total Cases
                      </p>
                      <p
                        class="text-3xl font-bold text-white"
                        id="stat-total-cases"
                      >
                        --
                      </p>
                    </div>
                    <div class="bg-blue-500/20 p-3 rounded-lg">
                      <svg
                        class="h-6 w-6 text-blue-400"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                        ></path>
                      </svg>
                    </div>
                  </div>
                  <p class="text-green-400 text-sm mt-2">
                    ↗ Chart will go here
                  </p>
                </div>

                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-gray-400 text-sm font-medium">
                        Active Cases
                      </p>
                      <p
                        class="text-3xl font-bold text-white"
                        id="stat-active-cases"
                      >
                        --
                      </p>
                    </div>
                    <div class="bg-green-500/20 p-3 rounded-lg">
                      <svg
                        class="h-6 w-6 text-green-400"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
                        ></path>
                      </svg>
                    </div>
                  </div>
                  <p class="text-blue-400 text-sm mt-2">
                    📊 Chart will go here
                  </p>
                </div>

                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-gray-400 text-sm font-medium">
                        Priority Cases
                      </p>
                      <p
                        class="text-3xl font-bold text-white"
                        id="stat-priority-cases"
                      >
                        --
                      </p>
                    </div>
                    <div class="bg-yellow-500/20 p-3 rounded-lg">
                      <svg
                        class="h-6 w-6 text-yellow-400"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.728-.833-2.498 0L4.316 16.5c-.77.833.192 2.5 1.732 2.5z"
                        ></path>
                      </svg>
                    </div>
                  </div>
                  <p class="text-orange-400 text-sm mt-2">
                    📈 Chart will go here
                  </p>
                </div>

                <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                  <div class="flex items-center justify-between">
                    <div>
                      <p class="text-gray-400 text-sm font-medium">
                        Total People
                      </p>
                      <p
                        class="text-3xl font-bold text-white"
                        id="stat-total-people"
                      >
                        --
                      </p>
                    </div>
                    <div class="bg-purple-500/20 p-3 rounded-lg">
                      <svg
                        class="h-6 w-6 text-purple-400"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          stroke-width="2"
                          d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                        ></path>
                      </svg>
                    </div>
                  </div>
                  <p class="text-purple-400 text-sm mt-2">
                    📋 Chart will go here
                  </p>
                </div>
              </div>

              <!-- Navigation Tiles -->
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div
                  class="bg-gradient-to-br from-blue-600 to-blue-700 rounded-lg p-6 hover:from-blue-700 hover:to-blue-800 transition-all duration-200 cursor-pointer group"
                  onclick="switchTab('case-management', 'Cases')"
                >
                  <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-white">
                      Case Management
                    </h3>
                    <svg
                      class="h-8 w-8 text-blue-200 group-hover:text-white transition-colors"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                      ></path>
                    </svg>
                  </div>
                  <p class="text-blue-100 mb-4">
                    Manage Medicaid cases, track applications, and monitor case
                    progress.
                  </p>
                  <div
                    class="flex items-center text-blue-200 group-hover:text-white"
                  >
                    <span class="text-sm font-medium">View All Cases</span>
                    <svg
                      class="h-4 w-4 ml-2 transition-transform group-hover:translate-x-1"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 5l7 7-7 7"
                      ></path>
                    </svg>
                  </div>
                </div>

                <div
                  class="bg-gradient-to-br from-green-600 to-green-700 rounded-lg p-6 hover:from-green-700 hover:to-green-800 transition-all duration-200 cursor-pointer group"
                  onclick="switchTab('person-details', 'People')"
                >
                  <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-white">
                      People Management
                    </h3>
                    <svg
                      class="h-8 w-8 text-green-200 group-hover:text-white transition-colors"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                      ></path>
                    </svg>
                  </div>
                  <p class="text-green-100 mb-4">
                    Add and manage people, update contact information, and track
                    relationships.
                  </p>
                  <div
                    class="flex items-center text-green-200 group-hover:text-white"
                  >
                    <span class="text-sm font-medium">Manage People</span>
                    <svg
                      class="h-4 w-4 ml-2 transition-transform group-hover:translate-x-1"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 5l7 7-7 7"
                      ></path>
                    </svg>
                  </div>
                </div>

                <div
                  class="bg-gradient-to-br from-purple-600 to-purple-700 rounded-lg p-6 hover:from-purple-700 hover:to-purple-800 transition-all duration-200 cursor-pointer group"
                  onclick="switchTab('organizations', 'Organizations')"
                >
                  <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold text-white">Organizations</h3>
                    <svg
                      class="h-8 w-8 text-purple-200 group-hover:text-white transition-colors"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"
                      ></path>
                    </svg>
                  </div>
                  <p class="text-purple-100 mb-4">
                    Manage nursing homes, care facilities, and their contact
                    personnel.
                  </p>
                  <div
                    class="flex items-center text-purple-200 group-hover:text-white"
                  >
                    <span class="text-sm font-medium">View Organizations</span>
                    <svg
                      class="h-4 w-4 ml-2 transition-transform group-hover:translate-x-1"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 5l7 7-7 7"
                      ></path>
                    </svg>
                  </div>
                </div>
              </div>

              <!-- Quick Actions -->
              <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
                <h3 class="text-xl font-bold text-white mb-4">Quick Actions</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <button
                    onclick="window.open('NightingaleCorrespondence.html', '_blank')"
                    class="bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-lg text-center transition-colors group"
                  >
                    <svg
                      class="h-6 w-6 mx-auto mb-2 group-hover:scale-110 transition-transform"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"
                      ></path>
                    </svg>
                    <span class="text-sm font-medium">Send Correspondence</span>
                  </button>

                  <button
                    onclick="showToast('Call Log feature coming soon', 'info')"
                    class="bg-green-600 hover:bg-green-700 text-white p-4 rounded-lg text-center transition-colors group"
                  >
                    <svg
                      class="h-6 w-6 mx-auto mb-2 group-hover:scale-110 transition-transform"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"
                      ></path>
                    </svg>
                    <span class="text-sm font-medium">Log Call</span>
                  </button>

                  <button
                    onclick="window.open('NightingaleReports.html', '_blank')"
                    class="bg-purple-600 hover:bg-purple-700 text-white p-4 rounded-lg text-center transition-colors group"
                  >
                    <svg
                      class="h-6 w-6 mx-auto mb-2 group-hover:scale-110 transition-transform"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                      ></path>
                    </svg>
                    <span class="text-sm font-medium">Generate Report</span>
                  </button>

                  <button
                    onclick="window.open('todo.html', '_blank')"
                    class="bg-yellow-600 hover:bg-yellow-700 text-white p-4 rounded-lg text-center transition-colors group"
                  >
                    <svg
                      class="h-6 w-6 mx-auto mb-2 group-hover:scale-110 transition-transform"
                      fill="none"
                      stroke="currentColor"
                      viewBox="0 0 24 24"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"
                      ></path>
                    </svg>
                    <span class="text-sm font-medium">Add Task</span>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div id="case-management" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
              <h1 class="text-3xl font-bold text-blue-300">Case Management</h1>
              <button
                id="add-master-case-btn"
                class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200"
              >
                New Master Case
              </button>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
              <div class="flex items-center space-x-4 mb-4">
                <div class="relative w-full">
                  <input
                    type="text"
                    id="case-search"
                    placeholder="Search cases by name or MCN..."
                    class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 pl-4 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500/50 clear-on-switch"
                  />
                  <button
                    id="clear-case-search"
                    class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-white hidden"
                  >
                    <svg
                      class="h-5 w-5"
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                        clip-rule="evenodd"
                      />
                    </svg>
                  </button>
                </div>
                <button
                  id="show-all-cases-btn"
                  class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200 flex-shrink-0"
                >
                  Show All
                </button>
                <div class="flex items-center space-x-2 flex-shrink-0">
                  <select
                    id="case-sort"
                    class="bg-gray-700 border border-gray-600 rounded-md py-2 px-4 focus:outline-none focus:ring-2 focus:ring-blue-500/50"
                  >
                    <option value="name">Name</option>
                    <option value="date">Date</option>
                    <option value="status-priority">Status (Priority)</option>
                    <option value="status-active">Status (Active)</option>
                  </select>
                  <button
                    id="case-sort-toggle"
                    class="bg-gray-600 hover:bg-gray-500 text-white p-2 rounded-md transition-all duration-200"
                    title="Reverse Sort Order"
                  >
                    <svg
                      class="h-5 w-5"
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"
                      />
                    </svg>
                  </button>
                  <button
                    id="priority-filter-toggle"
                    class="bg-gray-600 hover:bg-gray-500 text-white py-2 px-3 rounded-md transition-all duration-200 text-sm"
                    title="Show Priority Cases Only"
                  >
                    <span class="priority-filter-text">All</span>
                  </button>
                </div>
              </div>
              <div id="case-list" class="space-y-3"></div>
            </div>
          </div>

          <div id="master-case-view" class="tab-content hidden"></div>

          <div id="person-details" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
              <h1 class="text-3xl font-bold text-blue-300">People</h1>
              <button
                id="add-person-btn"
                class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200"
              >
                Add New Person
              </button>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
              <div class="flex items-center space-x-4 mb-4">
                <div class="relative w-full">
                  <input
                    type="text"
                    id="person-search"
                    placeholder="Search people by name..."
                    class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 pl-4 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500/50 clear-on-switch"
                  />
                  <button
                    id="clear-person-search"
                    class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-white hidden"
                  >
                    <svg
                      class="h-5 w-5"
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                        clip-rule="evenodd"
                      />
                    </svg>
                  </button>
                </div>
                <button
                  id="show-all-people-btn"
                  class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200 flex-shrink-0"
                >
                  Show All
                </button>
              </div>
              <div id="person-list" class="space-y-3"></div>
            </div>
          </div>

          <div id="organizations" class="tab-content hidden">
            <div class="flex justify-between items-center mb-6">
              <h1 class="text-3xl font-bold text-blue-300">Organizations</h1>
              <button
                id="add-organization-btn"
                class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200"
              >
                New Organization
              </button>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
              <div class="flex items-center space-x-4 mb-4">
                <div class="relative w-full">
                  <input
                    type="text"
                    id="organization-search"
                    placeholder="Search organizations by name or city..."
                    class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 pl-4 pr-10 focus:outline-none focus:ring-2 focus:ring-blue-500/50 clear-on-switch"
                  />
                  <button
                    id="clear-organization-search"
                    class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-white hidden"
                  >
                    <svg
                      class="h-5 w-5"
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 20 20"
                      fill="currentColor"
                    >
                      <path
                        fill-rule="evenodd"
                        d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                        clip-rule="evenodd"
                      />
                    </svg>
                  </button>
                </div>
                <button
                  id="show-all-organizations-btn"
                  class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200 flex-shrink-0"
                >
                  Show All
                </button>
              </div>
              <div id="organization-list" class="space-y-3"></div>
            </div>
          </div>

          <div id="eligibility" class="tab-content hidden"></div>
        </main>
        <div id="notes-drawer-container" class="flex-shrink-0"></div>
      </div>
    </div>

    <div id="modal-layer" class="fixed inset-0 z-[1000]"></div>
    <div id="toast-container"></div>

    <input
      type="file"
      id="import-contact-file-input"
      accept=".txt"
      style="display: none;"
    />

    <script>
      const TAB_ID = `cms-tab-${dayjs().valueOf()}-${Math.random()}`;
      /*
       * =============================================================================
       * FILE SYSTEM ACCESS API SERVICES (MODULAR VERSION)
       * =============================================================================
       * The FileSystemService class is now loaded from the shared nightingale.fileservice.js file.
       */

      /*
       * NIGHTINGALE CASE MANAGEMENT SYSTEM - STANDALONE VERSION
       * =========================================================
       * * TABLE OF CONTENTS:
       * ==================
       * 1. STATE MANAGEMENT & CONFIGURATION - Application state and settings
       * 2. CONSTANTS & CONFIGURATION - Status options, colors, and constants
       * 3. PERFORMANCE OPTIMIZATIONS & CACHING - Search cache, debouncing, selective rendering
       * 4. DATA INDEXING & MEMORY OPTIMIZATION - Data structures and memory management
       * 5. DATA ACCESS & UTILITY FUNCTIONS - Helper functions for data access
       * 6. DATA PERSISTENCE & STATE MANAGEMENT - Loading, saving, and batch operations
       * 7. UI RENDERING & DISPLAY FUNCTIONS - Main rendering and list display functions
       * 8. MODAL FACTORIES & DIALOG MANAGEMENT - Modal creation and management
       * 9. FORM VALIDATION & PROCESSING - Input validation and form processing
       * 10. FORM GENERATORS & INPUT HANDLING - Dynamic form generation
       * 11. UI NAVIGATION & INTERACTION - Tab switching and sidebar management
       * 12. EVENT HANDLING & USER INTERACTIONS - Event listeners and click handlers
       * 13. CUSTOM MODALS & SPECIALIZED DATA MANAGEMENT - Complex modal dialogs
       * 14. APPLICATION INITIALIZATION & EVENT LISTENERS - App startup and setup
       * 15. DEVELOPMENT & DEBUGGING UTILITIES - Debug tools and utilities
       */
      document.addEventListener("DOMContentLoaded", async () => {
        let isRefreshing = false;
        // =============================================================================
        // STATE MANAGEMENT & CONFIGURATION
        // =============================================================================

        // Define the StateManager class first, as it's needed by the startup logic.
        class StateManagementService {
          constructor(initialState, fileService) {
            this.fileService = fileService;
            this.lastSaveTimestamp = null;
            this.saveTimeout = null; // For debouncing
            this.isBatchLoading = false; // Flag to disable saves during file load

            const handler = {
              get: (target, property, receiver) => {
                const value = Reflect.get(target, property, receiver);
                if (typeof value === "object" && value !== null) {
                  return new Proxy(value, handler);
                }
                return value;
              },
              set: (target, property, value, receiver) => {
                const success = Reflect.set(target, property, value, receiver);
                return this._saveIfAllowed(success, initialState);
              },
              deleteProperty: (target, property) => {
                const success = Reflect.deleteProperty(target, property);
                return this._saveIfAllowed(success, initialState);
              },
            };

            this.state = new Proxy(initialState, handler);
          }

          _saveIfAllowed(success, stateObject) {
            if (success && !this.isBatchLoading) {
              this.debouncedSave(stateObject);
            }
            return success;
          }

          debouncedSave(stateObject) {
            clearTimeout(this.saveTimeout);
            this.saveTimeout = setTimeout(() => {
              this.saveState(stateObject);
            }, 50); // Debounce saves by 50ms
          }

          async saveState(stateObject) {
            if (this.isBatchLoading || !this.fileService.directoryHandle)
              return;

            // Prevent concurrent saves
            if (this.isSaving) {
              console.log("Save already in progress, skipping...");
              return;
            }
            
            this.isSaving = true;
            console.log("Change detected, auto-saving data...");

            buildDataIndexes();
            clearSearchCache();

            try {
              const success = await this.fileService.writeFile(stateObject);
              if (success) {
                this.lastSaveTimestamp = dayjs().valueOf();
                console.log("Auto-save successful.");
              } else {
                console.error("Auto-save failed.");
              }
            } catch (error) {
              console.error("Auto-save error:", error);
            } finally {
              this.isSaving = false;
            }
          }

          startBatchLoad() {
            this.isBatchLoading = true;
          }
          endBatchLoad() {
            this.isBatchLoading = false;
          }
        }

        // File System Services - Initialized here for use throughout the app
        const fileService = new FileSystemService({
          tabId: TAB_ID,
          errorCallback: showToast,
          sanitizeFn: sanitize,
        });
        window.stateManager = null; // Will be initialized with the StateManagementService
        let saveStatusUpdater = null;

        function updateSaveStatusDisplay() {
          const container = document.getElementById("save-status-container");
          const textEl = document.getElementById("save-status-text");
          const iconEl = document.getElementById("save-status-icon");

          if (
            !container ||
            !textEl ||
            !iconEl ||
            !window.stateManager?.lastSaveTimestamp
          )
            return;

          container.classList.remove("hidden");
          const diffSeconds = Math.round(
            (dayjs().valueOf() - window.stateManager.lastSaveTimestamp) / 1000
          );

          // Give a brief "Saved!" confirmation with a green check
          if (diffSeconds < 10) {
            iconEl.classList.add("text-green-400");
            iconEl.classList.remove("text-gray-400");
            textEl.textContent = "Saved";
            return;
          }

          // Revert to the idle state after 10 seconds
          iconEl.classList.remove("text-green-400");
          iconEl.classList.add("text-gray-400");
          if (diffSeconds < 60) {
            textEl.textContent = "Saved just now";
          } else {
            const diffMinutes = Math.round(diffSeconds / 60);
            textEl.textContent = `Saved ${diffMinutes}m ago`;
          }
        }

        function startSaveStatusInterval() {
          if (saveStatusUpdater) return; // Prevent multiple intervals
          saveStatusUpdater = setInterval(updateSaveStatusDisplay, 5000);
        }

        function startSaveStatusDisplay() {
          if (fileService.directoryHandle) {
            console.log("Save status display is active.");
            startSaveStatusInterval();
          } else {
            console.warn(
              "Cannot start save status display: No directory connected."
            );
          }
        }

        const channel = new BroadcastChannel("nightingale_suite");

        channel.addEventListener("message", (event) => {
          if (event.data.type === "show_case") {
            setTimeout(() => {
              if (window.opener) {
                // Future enhancement could involve a more robust handshake
              }
            }, 500);
          }
        });

        function updateFileSystemStatus() {
          const statusIndicator = document.getElementById(
            "fs-status-indicator"
          );
          const statusText = document.getElementById("fs-status-text");
          const folderPath = document.getElementById("fs-folder-path");
          const connectBtn = document.getElementById("connect-file-system-btn");
          const saveBtn = document.getElementById("save-to-file-system-btn");
          const loadBtn = document.getElementById("load-from-file-system-btn");

          if (!fileService.isSupported()) {
            if (statusIndicator)
              statusIndicator.className = "w-3 h-3 bg-red-500 rounded-full";
            if (statusText) statusText.textContent = "Not Supported";
            if (folderPath) {
              folderPath.textContent =
                "File System Access API not available in this browser";
              folderPath.classList.remove("hidden");
            }
            if (connectBtn) {
              connectBtn.disabled = true;
              connectBtn.textContent = "Not Supported";
              connectBtn.className = connectBtn.className.replace(
                "bg-blue-600 hover:bg-blue-700",
                "bg-gray-600"
              );
            }
            if (saveBtn) saveBtn.disabled = true;
            if (loadBtn) loadBtn.disabled = true;
            updateModalFileSystemStatus();
            return;
          }

          if (fileService.directoryHandle) {
            if (statusIndicator)
              statusIndicator.className = "w-3 h-3 bg-green-500 rounded-full";
            if (statusText) statusText.textContent = "Connected";
            if (folderPath) {
              folderPath.textContent = `Folder: ${fileService.directoryHandle.name}`;
              folderPath.classList.remove("hidden");
            }
            if (connectBtn) {
              connectBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>Change Folder`;
            }
            if (saveBtn) saveBtn.disabled = false;
            if (loadBtn) loadBtn.disabled = false;
          } else {
            if (statusIndicator)
              statusIndicator.className = "w-3 h-3 bg-gray-500 rounded-full";
            if (statusText) statusText.textContent = "Not Connected";
            if (folderPath) folderPath.classList.add("hidden");
            if (connectBtn) {
              connectBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>Select Folder`;
            }
            if (saveBtn) saveBtn.disabled = true;
            if (loadBtn) loadBtn.disabled = true;
          }
          updateModalFileSystemStatus();
        }

        async function connectFileSystem() {
          try {
            const success = await fileService.connect();
            if (success) {
              showToast(
                "Folder connected. Auto-save is now active.",
                "success"
              );
              updateFileSystemStatus();
              startSaveStatusDisplay();
              const existingData = await fileService.readFile();
              if (existingData) {
                createConfirmModal(
                  "Load Existing Data?",
                  "Found existing Nightingale data in this folder. Would you like to load it?",
                  async () => {
                    // Use the modern, safe data loading and state re-initialization process
                    const finalData = loadAndMigrateData(existingData);
                    window.stateManager = new StateManagementService(
                      finalData,
                      fileService
                    );
                    window.state = window.stateManager.state;
                    buildDataIndexes();
                    render();
                    showToast("Data loaded from directory", "success");
                  }
                );
              } else {
                // This is the fix: If no file exists, load the default empty state and render the UI.
                loadState();
                render();
                showToast(
                  "New folder connected. Ready to create data.",
                  "success"
                );
              }
            } else {
              showToast("Failed to connect to folder", "error");
            }
          } catch (error) {
            console.error("Error connecting to file system:", error);
            showToast("Error connecting to folder", "error");
          }
          updateFileSystemStatus();
        }

        // File System Save Handler
        async function saveToFileSystem() {
          if (!_ensureFileSystemConnected()) return;

          if (window.stateManager) {
            // Manually trigger a save using the raw state object
            await window.stateManager.saveState(window.rawInitialState);
            showToast("Data saved to file system", "success");
          }
        }

        async function loadFromFileSystem() {
          if (!_ensureFileSystemConnected()) return;

          try {
            const data = await fileService.readFile();
            if (data) {
              createConfirmModal(
                "Load Data from Directory?",
                "This will replace all current data with the data from the connected directory. Are you sure?",
                () => {
                  // Use the modern, safe data loading and state re-initialization process
                  const finalData = loadAndMigrateData(data);
                  window.stateManager = new StateManagementService(
                    finalData,
                    fileService
                  );
                  window.state = window.stateManager.state;
                  buildDataIndexes();
                  render();
                  showToast("Data loaded from directory", "success");
                }
              );
            } else {
              showToast("No data file found in connected folder", "warning");
            }
          } catch (error) {
            console.error("Error loading from file system:", error);
            showToast("Error loading from file system", "error");
          }
        }

        // This is the raw, un-proxied state object. We pass this to the StateManager.
        window.rawInitialState = {
          cases: [],
          people: [],
          organizations: [],
          nextCaseId: 1,
          nextPersonId: 1,
          nextOrganizationId: 1,
          nextFinancialItemId: 1,
          nextNoteId: 1,
          showAllCases: false,
          showAllContacts: false,
          showAllPeople: false,
          caseSortReversed: false,
          priorityFilterActive: false,
          accordionState: {
            simp_applicant: true,
            simp_joint: false,
            simp_spouse: true,
          },
          viewState: {
            currentTab: "dashboard",
            currentTitle: "Cases",
            currentCaseId: null,
            lastRefreshTimestamp: null,
            expandedFinancialCards: {},
          },
        };

        // Defer state manager initialization until after the user's data is loaded.
        window.stateManager = null;
        window.state = null;

        function loadAndMigrateData(data) {
          // Start with the application's default structure.
          let processedData = JSON.parse(
            JSON.stringify(window.rawInitialState)
          );
          // If data was loaded from a file, merge it in.
          if (data) {
            Object.assign(processedData, data);
          }

          // --- ALL DATA MIGRATION LOGIC NOW LIVES HERE ---

          // MIGRATE: Contacts to Organizations
          if (
            processedData.contacts &&
            (!processedData.organizations ||
              processedData.organizations.length === 0)
          ) {
            console.log("Migrating contacts to organizations...");
            processedData.organizations = processedData.contacts.map(
              (contact) => {
                const personnel = [];
                if (contact.adminName && contact.adminName !== "N/A")
                  personnel.push({
                    name: contact.adminName,
                    title: "Administrator",
                    email: contact.adminEmail || "",
                    phone: "",
                  });
                if (contact.bomName && contact.bomName !== "N/A")
                  personnel.push({
                    name: contact.bomName,
                    title: "BOM",
                    email: contact.bomEmail || "",
                    phone: "",
                  });
                return {
                  id: contact.id,
                  name: contact.facilityName,
                  type: "Nursing Facility",
                  phone: contact.phone,
                  address: { city: contact.facilityCity },
                  personnel: personnel,
                  notes: contact.altContact || "",
                };
              }
            );
            if (processedData.people) {
              processedData.people.forEach((person) => {
                if (person.facilityId) {
                  person.organizationId = person.facilityId;
                  delete person.facilityId;
                }
              });
            }
            delete processedData.contacts;
            if (processedData.nextContactId) {
              processedData.nextOrganizationId = processedData.nextContactId;
              delete processedData.nextContactId;
            }
          }

          // MIGRATE: Authorized Reps from Case to Person
          if (processedData.cases) {
            const personMap = new Map(
              (processedData.people || []).map((p) => [p.id, p])
            );
            processedData.cases.forEach((c) => {
              if (c.authorizedRepIds && c.authorizedRepIds.length > 0) {
                const person = personMap.get(c.personId);
                if (person) {
                  if (!person.authorizedRepIds) person.authorizedRepIds = [];
                  c.authorizedRepIds.forEach((repId) => {
                    if (!person.authorizedRepIds.includes(repId))
                      person.authorizedRepIds.push(repId);
                  });
                }
                delete c.authorizedRepIds;
              }
            });
          }

          // MIGRATE: Orphaned VR Requests
          if (processedData.vrRequests && processedData.cases) {
            console.log("Checking for orphaned VR requests...");
            const caseFinancialMap = new Map();
            processedData.cases.forEach((c) => {
              const financialIds = new Set(
                getFlatFinancials(c).map((f) => f.id)
              );
              if (financialIds.size > 0) {
                caseFinancialMap.set(c.id, financialIds);
              }
            });

            processedData.vrRequests.forEach((vr) => {
              if (
                !vr.caseId &&
                !vr.masterCaseNumber &&
                vr.financialItemIds &&
                vr.financialItemIds.length > 0
              ) {
                const firstItemId = vr.financialItemIds[0];
                for (const [
                  caseId,
                  financialIds,
                ] of caseFinancialMap.entries()) {
                  if (financialIds.has(firstItemId)) {
                    const foundCase = processedData.cases.find(
                      (c) => c.id === caseId
                    );
                    if (foundCase) {
                      console.log(
                        `Found parent case for orphaned VR #${vr.id}. Linking to Case #${foundCase.id}`
                      );
                      vr.caseId = foundCase.id;
                      vr.masterCaseNumber = foundCase.masterCaseNumber;
                    }
                    break;
                  }
                }
              }
            });
          }

          // Recalculate all ID counters to ensure they are correct.
          processedData.nextCaseId = getNextId(processedData.cases);
          processedData.nextPersonId = getNextId(processedData.people);
          processedData.nextOrganizationId = getNextId(
            processedData.organizations
          );
          processedData.nextFinancialItemId = getNextId(
            (processedData.cases || []).flatMap((c) => getFlatFinancials(c))
          );
          processedData.nextNoteId = getNextId(
            (processedData.cases || []).flatMap((c) => c.notes || [])
          );

          return processedData;
        }

        // =============================================================================
        // CONSTANTS & CONFIGURATION
        // =============================================================================

        const VERIFICATION_STATUS_OPTIONS = [
          "Needs VR",
          "VR Pending",
          "AVS Pending",
          "Verified",
        ];
        const VERIFICATION_STATUS_COLORS = {
          "Needs VR": "bg-red-600",
          "VR Pending": "bg-yellow-600",
          "AVS Pending": "bg-orange-500",
          Verified: "bg-green-600",
        };
        const MASTER_CASE_STATUSES = ["Active", "Pending", "Closed"];
        const MASTER_CASE_STATUS_COLORS = {
          Priority: "bg-red-500",
          Pending: "bg-yellow-500",
          Active: "bg-green-500",
          Closed: "bg-gray-500",
        };
        const NOTE_TRUNCATE_LENGTH = 80;
        const APP_VERSION_KEY = "caseManagementState_v16_vr_standalone";

        // =============================================================================
        // PERFORMANCE OPTIMIZATIONS & CACHING
        // =============================================================================
        let caseSearchService = null;
        let personSearchService = null;
        let organizationSearchService = null;
        let debounceTimer;
        function debounce(func, delay) {
          return function () {
            const context = this;
            const args = arguments;
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => func.apply(context, args), delay);
          };
        }

        const searchCache = new Map();

        function clearSearchCache() {
          searchCache.clear();
        }

        // =============================================================================
        // DATA INDEXING & MEMORY OPTIMIZATION
        // =============================================================================
        function getNewDataIndexes() {
          return {
            casesByPerson: new Map(),
            peopleByName: new Map(),
            contactsByFacility: new Map(),
            financialsByCase: new Map(),
            notesByCase: new Map(),
          };
        }
        let dataIndexes = getNewDataIndexes();

        function buildDataIndexes() {
          dataIndexes = getNewDataIndexes();
          (window.state.cases || []).forEach((c) => {
            if (!dataIndexes.casesByPerson.has(c.personId)) {
              dataIndexes.casesByPerson.set(c.personId, []);
            }
            dataIndexes.casesByPerson.get(c.personId).push(c);
            dataIndexes.financialsByCase.set(c.id, getFlatFinancials(c));
            dataIndexes.notesByCase.set(c.id, c.notes || []);
          });
          (window.state.people || []).forEach((p) => {
            const nameKey = p.name.toLowerCase();
            if (!dataIndexes.peopleByName.has(nameKey)) {
              dataIndexes.peopleByName.set(nameKey, []);
            }
            dataIndexes.peopleByName.get(nameKey).push(p);
          });
          (window.state.organizations || []).forEach((o) => {
            if (o.name) {
              dataIndexes.contactsByFacility.set(o.name.toLowerCase(), o);
            }
          });
        }

        const getIndexedCasesByPerson = (personId) =>
          dataIndexes.casesByPerson.get(personId) || [];
        const getIndexedFinancialsByCase = (caseId) =>
          dataIndexes.financialsByCase.get(caseId) || [];
        const getIndexedNotesByCase = (caseId) =>
          dataIndexes.notesByCase.get(caseId) || [];

        function analyzeDataSize() {
          const stateString = JSON.stringify(state);
          const sizeInBytes = new Blob([stateString]).size;
          const sizeInMB = (sizeInBytes / (1024 * 1024)).toFixed(2);
          const analysis = {
            totalSize: sizeInMB,
            totalCases: state.cases.length,
            totalPeople: state.people.length,
            totalContacts: state.contacts.length,
            avgCaseSize: state.cases.length
              ? (sizeInBytes / state.cases.length / 1024).toFixed(1)
              : 0,
            largestCases: state.cases
              .map((c) => ({
                id: c.id,
                name: c.name,
                size: JSON.stringify(c).length,
              }))
              .sort((a, b) => b.size - a.size)
              .slice(0, 5),
          };
          return analysis;
        }

        function suggestDataCleanup() {
          const suggestions = [];
          const sixMonthsAgo = dateUtils.monthsAgo(6);
          const oldCases = state.cases.filter((c) =>
            dateUtils.isBefore(c.createdAt, sixMonthsAgo)
          );
          if (oldCases.length > 0)
            suggestions.push(
              `Consider archiving ${oldCases.length} closed cases older than 6 months`
            );
          const casesWithManyNotes = state.cases.filter(
            (c) => (c.notes || []).length > 50
          );
          if (casesWithManyNotes.length > 0)
            suggestions.push(
              `${casesWithManyNotes.length} cases have 50+ notes - consider archiving old notes`
            );
          const facilityNames = state.contacts.map((c) =>
            c.facilityName.toLowerCase()
          );
          const duplicates = facilityNames.filter(
            (name, index) => facilityNames.indexOf(name) !== index
          );
          if (duplicates.length > 0)
            suggestions.push(
              `${duplicates.length} potential duplicate contacts found`
            );
          return suggestions;
        }

        function compressStateForStorage(stateObj) {
          const compressed = JSON.parse(JSON.stringify(stateObj));
          compressed.cases.forEach((c) => {
            delete c.personName;
            if (c.notes)
              c.notes = c.notes.filter(
                (note) => note.content && note.content.trim()
              );
            if (c.appDetails) {
              Object.keys(c.appDetails).forEach((key) => {
                if (!c.appDetails[key] || c.appDetails[key] === "")
                  delete c.appDetails[key];
              });
            }
          });
          return compressed;
        }

        function performMemoryCleanup() {
          clearSearchCache();
          if (window.gc && typeof window.gc === "function") window.gc();
          buildDataIndexes();
          console.log("Memory cleanup performed");
        }

        let memoryCleanupInterval;
        function startMemoryCleanupSchedule() {
          memoryCleanupInterval = setInterval(
            performMemoryCleanup,
            10 * 60 * 1000
          );
        }

        function stopMemoryCleanupSchedule() {
          if (memoryCleanupInterval) clearInterval(memoryCleanupInterval);
        }

        function renderOptimal(section = "all") {
          if (section === "all" || section === "cases") renderCaseList();
          if (section === "all" || section === "people") renderPersonList();
          if (section === "all" || section === "organizations")
            renderOrganizationList();
          if (section === "all" || section === "eligibility")
            renderEligibilityView();
          if (section === "all" || section === "dashboard")
            renderDashboardStats();
        }

        // =============================================================================
        // DATA ACCESS & UTILITY FUNCTIONS
        // =============================================================================

        const getCase = (id) => window.state.cases.find((c) => c.id == id);
        const getPerson = (id) => window.state.people.find((p) => p.id == id);
        const getOrganization = (id) =>
          window.state.organizations.find((o) => o.id == id);

        function extractFormData(modal, mapping) {
          const data = {};
          for (const [key, selector] of Object.entries(mapping)) {
            const element = modal.querySelector(selector);
            data[key] = element ? element.value : null;
          }
          return data;
        }

        // =============================================================================
        // DATA PERSISTENCE & STATE MANAGEMENT
        // =============================================================================
        function createOrUpdateItem(
          collection,
          payload,
          id,
          idField = "id",
          nextIdKey
        ) {
          // If this is a case operation, ensure 'lastOpened' is updated.
          if (nextIdKey === "nextCaseId") {
            payload.lastOpened = dateUtils.now();
          }

          if (id) {
            const index = collection.findIndex((item) => item[idField] == id);
            if (index > -1) {
              // Assign properties one by one to trigger the proxy's 'set' handler
              Object.keys(payload).forEach((key) => {
                collection[index][key] = payload[key];
              });
            }
          } else {
            const newId = state[nextIdKey]++;
            // Pushing to the array will trigger the proxy
            collection.push({ [idField]: newId, ...payload });
          }
        }
        // Batch Operations for Performance
        let batchMode = false;
        function startBatchUpdate() {
          batchMode = true;
        }

        function endBatchUpdate() {
          if (batchMode) {
            batchMode = false;
            buildDataIndexes(); // Rebuild indexes once after batch
            clearSearchCache(); // Clear cache once after batch
          }
        }

        // Optimized Save Functions
        // The saveStateOptimized function has been removed to prevent writing to localStorage.
        // State Loading & Data Migration
        function loadState() {
          // This function no longer reads from localStorage. It initializes a clean state.
          // The actual data loading is handled by initializeFileAccess() via the File System API.

          window.state.nextCaseId = getNextId(window.state.cases);
          window.state.nextPersonId = getNextId(window.state.people);
          window.state.nextOrganizationId = getNextId(
            window.state.organizations
          );
          window.state.nextFinancialItemId = getNextId(
            window.state.cases.flatMap((c) => getFlatFinancials(c))
          );
          window.state.nextNoteId = getNextId(
            window.state.cases.flatMap((c) => c.notes || [])
          );

          // Build performance indexes after loading
          buildDataIndexes();

          // Return the state for auto-refresh functionality
          return window.state;
        }
        // The primary saveState function is deprecated. All saves are now handled
        // automatically by the StateManagementService proxy.
        function saveState() {
          // This function is intentionally left empty.
          // It is no longer needed but might be called by older parts of the code.
          // All data mutations on the `state` object now trigger an automatic save.
        }

        function _ensureFileSystemConnected() {
          if (!fileService.directoryHandle) {
            showToast(
              "No folder connected. Please connect a folder in Settings.",
              "error"
            );
            return false;
          }
          return true;
        }

        // =============================================================================
        // AUTO-REFRESH FUNCTIONALITY WITH VIEW STATE PRESERVATION
        // =============================================================================

        // Update auto-refresh status indicator
        function updateAutoRefreshIndicator(status) {
          const indicator = document.getElementById("auto-refresh-indicator");
          const statusText = document.getElementById("auto-refresh-status");

          if (!indicator || !statusText) {
            // Create indicators if they don't exist
            const headerRight =
              document.querySelector(".header-right") ||
              document.querySelector("#app-title")?.parentElement;
            if (
              headerRight &&
              !document.getElementById("auto-refresh-indicator")
            ) {
              const indicatorHTML = `
                <div class="flex items-center space-x-2 text-sm">
                  <div id="auto-refresh-indicator" class="w-2 h-2 rounded-full bg-gray-500"></div>
                  <span id="auto-refresh-status" class="text-gray-400">Auto-refresh</span>
                </div>`;
              headerRight.insertAdjacentHTML("beforeend", indicatorHTML);
            }
            return;
          }

          // Update indicator based on status
          switch (status) {
            case "idle":
              indicator.className = "w-2 h-2 rounded-full bg-green-500";
              statusText.textContent = "Auto-refresh ready";
              statusText.className = "text-green-400";
              break;
            case "refreshing":
              indicator.className =
                "w-2 h-2 rounded-full bg-yellow-500 animate-pulse";
              statusText.textContent = "Refreshing...";
              statusText.className = "text-yellow-400";
              break;
            case "success":
              indicator.className = "w-2 h-2 rounded-full bg-blue-500";
              statusText.textContent = "Data updated";
              statusText.className = "text-blue-400";
              setTimeout(() => updateAutoRefreshIndicator("idle"), 2000);
              break;
            case "error":
              indicator.className = "w-2 h-2 rounded-full bg-red-500";
              statusText.textContent = "Refresh error";
              statusText.className = "text-red-400";
              setTimeout(() => updateAutoRefreshIndicator("idle"), 3000);
              break;
          }
        }

        // Auto-refresh when window becomes active with view state preservation
        function setupAutoRefresh() {
          let refreshTimeout = null;
          let lastRefreshTime = 0;

          // Central, debounced refresh function
          const triggerRefresh = () => {
            clearTimeout(refreshTimeout);
            refreshTimeout = setTimeout(() => {
              // Prevent running if another refresh (e.g. from storage) happened recently
              if (dayjs().valueOf() - lastRefreshTime > 1000) {
                performAutoRefresh();
              }
            }, 250); // Debounce by 250ms
          };

          function restoreViewState() {
            try {
              const viewState = state.viewState;
              if (!viewState) return false;
              if (viewState.currentCaseId && getCase(viewState.currentCaseId)) {
                renderMasterCaseView(viewState.currentCaseId);
                switchTab("master-case-view", viewState.currentTitle);
                return true;
              } else if (viewState.currentTab !== "master-case-view") {
                switchTab(viewState.currentTab, viewState.currentTitle);
                return true;
              }
              return false;
            } catch (error) {
              console.warn("Error restoring view state:", error);
              return false;
            }
          }

          function restoreViewState() {
            try {
              const savedStateJSON = localStorage.getItem(
                "nightingaleViewState"
              );
              if (!savedStateJSON) return false;

              const savedState = JSON.parse(savedStateJSON);
              if (
                savedState.currentCaseId &&
                getCase(savedState.currentCaseId)
              ) {
                renderMasterCaseView(savedState.currentCaseId);
                return true;
              } else if (savedState.currentTab) {
                switchTab(savedState.currentTab, savedState.currentTitle);
                return true;
              }
              return false;
            } catch (error) {
              console.warn("Could not restore view state:", error);
              return false;
            }
          }

          async function performAutoRefresh() {
            if (document.querySelector("#modal-layer .modal") || isRefreshing)
              return;
            isRefreshing = true;
            window.stateManager.startBatchLoad();

            try {
              const fileData = await fileService.readFile();
              if (fileData) {
                const currentStateComparable = JSON.parse(
                  JSON.stringify(window.state)
                );
                // Remove viewState for a more reliable comparison of core data
                delete currentStateComparable.viewState;
                const fileDataComparable = { ...fileData };
                delete fileDataComparable.viewState;

                if (
                  JSON.stringify(fileDataComparable) !==
                  JSON.stringify(currentStateComparable)
                ) {
                  console.log(
                    "Data change detected, performing silent refresh..."
                  );
                  const migratedData = loadAndMigrateData(fileData);

                  // Update all primary data arrays in place to respect the proxy
                  const arraysToUpdate = [
                    "cases",
                    "people",
                    "organizations",
                    "todos",
                    "vrTemplates",
                    "vrRequests",
                  ];
                  arraysToUpdate.forEach((key) => {
                    if (migratedData[key] && window.state[key]) {
                      window.state[key].length = 0;
                      Array.prototype.push.apply(
                        window.state[key],
                        migratedData[key]
                      );
                    }
                  });

                  // Update ID counters
                  Object.keys(migratedData).forEach((key) => {
                    if (key.startsWith("next")) {
                      window.state[key] = migratedData[key];
                    }
                  });

                  buildDataIndexes();
                  caseSearchService.updateCollection(window.state.cases);
                  personSearchService.updateCollection(window.state.people);
                  organizationSearchService.updateCollection(
                    window.state.organizations
                  );
                  restoreViewState();
                }
              }
            } catch (err) {
              console.error("Auto-refresh failed:", err);
              showToast("Sync Failed: Could not read data file.", "error");
            } finally {
              isRefreshing = false;
              window.stateManager.endBatchLoad();
            }
          }

          // Consolidated event listeners
          document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "visible") triggerRefresh();
          });
          window.addEventListener("focus", triggerRefresh);

          // Listen for storage events from other tabs
          window.addEventListener("storage", (e) => {
            if (e.key === "nightingale-last-save" && e.newValue) {
              try {
                const { tabId } = JSON.parse(e.newValue);
                if (tabId !== TAB_ID) {
                  console.log(
                    "Received save event from another tab. Refreshing data..."
                  );
                  // FIX: Add a small, randomized delay to prevent file lock race conditions.
                  const randomDelay = Math.random() * 200 + 100; // Delay between 100ms and 300ms
                  setTimeout(() => performAutoRefresh(), randomDelay);
                }
              } catch (err) {
                console.error("Could not parse storage event:", err);
                const randomDelay = Math.random() * 200 + 100;
                setTimeout(() => performAutoRefresh(), randomDelay); // Fallback for safety
              }
            }
          });

          updateAutoRefreshIndicator("idle");
          console.log("File-aware auto-refresh system initialized");
        }

        // Add CSS for spin animation
        if (!document.querySelector("#auto-refresh-styles")) {
          const style = document.createElement("style");
          style.id = "auto-refresh-styles";
          style.textContent = `
            @keyframes spin {
              from { transform: rotate(0deg); }
              to { transform: rotate(360deg); }
            }
          `;
          document.head.appendChild(style);
        }

        // =============================================================================
        // UI RENDERING & DISPLAY FUNCTIONS
        // =============================================================================

        // Main Rendering Functions
        function render() {
          renderOptimal();
        }

        function renderDashboardStats() {
          // Calculate statistics from current data
          const totalCases = state.cases?.length || 0;
          const activeCases =
            state.cases?.filter((c) => c.status === "Active")?.length || 0;
          const priorityCases =
            state.cases?.filter((c) => c.priority === true)?.length || 0;
          const totalPeople = state.people?.length || 0;

          // Update stat cards
          const totalCasesEl = document.getElementById("stat-total-cases");
          const activeCasesEl = document.getElementById("stat-active-cases");
          const priorityCasesEl = document.getElementById(
            "stat-priority-cases"
          );
          const totalPeopleEl = document.getElementById("stat-total-people");

          if (totalCasesEl) totalCasesEl.textContent = totalCases;
          if (activeCasesEl) activeCasesEl.textContent = activeCases;
          if (priorityCasesEl) priorityCasesEl.textContent = priorityCases;
          if (totalPeopleEl) totalPeopleEl.textContent = totalPeople;
        }

        // List Rendering Functions
        /**
         * A generic function to render a list of entities (People, Contacts) with search and display logic.
         * @param {object} config - Configuration object for the list rendering.
         * @param {string} config.entityType - The type of entity (e.g., "person", "contact").
         * @param {string} config.containerId - The ID of the list container element.
         * @param {string} config.searchId - The ID of the search input element.
         * @param {string} config.showAllStateKey - The key in the state object for the "show all" flag (e.g., "showAllPeople").
         * @param {function} config.itemRenderer - A function that takes an item and returns its HTML string.
         * @param {string} config.searchFields - A comma-separated string of fields to search on.
         * @param {string} config.sortField - The field to sort the list by.
         * @param {object} config.emptyMessages - An object with messages for different empty states.
         */
        function renderEntityList(config) {
          const container = document.getElementById(config.containerId);
          if (!container) return;

          const searchTerm = document
            .getElementById(config.searchId)
            .value.toLowerCase()
            .trim();
          let itemsToDisplay = [];
          let title = "";
          const dataKey = config.dataKey || config.entityType + "s";
          const sourceData = state[dataKey] || [];

          if (searchTerm) {
            state[config.showAllStateKey] = false;
            title = "Search Results";
            // Use the provided search service and sort the results alphabetically
            itemsToDisplay = config.searchService
              .search(searchTerm)
              .sort((a, b) =>
                (a[config.sortField] || "").localeCompare(
                  b[config.sortField] || ""
                )
              );
          } else if (state[config.showAllStateKey]) {
            title = `All ${
              config.entityType.charAt(0).toUpperCase() +
              config.entityType.slice(1)
            }s`;
            itemsToDisplay = [...sourceData].sort((a, b) =>
              a[config.sortField].localeCompare(b[config.sortField])
            );
          } else {
            title = config.emptyMessages.prompt;
          }

          let contentHTML = `<h2 class="text-xl font-bold text-blue-400 mb-3">${sanitize(
            title
          )} ${
            itemsToDisplay.length > 0 ? `(${itemsToDisplay.length})` : ""
          }</h2>`;
          if (itemsToDisplay.length > 0) {
            contentHTML += itemsToDisplay.map(config.itemRenderer).join("");
          } else {
            let emptyMessage = searchTerm
              ? config.emptyMessages.noResults
              : state[config.showAllStateKey]
              ? config.emptyMessages.noItems
              : config.emptyMessages.prompt;
            contentHTML += `<div class="text-center py-10 text-gray-500">${
              config.emptyMessages.icon
            }<p class="mt-4 text-lg">${sanitize(emptyMessage)}</p></div>`;
          }
          setSanitizedInnerHTML(container, contentHTML);
        }

        function renderCaseList() {
          const container = document.getElementById("case-list");
          if (!container) return;
          const searchTerm = document
            .getElementById("case-search")
            .value.toLowerCase()
            .trim();

          // Local helper function for name comparison to keep sort logic DRY
          const _compareCasesByName = (caseA, caseB) => {
            const personA = getPerson(caseA.personId);
            const personB = getPerson(caseB.personId);
            return (personA?.name || "").localeCompare(personB?.name || "");
          };

          const generateCaseHTML = (caseItem) => {
            const person = getPerson(caseItem.personId);
            // Do not render a case item if its person is missing
            if (!person) return "";

            const formattedName = formatPersonName(person.name);

            const statusIndicator = caseItem.status
              ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium text-white ${
                  MASTER_CASE_STATUS_COLORS[caseItem.status] || "bg-gray-500"
                }">${caseItem.status}</span>`
              : "";

            const priorityIndicator = caseItem.priority
              ? `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium text-white ${MASTER_CASE_STATUS_COLORS.Priority}">Priority</span>`
              : "";

            return `<div class="list-item bg-gray-700/80 p-4 rounded-md flex justify-between items-center" data-case-id="${
              caseItem.id
            }"><div class="flex-grow"><div class="flex items-center space-x-3"><p class="font-bold text-lg text-blue-300">${sanitize(
              formattedName
            )}</p><div class="flex items-center space-x-2">${priorityIndicator}${statusIndicator}</div></div><div class="text-sm text-gray-400 flex space-x-4 mt-1"><span>MCN: ${
              sanitize(caseItem.masterCaseNumber) || "N/A"
            }</span></div></div><div class="flex-shrink-0 flex items-center gap-2"><button title="Edit" data-case-id="${
              caseItem.id
            }" class="edit-master-case-btn text-gray-400 hover:text-white p-2 rounded-md hover:bg-gray-600"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></button><button title="Delete" data-case-id="${
              caseItem.id
            }" class="delete-master-case-btn text-gray-400 hover:text-white p-2 rounded-md hover:bg-red-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button></div></div>`;
          };

          const sortValue =
            document.getElementById("case-sort").value || "name";
          const isReversed = state.caseSortReversed;

          const sortCases = (cases) => {
            const sorted = [...cases].sort((a, b) => {
              switch (sortValue) {
                case "name":
                  return _compareCasesByName(a, b);
                case "date":
                  return dateUtils.compareDates(a.createdAt, b.createdAt);
                case "status-priority":
                  if (a.priority !== b.priority) return b.priority - a.priority;
                  if (a.status !== b.status)
                    return (a.status || "").localeCompare(b.status || "");
                  return _compareCasesByName(a, b);
                case "status-active":
                  if (a.status !== b.status)
                    return (a.status || "").localeCompare(b.status || "");
                  return _compareCasesByName(a, b);
                default:
                  return 0;
              }
            });
            if (isReversed) sorted.reverse();
            return sorted;
          };

          let casesToDisplay = [],
            title = "";
          let allCases = sortCases(state.cases);

          if (state.priorityFilterActive) {
            allCases = allCases.filter((c) => c.priority);
          }

          if (searchTerm) {
            state.showAllCases = false;
            title = "Search Results";
            // Add a searchableText property to cases for optimized searching
            const searchableCases = allCases.map((c) => {
              const person = getPerson(c.personId);
              if (!person) return { ...c, searchableText: "" };
              const formattedName = formatPersonName(person.name);
              c.searchableText = `${person.name} ${formattedName} ${
                c.masterCaseNumber || ""
              }`.toLowerCase();
              return c;
            });
            casesToDisplay = caseSearchService.search(searchTerm);
          } else if (state.showAllCases) {
            title = "All Cases";
            casesToDisplay = allCases;
          } else {
            title = "Recent Cases";
            casesToDisplay = state.cases
              .filter((c) => c.lastOpened)
              .sort((a, b) =>
                dateUtils.compareDates(b.lastOpened, a.lastOpened)
              )
              .slice(0, 3); // Decreased to 3
          }

          if (state.priorityFilterActive) title += " (Priority Only)";

          let contentHTML = `<h2 class="text-xl font-bold text-blue-400 mb-3">${title} (${casesToDisplay.length})</h2>`;
          if (casesToDisplay.length > 0) {
            contentHTML += casesToDisplay.map(generateCaseHTML).join("");
          } else {
            let emptyMessage = searchTerm
              ? "No cases match your search."
              : state.showAllCases
              ? 'No cases exist yet. Click "New Master Case" to get started.'
              : 'No recently opened cases. Use the search bar or click "Show All".';
            contentHTML += `<div class="text-center py-10 text-gray-500"><svg class="mx-auto h-12 w-12" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg><p class="mt-4 text-lg">${emptyMessage}</p></div>`;
          }
          setSanitizedInnerHTML(container, contentHTML);

          const toggleBtn = document.getElementById("case-sort-toggle");
          const priorityBtn = document.getElementById("priority-filter-toggle");
          const priorityText = document.querySelector(".priority-filter-text");

          if (toggleBtn)
            toggleBtn.classList.toggle("bg-blue-600", state.caseSortReversed);
          if (priorityBtn) {
            priorityBtn.classList.toggle(
              "bg-red-600",
              state.priorityFilterActive
            );
            priorityText.textContent = state.priorityFilterActive
              ? "Priority"
              : "All";
          }
        }

        function renderPersonList() {
          renderEntityList({
            searchService: personSearchService,
            entityType: "person",
            dataKey: "people",
            containerId: "person-list",
            searchId: "person-search",
            showAllStateKey: "showAllPeople",
            itemRenderer: (person) =>
              `<div class="list-item bg-gray-700/80 p-4 rounded-md flex justify-between items-center" data-person-id="${
                person.id
              }">
                        <div>
                            <p class="font-bold text-lg text-blue-300">${sanitize(
                              formatPersonName(person.name)
                            )}</p>
                            <p class="text-sm text-gray-400">${
                              person.isOrganization
                                ? "Organization"
                                : `${formatPhoneNumber(person.phone || "")} • ${
                                    sanitize(person.email) || "No Email"
                                  }`
                            }</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button title="Delete" data-person-id="${
                              person.id
                            }" class="delete-person-btn text-gray-400 hover:text-white p-2 rounded-md hover:bg-red-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
                        </div>
                    </div>`,
            searchFields: ["name"],
            sortField: "name",
            emptyMessages: {
              prompt: 'Search for a Person or click "Show All".',
              noResults: "No people match your search.",
              noItems: "No people added yet.",
              icon: '<svg class="mx-auto h-12 w-12" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197M15 21a6 6 0 006-6v-1a6 6 0 00-6-6h-2a6 6 0 00-6 6v1a6 6 0 006 6h2z" /></svg>',
            },
          });
        }

        function renderOrganizationList() {
          renderEntityList({
            searchService: organizationSearchService,
            entityType: "organization",
            containerId: "organization-list",
            searchId: "organization-search",
            showAllStateKey: "showAllOrganizations",
            itemRenderer: (org) => {
              const personnelInfo = (org.personnel || [])
                .map(
                  (p) => `<div>${sanitize(p.title)}: ${sanitize(p.name)}</div>`
                )
                .join("");
              return `<div class="list-item bg-gray-700/80 p-4 rounded-md flex justify-between items-start" data-organization-id="${
                org.id
              }">
                        <div class="flex-grow">
                            <p class="font-bold text-lg text-blue-300">${sanitize(
                              org.name
                            )}</p>
                            <p class="text-sm text-gray-400 font-semibold">${sanitize(
                              org.address.city
                            )}</p>
                            <p class="text-sm text-gray-400 mt-1">${formatPhoneNumber(
                              org.phone || ""
                            )}</p>
                            <div class="text-xs mt-2 space-y-1 text-gray-500">${personnelInfo}</div>
                        </div>
                        <div class="flex-shrink-0 flex items-center gap-2">
                            <button title="Delete" data-organization-id="${
                              org.id
                            }" class="delete-organization-btn text-gray-400 hover:text-white p-2 rounded-md hover:bg-red-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg></button>
                        </div>
                    </div>`;
            },
            searchFields: ["name", "address.city"],
            sortField: "name",
            emptyMessages: {
              prompt: 'Search for an Organization or click "Show All".',
              noResults: "No organizations match your search.",
              noItems: "No organizations exist yet.",
              icon: '<svg class="mx-auto h-12 w-12" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>',
            },
          });
        }

        function openAvsImportModal(masterCaseId, ownerFilter = "applicant") {
          const AVS_ACCOUNT_TYPES_KEY = "avsFormatter_accountTypes_v1";
          const DEFAULT_AVS_ACCOUNT_TYPES = [
            "Checking Account",
            "Savings Account",
            "CD",
            "Xmas Club Savings",
            "Xmas Club",
            "X-Mas Club",
            "Christmas Club",
            "Checking",
            "Savings",
          ];
          let knownAccountTypes =
            JSON.parse(localStorage.getItem(AVS_ACCOUNT_TYPES_KEY)) ||
            DEFAULT_AVS_ACCOUNT_TYPES;
          let previewItems = []; // To hold the combined parsed and match data

          const modalHTML = `
                <div class="space-y-4">
                    <div>
                        <label for="avs-data-input" class="block text-sm font-medium text-gray-400">Paste Raw AVS Data</label>
                        <textarea id="avs-data-input" rows="8" class="mt-1 w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-sm font-mono focus:ring-2 focus:ring-blue-500/50" placeholder="Paste your raw AVS data here..."></textarea>
                        <button id="parse-avs-data-btn" class="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md">Parse & Compare Data</button>
                    </div>
                    <div>
                        <h4 class="text-lg font-semibold text-blue-400 mb-2">Import Preview</h4>
                        <div id="avs-preview-container" class="space-y-2 max-h-64 overflow-y-auto p-2 bg-gray-900/50 rounded-md">
                            <p class="text-gray-500">Preview will appear here after parsing...</p>
                        </div>
                    </div>
                </div>`;

          const modal = createModal(
            "Import & Merge AVS Resources",
            modalHTML,
            () => {},
            {
              saveButtonText: "Import Selected",
              onInit: (m) =>
                (m.querySelector(".save-modal-btn").disabled = true),
            }
          );

          const parseBtn = modal.querySelector("#parse-avs-data-btn");
          const importBtn = modal.querySelector(".save-modal-btn");
          const previewContainer = modal.querySelector(
            "#avs-preview-container"
          );
          const dataInput = modal.querySelector("#avs-data-input");

          parseBtn.addEventListener("click", () => {
            const masterCase = getCase(masterCaseId);
            const existingResources = masterCase?.financials?.resources || [];
            const rawText = dataInput.value;
            const parsedAccounts = parseAvsData(rawText, knownAccountTypes);

            if (parsedAccounts.length === 0) {
              showToast(
                "Could not parse any valid accounts from the provided data.",
                "error"
              );
              previewContainer.innerHTML =
                '<p class="text-red-400">No accounts found. Please check your data.</p>';
              importBtn.disabled = true;
              return;
            }

            previewItems = parsedAccounts.map((parsed) => {
              const match = existingResources.find(
                (existing) =>
                  existing.location.toLowerCase() ===
                    parsed.location.toLowerCase() &&
                  existing.accountNumber.endsWith(parsed.accountNumber)
              );
              if (match) {
                return {
                  status: "match",
                  newData: parsed,
                  oldData: match,
                  id: match.id,
                };
              } else {
                return { status: "new", newData: parsed, id: null };
              }
            });

            previewContainer.innerHTML = previewItems
              .map((item, index) => {
                const isMatch = item.status === "match";
                const title = `${sanitize(item.newData.type)} - ${sanitize(
                  item.newData.location
                )} (${sanitize(item.newData.accountNumber)})`;
                const valueChanged =
                  isMatch &&
                  item.newData.value.toFixed(2) !==
                    item.oldData.value.toFixed(2);

                const statusBadge = isMatch
                  ? `<span class="text-xs font-semibold px-2 py-1 rounded-full bg-yellow-600 text-yellow-100">Match</span>`
                  : `<span class="text-xs font-semibold px-2 py-1 rounded-full bg-green-600 text-green-100">New</span>`;

                const valueDisplay = isMatch
                  ? `Value: <span class="${
                      valueChanged ? "text-gray-400 line-through" : ""
                    }">$${item.oldData.value.toFixed(2)}</span> ${
                      valueChanged
                        ? `<span class="font-bold text-green-400">→ $${item.newData.value.toFixed(
                            2
                          )}</span>`
                        : ""
                    }`
                  : `Value: $${item.newData.value.toFixed(2)}`;

                return `
                    <label class="flex items-start p-3 bg-gray-700/50 rounded-md hover:bg-gray-700 cursor-pointer border-l-4 ${
                      isMatch ? "border-yellow-500" : "border-green-500"
                    }">
                        <input type="checkbox" class="avs-import-checkbox h-4 w-4 rounded border-gray-500 text-blue-500 mt-1" checked data-index="${index}">
                        <div class="ml-3 text-sm flex-grow">
                            <div class="flex justify-between items-center">
                                <span class="font-medium">${title}</span>
                                ${statusBadge}
                            </div>
                            <div class="text-gray-300 mt-1">${valueDisplay}</div>
                        </div>
                    </label>`;
              })
              .join("");

            importBtn.disabled = false;
            showToast(
              `Parsed and compared ${previewItems.length} resources.`,
              "success"
            );
          });

          importBtn.onclick = () => {
            const masterCase = getCase(masterCaseId);
            if (!masterCase) return;

            const selectedCheckboxes = modal.querySelectorAll(
              ".avs-import-checkbox:checked"
            );
            let itemsAdded = 0;
            let itemsUpdated = 0;

            selectedCheckboxes.forEach((cb) => {
              const index = parseInt(cb.dataset.index, 10);
              const item = previewItems[index];

              if (item.status === "new") {
                const newItemPayload = { ...item.newData, owner: ownerFilter };
                createOrUpdateItem(
                  masterCase.financials.resources,
                  newItemPayload,
                  null,
                  "id",
                  "nextFinancialItemId"
                );
                itemsAdded++;
              } else if (item.status === "match") {
                const updatePayload = {
                  value: item.newData.value,
                  verificationStatus: item.newData.verificationStatus,
                  source: item.newData.source,
                };
                createOrUpdateItem(
                  masterCase.financials.resources,
                  updatePayload,
                  item.id,
                  "id"
                );
                itemsUpdated++;
              }
            });

            showToast(
              `${itemsAdded} new resource(s) added and ${itemsUpdated} updated.`,
              "success"
            );
            renderMasterCaseView(masterCaseId);
            closeModal(modal);
          };
        }

        function renderFinancialItemCard(item, type) {
          const statusColor =
            VERIFICATION_STATUS_COLORS[item.verificationStatus] ||
            "bg-gray-500";
          let statusText = item.verificationStatus;
          if (item.verificationStatus === "Verified" && item.source) {
            statusText += ` (${sanitize(item.source)})`;
          }

          return `
        <div class="p-2 bg-gray-900/50 rounded-md cursor-pointer edit-financial-item" data-item-id="${
          item.id
        }" data-type="${type}">
            <div class="flex justify-between items-start">
                <span class="font-semibold text-sm break-all">${sanitize(
                  item.type
                )}</span>
                <span class="text-sm font-bold text-blue-300 whitespace-nowrap">$${(
                  item.value || 0
                ).toFixed(2)}</span>
            </div>
            <p class="text-xs text-gray-400 break-all">${sanitize(
              item.location
            )} ${
            item.accountNumber
              ? `(${sanitize(item.accountNumber).slice(-4)})`
              : ""
          }</p>
            <div class="mt-1 text-right">
                <span class="inline-block text-xs font-semibold px-2 py-1 rounded-full ${statusColor} text-white">${sanitize(
            statusText
          )}</span>
            </div>
        </div>`;
        }

        function renderFinancialItemCards(items, type) {
          if (!items || items.length === 0) {
            return `<div class="text-center text-gray-500 py-3 text-sm">No ${type} added.</div>`;
          }
          return items
            .map((item) => renderFinancialItemCard(item, type))
            .join("");
        }

        function renderFinancialSimpTable(
          title,
          items,
          type,
          ownerFilter,
          masterCaseId
        ) {
          const filteredItems = items.filter(
            (item) => item.owner === ownerFilter
          );
          const total = filteredItems.reduce(
            (sum, item) => sum + (item.value || 0),
            0
          );

          const rows = renderFinancialItemCards(filteredItems, type);

          return `
              <div class="bg-gray-800 p-3 rounded-lg shadow-lg w-full md:flex-1 flex flex-col">
                  <div class="flex justify-between items-center mb-2">
                      <h3 class="text-md font-bold text-blue-400 copy-financials-header" title="Click to copy" data-type="${type}" data-owner="${ownerFilter}" data-master-case-id="${masterCaseId}">${title}</h3>
                      <div class="flex items-center space-x-2">
                        <button class="import-avs-btn bg-teal-600/80 hover:bg-teal-600 text-white font-bold py-1 px-2 rounded-md text-xs" data-type="${type}" data-owner="${ownerFilter}" title="Import AVS Data">Import</button>
                        <button class="add-financial-item-btn bg-green-600/80 hover:bg-green-600 text-white font-bold py-1 px-2 rounded-md text-xs" data-type="${type}" data-owner="${ownerFilter}">Add</button>
                      </div>
                  </div>
                  
                  <div class="flex-grow flex flex-col pr-2">
                    ${(() => {
                      const items = filteredItems;
                      const cardsHtml = renderFinancialItemCards(items, type);
                      const containerId = `collapsible-${type}-${masterCaseId}-${ownerFilter}`;
                      // Note: pr-2 has been removed from here
                      const listContainerHtml = `<div id="${containerId}" class="financial-items-container space-y-2 flex-grow">${cardsHtml}</div>`;

                      const buttonHtml =
                        items.length > 3
                          ? `
                          <div class="text-center -mt-2 toggle-container">
                            <button class="toggle-financial-list-btn" data-target="#${containerId}" title="Show More">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                          </div>
                        `
                          : "";

                      return listContainerHtml + buttonHtml;
                    })()}

                  </div>
              </div>
          `;
        }

        function renderSimpAccordionSection(
          title,
          ownerFilter,
          financials,
          masterCaseId
        ) {
          const accordionId = `simp_${ownerFilter || "all"}`;
          const isOpen = state.accordionState[accordionId];

          const resources = financials.resources || [];
          const income = financials.income || [];
          const expenses = financials.expenses || [];

          return `
            <div class="bg-gray-700 rounded-lg shadow-lg overflow-hidden">
                <div class="accordion-header flex justify-between items-center p-4 ${
                  isOpen ? "open" : ""
                }" data-accordion-id="${accordionId}">
                    <h2 class="text-xl font-bold text-blue-300">${title}</h2>
                    <svg class="accordion-icon h-6 w-6 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </div>
                <div class="accordion-content ${isOpen ? "open" : ""}">
                    <div class="p-4">
                        <div class="flex flex-col md:flex-row gap-4 items-start">
                            ${renderFinancialSimpTable(
                              "Resources",
                              resources,
                              "resources",
                              ownerFilter,
                              masterCaseId
                            )}
                            ${renderFinancialSimpTable(
                              "Income",
                              income,
                              "income",
                              ownerFilter,
                              masterCaseId
                            )}
                            ${renderFinancialSimpTable(
                              "Expenses",
                              expenses,
                              "expenses",
                              ownerFilter,
                              masterCaseId
                            )}
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function openCaseDetailsModal(masterCaseId, options = {}) {
          const caseData = getCase(masterCaseId);
          if (!caseData) return;
          const primaryPerson = getPerson(caseData.personId);
          if (!primaryPerson) return;

          // --- HTML GENERATION HELPERS FOR REORGANIZED MODAL ---
          const getDetailsTabHTML = () => {
            const spouse = primaryPerson.spouseId
              ? getPerson(primaryPerson.spouseId)
              : null;
            const organization = primaryPerson.organizationId
              ? getOrganization(primaryPerson.organizationId)
              : null;
            const reps = (primaryPerson.authorizedRepIds || [])
              .map((id) => getPerson(id))
              .filter(Boolean);

            const primaryPersonHTML = `<div class="case-info-item"><span class="case-info-label">Applicant</span><span class="case-info-value clickable-text clickable-person-name" data-person-id="${
              primaryPerson.id
            }" title="Edit Person">${sanitize(
              formatPersonName(primaryPerson.name)
            )}</span></div>`;
            const spouseHTML = spouse
              ? `<div class="case-info-item"><span class="case-info-label">Community Spouse</span><span class="case-info-value clickable-text clickable-person-name" data-person-id="${
                  spouse.id
                }" title="Edit Spouse">${sanitize(
                  formatPersonName(spouse.name)
                )}</span></div>`
              : "";
            const organizationHTML = organization
              ? `<div class="case-info-item"><span class="case-info-label">Organization</span><span class="case-info-value clickable-text clickable-organization-name" data-organization-id="${
                  organization.id
                }" title="Edit Organization">${sanitize(
                  organization.name
                )}</span></div>`
              : "";

            const repItemsHTML =
              reps.length > 0
                ? reps
                    .map(
                      (rep) => `
                <div class="bg-gray-700/50 p-3 rounded-md">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold text-sm clickable-text clickable-ar-name" data-rep-id="${
                          rep.id
                        }" title="Edit Representative">${sanitize(
                        formatPersonName(rep.name)
                      )}</span>
                        <button class="remove-ar-btn text-red-400 hover:text-red-300 p-1" data-rep-id="${
                          rep.id
                        }" title="Remove"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg></button>
                    </div>
                    ${
                      rep.phone
                        ? `<span class="text-xs text-gray-400 hover:text-blue-300 cursor-pointer copy-ar-phone" data-phone-number="${sanitize(
                            rep.phone
                          )}" title="Click to copy phone number with a 9 prefix">${formatPhoneNumber(
                            rep.phone
                          )}</span>`
                        : '<span class="text-xs text-gray-500">No phone number</span>'
                    }
                </div>
            `
                    )
                    .join("")
                : '<p class="text-gray-500 text-center text-sm py-2">No representatives assigned.</p>';

            return `<div class="p-4">
                <div class="case-info-grid">${primaryPersonHTML}${spouseHTML}${
              primaryPerson.livingArrangement === "Facility"
                ? organizationHTML
                : ""
            }</div>
                <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-700/50 mb-3"><h4 class="text-lg font-semibold text-blue-400">Authorized Reps</h4><button class="add-ar-btn bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-md text-sm">Add</button></div>
                <div class="space-y-2 overflow-y-auto pr-2">${repItemsHTML}</div>
            </div>`;
          };

          const getApplicationTabHTML = () => {
            const details = caseData.appDetails || {};
            const appDateLabel = getAppDateLabel(details.applicationType);
            return `<div class="p-4">
                <div class="case-info-grid">
                    ${createEditableFieldHTML(
                      "Application Type",
                      details.applicationType,
                      "applicationType",
                      "select"
                    )}
                    ${createEditableFieldHTML(
                      appDateLabel,
                      details.appDate,
                      "appDate",
                      "date"
                    )}
                    ${createEditableFieldHTML(
                      "Case Type",
                      details.caseType,
                      "caseType",
                      "select"
                    )}
                    ${createEditableFieldHTML(
                      "AVS Consent Date",
                      details.avsConsentDate,
                      "avsConsentDate",
                      "date"
                    )}
                    ${
                      primaryPerson.livingArrangement === "Facility"
                        ? `
                        ${createEditableFieldHTML(
                          "Admission Date",
                          details.admissionDate,
                          "admissionDate",
                          "date"
                        )}
                        ${createEditableFieldHTML(
                          "Medicare A Exp",
                          details.medicareAExpDate,
                          "medicareAExpDate",
                          "date"
                        )}
                    `
                        : ""
                    }
                </div>
            </div>`;
          };

          // --- MODAL ASSEMBLY AND EVENT HANDLING ---
          const isDetailsActive = options.activeTab !== "application";
          const modalHTML = `<div class="flex border-b border-gray-700"><button class="modal-tab-btn ${
            isDetailsActive ? "active-tab" : ""
          } px-4 py-2 text-sm" data-tab-content="details-content">Details</button><button class="modal-tab-btn ${
            !isDetailsActive ? "active-tab" : ""
          } px-4 py-2 text-sm" data-tab-content="application-content">Application</button></div><div id="details-content" class="modal-tab-content ${
            !isDetailsActive ? "hidden" : ""
          }">${getDetailsTabHTML()}</div><div id="application-content" class="modal-tab-content ${
            isDetailsActive ? "hidden" : ""
          }">${getApplicationTabHTML()}</div><style>.modal-tab-btn.active-tab{background:#374151;color:white;}.modal-tab-btn{color:#9ca3af;}</style>`;

          const modal = createModal(
            "Master Case Details",
            modalHTML,
            () => true,
            {
              saveButtonText: "Close",
            }
          );

          modal.addEventListener("click", (e) => {
            if (e.target.closest(".copy-ar-phone")) {
              const target = e.target.closest(".copy-ar-phone");
              const rawPhoneNumber = target.dataset.phoneNumber;
              const numberToCopy = `9${rawPhoneNumber}`;
              navigator.clipboard
                .writeText(numberToCopy)
                .then(() => showToast(`Copied: ${numberToCopy}`, "success"));
              return;
            }

            if (e.target.closest(".add-ar-btn")) {
              NightingaleUniversalPicker.open({
                type: "person",
                exclusions: [
                  primaryPerson.id,
                  ...(primaryPerson.authorizedRepIds || []),
                ],
                createPersonOptions: {
                  suppressCaseCreationPrompt: true,
                  addAsRepForPersonId: primaryPerson.id, // Pass the primary person's ID
                },
                onSelect: (person) => {
                  // This callback now only handles refreshing the UI, not data changes.
                  if (person) {
                    closeAllModals();
                    openCaseDetailsModal(masterCaseId);
                    showToast(
                      `${sanitize(formatPersonName(person.name))} added as Rep.`
                    );
                  }
                },
              });
              return;
            }

            if (e.target.closest(".remove-ar-btn")) {
              const repId = parseInt(
                e.target.closest(".remove-ar-btn").dataset.repId,
                10
              );
              primaryPerson.authorizedRepIds =
                primaryPerson.authorizedRepIds.filter((id) => id !== repId);
              closeAllModals();
              openCaseDetailsModal(masterCaseId);
              showToast("Authorized Rep removed.");
              return;
            }

            const editTarget = e.target.closest("[data-edit-field]");
            if (editTarget && !editTarget.querySelector("input, select")) {
              const fieldName = editTarget.dataset.editField;
              const originalValue = caseData.appDetails[fieldName] || "";
              let inputElement;
              if (fieldName === "caseType") {
                inputElement = document.createElement("select");
                inputElement.innerHTML = ["LTC", "SIMP", "Waiver"]
                  .map(
                    (o) =>
                      `<option value="${o}" ${
                        originalValue === o ? "selected" : ""
                      }>${o}</option>`
                  )
                  .join("");
              } else if (fieldName === "applicationType") {
                inputElement = document.createElement("select");
                inputElement.innerHTML = ["Application", "Renewal"]
                  .map(
                    (o) =>
                      `<option value="${o}" ${
                        originalValue === o ? "selected" : ""
                      }>${o}</option>`
                  )
                  .join("");
              } else {
                // Default to date or text input
                inputElement = document.createElement("input");
                inputElement.type = editTarget.dataset.editType;
                inputElement.value =
                  inputElement.type === "date"
                    ? toInputDateFormat(originalValue)
                    : originalValue;
              }
              inputElement.className = "w-full bg-gray-600 p-1 rounded";
              const saveEdit = () => {
                caseData.appDetails[fieldName] = inputElement.value;
                closeAllModals();
                openCaseDetailsModal(masterCaseId, {
                  activeTab: "application",
                });
              };
              inputElement.addEventListener("blur", saveEdit);
              inputElement.addEventListener("keydown", (ev) => {
                if (ev.key === "Enter") {
                  ev.preventDefault();
                  inputElement.blur();
                }
              });
              editTarget.innerHTML = "";
              editTarget.appendChild(inputElement);
              inputElement.focus();
              return;
            }

            if (e.target.classList.contains("modal-tab-btn")) {
              modal
                .querySelectorAll(".modal-tab-btn")
                .forEach((btn) => btn.classList.remove("active-tab"));
              modal
                .querySelectorAll(".modal-tab-content")
                .forEach((content) => content.classList.add("hidden"));
              e.target.classList.add("active-tab");
              modal
                .querySelector(`#${e.target.dataset.tabContent}`)
                .classList.remove("hidden");
            }

            const clickablePerson = e.target.closest(
              ".clickable-person-name, .clickable-ar-name, .clickable-organization-name"
            );
            if (clickablePerson) {
              let id, entityType;
              if (clickablePerson.dataset.personId) {
                id = clickablePerson.dataset.personId;
                entityType = "person";
              } else if (clickablePerson.dataset.repId) {
                id = clickablePerson.dataset.repId;
                entityType = "person";
              } else if (clickablePerson.dataset.organizationId) {
                id = clickablePerson.dataset.organizationId;
                entityType = "organization";
              }

              if (entityType === "person") {
                createModal(
                  "Edit Person Details",
                  getPersonFormHTML(getPerson(id)),
                  (pModal) => {
                    if (savePerson(pModal)) {
                      closeAllModals();
                      openCaseDetailsModal(masterCaseId);
                      return true;
                    }
                    return false;
                  }
                );
              } else if (entityType === "organization") {
                createModal(
                  "Edit Organization",
                  getOrganizationFormHTML(getOrganization(id)),
                  (oModal) => {
                    if (saveOrganization(oModal)) {
                      closeAllModals();
                      openCaseDetailsModal(masterCaseId);
                      return true;
                    }
                    return false;
                  }
                );
              }
            }
          });
        }

        function getNoteItemHTML(note) {
          const categoryOptions = [
            ...new Set(
              state.cases
                .flatMap((c) => c.notes || [])
                .map((note) => note.category)
                .filter(Boolean)
            ),
          ];
          const categoryDatalistHTML = categoryOptions
            .map((value) => `<option value="${sanitize(value)}"></option>`)
            .join("");

          return `
            <div class="note-item border-b border-gray-700/50 p-3 text-sm transition-all duration-300" data-note-id="${
              note.id
            }">
                <div class="note-display-view">
                    <div class="flex justify-between items-start mb-1">
                        <div class="flex items-center gap-x-2">
                            <strong class="text-blue-400">${
                              sanitize(note.category) || "General"
                            }</strong>
                            <button class="edit-note-icon-btn text-gray-500 hover:text-white" title="Edit Note">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            </button>
                            <button class="copy-note-for-mltc-btn text-gray-500 hover:text-white" title="Copy Note for MLTC">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                                </svg>
                            </button>
                        </div>
                        <span class="text-xs text-gray-500">${formatDate(
                          note.timestamp
                        )}</span>
                    </div>
                    <p class="text-gray-300 whitespace-pre-wrap break-words">${sanitize(
                      note.text || ""
                    )}</p>
                </div>
                <div class="note-edit-view space-y-3">
                    <datalist id="note-category-datalist-inline">${categoryDatalistHTML}</datalist>
                    <div>
                        <label class="block text-xs font-medium text-gray-400">Category</label>
                        <input type="text" list="note-category-datalist-inline" value="${sanitize(
                          note.category || ""
                        )}" class="note-edit-category mt-1 block w-full bg-gray-900/50 rounded-md p-2 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-400">Note</label>
                        <textarea rows="4" class="note-edit-text mt-1 block w-full bg-gray-900/50 rounded-md p-2 text-sm">${sanitize(
                          note.text || ""
                        )}</textarea>
                    </div>
                    <div class="flex justify-end gap-x-2">
                        <button class="delete-note-inline-btn text-xs bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-md">Delete</button>
                        <button class="save-note-inline-btn text-xs bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-md">Save</button>
                    </div>
                </div>
            </div>`;
        }

        function closeNotesDrawer() {
          const drawerContainer = document.getElementById(
            "notes-drawer-container"
          );
          const drawer = drawerContainer.querySelector(".notes-drawer");
          if (drawer) {
            drawer.classList.remove("open");

            // Clear content after the transition ends to prevent visual snap
            const handleTransitionEnd = () => {
              drawerContainer.innerHTML = "";
              drawer.removeEventListener("transitionend", handleTransitionEnd);
            };
            drawer.addEventListener("transitionend", handleTransitionEnd);
          }
        }

        function openNotesDrawer(masterCaseId) {
          const caseData = getCase(masterCaseId);
          if (!caseData) return;

          // If a drawer for another case is open, close it first and open the new one after a delay
          const existingDrawer = document.querySelector(".notes-drawer");
          if (
            existingDrawer &&
            existingDrawer.dataset.masterCaseId !== masterCaseId.toString()
          ) {
            closeNotesDrawer();
            setTimeout(() => openNotesDrawer(masterCaseId), 350); // Wait for close transition
            return;
          }

          const drawerContainer = document.getElementById(
            "notes-drawer-container"
          );
          const notes = (caseData.notes || []).sort((a, b) =>
            dateUtils.compareDates(b.timestamp, a.timestamp)
          );
          const noteItemsHTML =
            notes.length === 0
              ? `<p class="text-gray-500 text-center p-4">No notes for this case.</p>`
              : notes.map(getNoteItemHTML).join("");

          // Populate the container with the drawer's inner structure
          drawerContainer.innerHTML = `
                <div class="notes-drawer" data-master-case-id="${masterCaseId}">
                    <div class="p-4 bg-gray-900 flex justify-between items-center flex-shrink-0" style="min-width: 480px;">
                        <h3 class="text-xl font-bold text-blue-400">Case Notes</h3>
                        <div class="flex items-center gap-x-3">
                            <button id="add-note-btn" class="bg-green-600 hover:bg-green-700 text-white rounded-full h-8 w-8 flex items-center justify-center flex-shrink-0" title="Add New Note">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            </button>
                            <button id="close-notes-drawer-btn" class="text-gray-400 hover:text-white text-2xl leading-none">&times;</button>
                        </div>
                    </div>
                    <div class="notes-container flex-grow overflow-y-auto" style="min-width: 480px;">${noteItemsHTML}</div>
                </div>`;

          // Use a timeout to allow the element to be added to the DOM before adding the class that triggers the transition
          setTimeout(() => {
            const drawer = drawerContainer.querySelector(".notes-drawer");
            if (drawer) {
              drawer.classList.add("open");
              drawer.querySelector("#close-notes-drawer-btn").onclick =
                closeNotesDrawer;
            }
          }, 10);
        }

        function renderMasterCaseView(masterCaseId) {
          const masterCase = getCase(masterCaseId);
          if (!masterCase) {
            switchTab("case-management", "Cases");
            return;
          }

          // DEFENSIVE SAFEGUARD: Ensure the financials object and its arrays exist.
          masterCase.financials = masterCase.financials || {
            resources: [],
            income: [],
            expenses: [],
          };

          state.viewState.currentCaseId = masterCaseId;
          const viewContainer = document.getElementById("master-case-view");
          const isSimpCase = masterCase.appDetails?.caseType === "SIMP";

          const renderFinancialTable = (type, items, masterCaseId) => {
            const title = type.charAt(0).toUpperCase() + type.slice(1);
            return `<div class="bg-gray-800 p-3 rounded-lg shadow-lg flex flex-col h-full">
                        <div class="flex justify-between items-center mb-3">
                            <h3 class="text-md font-bold text-blue-400 copy-financials-header" title="Click to copy" data-type="${type}" data-owner="all" data-master-case-id="${masterCaseId}">${title}</h3>
                            <div class="flex items-center space-x-2">
                                <button class="import-avs-btn bg-teal-600/80 hover:bg-teal-600 text-white font-bold py-1 px-3 rounded-md text-sm" data-type="${type}" data-owner="all" title="Import AVS Data">Import</button>
                                <button class="add-financial-item-btn bg-green-600/80 hover:bg-green-600 text-white font-bold py-1 px-3 rounded-md text-sm" data-type="${type}">Add</button>
                            </div>
                        </div>
                        ${(() => {
                          const cardsHtml = items
                            .map((item) => renderFinancialItemCard(item, type))
                            .join("");
                          const containerId = `collapsible-${type}-${masterCaseId}-all`;
                          const cardStateId = `${masterCaseId}-${type}`;
                          const isExpanded =
                            state.viewState.expandedFinancialCards[cardStateId];

                          const listContainerHtml = `<div id="${containerId}" class="financial-items-container space-y-2 flex-grow pr-2 ${
                            isExpanded ? "expanded" : ""
                          }">${cardsHtml}</div>`;

                          const buttonHtml =
                            items.length > 3
                              ? `
                                <div class="text-center -mt-2 toggle-container">
                                    <button class="toggle-financial-list-btn" 
                                            data-target="#${containerId}" 
                                            data-card-state-id="${cardStateId}" 
                                            title="Show More">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                    </button>
                                </div>`
                              : "";

                          return listContainerHtml + buttonHtml;
                        })()}
                    </div>`;
          };

          let financialSectionHTML = "";
          if (isSimpCase) {
            financialSectionHTML = `<div class="space-y-4">${renderSimpAccordionSection(
              "Applicant Financials",
              "applicant",
              masterCase.financials,
              masterCaseId
            )}${renderSimpAccordionSection(
              "Joint Financials",
              "joint",
              masterCase.financials,
              masterCaseId
            )}${renderSimpAccordionSection(
              "Spouse Financials",
              "spouse",
              masterCase.financials,
              masterCaseId
            )}</div>`;
          } else {
            financialSectionHTML = `<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">${renderFinancialTable(
              "resources",
              masterCase.financials.resources,
              masterCaseId
            )}${renderFinancialTable(
              "income",
              masterCase.financials.income,
              masterCaseId
            )}${renderFinancialTable(
              "expenses",
              masterCase.financials.expenses,
              masterCaseId
            )}</div>`;
          }

          const person = getPerson(masterCase.personId);
          const caseName = person ? person.name : "Unknown Person";

          viewContainer.innerHTML = `<div data-master-case-id="${masterCaseId}">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <button id="back-to-cases-btn" class="text-blue-400 hover:text-blue-300 mb-4 text-sm">&larr; Back to Case List</button>
                    <h1 class="text-3xl font-bold text-blue-300 clickable-header flex items-center gap-x-2" title="View/Edit Case Details">${sanitize(
                      caseName
                    )} <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500 group-hover:text-blue-300 transition-colors" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg></h1>
                    <p class="text-gray-400 copy-mcn-header" title="Click to copy MCN">MCN: ${
                      sanitize(masterCase.masterCaseNumber) || "Not set"
                    }</p>
                    <div class="flex items-center gap-4 mt-3">
                        <div class="flex items-center gap-2"><label class="text-sm text-gray-400">Status:</label><select id="case-status-select" class="bg-gray-700 border border-gray-600 rounded-md py-1 px-2 text-sm" data-master-case-id="${masterCaseId}"><option value="">-- No Status --</option>${MASTER_CASE_STATUSES.map(
            (status) =>
              `<option value="${status}" ${
                masterCase.status === status ? "selected" : ""
              }>${status}</option>`
          ).join("")}</select></div>
                        <div class="flex items-center gap-2"><label class="text-sm text-gray-400">Priority:</label><input type="checkbox" id="case-priority-checkbox" class="h-4 w-4 rounded" data-master-case-id="${masterCaseId}" ${
            masterCase.priority ? "checked" : ""
          }></div>
                <div class="flex items-center gap-2"><label class="text-sm text-gray-400">Retro:</label><input type="checkbox" id="case-retro-checkbox" class="h-4 w-4 rounded" data-master-case-id="${masterCaseId}" ${
            masterCase.retroStatus ? "checked" : ""
          }></div>
                    </div>
                </div>
                <div class="flex items-center gap-3 self-start pt-8">
                    <button class="generate-summary-btn bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-md">Generate Summary</button>
                    <button class="open-vr-app-btn bg-orange-600 hover:bg-orange-700 text-white py-2 px-4 rounded-md">Open VR App</button>
                    <button class="view-notes-btn bg-gray-600 hover:bg-gray-500 text-white py-2 px-4 rounded-md">View Notes</button>
                </div>
            </div>
            ${financialSectionHTML}
        </div>`;
          switchTab("master-case-view", `Case: ${caseName}`);
        }

        function renderEligibilityView(masterCaseName = "") {
          const viewContainer = document.getElementById("eligibility");
          let content = masterCaseName
            ? `<h1 class="text-3xl font-bold text-blue-300 mb-6">Eligibility Results</h1><div class="bg-gray-800 p-6 rounded-lg shadow-lg"><p>Budgets for Case: <strong>${masterCaseName}</strong></p><p class="mt-6 text-gray-500">Program Cases system removed - eligibility logic simplified.</p></div>`
            : `<h1 class="text-3xl font-bold text-blue-300 mb-6">Eligibility</h1><div class="bg-gray-800 p-6 rounded-lg shadow-lg"><p class="text-gray-500">Run a budget from a Master Case to see results.</p></div>`;
          viewContainer.innerHTML = content;
        }

        // =============================================================================
        // MODAL FACTORIES & DIALOG MANAGEMENT
        // =============================================================================

        /**
         * Securely sets the inner HTML of an element using the DOMParser API to mitigate XSS risks.
         * @param {HTMLElement} element The target element to modify.
         * @param {string} htmlString The HTML string to render.
         */
        function setSanitizedInnerHTML(element, htmlString) {
          if (!element) return;
          // Use DOMParser to safely parse the string into a document fragment
          const parser = new DOMParser();
          const doc = parser.parseFromString(htmlString, "text/html");

          // Clear the existing element's content
          element.innerHTML = "";

          // Append the nodes from the parsed body. This process neutralizes executable scripts.
          Array.from(doc.body.childNodes).forEach((node) => {
            element.appendChild(node);
          });
        }

        function createConfirmModal(
          title,
          message,
          onConfirm,
          confirmText = "Confirm",
          cancelText = "Cancel"
        ) {
          const modal = createModal(
            sanitize(title),
            `<p class="text-gray-300">${sanitize(message)}</p>`,
            () => {},
            { widthClass: "w-11/12 md:w-1/3" }
          );
          MODAL_TEMPLATES.confirmation(
            modal,
            message,
            onConfirm,
            confirmText,
            cancelText
          );
        }

        // =============================================================================

        // Modal Creation & Management
        let modalCount = 0;
        function createModal(title, contentHTML, onSave, options = {}) {
          modalCount++;
          const modalId = `modal-${dayjs().valueOf()}`;
          const modalWrapper = document.createElement("div");
          modalWrapper.className = `modal fixed top-1/2 left-1/2 ${
            options.widthClass || "w-11/12 md:w-2/3 lg:w-1/2"
          } max-w-4xl bg-gray-800 rounded-lg shadow-2xl flex flex-col`;
          modalWrapper.id = modalId;
          modalWrapper.style.zIndex = 1600 + modalCount;
          const offset = (modalCount - 1) * 20;
          modalWrapper.style.transform = `translate(calc(-50% + ${offset}px), calc(-50% + ${offset}px))`;

          const leftButtons = [];
          if (options.onDelete) {
            leftButtons.push(
              `<button class="delete-in-modal-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Delete</button>`
            );
          }
          if (options.onSplit) {
            leftButtons.push(
              `<button class="split-in-modal-btn bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md">${
                options.splitButtonText || "Split"
              }</button>`
            );
          }

          const leftButtonsHTML =
            leftButtons.length > 0
              ? `<div class="mr-auto flex gap-x-2">${leftButtons.join(
                  ""
                )}</div>`
              : "";

          modalWrapper.innerHTML = `<div class="drag-handle bg-gray-900 p-3 flex justify-between items-center rounded-t-lg"><h3 class="font-bold text-lg text-blue-300">${sanitize(
            title
          )}</h3><button class="close-modal-btn text-gray-400 hover:text-white text-2xl leading-none">&times;</button></div><div class="p-6 overflow-y-auto" style="max-height: 70vh;">${contentHTML}</div><div id="modal-footer" class="bg-gray-900/50 p-3 flex items-center space-x-3 rounded-b-lg">${leftButtonsHTML}${
            !options.hideCancelButton
              ? `<button class="cancel-modal-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md">Cancel</button>`
              : ""
          }<button class="save-modal-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md">${
            options.saveButtonText || "Save"
          }</button></div>`;
          document.getElementById("modal-layer").appendChild(modalWrapper);

          const backdrop = document.getElementById("modal-backdrop");

          const modalElement = document.getElementById(modalId);
          const saveButton = modalElement.querySelector(".save-modal-btn");
          const onSaveWrapper = async () => {
            console.log("DEBUG: Step 1 - onSaveWrapper initiated for modal.");
            if (await onSave(modalElement)) {
              closeModal(modalElement);
            }
          };
          saveButton.onclick = onSaveWrapper;
          if (!options.hideCancelButton) {
            modalElement.querySelector(".cancel-modal-btn").onclick = () =>
              closeModal(modalElement);
          }
          modalElement.querySelector(".close-modal-btn").onclick = () =>
            closeModal(modalElement);

          if (options.onDelete) {
            modalElement.querySelector(".delete-in-modal-btn").onclick = () => {
              closeModal(modalElement);
              options.onDelete();
            };
          }
          if (options.onSplit) {
            modalElement.querySelector(".split-in-modal-btn").onclick = () => {
              // The onSplit function will handle its own confirmations and modal closing
              options.onSplit();
            };
          }

          makeDraggable(modalElement);
          modalElement
            .querySelector("input:not([type=hidden]), select, textarea")
            ?.focus();

          const keydownHandler = (e) => {
            if (e.key === "Enter" && e.target.tagName !== "TEXTAREA") {
              e.preventDefault();
              saveButton.click();
            } else if (e.key === "Tab") {
              const focusableElements =
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
              const focusableContent =
                modalElement.querySelectorAll(focusableElements);
              const firstFocusableElement = focusableContent[0];
              const lastFocusableElement =
                focusableContent[focusableContent.length - 1];

              if (e.shiftKey) {
                // if shift key pressed for shift + tab combination
                if (document.activeElement === firstFocusableElement) {
                  lastFocusableElement.focus(); // move focus to the last focusable element
                  e.preventDefault();
                }
              } else {
                // if tab key is pressed
                if (document.activeElement === lastFocusableElement) {
                  firstFocusableElement.focus(); // move focus to the first focusable element
                  e.preventDefault();
                }
              }
            }
          };
          modalElement.addEventListener("keydown", keydownHandler);

          modalElement._cleanupEventListeners = () => {
            modalElement.removeEventListener("keydown", keydownHandler);
            if (modalElement._cleanupDrag) {
              modalElement._cleanupDrag();
            }
          };

          // Run initialization logic if provided
          if (options.onInit) {
            options.onInit(modalElement);
          }

          return modalElement;
        }

        function closeModal(modalElement) {
          if (modalElement) {
            // Clean up event listeners before removing the element
            if (modalElement._cleanupEventListeners) {
              modalElement._cleanupEventListeners();
            }

            modalElement.remove();
            modalCount--;
            if (modalCount <= 0) {
              modalCount = 0;
              // Backdrop logic removed as it no longer exists.
            }
          }
        }
        function closeAllModals() {
          // Clean up event listeners for all modals before removing them
          const modals = document.querySelectorAll(".modal");
          modals.forEach((modal) => {
            if (modal._cleanupEventListeners) {
              modal._cleanupEventListeners();
            }
          });

          document.getElementById("modal-layer").innerHTML = "";
          modalCount = 0;
          // Backdrop logic removed as it no longer exists.
        }

        function handleDisconnectedFileSystemUI(modal) {
          const connectBtn = modal.querySelector(
            "#modal-connect-file-system-btn"
          );
          const saveBtn = modal.querySelector("#modal-save-to-file-system-btn");
          const loadBtn = modal.querySelector(
            "#modal-load-from-file-system-btn"
          );

          if (saveBtn) saveBtn.disabled = true;
          if (loadBtn) loadBtn.disabled = true;

          updateModalFileSystemStatus();
        }

        function makeDraggable(element) {
          let pos1 = 0,
            pos2 = 0,
            pos3 = 0,
            pos4 = 0;
          const header = element.querySelector(".drag-handle");

          if (header) {
            // If present, the header is where you move the DIV from:
            header.onmousedown = dragMouseDown;
          }

          function dragMouseDown(e) {
            e = e || window.event;
            e.preventDefault();
            // Get the mouse cursor position at startup:
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            // Call a function whenever the cursor moves:
            document.onmousemove = elementDrag;
          }

          function elementDrag(e) {
            e = e || window.event;
            e.preventDefault();
            // Calculate the new cursor position:
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            // Set the element's new position:
            element.style.top = element.offsetTop - pos2 + "px";
            element.style.left = element.offsetLeft - pos1 + "px";
          }

          function closeDragElement() {
            // Stop moving when mouse button is released:
            document.onmouseup = null;
            document.onmousemove = null;
          }

          // Store cleanup function on element for later removal
          element._cleanupDrag = () => {
            if (header) {
              header.onmousedown = null;
            }
            document.onmouseup = null;
            document.onmousemove = null;
          };
        }

        // =============================================================================
        // FORM VALIDATION & PROCESSING
        // =============================================================================
        function validateAndClear(modal) {
          modal.querySelectorAll(".error-message").forEach((el) => el.remove());
          modal
            .querySelectorAll(".input-error")
            .forEach((el) => el.classList.remove("input-error"));
        }
        function validateInput(modal, selector, condition, message) {
          const input = modal.querySelector(selector);
          if (condition) {
            input.classList.add("input-error");
            const errorElement = document.createElement("p");
            errorElement.className = "error-message";
            errorElement.textContent = message;
            input.parentElement.appendChild(errorElement);
            return false;
          }
          return true;
        }

        // The Validators object has been moved to nightingale.utils.js

        function getValidationRules(entityType) {
          const rules = {
            contact: {
              "#contact-facility-name": Validators.required(),
            },
            // We will add rules for 'person' and 'masterCase' here in the future.
          };
          return rules[entityType] || {};
        }

        function validateForm(modal, validationRules) {
          validateAndClear(modal);

          const errors = [];
          const sanitizedValues = {};
          let isValid = true;

          for (const [selector, validators] of Object.entries(
            validationRules
          )) {
            const input = modal.querySelector(selector);
            if (!input) continue;

            const value = input.value;
            const validatorArray = Array.isArray(validators)
              ? validators
              : [validators];

            for (const validator of validatorArray) {
              const result = validator(value);
              if (!result.isValid) {
                validateInput(modal, selector, true, result.message);
                errors.push({ selector, message: result.message });
                isValid = false;
                break;
              } else if (result.sanitizedValue !== undefined) {
                sanitizedValues[selector] = result.sanitizedValue;
              }
            }
          }

          return { isValid, errors, sanitizedValues };
        }
        // =============================================================================
        // FORM GENERATORS & INPUT HANDLING
        // =============================================================================
        function getMasterCaseFormHTML(caseData = null) {
          const personOptions = state.people
            .map(
              (p) =>
                `<option value="${p.id}" ${
                  caseData && caseData.personId == p.id ? "selected" : ""
                }>${formatPersonName(p.name)}</option>`
            )
            .join("");

          const statusOptions = MASTER_CASE_STATUSES.map(
            (status) =>
              `<option value="${status}" ${
                caseData && caseData.status === status ? "selected" : ""
              }>${status}</option>`
          ).join("");

          return `<input type="hidden" id="master-case-id" value="${
            caseData ? caseData.id : ""
          }">
            <div class="space-y-4">
                <div>
                    <label for="master-case-person" class="block text-sm font-medium text-gray-400">Assign Person</label>
                    <div class="flex items-center mt-1">
                        <select id="master-case-person" class="block w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-blue-500/50 focus:border-blue-500">
                            <option value="">-- No person assigned --</option>${personOptions}
                        </select>
                        <button type="button" id="add-person-from-case-modal-btn" class="ml-2 flex-shrink-0 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-md text-sm">Add Person</button>
                    </div>
                </div>
                <div>
                    <label for="master-case-number" class="block text-sm font-medium text-gray-400 copy-label" title="Click to copy">Master Case Number (MCN)</label>
                    <input type="text" id="master-case-number" value="${sanitize(
                      caseData?.masterCaseNumber || ""
                    )}" placeholder="e.g., 2025001" class="mt-1 block w-full bg-gray-700 p-2 rounded-md">
                </div>
                
            </div>`;
        }
        function saveMasterCase(modal) {
          const id = modal.querySelector("#master-case-id").value;
          const personId = modal.querySelector("#master-case-person").value;

          const validation = validateForm(modal, {
            "#master-case-person": Validators.required(
              "A person must be assigned to create a case."
            ),
            "#master-case-number": [
              Validators.required("MCN is required to create a case."),
              Validators.mcn(),
            ],
          });
          if (!validation.isValid) return false;

          const assignedPerson = getPerson(personId);
          if (!assignedPerson) {
            showToast("Error: Could not find the selected person.", "error");
            return false;
          }
          const name = assignedPerson.name;

          const payload = {
            masterCaseNumber: modal.querySelector("#master-case-number").value,
            personId: parseInt(personId, 10),
            ...(id
              ? {}
              : {
                  appDetails: getDefaultAppDetails(),
                  createdAt: dateUtils.now(),
                  lastOpened: null,
                  financials: { resources: [], income: [], expenses: [] },
                  notes: [],
                  authorizedRepIds: [],
                  retroStatus: false,
                }),
          };
          createOrUpdateItem(state.cases, payload, id, "id", "nextCaseId");
          saveState();
          render();
          const caseIdToView = id || state.cases[state.cases.length - 1].id;
          const isNewCase = !id;

          if (
            !document
              .getElementById("master-case-view")
              .classList.contains("hidden")
          ) {
            renderMasterCaseView(caseIdToView);
          } else if (isNewCase) {
            // Auto-open new cases after creation
            switchTab("master-case-view", `Case: ${name}`);
            renderMasterCaseView(caseIdToView);
          }

          showToast(
            `Master Case for ${name} ${
              isNewCase ? "created" : "saved"
            } successfully.`
          );
          return true;
        }
        function getAppDetailsFormHTML(caseData) {
          const details = caseData.appDetails || {};
          const caseTypeOptions = ["LTC", "SIMP", "Waiver"]
            .map(
              (o) =>
                `<option value="${o}" ${
                  details.caseType === o ? "selected" : ""
                }>${o}</option>`
            )
            .join("");
          const appTypeOptions = ["Application", "Renewal"]
            .map(
              (o) =>
                `<option value="${o}" ${
                  details.applicationType === o ? "selected" : ""
                }>${o}</option>`
            )
            .join("");
          const appDateLabel = getAppDateLabel(details.applicationType);

          return `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="app-detail-applicationType" class="block text-sm font-medium text-gray-400">Application Type</label>
                        <select id="app-detail-applicationType" class="mt-1 block w-full bg-gray-700 p-2 rounded-md">${appTypeOptions}</select>
                    </div>
                    <div>
                        <label for="app-detail-caseType" class="block text-sm font-medium text-gray-400">Case Type</label>
                        <select id="app-detail-caseType" class="mt-1 block w-full bg-gray-700 p-2 rounded-md">${caseTypeOptions}</select>
                    </div>
                    <div><label id="app-date-label" for="app-detail-appDate" class="block text-sm font-medium text-gray-400 copy-label" title="Click to copy">${appDateLabel}</label><input type="date" id="app-detail-appDate" value="${toInputDateFormat(
            details.appDate
          )}" class="mt-1 block w-full bg-gray-700 p-2 rounded-md text-gray-300"></div>
                    <div><label for="app-detail-careLevel" class="block text-sm font-medium text-gray-400 copy-label" title="Click to copy">AVS Consent Date</label><input type="date" id="app-detail-careLevel" value="${toInputDateFormat(
                      details.avsConsentDate
                    )}" placeholder="" class="mt-1 block w-full bg-gray-700 p-2 rounded-md"></div>
                    <div><label for="app-detail-admissionDate" class="block text-sm font-medium text-gray-400 copy-label" title="Click to copy">Admission Date</label><input type="date" id="app-detail-admissionDate" value="${toInputDateFormat(
                      details.admissionDate
                    )}" class="mt-1 block w-full bg-gray-700 p-2 rounded-md"></div>
                    <div><label for="app-detail-medicareAExpDate" class="block text-sm font-medium text-gray-400 copy-label" title="Click to copy">Medicare A Exp. Date</label><input type="date" id="app-detail-medicareAExpDate" value="${toInputDateFormat(
                      details.medicareAExpDate
                    )}" class="mt-1 block w-full bg-gray-700 p-2 rounded-md text-gray-300"></div>
                </div>`;
        }
        function saveAppDetails(modal, masterCaseId) {
          const masterCase = getCase(masterCaseId);
          if (!masterCase) {
            showToast("Error: Could not find case to update.", "error");
            return false;
          }
          masterCase.appDetails = {
            applicationType: modal.querySelector("#app-detail-applicationType")
              .value,
            caseType: modal.querySelector("#app-detail-caseType").value,
            appDate: modal.querySelector("#app-detail-appDate").value,
            avsConsentDate: modal.querySelector("#app-detail-careLevel").value,
            admissionDate: modal.querySelector("#app-detail-admissionDate")
              .value,
            medicareAExpDate: modal.querySelector(
              "#app-detail-medicareAExpDate"
            ).value,
          };
          saveState();
          renderMasterCaseView(masterCaseId);
          showToast("Application details updated.");
          return true;
        }
        function getPersonFormHTML(personData = null) {
          const isHome =
            personData?.livingArrangement === "Home" ||
            !personData?.livingArrangement;
          const organizationId = personData?.organizationId || "";
          const organizationName = organizationId
            ? getOrganization(organizationId)?.name || "None Selected"
            : "None Selected";
          const spouseId = personData?.spouseId || "";
          const spouseName = spouseId
            ? getPerson(spouseId)?.name || "Unknown Person"
            : "None Selected";
          const isOrg = personData?.isOrganization || false;

          return `<input type="hidden" id="person-id" value="${
            personData?.id || ""
          }">
            <input type="hidden" id="person-organization-id" value="${organizationId}">
            <input type="hidden" id="person-spouse-id" value="${spouseId}">
            <div class="space-y-4">
                 <div class="flex items-center"><input id="person-is-organization" type="checkbox" ${
                   isOrg ? "checked" : ""
                 } class="h-4 w-4 rounded border-gray-500 text-blue-500 focus:ring-blue-500/50"><label for="person-is-organization" class="ml-3 block text-sm font-medium text-gray-300">This is an Organization</label></div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label for="person-name" class="block text-sm font-medium text-gray-400 copy-label" title="Click to copy">Full Name</label><input type="text" id="person-name" value="${sanitize(
                      personData?.name || ""
                    )}" class="mt-1 block w-full bg-gray-700 p-2 rounded-md"></div>
                    <div id="person-dob-container" class="${
                      isOrg ? "hidden" : ""
                    }"><label for="person-dob" class="block text-sm font-medium text-gray-400 copy-label" title="Click to copy">Date of Birth</label><input type="date" id="person-dob" value="${toInputDateFormat(
            personData?.dob
          )}" class="mt-1 block w-full bg-gray-700 p-2 rounded-md text-gray-300"></div>
                    <div><label for="person-phone" class="block text-sm font-medium text-gray-400 copy-label" title="Click to copy">Phone Number</label><input type="tel" id="person-phone" value="${formatPhoneNumber(
                      personData?.phone || ""
                    )}" placeholder="(555) 555-5555" class="mt-1 block w-full bg-gray-700 p-2 rounded-md"></div>
                    <div><label for="person-email" class="block text-sm font-medium text-gray-400 copy-label" title="Click to copy">Email Address</label><input type="email" id="person-email" value="${sanitize(
                      personData?.email || ""
                    )}" placeholder="user@example.com" class="mt-1 block w-full bg-gray-700 p-2 rounded-md"></div>
                    <div class="md:col-span-2"><label for="person-living-arrangement" class="block text-sm font-medium text-gray-400">Living Arrangement</label><select id="person-living-arrangement" class="mt-1 block w-full bg-gray-700 p-2 rounded-md"><option value="Home" ${
                      isHome ? "selected" : ""
                    }>Home</option><option value="Facility" ${
            !isHome ? "selected" : ""
          }>Facility</option></select></div>
                </div>
                
                <div id="spouse-details-container" class="${
                  isOrg ? "hidden" : ""
                }">
                    <hr class="border-gray-600">
                    <h4 class="text-lg font-semibold text-blue-400 mt-4">Spouse Details</h4>
                    <div class="bg-gray-700/50 p-3 rounded-md flex justify-between items-center mt-2">
                        <p><strong>Current Spouse:</strong> <span id="selected-spouse-name">${sanitize(
                          spouseName
                        )}</span></p>
                        <button id="select-spouse-btn" type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-md text-sm">Change Spouse</button>
                    </div>
                </div>
                
                <div id="home-address-fields" class="${
                  isHome ? "" : "hidden"
                } space-y-4"><hr class="border-gray-600"><h4 class="text-lg font-semibold text-blue-400 mt-4">Home Address</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="md:col-span-2"><label for="address-street" class="block text-sm font-medium text-gray-400 copy-label" title="Click to copy">Street Address</label><input type="text" id="address-street" value="${sanitize(
            personData?.address || ""
          )}" class="mt-1 block w-full bg-gray-700 p-2 rounded-md"></div><div><label for="address-city" class="block text-sm font-medium text-gray-400 copy-label" title="Click to copy">City</label><input type="text" id="address-city" value="${sanitize(
            personData?.city || ""
          )}" class="mt-1 block w-full bg-gray-700 p-2 rounded-md"></div><div><label for="address-state" class="block text-sm font-medium text-gray-400 copy-label" title="Click to copy">State</label><input type="text" id="address-state" value="${sanitize(
            personData?.state || ""
          )}" class="mt-1 block w-full bg-gray-700 p-2 rounded-md"></div><div><label for="address-zip" class="block text-sm font-medium text-gray-400 copy-label" title="Click to copy">ZIP Code</label><input type="text" id="address-zip" value="${sanitize(
            personData?.zipCode || ""
          )}" class="mt-1 block w-full bg-gray-700 p-2 rounded-md"></div></div></div>
                <div id="organization-fields" class="${
                  !isHome ? "" : "hidden"
                } space-y-4"><hr class="border-gray-600"><h4 class="text-lg font-semibold text-blue-400 mt-4">Organization Details</h4><div class="bg-gray-700/50 p-3 rounded-md flex justify-between items-center"><p><strong>Selected:</strong> <span id="selected-organization-name">${sanitize(
            organizationName
          )}</span></p><button id="select-organization-btn" type="button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded-md text-sm">Select Organization</button></div></div>
            </div>`;
        }
        function savePerson(modal, options = {}) {
          const name = modal.querySelector("#person-name").value;

          const validation = validateForm(modal, {
            "#person-name": Validators.required(),
            "#person-email": Validators.email(),
            "#person-phone": Validators.phone(),
          });
          if (!validation.isValid) {
            return false;
          }

          const id = modal.querySelector("#person-id").value;
          const currentPersonId = parseInt(id) || null;
          const newSpouseId =
            parseInt(modal.querySelector("#person-spouse-id").value) || null;

          const existingPerson = currentPersonId
            ? getPerson(currentPersonId)
            : null;
          const oldSpouseId = existingPerson?.spouseId || null;

          if (newSpouseId && newSpouseId === currentPersonId) {
            validateInput(
              modal,
              "#select-spouse-btn",
              true,
              "A person cannot be married to themselves."
            );
            return false;
          }

          if (newSpouseId) {
            const proposedSpouse = getPerson(newSpouseId);
            // Guard Clause: Exit early if there is a spousal conflict.
            if (
              proposedSpouse &&
              proposedSpouse.spouseId &&
              proposedSpouse.spouseId !== currentPersonId
            ) {
              const conflictSpouseName =
                getPerson(proposedSpouse.spouseId)?.name || "Unknown Person";
              validateInput(
                modal,
                "#select-spouse-btn",
                true,
                `${proposedSpouse.name} is already married to ${conflictSpouseName}. Please resolve this conflict first.`
              );
              return false;
            }
          }
          // Use sanitized values from validation and apply proper case formatting
          const payload = {
            name: formatProperCase(validation.sanitizedValues["#person-name"]),
            authorizedRepIds: getPerson(id)?.authorizedRepIds || [], // Preserve existing ARs or initialize a new array
            dob: modal.querySelector("#person-dob").value,
            phone: validation.sanitizedValues["#person-phone"],
            email: validation.sanitizedValues["#person-email"],
            livingArrangement: modal.querySelector("#person-living-arrangement")
              .value,
            address: modal.querySelector("#address-street").value,
            city: modal.querySelector("#address-city").value,
            state: modal.querySelector("#address-state").value,
            zipCode: modal.querySelector("#address-zip").value,
            organizationId:
              parseInt(
                modal.querySelector("#person-organization-id").value,
                10
              ) || null,
            spouseId: newSpouseId,
            isOrganization: modal.querySelector("#person-is-organization")
              .checked,
          };

          // If the spouse has changed, update the previous and new spouse records.
          if (oldSpouseId !== newSpouseId) {
            // Clear the spouseId from the old spouse, if they exist.
            if (oldSpouseId) {
              const oldSpouse = getPerson(oldSpouseId);
              if (oldSpouse) oldSpouse.spouseId = null;
            }
            // Update the new spouse, clearing any previous relationships they had.
            if (newSpouseId) {
              const newSpouse = getPerson(newSpouseId);
              if (newSpouse) {
                if (
                  newSpouse.spouseId &&
                  newSpouse.spouseId !== currentPersonId
                ) {
                  const previousPartner = getPerson(newSpouse.spouseId);
                  if (previousPartner) previousPartner.spouseId = null;
                }
                newSpouse.spouseId = currentPersonId;
              }
            }
          }

          createOrUpdateItem(state.people, payload, id, "id", "nextPersonId");

          // If called from the 'Add AR' flow, link the new person immediately.
          if (options.addAsRepForPersonId && !id) {
            const primaryPerson = getPerson(options.addAsRepForPersonId);
            const newPerson = state.people[state.people.length - 1];
            if (primaryPerson && newPerson) {
              if (!primaryPerson.authorizedRepIds) {
                primaryPerson.authorizedRepIds = [];
              }
              primaryPerson.authorizedRepIds.push(newPerson.id);
            }
          }

          saveState();
          render();
          // Always refresh the person list since people can be created from any tab
          renderPersonList();

          const masterCaseView = document.querySelector(
            "#master-case-view > div[data-master-case-id]"
          );
          if (masterCaseView) {
            const caseData = getCase(masterCaseView.dataset.masterCaseId);
            if (caseData) {
              const primaryPerson = getPerson(caseData.personId);
              const isPrimary = caseData.personId == id;
              const isSpouse = primaryPerson?.spouseId == id;
              // Corrected: Check for authorized reps on the Person object, not the Case object.
              const isRep = primaryPerson?.authorizedRepIds?.includes(parseInt(id, 10));

              if (isPrimary || isRep || (caseData.appDetails?.caseType === "SIMP" && isSpouse)) {
                renderMasterCaseView(caseData.id);
              }
            }
          }

          showToast("Person details saved.");

          // Prompt to create case for new non-organization people, unless suppressed.
          const isNewPerson = !id;
          const isOrganization = payload.isOrganization;
          if (
            isNewPerson &&
            !isOrganization &&
            !options.suppressCaseCreationPrompt
          ) {
            // Close the current modal first
            closeModal(modal);

            // Show confirmation modal for case creation
            createConfirmModal(
              `Create Master Case for ${formatPersonName(payload.name)}?`,
              "This will open a new master case form with this person pre-selected.", // This message argument was missing
              () => {
                // Get the newly created person ID
                const newPersonId = state.people[state.people.length - 1].id;
                // Create and open the master case modal with this person pre-selected
                const caseModalContent = getMasterCaseFormHTML();
                const caseModal = createModal(
                  "New Master Case",
                  caseModalContent,
                  saveMasterCase,
                  {
                    widthClass: "w-11/12 md:w-1/2 lg:w-1/3",
                  }
                );
                // Pre-select the person in the dropdown
                const personSelect = caseModal.querySelector(
                  "#master-case-person"
                );
                if (personSelect) {
                  personSelect.value = newPersonId;
                }
              },
              "Yes, Create Case",
              "No Thanks"
            );
            return false; // Don't close the modal normally since we handle it manually
          }

          return true;
        }
        function getOrganizationFormHTML(orgData = null) {
          const personnel = orgData?.personnel || [
            { name: "", title: "", email: "", phone: "" },
          ];
          const personnelHTML = personnel
            .map(
              (p, index) => `
              <div class="personnel-group grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2 border-t border-gray-700 pt-3 mt-3">
                  <div><label class="text-xs text-gray-400">Personnel Name</label><input type="text" value="${sanitize(
                    p.name
                  )}" class="personnel-name w-full bg-gray-900/50 p-2 rounded-md text-sm"></div>
                  <div><label class="text-xs text-gray-400">Title</label><input type="text" value="${sanitize(
                    p.title
                  )}" class="personnel-title w-full bg-gray-900/50 p-2 rounded-md text-sm"></div>
                  <div><label class="text-xs text-gray-400">Email</label><input type="email" value="${sanitize(
                    p.email
                  )}" class="personnel-email w-full bg-gray-900/50 p-2 rounded-md text-sm"></div>
                  <div><label class="text-xs text-gray-400">Phone</label><input type="tel" value="${formatPhoneNumber(
                    p.phone
                  )}" class="personnel-phone w-full bg-gray-900/50 p-2 rounded-md text-sm"></div>
              </div>
          `
            )
            .join("");

          return `<input type="hidden" id="organization-id" value="${
            orgData?.id || ""
          }">
            <div class="space-y-4">
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div><label for="organization-name" class="block text-sm font-medium text-gray-400">Organization Name</label><input type="text" id="organization-name" value="${sanitize(
                  orgData?.name || ""
                )}" class="mt-1 block w-full bg-gray-700 p-2 rounded-md"></div>
                <div><label for="organization-type" class="block text-sm font-medium text-gray-400">Type</label><input type="text" id="organization-type" value="${sanitize(
                  orgData?.type || "Nursing Facility"
                )}" class="mt-1 block w-full bg-gray-700 p-2 rounded-md"></div>
                <div><label for="organization-city" class="block text-sm font-medium text-gray-400">City</label><input type="text" id="organization-city" value="${sanitize(
                  orgData?.address?.city || ""
                )}" class="mt-1 block w-full bg-gray-700 p-2 rounded-md"></div>
                <div><label for="organization-phone" class="block text-sm font-medium text-gray-400">Phone</label><input type="tel" id="organization-phone" value="${formatPhoneNumber(
                  orgData?.phone || ""
                )}" class="mt-1 block w-full bg-gray-700 p-2 rounded-md"></div>
              </div>
              <div><label for="organization-notes" class="block text-sm font-medium text-gray-400">Notes</label><textarea id="organization-notes" rows="2" class="mt-1 block w-full bg-gray-700 p-2 rounded-md">${sanitize(
                orgData?.notes || ""
              )}</textarea></div>
              <hr class="border-gray-600">
              <div class="flex justify-between items-center">
                  <h4 class="text-lg font-semibold text-blue-400">Key Personnel</h4>
                  <button id="add-personnel-btn" type="button" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1 px-3 rounded-md text-sm">Add Person</button>
              </div>
              <div id="personnel-container">${personnelHTML}</div>
            </div>`;
        }
        function saveOrganization(modal) {
          const id = modal.querySelector("#organization-id").value;
          const validation = validateForm(modal, {
            "#organization-name": Validators.required(),
          });
          if (!validation.isValid) return false;

          const personnel = Array.from(
            modal.querySelectorAll(".personnel-group")
          )
            .map((group) => ({
              name: group.querySelector(".personnel-name").value,
              title: group.querySelector(".personnel-title").value,
              email: group.querySelector(".personnel-email").value,
              phone: group
                .querySelector(".personnel-phone")
                .value.replace(/[^\d]/g, ""),
            }))
            .filter((p) => p.name.trim() !== "");

          const payload = {
            name: modal.querySelector("#organization-name").value,
            type: modal.querySelector("#organization-type").value,
            phone: modal
              .querySelector("#organization-phone")
              .value.replace(/[^\d]/g, ""),
            address: { city: modal.querySelector("#organization-city").value },
            notes: modal.querySelector("#organization-notes").value,
            personnel: personnel,
          };

          createOrUpdateItem(
            window.state.organizations,
            payload,
            id,
            "id",
            "nextOrganizationId"
          );
          renderOptimal("organizations");

          const masterCaseView = document.querySelector(
            "#master-case-view > div[data-master-case-id]"
          );
          if (masterCaseView)
            renderMasterCaseView(masterCaseView.dataset.masterCaseId);

          showToast("Organization saved successfully.");
          return true;
        }

        /**
         * Generates the required HTML for a text input with an autocomplete overlay.
         * @param {string} id - The base ID for the input element.
         * @param {string} label - The label text for the input.
         * @param {string} value - The initial value of the input.
         * @param {string} placeholder - The placeholder text.
         * @returns {string} The HTML string for the autocomplete input component.
         */
        function createAutocompleteInputHTML(
          id,
          label,
          value = "",
          placeholder = ""
        ) {
          return `
            <div>
              <label for="${id}" class="block text-sm font-medium text-gray-400 copy-label" title="Click to copy">${sanitize(
            label
          )}</label>
              <div class="relative mt-1">
                <div id="${id}-overlay" class="absolute inset-0 p-2 pointer-events-none text-gray-500 whitespace-pre overflow-hidden rounded-md"></div>
                <input type="text" id="${id}" value="${sanitize(
            value
          )}" placeholder="${sanitize(placeholder)}"
                  class="relative w-full bg-gray-700 autocomplete-input border border-gray-600 rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500/50 z-10">
              </div>
            </div>
          `;
        }

        // Helper to generate the HTML for a single inline-editable field
        function createEditableFieldHTML(
          label,
          value,
          fieldName,
          type = "text"
        ) {
          let displayValue = value
            ? sanitize(value)
            : '<span class="text-gray-500">Click to edit...</span>';
          if (type === "date" && value) displayValue = formatDate(value);
          return `<div class="case-info-item"><span class="case-info-label">${label}</span><span class="case-info-value clickable-text" data-edit-field="${fieldName}" data-edit-type="${type}">${displayValue}</span></div>`;
        }

        /**
         * Initializes an autocomplete feature on a text input created with createAutocompleteInputHTML.
         * This function is self-contained and manages its own state.
         * @param {string} inputId - The ID of the input element to attach autocomplete to.
         * @param {string[]} sourceData - An array of strings for autocomplete suggestions.
         */
        function setupAutocomplete(inputId, sourceData) {
          const input = document.getElementById(inputId);
          const overlay = document.getElementById(`${inputId}-overlay`);
          if (!input || !overlay) return;

          let currentSuggestion = null;

          const updateSuggestion = () => {
            const value = input.value;
            if (!value) {
              overlay.innerHTML = "";
              currentSuggestion = null;
              return;
            }

            const match = sourceData.find((item) =>
              item.toLowerCase().startsWith(value.toLowerCase())
            );

            if (match && match.toLowerCase() !== value.toLowerCase()) {
              currentSuggestion = match;
              const suggestionPart = match.substring(value.length);
              overlay.innerHTML = `${sanitize(
                value
              )}<span class="text-gray-400">${sanitize(
                suggestionPart
              )}</span><span class="tab-hint">Tab</span>`;
            } else {
              overlay.innerHTML = "";
              currentSuggestion = null;
            }
          };

          const acceptSuggestion = () => {
            if (currentSuggestion) {
              input.value = currentSuggestion;
              overlay.innerHTML = "";
              currentSuggestion = null;
              input.dispatchEvent(new Event("input", { bubbles: true }));
              return true;
            }
            return false;
          };

          input.addEventListener("input", updateSuggestion);
          input.addEventListener("focus", updateSuggestion);
          input.addEventListener("blur", () => {
            overlay.innerHTML = "";
            currentSuggestion = null;
          });

          input.addEventListener("keydown", (e) => {
            if (e.key === "Tab" && !e.shiftKey && currentSuggestion) {
              e.preventDefault();
              acceptSuggestion();
            } else if (
              e.key === "ArrowRight" &&
              input.selectionStart === input.value.length &&
              currentSuggestion
            ) {
              e.preventDefault();
              acceptSuggestion();
            }
          });
        }

        function setupFinancialItemModal(modal, itemData = null) {
          const allFinancialItems = state.cases.flatMap((c) =>
            getFlatFinancials(c)
          );
          const typeData = [
            ...new Set(allFinancialItems.map((i) => i.type).filter(Boolean)),
          ];
          const locationData = [
            ...new Set(
              allFinancialItems.map((i) => i.location).filter(Boolean)
            ),
          ];
          const sourceData = [
            ...new Set(allFinancialItems.map((i) => i.source).filter(Boolean)),
          ];

          setupAutocomplete("financial-item-type", typeData);
          setupAutocomplete("financial-item-location", locationData);

          const statusSelect = modal.querySelector("#financial-item-status");
          statusSelect.addEventListener("change", (e) => {
            const isVerified = e.target.value === "Verified";
            modal
              .querySelector("#source-field-container")
              ?.classList.toggle("hidden", !isVerified);
            if (isVerified) {
              setupAutocomplete("financial-item-source", sourceData);
            }
          });

          if (itemData?.verificationStatus === "Verified") {
            statusSelect.dispatchEvent(new Event("change"));
          }
        }

        function getFinancialItemFormHTML(
          itemData = null,
          masterCaseId = null,
          type = null
        ) {
          const masterCase = getCase(masterCaseId);
          const isSimpCase = masterCase?.appDetails?.caseType === "SIMP";
          let ownerFieldHTML = "";

          // Create context-appropriate placeholders based on financial type
          let typePlaceholder = "e.g., Checking Account";
          let locationPlaceholder = "e.g., Bank of America";

          if (type === "resources") {
            typePlaceholder =
              "e.g., Checking Account, Savings Account, Vehicle";
            locationPlaceholder = "e.g., Chase Bank, Wells Fargo";
          } else if (type === "income") {
            typePlaceholder = "e.g., Social Security, Wages, Pension";
            locationPlaceholder = "e.g., SSA, ABC Company, State Retirement";
          } else if (type === "expenses") {
            typePlaceholder = "e.g., Rent, Medicare Part B, Utilities";
            locationPlaceholder = "e.g., Landlord Name, CMS, Electric Company";
          }

          if (isSimpCase) {
            const owner = itemData?.owner || "applicant";
            ownerFieldHTML = `
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-400">Owner</label>
                    <div class="flex items-center space-x-4 mt-2">
                        <label class="flex items-center">
                            <input type="radio" name="financial-item-owner" value="applicant" ${
                              owner === "applicant" ? "checked" : ""
                            } class="h-4 w-4 text-blue-500 border-gray-500 focus:ring-blue-500/50">
                            <span class="ml-2 text-gray-300">Applicant</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="financial-item-owner" value="spouse" ${
                              owner === "spouse" ? "checked" : ""
                            } class="h-4 w-4 text-blue-500 border-gray-500 focus:ring-blue-500/50">
                            <span class="ml-2 text-gray-300">Spouse</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="financial-item-owner" value="joint" ${
                              owner === "joint" ? "checked" : ""
                            } class="h-4 w-4 text-blue-500 border-gray-500 focus:ring-blue-500/50">
                            <span class="ml-2 text-gray-300">Joint</span>
                        </label>
                    </div>
                </div>`;
          }

          return `<input type="hidden" id="financial-item-id" value="${
            itemData?.id || ""
          }"><div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            ${ownerFieldHTML}
            ${createAutocompleteInputHTML(
              "financial-item-type",
              "Type",
              itemData?.type,
              typePlaceholder
            )}
            ${createAutocompleteInputHTML(
              "financial-item-location",
              "Location / Institution",
              itemData?.location,
              locationPlaceholder
            )}
            <div><label for="financial-item-account" class="block text-sm font-medium text-gray-400 copy-label" title="Click to copy">Account Number</label><input type="text" id="financial-item-account" value="${
              itemData?.accountNumber || ""
            }" placeholder="Last 4 digits or full number" class="mt-1 block w-full bg-gray-700 rounded-md p-2"></div><div><label for="financial-item-value" class="block text-sm font-medium text-gray-400 copy-label" title="Click to copy">Value</label><input type="number" id="financial-item-value" value="${
            itemData?.value || ""
          }" placeholder="0.00" class="mt-1 block w-full bg-gray-700 rounded-md p-2"></div><div class="md:col-span-2"><label class="block text-sm font-medium text-gray-400">Verification Status</label><select id="financial-item-status" class="mt-1 block w-full bg-gray-700 rounded-md p-2">${VERIFICATION_STATUS_OPTIONS.map(
            (s) =>
              `<option value="${s}" ${
                itemData?.verificationStatus === s ? "selected" : ""
              }>${s}</option>`
          ).join(
            ""
          )}</select></div><div id="source-field-container" class="md:col-span-2 ${
            itemData?.verificationStatus === "Verified" ? "" : "hidden"
          }"><label for="financial-item-source" class="block text-sm font-medium text-gray-400 copy-label" title="Click to copy">Source</label><input type="text" id="financial-item-source" value="${
            itemData?.source || ""
          }" placeholder="e.g., Bank Statement 05/2025" class="mt-1 block w-full bg-gray-700 rounded-md p-2"></div><div class="md:col-span-2"><label for="financial-item-notes" class="block text-sm font-medium text-gray-400 copy-label" title="Click to copy">Item Notes</label><textarea id="financial-item-notes" rows="3" class="mt-1 block w-full bg-gray-700 rounded-md p-2">${sanitize(
            itemData?.notes || ""
          )}</textarea></div>${
            !itemData?.id
              ? '<div class="md:col-span-2"><label class="flex items-center"><input type="checkbox" id="add-another-financial-item" class="h-4 w-4 text-blue-500 border-gray-500 focus:ring-blue-500/50 mr-3"><span class="text-gray-300">Add another item after saving?</span></label></div>'
              : ""
          }</div>`;
        }
        async function saveFinancialItem(modal, masterCaseId, type) {
          const validation = validateForm(modal, {
            "#financial-item-type": Validators.required(
              "Item type is required."
            ),
          });

          if (!validation.isValid) return false;

          const id = modal.querySelector("#financial-item-id").value;
          const itemPayload = {
            type: validation.sanitizedValues["#financial-item-type"],
            location: modal.querySelector("#financial-item-location").value,
            accountNumber: modal.querySelector("#financial-item-account").value,
            value:
              parseFloat(modal.querySelector("#financial-item-value").value) ||
              0,
            verificationStatus: modal.querySelector("#financial-item-status")
              .value,
            source: modal.querySelector("#financial-item-source").value,
            notes: modal.querySelector("#financial-item-notes").value,
            owner:
              modal.querySelector('input[name="financial-item-owner"]:checked')
                ?.value || "applicant",
          };

          const masterCase = getCase(masterCaseId);
          if (!masterCase) {
            console.error("Could not find master case.");
            return false;
          }

          createOrUpdateItem(
            masterCase.financials[type],
            itemPayload,
            id,
            "id",
            "nextFinancialItemId"
          );

          renderMasterCaseView(masterCaseId);
          showToast("Financial item saved.");

          const addAnotherCheckbox = modal.querySelector(
            "#add-another-financial-item"
          );
          if (addAnotherCheckbox && addAnotherCheckbox.checked && !id) {
            modal.querySelector("#financial-item-type").value = "";
            modal.querySelector("#financial-item-location").value = "";
            modal.querySelector("#financial-item-account").value = "";
            modal.querySelector("#financial-item-value").value = "";
            modal.querySelector("#financial-item-status").value = "Needs VR";
            modal.querySelector("#financial-item-source").value = "";
            modal.querySelector("#financial-item-notes").value = "";
            const applicantRadio = modal.querySelector(
              'input[name="financial-item-owner"][value="applicant"]'
            );
            if (applicantRadio) applicantRadio.checked = true;
            const sourceContainer = modal.querySelector(
              "#source-field-container"
            );
            if (sourceContainer) sourceContainer.classList.add("hidden");
            modal.querySelector("#financial-item-type").focus();

            return false;
          }

          // The 200ms buffer has been removed to make the UI feel instantaneous.
          // The async auto-save will continue safely in the background.
          return true;
        }
        function getNoteFormHTML(noteData = null) {
          // Get unique categories for the new datalist implementation
          const categoryDatalistHTML = getUniqueNoteCategories(state.cases)
            .map((value) => `<option value="${sanitize(value)}"></option>`)
            .join("");

          return `<input type="hidden" id="note-id" value="${
            noteData?.id || ""
          }"><datalist id="note-category-datalist">${categoryDatalistHTML}</datalist><div class="space-y-4"><div><label for="note-category" class="block text-sm font-medium text-gray-400 copy-label" title="Click to copy">Category</label><input type="text" id="note-category" list="note-category-datalist" value="${sanitize(
            noteData?.category || ""
          )}" placeholder="e.g., Client Call, Document Received" class="mt-1 block w-full bg-gray-700 rounded-md p-2"></div><div><div class="flex justify-between items-center"><label for="note-text" class="block text-sm font-medium text-gray-400 copy-label" title="Click to copy">Note</label><button type="button" id="copy-note-text-btn" class="p-1 rounded-md text-gray-400 hover:bg-gray-600 hover:text-white" title="Copy Note for MLTC">
<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
    <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
</svg>
</button></div><textarea id="note-text" rows="5" class="mt-1 block w-full bg-gray-700 rounded-md p-2">${sanitize(
            noteData?.text || noteData?.content || ""
          )}</textarea></div></div>`;
        }
        function saveNote(noteItemElement, masterCaseId) {
          const noteIdStr = noteItemElement.dataset.noteId;
          const isTempNote = noteIdStr.startsWith("temp-");
          const noteId = isTempNote ? null : parseInt(noteIdStr);

          const text = noteItemElement.querySelector(".note-edit-text").value;
          const category = noteItemElement.querySelector(
            ".note-edit-category"
          ).value;

          if (!text || text.trim() === "") {
            showToast("Note text cannot be empty.", "error");
            if (isTempNote) {
              const masterCase = getCase(masterCaseId);
              masterCase.notes = masterCase.notes.filter(
                (n) => n.id !== noteIdStr
              );
              openNotesDrawer(masterCaseId); // Re-render to remove the empty temp note
            }
            return false;
          }

          const masterCase = getCase(masterCaseId);
          if (!masterCase) return false;

          const payload = { category: category.trim(), text: text.trim() };

          if (noteId) {
            // Editing an existing note
            const note = masterCase.notes.find((n) => n.id === noteId);
            if (note) {
              note.category = payload.category;
              note.text = payload.text;
            }
            // Silently update the UI in-place instead of re-rendering the whole drawer
            const displayCategory = noteItemElement.querySelector(
              ".note-display-view strong"
            );
            const displayText = noteItemElement.querySelector(
              ".note-display-view p"
            );
            // Use .textContent with the raw payload, as it's safer and avoids double-encoding.
            if (displayCategory)
              displayCategory.textContent = payload.category || "General";
            if (displayText) displayText.textContent = payload.text;
            noteItemElement.classList.remove("editing");
            showToast("Note updated.");
          } else {
            // Creating a new note
            // Remove the temporary note
            masterCase.notes = masterCase.notes.filter(
              (n) => n.id !== noteIdStr
            );
            // Add the real note
            payload.timestamp = dateUtils.now();
            createOrUpdateItem(
              masterCase.notes,
              payload,
              null,
              "id",
              "nextNoteId"
            );
            showToast("Note saved.");
            // Re-render the drawer ONLY when adding a new note to ensure it appears correctly
            openNotesDrawer(masterCaseId);
          }

          return true;
        }

        function getBulkCreateFormHTML() {
          return `
    <div class="space-y-4">
        <div>
            <label for="bulk-mcn-data" class="block text-sm font-medium text-gray-400">Paste Tab-Delimited Data</label>
            <p class="text-xs text-gray-500 mb-2">Paste content from a spreadsheet with 5 columns: MCN, Case Name, Status, Renewal Due, App Received.</p>
            <textarea id="bulk-mcn-data" rows="10" class="mt-1 w-full bg-gray-700 border border-gray-600 rounded-md p-3 text-sm font-mono focus:ring-2 focus:ring-blue-500/50" placeholder="12345    Doe, Jane    PE        08/15/2025"></textarea>
        </div>
    </div>`;
        }

        function getSettingsModalHTML() {
          return `
        <div class="space-y-6">
          <div class="space-y-4">
             <div class="flex items-center space-x-2 mb-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" /></svg><h3 class="text-lg font-semibold text-blue-400">Data Management</h3></div>
             <p class="text-gray-400 text-sm mb-4">Import data from JSON files. This will replace your current data.</p>
             <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
   <button id="modal-migrate-legacy-data-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200">Import .json</button>
   <button id="recover-from-logs-btn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200">Recover from Logs</button>
   <button id="bulk-create-cases-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200">Bulk Create Cases</button>
</div>
             <input type="file" id="migrate-file-input" accept=".json" style="display: none;" />
             <input type="file" id="log-recovery-input" accept=".txt" style="display: none;" multiple />
          </div>
                <p class="text-gray-400 text-sm mb-4">Connect to a folder on your computer for automatic saving and backup.</p>
                <div class="space-y-3">
                  <button id="modal-connect-file-system-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200">Select Folder</button>
                  <div class="grid grid-cols-2 gap-2">
                    <button id="modal-save-to-file-system-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Save Now</button>
                    <button id="modal-load-from-file-system-btn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>Load Data</button>
                  </div>
                </div>
              </div>
              <div class="border-t border-gray-700"></div>
              <div class="space-y-4">
                 <div class="flex items-center space-x-2 mb-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" /></svg><h3 class="text-lg font-semibold text-blue-400">Data Management</h3></div>
                 <p class="text-gray-400 text-sm mb-4">Import data from JSON files. This will replace your current data.</p>
                 <button id="modal-migrate-legacy-data-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200">Import Data</button>
                 <input type="file" id="migrate-file-input" accept=".json" style="display: none;" />
              </div>
               <div class="border-t border-gray-700"></div>
              <div class="space-y-4">
                <div class="flex items-center space-x-2 mb-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><h3 class="text-lg font-semibold text-blue-400">VR Correspondence</h3></div>
                <p class="text-gray-400 text-sm mb-4">Open the standalone VR Correspondence application.</p>
                <button id="open-vr-correspondence-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200">Open VR Correspondence App</button>
              </div>
              <div class="border-t border-gray-700"></div>
              <div class="space-y-4">
                 <div class="flex items-center space-x-2 mb-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg><h3 class="text-lg font-semibold text-blue-400">Contact Book Import</h3></div>
                 <p class="text-gray-400 text-sm mb-4">Import contacts from the tab-separated NH Contact.txt file.</p>
                 <button id="modal-import-contact-data-btn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200">Import Contact Data</button>
              </div>
            </div>
          `;
        }

        // =============================================================================
        // VR GENERATOR FORMS & TEMPLATES
        // =============================================================================

        // Update modal file system status indicators
        function updateModalFileSystemStatus() {
          const modalStatusIndicator = document.getElementById(
            "modal-fs-status-indicator"
          );
          const modalStatusText = document.getElementById(
            "modal-fs-status-text"
          );
          const modalFolderPath = document.getElementById(
            "modal-fs-folder-path"
          );
          const modalConnectBtn = document.getElementById(
            "modal-connect-file-system-btn"
          );
          const modalSaveBtn = document.getElementById(
            "modal-save-to-file-system-btn"
          );
          const modalLoadBtn = document.getElementById(
            "modal-load-from-file-system-btn"
          );

          if (!modalStatusIndicator || !modalStatusText || !modalConnectBtn)
            return;

          if (!fileService.isSupported()) {
            modalStatusIndicator.className = "w-3 h-3 bg-red-500 rounded-full";
            modalStatusText.textContent = "Not Supported";
            if (modalFolderPath) {
              modalFolderPath.textContent =
                "File System Access API not available in this browser";
              modalFolderPath.classList.remove("hidden");
            }

            modalConnectBtn.disabled = true;
            modalConnectBtn.textContent = "Not Supported";
            modalConnectBtn.className = modalConnectBtn.className.replace(
              "bg-blue-600 hover:bg-blue-700",
              "bg-gray-600"
            );

            if (modalSaveBtn) modalSaveBtn.disabled = true;
            if (modalLoadBtn) modalLoadBtn.disabled = true;

            return;
          }

          if (fileService.directoryHandle) {
            modalStatusIndicator.className =
              "w-3 h-3 bg-green-500 rounded-full";
            modalStatusText.textContent = "Connected";
            if (modalFolderPath) {
              modalFolderPath.textContent = `Folder: ${fileService.directoryHandle.name}`;
              modalFolderPath.classList.remove("hidden");
            }

            modalConnectBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>Change Folder`;

            if (modalSaveBtn) modalSaveBtn.disabled = false;
            if (modalLoadBtn) modalLoadBtn.disabled = false;
          } else {
            modalStatusIndicator.className = "w-3 h-3 bg-gray-500 rounded-full";
            modalStatusText.textContent = "Not Connected";
            if (modalFolderPath) modalFolderPath.classList.add("hidden");

            modalConnectBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>Select Folder`;

            if (modalSaveBtn) modalSaveBtn.disabled = true;
            if (modalLoadBtn) modalLoadBtn.disabled = true;
          }
        }

        // Attach event listeners for modal settings elements
        function attachModalSettingsEventListeners(modal) {
          const modalConnectBtn = modal.querySelector(
            "#modal-connect-file-system-btn"
          );
          const modalSaveBtn = modal.querySelector(
            "#modal-save-to-file-system-btn"
          );
          const modalLoadBtn = modal.querySelector(
            "#modal-load-from-file-system-btn"
          );
          const modalMigrateBtn = modal.querySelector(
            "#modal-migrate-legacy-data-btn"
          );
          const modalVrCorrespondenceBtn = modal.querySelector(
            "#open-vr-correspondence-btn"
          );
          const modalContactImportBtn = modal.querySelector(
            "#modal-import-contact-data-btn"
          );

          if (modalConnectBtn) {
            modalConnectBtn.addEventListener("click", async () => {
              await connectFileSystem();
              updateModalFileSystemStatus();
            });
          }

          if (modalSaveBtn) {
            modalSaveBtn.addEventListener("click", saveToFileSystem);
          }

          if (modalLoadBtn) {
            modalLoadBtn.addEventListener("click", loadFromFileSystem);
          }

          if (modalMigrateBtn) {
            modalMigrateBtn.addEventListener("click", () => {
              document.getElementById("migrate-file-input").click();
            });
          }

          const recoverBtn = modal.querySelector("#recover-from-logs-btn");
          const logRecoveryInput =
            document.getElementById("log-recovery-input");

          if (recoverBtn) {
            recoverBtn.addEventListener("click", () => {
              logRecoveryInput.click();
            });
          }

          if (logRecoveryInput) {
            logRecoveryInput.addEventListener("change", async (event) => {
              const files = event.target.files;
              if (!files.length) return;

              const recoveredCases = new Map();
              const recoveredPeople = new Map();

              for (const file of files) {
                const text = await file.text();
                const result = parseCaseSummaryLog(text, window.state);
                if (result) {
                  if (!recoveredCases.has(result.newCase.masterCaseNumber)) {
                    recoveredCases.set(
                      result.newCase.masterCaseNumber,
                      result.newCase
                    );
                    if (!recoveredPeople.has(result.newPerson.name)) {
                      recoveredPeople.set(
                        result.newPerson.name,
                        result.newPerson
                      );
                    }
                  }
                }
              }

              if (recoveredCases.size > 0) {
                createConfirmModal(
                  "Confirm Recovery",
                  `Found ${recoveredCases.size} unique case(s) and ${recoveredPeople.size} unique people from the logs. Do you want to add them to your data?`,
                  () => {
                    const newCasesArray = Array.from(recoveredCases.values());
                    const newPeopleArray = Array.from(recoveredPeople.values());

                    window.state.cases.push(...newCasesArray);
                    window.state.people.push(...newPeopleArray);

                    // Manually trigger a save since the state manager might not catch deep pushes like this.
                    window.stateManager.saveState(window.rawInitialState);

                    render();
                    showToast(
                      `${newCasesArray.length} case(s) recovered successfully.`,
                      "success"
                    );
                    closeAllModals();
                  }
                );
              } else {
                showToast(
                  "No valid case summaries could be parsed from the selected files.",
                  "error"
                );
              }

              // Reset the input so the user can select the same file again if needed
              event.target.value = "";
              closeModal(modal);
            });
          }

          if (modalVrCorrespondenceBtn) {
            modalVrCorrespondenceBtn.addEventListener("click", () => {
              closeModal(modal);
              window.open("NightingaleCorrespondence.html", "_blank");
            });
          }

          if (modalContactImportBtn) {
            modalContactImportBtn.addEventListener("click", () => {
              // The file input is now document-global, not modal-specific
              document.getElementById("import-contact-file-input").click();
            });
          }

          const bulkCreateCasesBtn = modal.querySelector(
            "#bulk-create-cases-btn"
          );
          if (bulkCreateCasesBtn) {
            bulkCreateCasesBtn.addEventListener("click", () => {
              closeModal(modal); // Close settings modal
              createModal(
                "Bulk Create Placeholder Cases",
                getBulkCreateFormHTML(),
                (bulkModal) => {
                  const text = bulkModal.querySelector("#bulk-mcn-data").value;
                  const lines = text
                    .split("\n")
                    .filter((line) => line.trim() !== "");
                  if (lines.length === 0) {
                    showToast("No data entered.", "error");
                    return false;
                  }

                  let createdCount = 0;
                  let skippedCount = 0;
                  const existingMCNs = new Set(
                    window.state.cases.map((c) => c.masterCaseNumber)
                  );

                  lines.forEach((line) => {
                    const cols = line.split("\t");
                    if (cols.length < 5) return;

                    const mcn = cols[0].trim().toUpperCase();
                    const name = cols[1].trim();
                    const status_code = cols[2].trim().toUpperCase();
                    const renewal_due = cols[3].trim();
                    const app_received = cols[4].trim();

                    if (!mcn || !name || existingMCNs.has(mcn)) {
                      skippedCount++;
                      return;
                    }

                    // Map status code to full status
                    let status = "Pending";
                    if (["AC", "SP"].includes(status_code)) status = "Active";
                    if (["DE", "IE"].includes(status_code)) status = "Closed";

                    // Determine application details based on dates and status
                    const appDetails = getDefaultAppDetails();
                    const renewalDate = dayjs(renewal_due, "MM/DD/YYYY");
                    if (
                      renewal_due &&
                      renewalDate.isValid() &&
                      renewalDate.year() === 2025
                    ) {
                      appDetails.applicationType = "Renewal";
                      appDetails.appDate = renewalDate.toISOString();
                    } else if (status === "Pending" && app_received) {
                      const appDate = dayjs(app_received, "MM/DD/YYYY");
                      if (appDate.isValid()) {
                        appDetails.applicationType = "Application";
                        appDetails.appDate = appDate.toISOString();
                      }
                    }

                    // 1. Create a new person
                    const personPayload = {
                      name: formatProperCase(name),
                      livingArrangement: "Home",
                    };
                    const newPersonId = window.state.nextPersonId;
                    createOrUpdateItem(
                      window.state.people,
                      personPayload,
                      null,
                      "id",
                      "nextPersonId"
                    );

                    // 2. Create a new master case and link the person
                    const casePayload = {
                      masterCaseNumber: mcn,
                      personId: newPersonId,
                      status: status,
                      appDetails: appDetails,
                      createdAt: dateUtils.now(),
                    };
                    createOrUpdateItem(
                      window.state.cases,
                      casePayload,
                      null,
                      "id",
                      "nextCaseId"
                    );

                    existingMCNs.add(mcn);
                    createdCount++;
                  });

                  showToast(
                    `${createdCount} cases created. ${skippedCount} skipped (invalid format or duplicate MCN).`,
                    "success"
                  );
                  render(); // Re-render the main UI
                  return true; // Close the modal
                },
                { saveButtonText: "Create Cases" }
              );
            });
          }
        }

        // =============================================================================

        function getVrTemplateFormHTML(templateData = null) {
          const categoryOptions = state.vrCategories
            .map(
              (cat) =>
                `<option value="${sanitize(cat)}" ${
                  templateData?.category === cat ? "selected" : ""
                }>${sanitize(cat)}</option>`
            )
            .join("");

          const placeholderHelpHTML = Object.entries(PLACEHOLDER_OPTIONS)
            .map(
              ([group, placeholders]) =>
                `<div class="mb-2"><strong class="text-blue-400">${group}:</strong><br><span class="text-sm text-gray-400">${placeholders
                  .map((p) => `{${p}}`)
                  .join(", ")}</span></div>`
            )
            .join("");

          return `
            <input type="hidden" id="vr-template-id" value="${
              templateData?.id || ""
            }">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <div class="space-y-4">
                        <div>
                            <label for="vr-template-name" class="block text-sm font-medium text-gray-400">Template Name</label>
                            <input type="text" id="vr-template-name" value="${sanitize(
                              templateData?.name || ""
                            )}" 
                                placeholder="e.g., Bank Statement Request" 
                                class="mt-1 block w-full bg-gray-700 rounded-md p-2">
                        </div>
                        <div>
                            <label for="vr-template-category" class="block text-sm font-medium text-gray-400">Category</label>
                            <select id="vr-template-category" class="mt-1 block w-full bg-gray-700 rounded-md p-2">
                                ${categoryOptions}
                            </select>
                        </div>
                        <div>
                            <label for="vr-template-content" class="block text-sm font-medium text-gray-400">Template Content</label>
                            <textarea id="vr-template-content" rows="8" 
                                placeholder="Enter your template text here. Use placeholders like {ClientName}, {ItemName}, etc."
                                class="mt-1 block w-full bg-gray-700 rounded-md p-2">${sanitize(
                                  templateData?.content || ""
                                )}</textarea>
                        </div>
                    </div>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-blue-400 mb-3">Available Placeholders</h4>
                    <div class="bg-gray-800 p-4 rounded-lg text-sm">
                        ${placeholderHelpHTML}
                    </div>
                </div>
            </div>`;
        }

        function saveVrTemplate(modal) {
          validateAndClear(modal);
          const name = modal.querySelector("#vr-template-name").value.trim();
          if (
            !validateInput(
              modal,
              "#vr-template-name",
              !name,
              "Template name is required."
            )
          )
            return false;

          const content = modal
            .querySelector("#vr-template-content")
            .value.trim();
          if (
            !validateInput(
              modal,
              "#vr-template-content",
              !content,
              "Template content is required."
            )
          )
            return false;

          const id = modal.querySelector("#vr-template-id").value;
          const payload = {
            name,
            category: modal.querySelector("#vr-template-category").value,
            content,
            placeholders: extractPlaceholders(content),
            createdAt: id ? undefined : dateUtils.now(),
          };

          createOrUpdateItem(
            state.vrTemplates,
            payload,
            id,
            "id",
            "nextVrTemplateId"
          );
          saveState();
          showToast("VR Template saved successfully.");
          return true;
        }

        function extractPlaceholders(content) {
          const matches = content.match(/\{([^}]+)\}/g);
          return matches
            ? [...new Set(matches.map((m) => m.slice(1, -1)))]
            : [];
        }

        function getVrCategoryFormHTML() {
          const categoriesHTML = state.vrCategories
            .map(
              (cat) =>
                `<div class="flex items-center justify-between p-2 bg-gray-700 rounded-md">
                <span>${cat}</span>
                <button class="delete-vr-category-btn text-red-400 hover:text-red-300" data-category="${cat}">
                    <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>`
            )
            .join("");

          return `
            <div class="space-y-4">
                <div>
                    <label for="new-vr-category" class="block text-sm font-medium text-gray-400">Add New Category</label>
                    <div class="flex mt-1 space-x-2">
                        <input type="text" id="new-vr-category" placeholder="e.g., Insurance, Legal" 
                            class="flex-1 bg-gray-700 rounded-md p-2">
                        <button id="add-vr-category-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md">Add</button>
                    </div>
                </div>
                <div>
                    <h4 class="text-sm font-medium text-gray-400 mb-2">Current Categories</h4>
                    <div class="space-y-2 max-h-64 overflow-y-auto">
                        ${categoriesHTML}
                    </div>
                </div>
            </div>`;
        }

        // =============================================================================
        // UI NAVIGATION & INTERACTION
        // =============================================================================
        window.switchTab = function (targetTabId, title) {
          document
            .querySelectorAll(".tab-content:not(.hidden) .clear-on-switch")
            .forEach((input) => {
              input.value = "";
              input.dispatchEvent(new Event("input", { bubbles: true }));
            });
          document
            .querySelectorAll(".tab-content")
            .forEach((tab) => tab.classList.add("hidden"));
          document.getElementById(targetTabId).classList.remove("hidden");
          document.querySelectorAll(".tab-button").forEach((button) => {
            const isTarget = button.dataset.tab === targetTabId;
            button.classList.toggle("bg-blue-500", isTarget);
            button.classList.toggle("text-white", isTarget);
            button.classList.toggle("bg-gray-700", !isTarget);
            button.classList.toggle("text-gray-300", !isTarget);
          });
          document.getElementById("app-title-text").textContent =
            title || "Personal Case Manager";

          // Track view state for auto-refresh preservation
          state.viewState.currentTab = targetTabId;
          state.viewState.currentTitle = title;

          if (targetTabId === "master-case-view") {
            const b = document.querySelector(
              '.tab-button[data-tab="case-management"]'
            );
            b.classList.add("bg-blue-500", "text-white");
            b.classList.remove("bg-gray-700", "text-gray-300");
          } else if (targetTabId === "case-management") {
            window.state.showAllCases = false;
            renderCaseList();
            // Clear case-specific view state when returning to case list
            window.state.viewState.currentCaseId = null;
          } else if (targetTabId === "dashboard") {
            renderDashboardStats();
          } else if (targetTabId === "organizations") {
            window.state.showAllOrganizations = false;
            renderOptimal("organizations");
          } else if (targetTabId === "person-details") {
            window.state.showAllPeople = false;
            renderOptimal("people");
          }

          saveViewStateToLocalStorage();
        };

        // =============================================================================
        // SEARCH HANDLING UTILITIES - Eliminates 40+ lines of duplicate search code
        // =============================================================================

        // Universal Search Input Handler
        function handleSearchInput(e) {
          const searchId = e.target.id;
          if (searchId === "universal-picker-search") return false;
          if (!searchId.endsWith("-search")) return false;

          const searchType = searchId.replace("-search", "");
          const clearBtn = document.getElementById(
            `clear-${searchType}-search`
          );

          if (clearBtn) {
            clearBtn.classList.toggle("hidden", e.target.value === "");
          }

          // Map search type to render target
          const renderTargetMap = {
            case: "cases",
            person: "people",
            organization: "organizations",
          };
          const renderTarget = renderTargetMap[searchType] || "people";

          debounce(() => renderOptimal(renderTarget), 300)();
          return true;
        }

        // Universal Clear Search Handler
        function handleClearSearch(searchType) {
          const searchInput = document.getElementById(`${searchType}-search`);
          if (searchInput) {
            searchInput.value = "";
            searchInput.dispatchEvent(new Event("input", { bubbles: true }));
          }
        }

        // Universal Show All Handler
        function handleShowAll(dataType) {
          const stateKey = `showAll${
            dataType.charAt(0).toUpperCase() + dataType.slice(1)
          }`;
          const searchTypeMap = {
            cases: "case",
            people: "person",
            organizations: "organization",
          };
          const searchType = searchTypeMap[dataType];

          window.state[stateKey] = true;
          document.getElementById(`${searchType}-search`).value = "";
          renderOptimal(dataType);
        }

        // =============================================================================
        // EVENT HANDLING & USER INTERACTIONS
        // =============================================================================

        // Click Event Handlers
        document.body.addEventListener("click", (e) => {
          // --- Click-to-Copy Financials Header ---
          const copyFinancialsHeader = e.target.closest(
            ".copy-financials-header"
          );
          if (copyFinancialsHeader) {
            e.preventDefault();
            const type = copyFinancialsHeader.dataset.type;
            const owner = copyFinancialsHeader.dataset.owner;
            const masterCaseId = copyFinancialsHeader.dataset.masterCaseId;

            if (type && masterCaseId) {
              const caseObject = getCase(masterCaseId);
              if (!caseObject) return;

              let itemsToCopy = caseObject.financials[type] || [];
              if (owner && owner !== "all") {
                itemsToCopy = itemsToCopy.filter(
                  (item) => item.owner === owner
                );
              }

              if (itemsToCopy.length > 0) {
                const textToCopy = itemsToCopy
                  .map((item) => {
                    let line = `- ${item.type || "N/A"}`;
                    if (item.accountNumber) line += ` (${item.accountNumber})`;
                    if (item.location) line += ` @ ${item.location}`;
                    line += ` | $${(item.value || 0).toFixed(2)}`;
                    if (item.source) line += ` (Verified: ${item.source})`;
                    return line;
                  })
                  .join("\n");

                navigator.clipboard.writeText(textToCopy).then(
                  () => {
                    const title = type.charAt(0).toUpperCase() + type.slice(1);
                    showToast(`Copied ${title}`, "success");
                  },
                  () => {
                    showToast("Failed to copy.", "error");
                  }
                );
              } else {
                showToast("No items to copy.", "warning");
              }
              return;
            }
          }

          // --- Universal Click-to-Copy on Labels ---
          const copyLabel = e.target.closest(".copy-label");
          if (copyLabel) {
            e.preventDefault();
            const inputId = copyLabel.getAttribute("for");
            if (inputId) {
              const inputElement = document.getElementById(inputId);
              const valueToCopy = inputElement ? inputElement.value : null;
              if (valueToCopy && valueToCopy.trim() !== "") {
                navigator.clipboard.writeText(valueToCopy).then(
                  () => {
                    showToast(`Copied: "${valueToCopy}"`, "success");
                  },
                  () => {
                    showToast("Failed to copy.", "error");
                  }
                );
                return; // Stop further processing for this click
              } else {
                showToast("Field is empty.", "warning");
              }
            }
          }

          // --- Modal click handling ---
          const modal = e.target.closest(".modal");
          if (modal) {
            const addPersonFromCaseBtn = e.target.closest(
              "#add-person-from-case-modal-btn"
            );
            if (addPersonFromCaseBtn) {
              const caseModal = modal;
              createModal(
                "Add New Person",
                getPersonFormHTML(),
                (personModal) => {
                  // Pass the suppress option to prevent the "Create Case?" prompt
                  const success = savePerson(personModal, {
                    suppressCaseCreationPrompt: true,
                  });
                  if (success) {
                    const newPerson = state.people[state.people.length - 1];
                    const personSelect = caseModal.querySelector(
                      "#master-case-person"
                    );
                    if (personSelect && newPerson) {
                      const newOption = new Option(
                        formatPersonName(newPerson.name),
                        newPerson.id,
                        true,
                        true
                      );
                      personSelect.add(newOption);
                    }
                  }
                  return success;
                }
              );
            }

            const selectOrganizationBtn = e.target.closest(
              "#select-organization-btn"
            );
            if (selectOrganizationBtn) {
              NightingaleUniversalPicker.open({
                type: "organization",
                onSelect: (org) => {
                  if (org) {
                    document.getElementById("person-organization-id").value =
                      org.id;
                    document.getElementById(
                      "selected-organization-name"
                    ).textContent = org.name;
                  }
                },
              });
            }
            const selectArBtn = e.target.closest(".select-ar-for-person-btn");
            if (selectArBtn && modal.onSelect) {
              const person = getPerson(selectArBtn.dataset.personId);
              modal.onSelect(person);
              closeModal(modal);
            }
            const selectSpouseBtnInPicker =
              e.target.closest(".select-spouse-btn");
            if (selectSpouseBtnInPicker && modal.onSelect) {
              const person = getPerson(
                selectSpouseBtnInPicker.dataset.personId
              );
              modal.onSelect(person);
              closeModal(modal);
            }
            const addPersonnelBtn = e.target.closest("#add-personnel-btn");
            if (addPersonnelBtn) {
              const container = modal.querySelector("#personnel-container");
              const newPersonnelHTML = `
                <div class="personnel-group grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-2 border-t border-gray-700 pt-3 mt-3">
                    <div><label class="text-xs text-gray-400">Personnel Name</label><input type="text" value="" class="personnel-name w-full bg-gray-900/50 p-2 rounded-md text-sm"></div>
                    <div><label class="text-xs text-gray-400">Title</label><input type="text" value="" class="personnel-title w-full bg-gray-900/50 p-2 rounded-md text-sm"></div>
                    <div><label class="text-xs text-gray-400">Email</label><input type="email" value="" class="personnel-email w-full bg-gray-900/50 p-2 rounded-md text-sm"></div>
                    <div><label class="text-xs text-gray-400">Phone</label><input type="tel" value="" class="personnel-phone w-full bg-gray-900/50 p-2 rounded-md text-sm"></div>
                </div>`;
              container.insertAdjacentHTML("beforeend", newPersonnelHTML);
              container.lastElementChild.querySelector("input").focus();
            }

            const selectSpouseBtnModal = e.target.closest("#select-spouse-btn");
            if (selectSpouseBtnModal) {
              const currentPersonId = modal.querySelector("#person-id").value;
              NightingaleUniversalPicker.open(
                {
                  type: "spouse",
                  exclusions: [parseInt(currentPersonId)],
                  onSelect: (selectedPerson) => {
                    modal.querySelector("#person-spouse-id").value =
                      selectedPerson ? selectedPerson.id : "";
                    modal.querySelector("#selected-spouse-name").textContent =
                      selectedPerson
                        ? formatPersonName(selectedPerson.name)
                        : "None Selected";
                  },
                },
                currentPersonId
              );
            }
            return;
          }

          // --- Main page click handling ---
          const listItem = e.target.closest(".list-item");
          const addMasterCaseBtn = e.target.closest("#add-master-case-btn");
          const addPersonBtn = e.target.closest("#add-person-btn");
          const addOrganizationBtn = e.target.closest("#add-organization-btn");
          const tabButton = e.target.closest(".tab-button");
          const exportBtn = e.target.closest("#export-data-btn");
          const importBtn = e.target.closest("#import-data-btn");
          const migrateBtn = e.target.closest("#migrate-legacy-data-btn");
          const importContactBtn = e.target.closest("#import-contact-data-btn");
          const clearCaseSearchBtn = e.target.closest("#clear-case-search");
          const clearOrganizationSearchBtn = e.target.closest(
            "#clear-organization-search"
          );
          const clearPersonSearchBtn = e.target.closest("#clear-person-search");
          const showAllCasesBtn = e.target.closest("#show-all-cases-btn");
          const showAllOrganizationsBtn = e.target.closest(
            "#show-all-organizations-btn"
          );
          const showAllPeopleBtn = e.target.closest("#show-all-people-btn");
          const caseSortToggleBtn = e.target.closest("#case-sort-toggle");
          const priorityFilterBtn = e.target.closest("#priority-filter-toggle");
          const masterCaseView = e.target.closest(
            "#master-case-view > div[data-master-case-id]"
          );
          const notesDrawer = e.target.closest(
            ".notes-drawer[data-master-case-id]"
          );
          const activeContext = masterCaseView || notesDrawer;

          if (listItem && !e.target.closest("button")) {
            if (listItem.dataset.caseId) {
              const caseToOpen = getCase(listItem.dataset.caseId);
              if (caseToOpen) {
                caseToOpen.lastOpened = dateUtils.now();
                // Auto-save will be triggered by the state change
              }
              renderMasterCaseView(listItem.dataset.caseId);
              saveViewStateToLocalStorage();
            } else if (listItem.dataset.personId) {
              createModal(
                "Edit Person Details",
                getPersonFormHTML(getPerson(listItem.dataset.personId)),
                savePerson
              );
            } else if (listItem.dataset.organizationId) {
              createModal(
                "Edit Organization",
                getOrganizationFormHTML(
                  getOrganization(listItem.dataset.organizationId)
                ),
                saveOrganization
              );
            }
          } else if (e.target.closest(".edit-master-case-btn")) {
            createModal(
              "Edit Master Case",
              getMasterCaseFormHTML(
                getCase(
                  e.target.closest(".edit-master-case-btn").dataset.caseId
                )
              ),
              saveMasterCase,
              { widthClass: "w-11/12 md:w-1/2 lg:w-1/3" }
            );
          } else if (e.target.closest(".delete-master-case-btn")) {
            const btn = e.target.closest(".delete-master-case-btn");
            createConfirmModal(
              "Delete this Master Case?",
              "This will permanently remove the case and all of its associated VRs. This cannot be undone.",
              () => {
                const caseIdToDelete = parseInt(btn.dataset.caseId, 10);
                const indexToDelete = window.state.cases.findIndex(
                  (c) => c.id === caseIdToDelete
                );

                if (indexToDelete > -1) {
                  // First, remove all VRs associated with this case
                  // Use loose equality to handle both string and number caseId values
                  window.state.vrRequests = window.state.vrRequests.filter(
                    (vr) => vr.caseId != caseIdToDelete
                  );

                  // Then, remove the case itself
                  window.state.cases.splice(indexToDelete, 1);
                  render();
                  showToast(
                    "Master Case and associated VRs deleted.",
                    "success"
                  );
                } else {
                  showToast("Could not find case to delete.", "error");
                }
              }
            );
          } else if (e.target.closest(".delete-person-btn")) {
            const btn = e.target.closest(".delete-person-btn");
            const personId = parseInt(btn.dataset.personId);
            if (
              window.state.cases.some(
                (c) =>
                  c.personId === personId ||
                  (c.authorizedRepIds && c.authorizedRepIds.includes(personId))
              )
            ) {
              createAlertModal(
                "Cannot Delete Person",
                "This person is assigned to one or more cases."
              );
            } else {
              createConfirmModal(
                "Delete this person?",
                "This action cannot be undone.",
                () => {
                  const personToDelete = getPerson(personId);
                  if (personToDelete?.spouseId) {
                    const spouse = getPerson(personToDelete.spouseId);
                    if (spouse) spouse.spouseId = null;
                  }
                  window.state.people = window.state.people.filter(
                    (p) => p.id !== personId
                  );
                  render();
                  showToast("Person deleted.", "success");
                }
              );
            }
          } else if (e.target.closest(".delete-organization-btn")) {
            const btn = e.target.closest(".delete-organization-btn");
            createConfirmModal(
              "Delete this organization?",
              "This action cannot be undone.",
              () => {
                window.state.organizations = window.state.organizations.filter(
                  (o) => o.id != btn.dataset.organizationId
                );
                renderOptimal("organizations");
                showToast("Organization deleted.", "success");
              }
            );
          } else if (addMasterCaseBtn)
            createModal(
              "New Master Case",
              getMasterCaseFormHTML(),
              saveMasterCase,
              {
                widthClass: "w-11/12 md:w-1/2 lg:w-1/3",
              }
            );
          else if (addPersonBtn)
            createModal("Add New Person", getPersonFormHTML(), savePerson);
          else if (addOrganizationBtn)
            createModal(
              "Add New Organization",
              getOrganizationFormHTML(),
              saveOrganization
            );
          // Handle clear search buttons using universal handler
          else if (clearCaseSearchBtn) {
            handleClearSearch("case");
          } else if (clearOrganizationSearchBtn) {
            handleClearSearch("organization");
          } else if (clearPersonSearchBtn) {
            handleClearSearch("person");
            // Handle show all buttons using universal handler
          } else if (showAllCasesBtn) {
            handleShowAll("cases");
          } else if (showAllOrganizationsBtn) {
            handleShowAll("organizations");
          } else if (showAllPeopleBtn) {
            handleShowAll("people");
          } else if (caseSortToggleBtn) {
            state.caseSortReversed = !state.caseSortReversed;
            saveState();
            renderOptimal("cases");
          } else if (priorityFilterBtn) {
            state.priorityFilterActive = !state.priorityFilterActive;
            saveState();
            renderOptimal("cases");
          } else if (activeContext)
            handleMasterCaseViewClicks(e, activeContext.dataset.masterCaseId);
          else if (tabButton)
            switchTab(tabButton.dataset.tab, tabButton.dataset.title);
          else if (exportBtn) exportData();
          else if (importBtn) createImportConfirmationModal();
          else if (migrateBtn)
            document.getElementById("migrate-file-input").click();
          else if (importContactBtn)
            document.getElementById("import-contact-file-input").click();
        });

        function handleMasterCaseViewClicks(e, masterCaseId) {
          // New Handlers for Refactored UI
          const caseHeader = e.target.closest(".clickable-header");
          const viewNotesBtn = e.target.closest(".view-notes-btn");
          if (caseHeader) {
            openCaseDetailsModal(masterCaseId);
            return;
          }
          if (viewNotesBtn) {
            const openDrawer = document.querySelector(".notes-drawer.open");
            // If a drawer is open for the current case, close it. Otherwise, open it.
            if (
              openDrawer &&
              openDrawer.dataset.masterCaseId === masterCaseId
            ) {
              closeNotesDrawer();
            } else {
              openNotesDrawer(masterCaseId);
            }
            return;
          }

          // Handlers for Modals and Drawers
          const addNoteBtn = e.target.closest("#add-note-btn");
          const editNoteIconBtn = e.target.closest(".edit-note-icon-btn");
          const saveNoteInlineBtn = e.target.closest(".save-note-inline-btn");
          const deleteNoteInlineBtn = e.target.closest(
            ".delete-note-inline-btn"
          );
          const addArBtn = e.target.closest(".add-ar-btn");
          const removeArBtn = e.target.closest(".remove-ar-btn");
          const clickablePersonName = e.target.closest(
            ".clickable-person-name"
          );
          const clickableFacilityName = e.target.closest(
            ".clickable-facility-name"
          );
          const clickableArName = e.target.closest(".clickable-ar-name");

          if (addNoteBtn) {
            const drawer = document.querySelector(".notes-drawer");
            const notesContainer = drawer?.querySelector(".notes-container");
            if (!drawer || !notesContainer) return;

            // Remove any other temp notes that weren't saved
            drawer
              .querySelectorAll('[data-note-id^="temp-"]')
              .forEach((el) => el.remove());

            // Create a temporary note object and generate its HTML
            const newNote = {
              id: `temp-${dayjs().valueOf()}`,
              text: "",
              category: "General",
              timestamp: dateUtils.now(),
            };

            // Use a more robust method to create and add the new element
            const newNoteElement = document.createElement("div");
            newNoteElement.innerHTML = getNoteItemHTML(newNote);

            // The actual element we want is the first child of the div we created
            const noteItem = newNoteElement.firstElementChild;

            if (noteItem) {
              noteItem.classList.add("editing");
              notesContainer.prepend(noteItem); // Add the prepared element to the page
              noteItem.querySelector(".note-edit-text").focus();
            }
            return;
          }
          if (editNoteIconBtn) {
            const noteItem = editNoteIconBtn.closest(".note-item");
            const drawer = noteItem.closest(".notes-drawer");
            // Close any other note that might be in edit mode
            drawer.querySelectorAll(".note-item.editing").forEach((el) => {
              if (el !== noteItem) el.classList.remove("editing");
            });
            // Then, toggle the current one
            noteItem.classList.toggle("editing");
            if (noteItem.classList.contains("editing")) {
              noteItem.querySelector(".note-edit-text").focus();
            }
            return;
          }
          if (saveNoteInlineBtn) {
            const noteItem = saveNoteInlineBtn.closest(".note-item");
            saveNote(noteItem, masterCaseId);
            return;
          }
          if (deleteNoteInlineBtn) {
            const noteItem = deleteNoteInlineBtn.closest(".note-item");
            const noteId = parseInt(noteItem.dataset.noteId);
            createConfirmationModal("Delete this note?", () => {
              const masterCase = getCase(masterCaseId);
              masterCase.notes = masterCase.notes.filter(
                (n) => n.id !== noteId
              );
              openNotesDrawer(masterCaseId);
              showToast("Note deleted.", "success");
            });
            return;
          }
          if (addArBtn) {
            const masterCase = getCase(masterCaseId);
            NightingaleUniversalPicker.open({
              type: "person",
              exclusions: [masterCase.personId, ...masterCase.authorizedRepIds],
              onSelect: (person) => {
                // This callback now only handles refreshing the UI, not data changes.
                if (person) {
                  closeAllModals();
                  openCaseDetailsModal(masterCaseId);
                  showToast(
                    `${sanitize(formatPersonName(person.name))} added as Rep.`
                  );
                }
              },
            });
            return;
          }
          if (removeArBtn) {
            const repId = parseInt(removeArBtn.dataset.repId, 10);
            const masterCase = getCase(masterCaseId);
            masterCase.authorizedRepIds = masterCase.authorizedRepIds.filter(
              (id) => id !== repId
            );
            openCaseDetailsModal(masterCaseId); // Refresh modal
            showToast("Authorized Rep removed.");
            return;
          }

          if (clickablePersonName || clickableArName) {
            const personId =
              clickablePersonName?.dataset.personId ||
              clickableArName?.dataset.repId;
            const person = getPerson(personId);
            if (person)
              createModal(
                "Edit Person Details",
                getPersonFormHTML(person),
                (modal) => {
                  if (savePerson(modal)) {
                    openCaseDetailsModal(masterCaseId);
                    return true;
                  }
                  return false;
                }
              );
            return;
          }

          const copyNoteBtn = e.target.closest(".copy-note-for-mltc-btn");
          if (copyNoteBtn) {
            const noteItem = copyNoteBtn.closest(".note-item");
            const noteTextElement = noteItem.querySelector(
              ".note-display-view p"
            );
            if (noteTextElement && noteTextElement.textContent) {
              const textToCopy = `MLTC: ${noteTextElement.textContent}`;
              navigator.clipboard.writeText(textToCopy).then(
                () => {
                  showToast("Note copied for MLTC.", "success");
                },
                () => {
                  showToast("Failed to copy note.", "error");
                }
              );
            }
            return;
          }

          // This entire block is now handled by the generic ".clickable-person-name, .clickable-ar-name, .clickable-organization-name"
          // handler in the main event listener. It can be safely removed to avoid redundancy.

          // Original Handlers for Main Page and Financial Cards
          const addFinancialBtn = e.target.closest(".add-financial-item-btn");
          const editFinancialItem = e.target.closest(".edit-financial-item");
          const generateSummaryBtn = e.target.closest(".generate-summary-btn");
          const generateVrBtn = e.target.closest(".open-vr-app-btn");
          const accordionHeader = e.target.closest(".accordion-header");
          const importAvsBtn = e.target.closest(".import-avs-btn");
          const toggleFinancialBtn = e.target.closest(
            ".toggle-financial-list-btn"
          );
          const copyMcnHeader = e.target.closest(".copy-mcn-header");

          if (copyMcnHeader) {
            const mcnText = copyMcnHeader.textContent
              .replace("MCN: ", "")
              .trim();
            if (mcnText && mcnText !== "Not set") {
              navigator.clipboard.writeText(mcnText).then(() => {
                showToast("MCN copied to clipboard!", "success");
              });
            }
            return;
          }

          if (toggleFinancialBtn) {
            const cardStateId = toggleFinancialBtn.dataset.cardStateId;
            if (cardStateId) {
              // Update the viewState object; the proxy will trigger an auto-save.
              state.viewState.expandedFinancialCards[cardStateId] =
                !state.viewState.expandedFinancialCards[cardStateId];
            }

            // Also toggle the class in the DOM for immediate visual feedback.
            const targetId = toggleFinancialBtn.dataset.target;
            document.querySelector(targetId)?.classList.toggle("expanded");
          } else if (
            importAvsBtn &&
            importAvsBtn.dataset.type === "resources"
          ) {
            openAvsImportModal(masterCaseId, importAvsBtn.dataset.owner);
          } else if (accordionHeader) {
            const accordionId = accordionHeader.dataset.accordionId;
            state.accordionState[accordionId] =
              !state.accordionState[accordionId];
            accordionHeader.classList.toggle("open");
            accordionHeader.nextElementSibling.classList.toggle("open");
          } else if (e.target.closest("#back-to-cases-btn")) {
            switchTab("case-management", "Cases");
          } else if (
            e.target.id === "case-status-select" ||
            e.target.id === "case-priority-checkbox" ||
            e.target.id === "case-retro-checkbox"
          ) {
            const masterCase = getCase(masterCaseId);
            if (masterCase) {
              if (e.target.id === "case-status-select")
                masterCase.status = e.target.value || undefined;
              if (e.target.id === "case-priority-checkbox")
                masterCase.priority = e.target.checked;
              if (e.target.id === "case-retro-checkbox")
                masterCase.retroStatus = e.target.checked;
            }
          } else if (addFinancialBtn) {
            const owner = addFinancialBtn.dataset.owner || "applicant";
            const type = addFinancialBtn.dataset.type;
            createModal(
              `Add ${type}`,
              getFinancialItemFormHTML({ owner }, masterCaseId, type),
              (modal) => saveFinancialItem(modal, masterCaseId, type),
              { onInit: (modal) => setupFinancialItemModal(modal) }
            );
          } else if (editFinancialItem) {
            const type = editFinancialItem.dataset.type;
            const itemId = editFinancialItem.dataset.itemId;
            const itemData = getCase(masterCaseId).financials[type].find(
              (i) => i.id == itemId
            );
            const onDelete = () =>
              createConfirmationModal(
                "Delete this item?<br><br><span class='text-sm text-gray-400'>This action cannot be undone.</span>",
                () => {
                  getCase(masterCaseId).financials[type] = getCase(
                    masterCaseId
                  ).financials[type].filter((i) => i.id != itemId);
                  renderMasterCaseView(masterCaseId);
                  showToast("Financial item deleted.", "success");
                }
              );
            const onSplit = () =>
              createConfirmationModal(
                "Split Joint Item?",
                "This will delete this joint item and create two new items (applicant/spouse) with half the value.",
                () => {
                  const masterCase = getCase(masterCaseId);
                  const originalItem = masterCase.financials[type].find(
                    (i) => i.id == itemId
                  );
                  if (!originalItem) return;
                  const splitValue = (originalItem.value || 0) / 2;
                  masterCase.financials[type].push({
                    ...originalItem,
                    id: state.nextFinancialItemId++,
                    owner: "applicant",
                    value: splitValue,
                  });
                  masterCase.financials[type].push({
                    ...originalItem,
                    id: state.nextFinancialItemId++,
                    owner: "spouse",
                    value: splitValue,
                  });
                  masterCase.financials[type] = masterCase.financials[
                    type
                  ].filter((i) => i.id != itemId);
                  closeAllModals();
                  renderMasterCaseView(masterCaseId);
                  showToast("Joint item has been split.", "success");
                }
              );
            let modalOptions = { onDelete };
            if (itemData.owner === "joint") {
              modalOptions.onSplit = onSplit;
              modalOptions.splitButtonText = "Split Item";
            }
            createModal(
              `Edit ${type}`,
              getFinancialItemFormHTML(itemData, masterCaseId, type),
              (modal) => saveFinancialItem(modal, masterCaseId, type),
              {
                ...modalOptions,
                onInit: (modal) => setupFinancialItemModal(modal, itemData),
              }
            );
          } else if (generateSummaryBtn) {
            openSummaryGeneratorModal(masterCaseId);
          } else if (generateVrBtn) {
            const url = `NightingaleCorrespondence.html?caseId=${encodeURIComponent(
              masterCaseId
            )}&mcn=${encodeURIComponent(
              getCase(masterCaseId).masterCaseNumber
            )}`;
            window.open(url, "_blank");
          }
        }

        document.body.addEventListener("input", (e) => {
          // Let the universal picker handle its own search events
          if (e.target.id === "universal-picker-search") {
            return;
          }

          if (e.target.type === "tel") {
            e.target.value = formatPhoneNumber(e.target.value);
          }

          // Handle main page search inputs
          if (handleSearchInput(e)) {
            return;
          }

          if (e.target.classList.contains("input-error")) {
            e.target.classList.remove("input-error");
            e.target.parentElement.querySelector(".error-message")?.remove();
          }
        });
        document.body.addEventListener("change", (e) => {
          if (e.target.id === "person-living-arrangement") {
            const modal = e.target.closest(".modal");
            if (modal) {
              const isHome = e.target.value === "Home";
              modal
                .querySelector("#home-address-fields")
                .classList.toggle("hidden", !isHome);
              modal
                .querySelector("#organization-fields")
                .classList.toggle("hidden", isHome);
            }
          }
          if (e.target.id === "person-is-organization") {
            const modal = e.target.closest(".modal");
            if (modal) {
              const isOrg = e.target.checked;
              modal
                .querySelector("#person-dob-container")
                ?.classList.toggle("hidden", isOrg);
              modal
                .querySelector("#spouse-details-container")
                ?.classList.toggle("hidden", isOrg);
            }
          }
          if (
            e.target.id === "note-filter-category" ||
            e.target.id === "note-sort-order"
          ) {
            const masterCaseView = e.target.closest("#master-case-view > div");
            if (masterCaseView) {
              const notesContainer =
                masterCaseView.querySelector(".notes-container");
              notesContainer.style.opacity = "0";
              setTimeout(() => {
                renderMasterCaseView(masterCaseView.dataset.masterCaseId);
                masterCaseView.querySelector(".notes-container").style.opacity =
                  "1";
              }, 150);
            }
          }
        });

        // =============================================================================
        // CUSTOM MODALS & SPECIALIZED DATA MANAGEMENT
        // =============================================================================

        function createConfirmationModal(
          message,
          onConfirm,
          confirmText = "Confirm",
          cancelText = "Cancel"
        ) {
          const modal = createModal(
            "Confirm",
            `<p class="text-gray-300">${message}</p>`,
            () => {},
            { widthClass: "w-11/12 md:w-1/3" }
          );
          MODAL_TEMPLATES.confirmation(
            modal,
            message,
            onConfirm,
            confirmText,
            cancelText
          );
        }

        function createAlertModal(title, message) {
          const modal = createModal(
            sanitize(title),
            `<p class="text-gray-300">${sanitize(message)}</p>`,
            () => {},
            { widthClass: "w-11/12 md:w-1/3" }
          );
          MODAL_TEMPLATES.alert(modal);
        }

        // MODAL CONFIGURATION SYSTEM - Eliminates 60+ lines of duplicate button code
        function configureModalButtons(modal, buttonConfig) {
          const footer = modal.querySelector("#modal-footer");
          if (!footer || !Array.isArray(buttonConfig)) return;

          // Generate button HTML with full sanitization
          const buttonsHTML = buttonConfig
            .map((btn) => {
              const classes = sanitize(
                btn.classes || getDefaultButtonClasses(btn.type)
              );
              const id = btn.id ? `id="${sanitize(btn.id)}"` : "";
              return `<button ${id} class="${classes}">${sanitize(
                btn.text
              )}</button>`;
            })
            .join("");

          footer.innerHTML = buttonsHTML;

          // Bind event handlers with safe selectors
          buttonConfig.forEach((btn) => {
            const selector = btn.id
              ? `#${sanitize(btn.id)}`
              : `.${sanitize(
                  btn.classes
                    ? btn.classes.split(" ")[0]
                    : getDefaultButtonClasses(btn.type).split(" ")[0]
                )}`;
            const element = modal.querySelector(selector);
            if (element && btn.action) {
              element.onclick = btn.action;
            }
          });
        }

        function getDefaultButtonClasses(type) {
          const baseClasses = "font-bold py-2 px-4 rounded-md";
          switch (type) {
            case "cancel":
              return `cancel-modal-btn bg-gray-600 hover:bg-gray-700 ${baseClasses}`;
            case "primary":
              return `bg-blue-600 hover:bg-blue-700 ${baseClasses}`;
            case "danger":
              return `bg-red-600 hover:bg-red-700 ${baseClasses}`;
            case "save":
              return `save-modal-btn bg-blue-500 hover:bg-blue-600 text-white ${baseClasses}`;
            case "delete":
              return `confirm-delete bg-blue-600 hover:bg-blue-700 ${baseClasses}`;
            default:
              return `bg-gray-600 hover:bg-gray-700 ${baseClasses}`;
          }
        }

        // MODAL TEMPLATES - Common modal configurations
        const MODAL_TEMPLATES = {
          confirmation: (
            modal,
            message,
            onConfirm,
            confirmText = "Confirm",
            cancelText = "Cancel"
          ) => {
            configureModalButtons(modal, [
              {
                text: sanitize(cancelText),
                type: "cancel",
                action: () => closeModal(modal),
              },
              {
                text: sanitize(confirmText),
                type: "delete",
                action: () => {
                  onConfirm();
                  closeModal(modal);
                },
              },
            ]);
          },

          alert: (modal) => {
            configureModalButtons(modal, [
              {
                text: "OK",
                type: "primary",
                action: () => closeModal(modal),
              },
            ]);
          },

          import: (modal, onMerge, onOverwrite) => {
            configureModalButtons(modal, [
              {
                id: "import-merge-btn",
                text: "Merge",
                type: "primary",
                action: onMerge,
              },
              {
                id: "import-overwrite-btn",
                text: "Overwrite",
                type: "danger",
                action: onOverwrite,
              },
              {
                text: "Cancel",
                type: "cancel",
                action: () => closeModal(modal),
              },
            ]);
          },

          // Complex footer layout with left/right groups
          complexFooter: (modal, leftButtons, rightButtons) => {
            const footer = modal.querySelector("#modal-footer");
            if (!footer) return;

            footer.innerHTML = "";
            footer.classList.remove("justify-end");
            footer.classList.add("justify-between", "items-center");

            // Create left group
            const leftGroup = document.createElement("div");
            leftGroup.className = "flex space-x-3";
            leftButtons.forEach((btn) => {
              const button = document.createElement("button");
              button.id = btn.id || "";
              button.className =
                btn.classes || getDefaultButtonClasses(btn.type);
              button.textContent = sanitize(btn.text);
              if (btn.action) button.onclick = btn.action;
              leftGroup.appendChild(button);
            });
            footer.appendChild(leftGroup);

            // Create right group
            const rightGroup = document.createElement("div");
            rightGroup.className = "flex space-x-3";
            rightButtons.forEach((btn) => {
              const button = document.createElement("button");
              button.id = btn.id || "";
              button.className =
                btn.classes || getDefaultButtonClasses(btn.type);
              button.textContent = sanitize(btn.text);
              if (btn.action) button.onclick = btn.action;
              rightGroup.appendChild(button);
            });
            footer.appendChild(rightGroup);
          },
        };

        function showToast(message, type = "success") {
          const container = document.getElementById("toast-container");
          const toastElement = document.createElement("div");
          toastElement.className = `toast ${type}`;
          toastElement.textContent = message;
          container.appendChild(toastElement);

          setTimeout(() => toastElement.classList.add("show"), 10);
          setTimeout(() => {
            toastElement.classList.remove("show");
            toastElement.addEventListener("transitionend", () =>
              toastElement.remove()
            );
          }, 3000);
        }

        function attachNoteCopyListener(modal) {
          const copyBtn = modal.querySelector("#copy-note-text-btn");
          const noteTextarea = modal.querySelector("#note-text");
          if (copyBtn && noteTextarea) {
            copyBtn.addEventListener("click", () => {
              const noteText = noteTextarea.value;
              if (!noteText.trim()) {
                showToast("Note is empty.", "warning");
                return;
              }
              const textToCopy = `MLTC: ${noteText}`;
              navigator.clipboard.writeText(textToCopy).then(
                () => {
                  showToast("Copied!");
                },
                () => {
                  showToast("Failed to copy note.", "error");
                }
              );
            });
          }
        }

        // =============================================================================
        // UNIVERSAL PICKER SYSTEM
        // =============================================================================

        class NightingaleUniversalPicker {
          constructor() {
            this.currentModal = null;
            this.currentConfig = null;
            this.searchTimeout = null;
          }

          open(config) {
            this.currentConfig = this.normalizeConfig(config);
            this.createModal();
            this.setupEventListeners();
            this.renderInitialResults();
          }

          normalizeConfig(config) {
            const defaults = {
              title: "Select Item",
              searchPlaceholder: "Search...",
              items: null,
              onSelect: () => {},
              filterFn: null,
              renderItem: null,
              exclusions: [],
              actionButtons: [],
              options: {},
            };

            const typeDefaults = config.type
              ? this.getTypeDefaults(config.type)
              : {};
            const normalized = { ...defaults, ...typeDefaults, ...config };

            return normalized;
          }

          getTypeDefaults(type) {
            const typeConfigs = {
              organization: {
                title: "Select an Organization",
                searchPlaceholder: "Search organizations...",
                items: () => window.state?.organizations || [],
                filterFn: (item, searchTerm) =>
                  item.name.toLowerCase().includes(searchTerm) ||
                  (item.address?.city &&
                    item.address.city.toLowerCase().includes(searchTerm)),
                renderItem: (item) => this.renderOrganizationItem(item),
                actionButtons: [
                  {
                    text: "Create New Organization",
                    className:
                      "create-new-organization-from-picker-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md mr-auto",
                    position: "left",
                  },
                ],
              },
              person: {
                title: "Select a Person",
                searchPlaceholder: "Search people...",
                items: () => state?.people || [],
                filterFn: (item, searchTerm, exclusions = []) => {
                  const isExcluded = exclusions.some(
                    (id) => parseInt(id) === item.id
                  );
                  return (
                    !isExcluded && item.name.toLowerCase().includes(searchTerm)
                  );
                },
                renderItem: (item) => this.renderPersonItem(item),
                actionButtons: [
                  {
                    text: "Create New Person",
                    className:
                      "create-new-person-from-picker-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md mr-auto",
                    position: "left",
                  },
                ],
              },
              spouse: {
                title: "Select Spouse",
                searchPlaceholder: "Search for spouse...",
                items: () => state?.people || [],
                filterFn: (item, searchTerm, exclusions = []) => {
                  const isExcluded = exclusions.some(
                    (id) => parseInt(id) === item.id
                  );
                  return (
                    !isExcluded && item.name.toLowerCase().includes(searchTerm)
                  );
                },
                renderItem: (item) => this.renderPersonItem(item),
                actionButtons: [
                  {
                    text: "No Spouse",
                    className:
                      "no-spouse-btn bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md mr-auto",
                    position: "left",
                    action: (modal, config) => {
                      config.onSelect(null);
                      this.close();
                    },
                  },
                  {
                    text: "Create New Person",
                    className:
                      "create-new-person-from-picker-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md mr-2",
                    position: "left",
                  },
                ],
              },
            };

            return typeConfigs[type] || {};
          }

          createModal() {
            const contentHTML = `
              <div>
                <input 
                  type="text" 
                  id="universal-picker-search" 
                  placeholder="${this.currentConfig.searchPlaceholder}" 
                  class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-4 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500/50"
                >
                <div 
                  id="universal-picker-results" 
                  class="space-y-2 overflow-y-auto" 
                  style="max-height: 40vh;"
                >
                  <p class="text-gray-500 text-center">Start typing...</p>
                </div>
              </div>
            `;

            this.currentModal = createModal(
              this.currentConfig.title,
              contentHTML,
              () => {},
              {
                saveButtonText: "Close",
              }
            );

            this.currentModal.querySelector(".save-modal-btn").onclick = () =>
              this.close();
            this.addActionButtons();
          }

          addActionButtons() {
            const footer = this.currentModal.querySelector("#modal-footer");

            this.currentConfig.actionButtons.forEach((buttonConfig) => {
              const button = document.createElement("button");
              button.className = buttonConfig.className;
              button.textContent = buttonConfig.text;

              if (buttonConfig.action) {
                button.onclick = () =>
                  buttonConfig.action(this.currentModal, this.currentConfig);
              }

              if (buttonConfig.position === "left") {
                footer.prepend(button);
              } else {
                footer.insertBefore(
                  button,
                  footer.querySelector(".save-modal-btn")
                );
              }
            });
          }

          setupEventListeners() {
            const searchInput = this.currentModal.querySelector(
              "#universal-picker-search"
            );

            searchInput.addEventListener("input", (e) => {
              clearTimeout(this.searchTimeout);
              this.searchTimeout = setTimeout(() => {
                this.renderResults(e.target.value);
              }, 300);
            });

            this.currentModal.addEventListener("click", (e) => {
              const selectButton = e.target.closest("[data-picker-item-id]");
              const createPersonBtn = e.target.closest(
                ".create-new-person-from-picker-btn"
              );
              const createOrganizationBtn = e.target.closest(
                ".create-new-organization-from-picker-btn"
              );

              if (selectButton) {
                const itemId = parseInt(selectButton.dataset.pickerItemId);
                const items = this.getItems();
                const selectedItem = items.find((item) => item.id === itemId);

                if (selectedItem) {
                  this.currentConfig.onSelect(selectedItem);
                  this.close();
                }
              } else if (createPersonBtn) {
                const onSelect = this.currentConfig.onSelect;
                const createPersonOptions =
                  this.currentConfig.createPersonOptions || {};
                this.close();
                createModal(
                  "Add New Person",
                  getPersonFormHTML(),
                  (personModal) => {
                    const success = savePerson(
                      personModal,
                      createPersonOptions
                    );
                    if (success) {
                      const newPerson =
                        window.state.people[window.state.people.length - 1];
                      onSelect(newPerson);
                    }
                    return false;
                  }
                );
              } else if (createOrganizationBtn) {
                const onSelect = this.currentConfig.onSelect;
                this.close();
                createModal(
                  "Add New Organization",
                  getOrganizationFormHTML(),
                  (orgModal) => {
                    const success = saveOrganization(orgModal);
                    if (success) {
                      const newOrg =
                        window.state.organizations[
                          window.state.organizations.length - 1
                        ];
                      onSelect(newOrg);
                    }
                    return success;
                  }
                );
              }
            });
          }

          renderOrganizationItem(org) {
            return `
              <div class="p-3 bg-gray-700/80 rounded-md flex justify-between items-center">
                <div>
                  <p class="font-semibold">${sanitize(org.name)}</p>
                  <p class="text-sm text-gray-400">${sanitize(
                    org.address?.city || ""
                  )}</p>
                </div>
                <button 
                  class="bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 text-sm rounded-md" 
                  data-picker-item-id="${org.id}"
                >
                  Select
                </button>
              </div>
            `;
          }

          getItems() {
            if (typeof this.currentConfig.items === "function") {
              return this.currentConfig.items();
            }
            return this.currentConfig.items || [];
          }

          renderInitialResults() {
            this.renderResults("");
          }

          renderResults(searchTerm = "") {
            if (!this.currentModal) {
              return;
            }
            const container = this.currentModal.querySelector(
              "#universal-picker-results"
            );
            const normalizedSearch = searchTerm.toLowerCase().trim();
            const items = this.getItems();

            let filteredItems;
            if (this.currentConfig.filterFn) {
              filteredItems = items.filter((item) =>
                this.currentConfig.filterFn(
                  item,
                  normalizedSearch,
                  this.currentConfig.exclusions
                )
              );
            } else {
              filteredItems = items.filter((item) =>
                JSON.stringify(item).toLowerCase().includes(normalizedSearch)
              );
            }

            filteredItems.sort((a, b) => {
              if (a.name && b.name) return a.name.localeCompare(b.name);
              if (a.facilityName && b.facilityName)
                return a.facilityName.localeCompare(b.facilityName);
              return 0;
            });

            if (filteredItems.length === 0) {
              container.innerHTML =
                '<p class="text-gray-500 text-center">No items match your search.</p>';
              return;
            }

            container.innerHTML = filteredItems
              .map((item) => this.currentConfig.renderItem(item))
              .join("");
          }

          renderContactItem(contact) {
            return `
              <div class="p-3 bg-gray-700/80 rounded-md flex justify-between items-center">
                <div>
                  <p class="font-semibold">${sanitize(contact.facilityName)}</p>
                  <p class="text-sm text-gray-400">${sanitize(
                    contact.facilityCity || ""
                  )}</p>
                </div>
                <button 
                  class="select-contact-for-person-btn bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 text-sm rounded-md" 
                  data-picker-item-id="${contact.id}"
                >
                  Select
                </button>
              </div>
            `;
          }

          renderPersonItem(person) {
            const formattedName = formatPersonName
              ? formatPersonName(person.name)
              : person.name;
            const formattedPhone = formatPhoneNumber
              ? formatPhoneNumber(person.phone || "")
              : person.phone || "";

            return `
              <div class="p-3 bg-gray-700/80 rounded-md flex justify-between items-center">
                <div>
                  <p class="font-semibold">${sanitize(formattedName)}</p>
                  <p class="text-sm text-gray-400">${sanitize(
                    formattedPhone
                  )}</p>
                </div>
                <button 
                  class="select-ar-for-person-btn bg-blue-600 hover:bg-blue-700 text-white py-1 px-3 text-sm rounded-md" 
                  data-picker-item-id="${person.id}"
                >
                  Select
                </button>
              </div>
            `;
          }

          close() {
            clearTimeout(this.searchTimeout);
            if (this.currentModal && closeModal) {
              closeModal(this.currentModal);
            }
            this.currentModal = null;
            this.currentConfig = null;
          }

          static open(config) {
            const picker = new NightingaleUniversalPicker();
            picker.open(config);
            return picker;
          }
        }

        // Make the universal picker available globally
        window.NightingaleUniversalPicker = NightingaleUniversalPicker;

        function exportData() {
          const dataStr = JSON.stringify(state, null, 2);
          const link = document.createElement("a");
          link.href = URL.createObjectURL(
            new Blob([dataStr], { type: "application/json" })
          );
          link.download = `case-manager-data-${dateUtils.format(
            dateUtils.now(),
            "YYYY-MM-DD"
          )}.json`;
          link.click();
          URL.revokeObjectURL(link.href);
        }
        function createImportConfirmationModal() {
          const content = `<p class="text-gray-300 mb-4">How would you like to import data?</p><div class="space-y-2"><div><strong class="text-blue-400">Merge</strong><p class="text-sm text-gray-400">Adds new data and updates existing items with the same ID.</p></div><div><strong class="text-red-400">Overwrite</strong><p class="text-sm text-gray-400">Deletes all current data and replaces it. This cannot be undone.</p></div></div>`;
          const modal = createModal("Import Data", content, () => {}, {
            widthClass: "w-11/12 md:w-1/3",
          });
          const fileInput = document.getElementById("import-file-input");
          MODAL_TEMPLATES.import(
            modal,
            () => {
              fileInput.dataset.importAction = "merge";
              fileInput.click();
              closeModal(modal);
            },
            () => {
              fileInput.dataset.importAction = "overwrite";
              fileInput.click();
              closeModal(modal);
            }
          );
        }
        function importData(event) {
          const file = event.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          const action = event.target.dataset.importAction || "overwrite";
          reader.onload = function (e) {
            try {
              const importedState = JSON.parse(e.target.result);
              if (!importedState || typeof importedState !== "object")
                throw new Error("Invalid data format.");
              if (action === "overwrite") state = importedState;
              else if (action === "merge") {
                const merge = (existing, imported, idField = "id") => {
                  const map = new Map(
                    existing.map((item) => [item[idField], item])
                  );
                  imported.forEach((item) => map.set(item[idField], item));
                  return Array.from(map.values());
                };
                state.people = merge(state.people, importedState.people || []);
                state.cases = merge(state.cases, importedState.cases || []);
                state.organizations = merge(
                  state.organizations,
                  importedState.organizations || []
                );
              }
              saveState();
              loadState();
              render();
              switchTab("case-management", "Cases");
              showToast(
                `Data ${
                  action === "merge" ? "merged" : "imported"
                } successfully!`
              );
            } catch (error) {
              console.error("Import error:", error);
              createAlertModal(
                "Import Error",
                "Import failed: Could not parse the file."
              );
            }
          };
          reader.readAsText(file);
          event.target.value = "";
        }
        function importOrganizationData(event) {
          const file = event.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const lines = e.target.result
                .split(/[\r\n]+/)
                .filter((line) => line.trim() !== "");
              if (lines.length <= 1)
                throw new Error("File has no data or only a header.");

              const newOrganizations = lines.slice(1).map((line) => {
                const values = line.split("\t");
                const personnel = [];
                // Check for Admin Name
                if (values[3] && values[3].trim()) {
                  personnel.push({
                    name: values[3],
                    title: "Administrator",
                    email: values[4] || "",
                    phone: "",
                  });
                }
                // Check for BOM Name
                if (values[5] && values[5].trim()) {
                  personnel.push({
                    name: values[5],
                    title: "BOM",
                    email: values[6] || "",
                    phone: "",
                  });
                }

                return {
                  id: window.state.nextOrganizationId++,
                  name: values[0] || "N/A",
                  type: "Nursing Facility",
                  phone: (values[2] || "").replace(/[^\d]/g, ""),
                  address: { city: values[1] || "N/A" },
                  notes: values[7] || "",
                  personnel: personnel,
                };
              });

              const orgMap = new Map(
                window.state.organizations.map((o) => [o.name, o])
              );
              newOrganizations.forEach((org) => orgMap.set(org.name, org));
              window.state.organizations = Array.from(orgMap.values());

              render();
              switchTab("organizations", "Organizations");
              showToast(
                `${newOrganizations.length} organizations were imported/updated.`
              );
            } catch (error) {
              console.error("Organization Import Error:", error);
              createAlertModal(
                "Import Error",
                "Failed to import organizations."
              );
            }
          };
          reader.readAsText(file);
          event.target.value = "";
        }
        function migrateLegacyData(event) {
          const file = event.target.files[0];
          if (!file) return;

          console.log("Starting migration of file:", file.name);

          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              console.log("File read successfully, parsing JSON...");
              const legacyData = JSON.parse(e.target.result);

              console.log("Parsed data:", legacyData);

              if (!legacyData || !legacyData.cases) {
                console.error(
                  "Invalid data structure - missing cases:",
                  legacyData
                );
                throw new Error(
                  "Invalid legacy data format - missing 'cases' property."
                );
              }

              console.log("Found cases:", Object.keys(legacyData.cases).length);

              const newPeople = [];
              const newCases = [];
              const personMap = new Map();

              // Helper function to safely parse dates
              const parseDate = (dateValue) => {
                if (!dateValue) return dateUtils.now();

                const date = new Date(dateValue);
                if (isNaN(date.getTime())) {
                  console.warn(
                    "Invalid date found:",
                    dateValue,
                    "- using current date"
                  );
                  return dateUtils.now();
                }
                return date.toISOString();
              };
              Object.values(legacyData.cases).forEach((oldCase) => {
                let personId;
                if (personMap.has(oldCase.clientName)) {
                  personId = personMap.get(oldCase.clientName);
                } else {
                  const newPerson = {
                    id: state.nextPersonId++,
                    name: oldCase.clientName,
                    phone: oldCase.clientPhoneNumber || "",
                    email: "",
                    dob: "",
                    livingArrangement: oldCase.livingArrangement || "Home",
                    address: {
                      street: oldCase.homeAddress || "",
                      city: "",
                      state: "",
                      zip: "",
                    },
                    facilityId: null,
                  };
                  newPeople.push(newPerson);
                  personMap.set(oldCase.clientName, newPerson.id);
                  personId = newPerson.id;
                }
                const mapFinancialItem = (oldItem) => ({
                  id: state.nextFinancialItemId++,
                  type: oldItem.type || "",
                  location: oldItem.location || "",
                  accountNumber: oldItem.accountNumber || "",
                  value: parseFloat(oldItem.value || oldItem.amount) || 0,
                  verificationStatus:
                    oldItem.status === "Verified" ? "Verified" : "Needs VR",
                  source: oldItem.verificationSource || "",
                  notes: oldItem.itemNotes || "",
                  owner: "applicant",
                });
                const mapNote = (oldNote) => ({
                  id: state.nextNoteId++,
                  category: "General",
                  content: oldNote.note || oldnote.content || "",
                  timestamp: dateUtils.now(),
                });

                // Safely handle items structure - it might be undefined or have different property names
                const items = oldCase.items || {};
                console.log(
                  "Processing items for case:",
                  oldCase.clientName,
                  items
                );

                const newCase = {
                  id: state.nextCaseId++,
                  name: oldCase.clientName,
                  personId: personId,
                  masterCaseNumber: oldCase.masterCaseNumber || "",
                  createdAt: parseDate(oldCase.appDate),
                  financials: {
                    resources: (items.resources || []).map(mapFinancialItem),
                    income: (items.income || []).map(mapFinancialItem),
                    expenses: (items.expenses || []).map(mapFinancialItem),
                  },
                  notes: (items.notes || []).map(mapNote),
                };
                newCases.push(newCase);
              });

              console.log("Migration processing complete. Adding to state...");
              console.log("New people:", newPeople.length);
              console.log("New cases:", newCases.length);

              state.people.push(...newPeople);
              state.cases.push(...newCases);

              console.log("Saving state...");
              saveState();
              loadState();
              render();
              switchTab("case-management", "Cases");

              console.log("Migration complete, showing success message");
              createAlertModal(
                "Migration Complete",
                `Successfully migrated ${newCases.length} cases and ${newPeople.length} people.`
              );
            } catch (error) {
              console.error("Migration error:", error);
              console.error("Error details:", error.message);
              console.error("Stack trace:", error.stack);
              createAlertModal(
                "Migration Error",
                `The file could not be migrated: ${error.message}`
              );
            }
          };

          reader.onerror = function (e) {
            console.error("File reading failed:", e);
            createAlertModal(
              "File Read Error",
              "Could not read the selected file. Please try again."
            );
          };

          reader.readAsText(file);
          event.target.value = "";
        }

        function parseCaseSummaryLog(logText, currentState) {
          if (!logText) return null;

          const newPerson = {
            id: currentState.nextPersonId,
            name: "",
            isOrganization: false,
          };
          const newCase = {
            id: currentState.nextCaseId,
            personId: newPerson.id,
            financials: { resources: [], income: [], expenses: [] },
            notes: [],
          };

          // Regex to find section headers like "CASE NOTES" followed by "----------"
          const sections = logText.split(/^[A-Z\s]+$\r?\n-+\r?\n/m);
          const headers = logText.match(/^[A-Z\s]+$/gm);

          // First, parse the header block which is unique
          const headerBlock = sections[0];
          const nameMatch = headerBlock.match(/^CASE SUMMARY:\s*(.+)/m);
          const mcnMatch = headerBlock.match(/^MC#:\s*(.+)/m);
          const appDateMatch = headerBlock.match(/^Application Date:\s*(.+)/m);

          if (nameMatch) newPerson.name = formatProperCase(nameMatch[1].trim());
          if (mcnMatch) newCase.masterCaseNumber = mcnMatch[1].trim();
          if (appDateMatch) {
            const parsedDate = dayjs(appDateMatch[1].trim(), "MM/DD/YYYY");
            if (parsedDate.isValid()) {
              newCase.appDetails = { appDate: parsedDate.toISOString() };
              newCase.createdAt = parsedDate.toISOString();
            }
          }

          // If we didn't get the essentials, the log is invalid
          if (!newPerson.name || !newCase.masterCaseNumber) return null;

          // Now, parse the rest of the sections
          const financialItemRegex =
            /-\s*(.+?)(?:\s\((\d{4,})\))?\s*@\s*(.+?)\s*\|\s*\$([\d,.]+)/;
          let currentOwner = "applicant";

          headers.forEach((header, index) => {
            const sectionContent = sections[index + 1];
            if (!sectionContent) return;

            if (
              header.includes("FINANCIALS") ||
              ["RESOURCES", "INCOME", "EXPENSES"].includes(header)
            ) {
              if (header.includes("APPLICANT")) currentOwner = "applicant";
              if (header.includes("JOINT")) currentOwner = "joint";
              if (header.includes("SPOUSE")) currentOwner = "spouse";

              const financialType = header.includes("INCOME")
                ? "income"
                : header.includes("EXPENSES")
                ? "expenses"
                : "resources";

              sectionContent.split("\n").forEach((line) => {
                const itemMatch = line.match(financialItemRegex);
                if (itemMatch) {
                  newCase.financials[financialType].push({
                    id: currentState.nextFinancialItemId++,
                    type: itemMatch[1].trim(),
                    accountNumber: itemMatch[2] || "",
                    location: itemMatch[3].trim(),
                    value: parseFloat(itemMatch[4].replace(/,/g, "")) || 0,
                    owner: currentOwner,
                    verificationStatus: "Needs VR",
                  });
                }
              });
            } else if (header === "CASE NOTES") {
              sectionContent.split("\n").forEach((line) => {
                const noteMatch = line.match(/^\((\d{2}\/\d{2})\)\s*(.*)/);
                if (noteMatch) {
                  newCase.notes.push({
                    id: currentState.nextNoteId++,
                    category: "Recovered",
                    text: noteMatch[2].trim(),
                    timestamp: dayjs().toISOString(),
                  });
                }
              });
            }
          });

          return { newPerson, newCase };
        }

        function generateCaseSummaryText(caseId, options = {}) {
          const defaultOptions = {
            includeReps: true,
            includeLivingArrangement: true,
            includeFinancials: true,
            includeNotes: true,
          };
          const opts = { ...defaultOptions, ...options };

          const caseObject = getCase(caseId);
          const person = getPerson(caseObject.personId);
          if (!caseObject || !person)
            return "Unable to generate summary: Missing case or person data.";

          const authorizedReps = (caseObject.authorizedRepIds || [])
            .map((id) => getPerson(id))
            .filter(Boolean);
          const contact = person.facilityId
            ? getContact(person.facilityId)
            : null;

          // --- New Formatting Logic ---
          const dynamicSeparator = (text) => "-".repeat(text.length);
          const summaryParts = [];

          // --- Helper to add a section ---
          const addSection = (title, contentCallback) => {
            if (contentCallback) {
              summaryParts.push(title);
              summaryParts.push(dynamicSeparator(title));
              const content = contentCallback();
              if (content && content.trim() !== "") {
                summaryParts.push(content);
              }
            }
            summaryParts.push(""); // Add a blank line for spacing
          };

          // --- Build Summary ---
          const mainTitle = `CASE SUMMARY: ${formatPersonName(
            caseObject.name
          )}`;
          addSection(
            mainTitle,
            () =>
              `MC#: ${
                sanitize(caseObject.masterCaseNumber) || "Not Set"
              }\nApplication Date: ${formatDate(
                caseObject.appDetails?.appDate
              )}`
          );

          if (opts.includeReps) {
            addSection("AUTHORIZED REPRESENTATIVES", () => {
              if (authorizedReps.length > 0) {
                return authorizedReps
                  .map(
                    (rep) =>
                      `- Name: ${sanitize(
                        formatPersonName(rep.name)
                      )}\n  Phone: ${
                        rep.phone ? formatPhoneNumber(rep.phone) : "N/A"
                      }\n  Email: ${rep.email || "N/A"}`
                  )
                  .join("\n\n");
              }
              return "No authorized representative assigned.";
            });
          }

          if (opts.includeLivingArrangement) {
            addSection("LIVING ARRANGEMENT", () => {
              let content = `Type: ${
                person.livingArrangement || "Not specified"
              }`;
              if (person.livingArrangement === "Facility" && contact) {
                content += `\nFacility Name: ${contact.facilityName}`;
                content += `\nAddress: ${
                  contact.facilityCity || "Not specified"
                }`;
                if (caseObject.appDetails?.admissionDate) {
                  content += `\nAdmission Date: ${formatDate(
                    caseObject.appDetails.admissionDate
                  )}`;
                }
              }
              return content;
            });
          }

          if (opts.includeFinancials) {
            const isSimpCase = caseObject.appDetails?.caseType === "SIMP";

            if (isSimpCase) {
              const spouse = person.spouseId
                ? getPerson(person.spouseId)
                : null;

              const formatSimpFinancialItems = (items) => {
                if (items && items.length > 0) {
                  return items
                    .map((item) => {
                      let line = `  - ${item.type || "N/A"}`;
                      if (item.accountNumber)
                        line += ` (${item.accountNumber})`;
                      if (item.location) line += ` @ ${item.location}`;
                      line += ` | $${(item.value || 0).toFixed(2)}`;
                      if (item.source) line += ` (Verified: ${item.source})`;
                      return line;
                    })
                    .join("\n");
                }
                return "  No items recorded.";
              };

              const addOwnerSection = (owner, ownerTitle) => {
                const resources = (
                  caseObject.financials.resources || []
                ).filter((i) => i.owner === owner);
                const income = (caseObject.financials.income || []).filter(
                  (i) => i.owner === owner
                );
                const expenses = (caseObject.financials.expenses || []).filter(
                  (i) => i.owner === owner
                );

                if (
                  resources.length === 0 &&
                  income.length === 0 &&
                  expenses.length === 0
                )
                  return;

                addSection(ownerTitle, () => {
                  let content =
                    "Resources\n" + formatSimpFinancialItems(resources);
                  content += "\n\nIncome\n" + formatSimpFinancialItems(income);
                  content +=
                    "\n\nExpenses\n" + formatSimpFinancialItems(expenses);
                  return content;
                });
              };

              addOwnerSection("applicant", "APPLICANT FINANCIALS");
              addOwnerSection("joint", "JOINT FINANCIALS");
              if (spouse) {
                addOwnerSection("spouse", "SPOUSE FINANCIALS");
              }
            } else {
              // Not a SIMP case, use standard layout
              const formatFinancialItems = (items) => {
                if (items && items.length > 0) {
                  return items
                    .map((item) => {
                      let line = `- ${item.type || "N/A"}`;
                      if (item.accountNumber)
                        line += ` (${item.accountNumber})`;
                      if (item.location) line += ` @ ${item.location}`;
                      line += ` | $${(item.value || 0).toFixed(2)}`;
                      if (item.source) line += ` (Verified: ${item.source})`;
                      return line;
                    })
                    .join("\n");
                }
                return null;
              };

              addSection(
                "RESOURCES",
                () =>
                  formatFinancialItems(caseObject.financials.resources) ||
                  "No resources recorded."
              );
              addSection(
                "INCOME",
                () =>
                  formatFinancialItems(caseObject.financials.income) ||
                  "No income recorded."
              );
              addSection(
                "EXPENSES",
                () =>
                  formatFinancialItems(caseObject.financials.expenses) ||
                  "No expenses recorded."
              );
            }
          }

          if (opts.includeNotes) {
            addSection("CASE NOTES", () => {
              const notes = caseObject.notes || [];
              if (notes.length > 0) {
                const sortedNotes = [...notes].sort((a, b) =>
                  dateUtils.compareDates(a.timestamp, b.timestamp)
                );
                return sortedNotes
                  .map((note) => {
                    const dateStr = `(${dateUtils.format(
                      note.timestamp,
                      "MM/DD"
                    )})`;
                    return `${dateStr} ${note.text}`;
                  })
                  .join("\n");
              }
              return "No notes added yet.";
            });
          }

          return summaryParts.join("\n").trim();
        }

        function openSummaryGeneratorModal(caseId) {
          const caseObject = getCase(caseId);
          if (!caseObject) {
            createAlertModal("Error", "Could not load case data.");
            return;
          }
          const person = getPerson(caseObject.personId);
          if (!person) {
            createAlertModal(
              "Error",
              "Could not load person data for this case."
            );
            return;
          }

          const summaryModalHTML = `
            <div class="flex flex-col md:flex-row gap-6" style="height: 60vh;">
                <div class="w-full md:w-1/3 bg-gray-900/50 p-4 rounded-lg flex flex-col">
                    <h4 class="text-lg font-semibold text-blue-400 mb-4">Select Sections to Include</h4>
                    <div id="summary-options" class="space-y-3">
                        <label class="flex items-center"><input type="checkbox" data-option="includeReps" checked class="h-4 w-4 rounded border-gray-500 text-blue-500 focus:ring-blue-500/50 mr-3"><span>Authorized Reps</span></label>
                        <label class="flex items-center"><input type="checkbox" data-option="includeLivingArrangement" checked class="h-4 w-4 rounded border-gray-500 text-blue-500 focus:ring-blue-500/50 mr-3"><span>Living Arrangement</span></label>
                        <label class="flex items-center"><input type="checkbox" data-option="includeFinancials" checked class="h-4 w-4 rounded border-gray-500 text-blue-500 focus:ring-blue-500/50 mr-3"><span>Financials</span></label>
                        <label class="flex items-center"><input type="checkbox" data-option="includeNotes" checked class="h-4 w-4 rounded border-gray-500 text-blue-500 focus:ring-blue-500/50 mr-3"><span>Case Notes</span></label>
                    </div>
                </div>
                <div class="w-full md:w-2/3 flex flex-col">
                    <h4 class="text-lg font-semibold text-blue-400 mb-4">Live Preview</h4>
                    <pre id="summary-preview-content" class="flex-grow bg-gray-900 p-4 rounded-lg text-sm text-gray-200 whitespace-pre-wrap font-mono leading-relaxed overflow-y-auto"></pre>
                </div>
            </div>`;

          const summaryModal = createModal(
            "Generate Case Summary",
            summaryModalHTML,
            () => {},
            {
              widthClass: "w-11/12 lg:w-3/4 xl:w-2/3",
              saveButtonText: "Copy",
            }
          );

          const footer = summaryModal.querySelector("#modal-footer");
          const previewElement = summaryModal.querySelector(
            "#summary-preview-content"
          );
          const optionsContainer =
            summaryModal.querySelector("#summary-options");

          if (!footer || !previewElement || !optionsContainer) {
            console.error(
              "Could not find essential elements in the summary modal."
            );
            closeModal(summaryModal);
            return;
          }

          // Use complex footer template instead of manual DOM manipulation
          MODAL_TEMPLATES.complexFooter(
            summaryModal,
            [
              {
                id: "download-summary-btn",
                text: "Download .txt",
                classes:
                  "bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md",
                action: () => {
                  const summaryText = previewElement.textContent;
                  const formattedName = formatPersonName(person.name);
                  const nameParts = formattedName.split(", ");
                  const lastName = nameParts[0] || person.name;
                  const mcn = caseObject.masterCaseNumber || "N-A";
                  const filename = `${lastName}_${mcn}.txt`;
                  const blob = new Blob([summaryText], { type: "text/plain" });
                  const url = URL.createObjectURL(blob);
                  const a = document.createElement("a");
                  a.href = url;
                  a.download = filename;
                  a.click();
                  URL.revokeObjectURL(url);
                },
              },
              {
                id: "email-summary-btn",
                text: "Email",
                classes:
                  "bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md",
                action: () => {
                  const summaryText = previewElement.textContent;
                  const subject = encodeURIComponent(
                    `Case Summary - ${person.name} - ${mcn}`
                  );
                  const body = encodeURIComponent(summaryText);
                  const mailto = `mailto:?subject=${subject}&body=${body}`;
                  window.location.href = mailto;
                },
              },
            ],
            [
              {
                id: "copy-summary-btn",
                text: "Copy to Clipboard",
                type: "primary",
                action: () => {
                  navigator.clipboard
                    .writeText(previewElement.textContent)
                    .then(
                      () => {
                        showToast("Summary copied to clipboard!");
                      },
                      () => {
                        showToast("Failed to copy summary.", "error");
                      }
                    );
                },
              },
              {
                text: "Close",
                type: "cancel",
                action: () => closeModal(summaryModal),
              },
            ]
          );

          const updateSummaryPreview = () => {
            if (!optionsContainer || !previewElement) return;
            const options = {};
            optionsContainer
              .querySelectorAll('input[type="checkbox"]')
              .forEach((cb) => {
                options[cb.dataset.option] = cb.checked;
              });
            previewElement.textContent = generateCaseSummaryText(
              caseId,
              options
            );
          };

          optionsContainer.addEventListener("change", updateSummaryPreview);

          // Initial preview generation
          updateSummaryPreview();
        }

        // =============================================================================
        // GLOBAL ERROR HANDLING
        // =============================================================================
        function setupGlobalErrorHandler() {
          window.addEventListener("error", function (event) {
            // Prevent the default browser error handling
            event.preventDefault();

            // Log the detailed error for debugging
            console.error("An unexpected global error occurred:", event.error);

            // Display a user-friendly modal
            createAlertModal(
              "An Unexpected Error Occurred",
              "A critical error was encountered. Please save any unsaved work by exporting your data via the settings menu, and then reload the application. Details of the error have been logged to the developer console."
            );
          });
        }

        // =============================================================================
        // DEVELOPMENT & DEBUGGING UTILITIES
        // =============================================================================

        function openVrGeneratorModal(masterCaseId) {
          const masterCase = getCase(masterCaseId);
          if (!masterCase) {
            createAlertModal("Error", "Could not find case data.");
            return;
          }

          const person = getPerson(masterCase.personId);
          if (!person) {
            createAlertModal(
              "Error",
              "Could not find person data for this case."
            );
            return;
          }

          const allFinancials = [
            ...(masterCase.financials.resources || []),
            ...(masterCase.financials.income || []),
            ...(masterCase.financials.expenses || []),
          ];

          const financialItemsHTML =
            allFinancials.length > 0
              ? allFinancials
                  .map(
                    (item) =>
                      `<label class="flex items-center p-2 bg-gray-700/50 rounded-md hover:bg-gray-700">
                    <input type="checkbox" class="vr-financial-item-checkbox h-4 w-4 rounded border-gray-500 text-blue-500 focus:ring-blue-500/50 mr-3" 
                        value="${item.id}" data-type="${
                        item.type
                      }" data-location="${item.location}" 
                        data-account="${
                          item.accountNumber || ""
                        }" data-value="${item.value || 0}">
                    <div class="flex-1">
                        <div class="font-medium">${item.type} ${
                        item.accountNumber ? `(${item.accountNumber})` : ""
                      }</div>
                        <div class="text-sm text-gray-400">${
                          item.location
                        } - $${(item.value || 0).toFixed(2)}</div>
                    </div>
                </label>`
                  )
                  .join("")
              : '<p class="text-gray-500 text-center py-4">No financial items found for this case.</p>';

          const templateCategoriesHTML = state.vrCategories
            .map((cat) => `<option value="${cat}">${cat}</option>`)
            .join("");

          const vrGeneratorHTML = `
            <div class="space-y-6">
                <!-- Request Builder Section -->
                <div class="bg-gray-900/50 p-4 rounded-lg">
                    <h4 class="text-lg font-semibold text-blue-400 mb-3">Request Builder</h4>
                    <div class="space-y-4">
                        <div>
                            <label for="vr-final-content" class="block text-sm font-medium text-gray-400 mb-2">Final Request Content</label>
                            <textarea id="vr-final-content" rows="8" 
                                placeholder="Your compiled verification request will appear here..."
                                class="w-full bg-gray-700 rounded-md p-3 text-sm font-mono"></textarea>
                        </div>
                        <div class="flex space-x-2">
                            <button id="vr-add-to-request-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                Add to Request
                            </button>
                            <button id="vr-clear-request-btn" class="bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-md">
                                Clear Request
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Item Selection Section -->
                <div class="bg-gray-900/50 p-4 rounded-lg">
                    <h4 class="text-lg font-semibold text-blue-400 mb-3">Financial Items (Optional)</h4>
                    <div class="space-y-2 max-h-32 overflow-y-auto">
                        ${financialItemsHTML}
                    </div>
                </div>
                
                <!-- Template Selection Section -->
                <div class="bg-gray-900/50 p-4 rounded-lg">
                    <h4 class="text-lg font-semibold text-blue-400 mb-3">Template Selection</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="vr-template-category-select" class="block text-sm font-medium text-gray-400 mb-1">Category</label>
                            <select id="vr-template-category-select" class="w-full bg-gray-700 rounded-md p-2">
                                <option value="">All Categories</option>
                                ${templateCategoriesHTML}
                            </select>
                        </div>
                        <div>
                            <label for="vr-template-select" class="block text-sm font-medium text-gray-400 mb-1">Template</label>
                            <select id="vr-template-select" class="w-full bg-gray-700 rounded-md p-2">
                                <option value="">Select a template...</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button id="vr-manage-templates-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md text-sm">
                            Manage Templates
                        </button>
                    </div>
                </div>
                
                <!-- Due Date Section -->
                <div class="bg-gray-900/50 p-4 rounded-lg">
                    <h4 class="text-lg font-semibold text-blue-400 mb-3">Due Date Setting</h4>
                    <div class="flex space-x-4">
                        <label class="flex items-center">
                            <input type="radio" name="vr-due-date" value="15" checked class="h-4 w-4 text-blue-500 border-gray-500 focus:ring-blue-500/50 mr-2">
                            <span>15 days from today</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="vr-due-date" value="30" class="h-4 w-4 text-blue-500 border-gray-500 focus:ring-blue-500/50 mr-2">
                            <span>30 days from today</span>
                        </label>
                    </div>
                </div>
            </div>`;

          const vrModal = createModal(
            "Generate Verification Request",
            vrGeneratorHTML,
            () => {
              const finalContent = vrModal
                .querySelector("#vr-final-content")
                .value.trim();
              if (!finalContent) {
                createAlertModal(
                  "Error",
                  "Please create some content before saving."
                );
                return false;
              }

              const selectedItems = Array.from(
                vrModal.querySelectorAll(".vr-financial-item-checkbox:checked")
              ).map((cb) => parseInt(cb.value));
              const dueDays = parseInt(
                vrModal.querySelector('input[name="vr-due-date"]:checked').value
              );
              const dueDate = dateUtils.dayjs().add(dueDays, "day").toDate();

              // Create VR Request
              const vrRequest = {
                id: state.nextVrRequestId++,
                caseId: masterCaseId,
                content: finalContent,
                linkedItemIds: selectedItems,
                dueDate: dueDate.toISOString(),
                status: "Pending",
                createdAt: dateUtils.now(),
                notes: "",
              };

              state.vrRequests.push(vrRequest);

              // Update linked financial items to "VR Pending" status
              selectedItems.forEach((itemId) => {
                allFinancials.forEach((item) => {
                  if (item.id === itemId) {
                    item.verificationStatus = "VR Pending";
                  }
                });
              });

              saveState();
              renderMasterCaseView(masterCaseId);
              showToast(
                `Verification request created. ${selectedItems.length} items marked as VR Pending.`
              );
              return true;
            },
            {
              widthClass: "w-11/12 lg:w-3/4",
              saveButtonText: "Create VR Request",
            }
          );

          // Add Copy to Clipboard button
          const footer = vrModal.querySelector("#modal-footer");
          const copyBtn = document.createElement("button");
          copyBtn.id = "vr-copy-btn";
          copyBtn.className =
            "bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md mr-auto";
          copyBtn.textContent = "Copy to Clipboard";
          footer.prepend(copyBtn);

          setupVrGeneratorModal(vrModal, masterCaseId);
        }

        function setupVrGeneratorModal(modal, masterCaseId) {
          const templateCategorySelect = modal.querySelector(
            "#vr-template-category-select"
          );
          const templateSelect = modal.querySelector("#vr-template-select");
          const addToRequestBtn = modal.querySelector("#vr-add-to-request-btn");
          const clearRequestBtn = modal.querySelector("#vr-clear-request-btn");
          const finalContentTextarea = modal.querySelector("#vr-final-content");
          const copyBtn = modal.querySelector("#vr-copy-btn");
          const manageTemplatesBtn = modal.querySelector(
            "#vr-manage-templates-btn"
          );

          // Load templates into dropdown
          function loadTemplates(categoryFilter = "") {
            const templates = categoryFilter
              ? getVrTemplatesByCategory(categoryFilter)
              : state.vrTemplates;

            templateSelect.innerHTML =
              '<option value="">Select a template...</option>' +
              templates
                .map((t) => `<option value="${t.id}">${t.name}</option>`)
                .join("");

            addToRequestBtn.disabled = true;
          }

          // Enable/disable Add to Request button
          function updateAddButton() {
            const hasTemplate = templateSelect.value !== "";
            addToRequestBtn.disabled = !hasTemplate;
          }

          // Event listeners
          templateCategorySelect.addEventListener("change", () =>
            loadTemplates(templateCategorySelect.value)
          );
          templateSelect.addEventListener("change", updateAddButton);

          addToRequestBtn.addEventListener("click", () => {
            const templateId = templateSelect.value;
            if (!templateId) return;

            const template = getVrTemplate(templateId);
            if (!template) return;

            const selectedItems = Array.from(
              modal.querySelectorAll(".vr-financial-item-checkbox:checked")
            );
            let processedContent = "";

            if (selectedItems.length > 0) {
              // Generate content for each selected item
              selectedItems.forEach((checkbox, index) => {
                if (index > 0) processedContent += "\n\n";
                processedContent += processPlaceholders(
                  template.content,
                  masterCaseId,
                  {
                    ItemName: checkbox.dataset.type,
                    Location: checkbox.dataset.location,
                    AccountNumber: checkbox.dataset.account,
                    Value: `$${parseFloat(checkbox.dataset.value || 0).toFixed(
                      2
                    )}`,
                  }
                );
              });
            } else {
              // Use template with general placeholders
              processedContent = processPlaceholders(
                template.content,
                masterCaseId
              );
            }

            // Append to existing content
            const existingContent = finalContentTextarea.value.trim();
            finalContentTextarea.value = existingContent
              ? `${existingContent}\n\n${processedContent}`
              : processedContent;
          });

          clearRequestBtn.addEventListener("click", () => {
            finalContentTextarea.value = "";
          });

          copyBtn.addEventListener("click", () => {
            const content = finalContentTextarea.value.trim();
            if (!content) {
              showToast("No content to copy.", "error");
              return;
            }

            navigator.clipboard.writeText(content).then(
              () => {
                showToast("Content copied to clipboard!");
              },
              () => {
                showToast("Failed to copy content.", "error");
              }
            );
          });

          manageTemplatesBtn.addEventListener("click", () => {
            openVrTemplateManagerModal(() => {
              loadTemplates(templateCategorySelect.value);
            });
          });

          // Initial load
          loadTemplates();
        }

        function processPlaceholders(
          templateContent,
          masterCaseId,
          customReplacements = {}
        ) {
          const masterCase = getCase(masterCaseId);
          const person = getPerson(masterCase.personId);
          const contact = person.facilityId
            ? getContact(person.facilityId)
            : null;

          const replacements = {
            ClientName: person?.name || "[CLIENT NAME]",
            ClientDOB: person?.dob || "[DOB]",
            ClientPhone: person?.phone
              ? formatPhoneNumber(person.phone)
              : "[PHONE]",
            MCN: masterCase?.masterCaseNumber || "[MCN]",
            CaseType: masterCase?.appDetails?.caseType || "[CASE TYPE]",
            ApplicationDate: masterCase?.appDetails?.appDate || "[APP DATE]",
            FacilityName: contact?.facilityName || "[FACILITY]",
            CurrentDate: formatDate(dateUtils.now()),
            DueDate: "[DUE DATE]",
            ItemName: "[ITEM NAME]",
            Location: "[LOCATION]",
            AccountNumber: "[ACCOUNT NUMBER]",
            Value: "[VALUE]",
            ...customReplacements,
          };

          let processed = templateContent;
          Object.keys(replacements).forEach((key) => {
            const regex = new RegExp(`\\{${key}\\}`, "g");
            processed = processed.replace(regex, replacements[key]);
          });

          return processed;
        }

        // =============================================================================
        // VR TEMPLATE MANAGER - Refactored into smaller, focused functions
        // =============================================================================

        // Generate HTML for template list display
        function generateVrTemplatesHTML() {
          return state.vrTemplates.length > 0
            ? state.vrTemplates
                .map(
                  (template) =>
                    `<div class="bg-gray-700/50 p-3 rounded-md flex items-center justify-between">
                      <div class="flex-1">
                          <div class="font-medium">${sanitize(
                            template.name
                          )}</div>
                          <div class="text-sm text-gray-400">${sanitize(
                            template.category
                          )}</div>
                      </div>
                      <div class="flex space-x-2">
                          <button class="edit-vr-template-btn text-blue-400 hover:text-blue-300 p-1" data-template-id="${
                            template.id
                          }" title="Edit">
                              <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                  <path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" />
                                  <path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" />
                              </svg>
                          </button>
                          <button class="delete-vr-template-btn text-red-400 hover:text-red-300 p-1" data-template-id="${
                            template.id
                          }" title="Delete">
                              <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                              </svg>
                          </button>
                      </div>
                  </div>`
                )
                .join("")
            : '<p class="text-gray-500 text-center py-4">No templates created yet.</p>';
        }

        // Handle VR template manager modal actions
        function handleVrTemplateManagerActions(e, managerModal, onUpdate) {
          const addBtn = e.target.closest("#add-vr-template-btn");
          const editBtn = e.target.closest(".edit-vr-template-btn");
          const deleteBtn = e.target.closest(".delete-vr-template-btn");
          const manageCategoriesBtn = e.target.closest(
            "#manage-vr-categories-btn"
          );

          if (addBtn) {
            createVrTemplateModal(null, managerModal, onUpdate);
          } else if (editBtn) {
            const templateId = editBtn.dataset.templateId;
            const template = getVrTemplate(templateId);
            createVrTemplateModal(template, managerModal, onUpdate);
          } else if (deleteBtn) {
            handleVrTemplateDelete(
              deleteBtn.dataset.templateId,
              managerModal,
              onUpdate
            );
          } else if (manageCategoriesBtn) {
            openVrCategoryManagerModal(() => {
              closeModal(managerModal);
              openVrTemplateManagerModal(onUpdate);
            });
          }
        }

        // Create or edit VR template modal
        function createVrTemplateModal(template, managerModal, onUpdate) {
          const modalTitle = template ? "Edit VR Template" : "Add VR Template";
          createModal(
            modalTitle,
            getVrTemplateFormHTML(template),
            (modal) => {
              const success = saveVrTemplate(modal);
              if (success && onUpdate) {
                closeModal(managerModal);
                openVrTemplateManagerModal(onUpdate);
                onUpdate();
              }
              return success;
            },
            { widthClass: "w-11/12 lg:w-3/4" }
          );
        }

        // Handle VR template deletion
        function handleVrTemplateDelete(templateId, managerModal, onUpdate) {
          const template = getVrTemplate(templateId);
          createConfirmationModal(
            `Delete template "${sanitize(template?.name)}"?`,
            () => {
              state.vrTemplates = state.vrTemplates.filter(
                (t) => t.id != templateId
              );
              saveState();
              closeModal(managerModal);
              openVrTemplateManagerModal(onUpdate);
              if (onUpdate) onUpdate();
              showToast("Template deleted.", "success");
            }
          );
        }

        function openVrTemplateManagerModal(onUpdate = null) {
          const templatesHTML = generateVrTemplatesHTML();

          const managerHTML = `
            <div class="space-y-6">
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-lg font-semibold text-blue-400">VR Templates</h4>
                        <button id="add-vr-template-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md">Add Template</button>
                    </div>
                    <div class="space-y-2 max-h-64 overflow-y-auto">
                        ${templatesHTML}
                    </div>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-blue-400 mb-4">Manage Categories</h4>
                    <button id="manage-vr-categories-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md">Manage Categories</button>
                </div>
            </div>`;

          const managerModal = createModal(
            "VR Template Manager",
            managerHTML,
            () => true,
            {
              widthClass: "w-11/12 md:w-2/3",
              saveButtonText: "Close",
            }
          );

          // Event handlers - delegated to modular functions
          const managerClickHandler = (e) => {
            handleVrTemplateManagerActions(e, managerModal, onUpdate);
          };

          managerModal.addEventListener("click", managerClickHandler);

          // Add cleanup for this modal's specific event listeners
          const originalCleanup = managerModal._cleanupEventListeners;
          managerModal._cleanupEventListeners = () => {
            if (originalCleanup) originalCleanup();
            managerModal.removeEventListener("click", managerClickHandler);
          };
        }

        function openVrCategoryManagerModal(onUpdate = null) {
          const categoryModal = createModal(
            "Manage VR Categories",
            getVrCategoryFormHTML(),
            () => true,
            {
              widthClass: "w-11/12 md:w-1/2",
              saveButtonText: "Close",
            }
          );

          // Event handlers
          const categoryClickHandler = (e) => {
            const addBtn = e.target.closest("#add-vr-category-btn");
            const deleteBtn = e.target.closest(".delete-vr-category-btn");

            if (addBtn) {
              const input = categoryModal.querySelector("#new-vr-category");
              const newCategory = input.value.trim();
              if (newCategory && !state.vrCategories.includes(newCategory)) {
                state.vrCategories.push(newCategory);
                saveState();
                input.value = "";
                closeModal(categoryModal);
                openVrCategoryManagerModal(onUpdate);
                showToast("Category added.");
              } else if (state.vrCategories.includes(newCategory)) {
                showToast("Category already exists.", "error");
              }
            } else if (deleteBtn) {
              const categoryToDelete = deleteBtn.dataset.category;
              const templatesUsingCategory = state.vrTemplates.filter(
                (t) => t.category === categoryToDelete
              );

              if (templatesUsingCategory.length > 0) {
                createAlertModal(
                  "Cannot Delete Category",
                  `This category is used by ${templatesUsingCategory.length} template(s). Please reassign or delete those templates first.`
                );
              } else {
                createConfirmationModal(
                  `Delete category "${sanitize(categoryToDelete)}"?`,
                  () => {
                    state.vrCategories = state.vrCategories.filter(
                      (c) => c !== categoryToDelete
                    );
                    saveState();
                    closeModal(categoryModal);
                    openVrCategoryManagerModal(onUpdate);
                    showToast("Category deleted.", "success");
                  }
                );
              }
            }
          };

          categoryModal.addEventListener("click", categoryClickHandler);

          // Add cleanup for this modal's specific event listeners
          const originalCleanup = categoryModal._cleanupEventListeners;
          categoryModal._cleanupEventListeners = () => {
            if (originalCleanup) originalCleanup();
            categoryModal.removeEventListener("click", categoryClickHandler);
          };
        }

        // =============================================================================
        // APPLICATION INITIALIZATION & EVENT LISTENERS
        // =============================================================================

        // Safe event listener attachments with element existence checks
        const caseSortEl = document.getElementById("case-sort");
        if (caseSortEl) {
          caseSortEl.addEventListener("change", () => {
            debounce(() => renderOptimal("cases"), 300)();
          });
        }

        const caseSearchInput = document.getElementById("case-search");
        if (caseSearchInput) {
          caseSearchInput.addEventListener("input", handleSearchInput);
        }

        const contactSearchInput = document.getElementById("contact-search");
        if (contactSearchInput) {
          contactSearchInput.addEventListener("input", handleSearchInput);
        }

        const personSearchInput = document.getElementById("person-search");
        if (personSearchInput) {
          personSearchInput.addEventListener("input", handleSearchInput);
        }

        const importFileEl = document.getElementById("import-file-input");
        if (importFileEl) {
          importFileEl.addEventListener("change", importData);
        }

        const importContactFileEl = document.getElementById(
          "import-contact-file-input"
        );
        if (importContactFileEl) {
          importContactFileEl.addEventListener(
            "change",
            importOrganizationData
          );
        }

        // Note: migrate-file-input event listener is attached in modal creation since element is modal-only

        // File System Event Listeners - with safety checks
        const connectFsBtn = document.getElementById("connect-file-system-btn");
        if (connectFsBtn) {
          connectFsBtn.addEventListener("click", connectFileSystem);
        }

        const saveFsBtn = document.getElementById("save-to-file-system-btn");
        if (saveFsBtn) {
          saveFsBtn.addEventListener("click", saveToFileSystem);
        }

        const loadFsBtn = document.getElementById("load-from-file-system-btn");
        if (loadFsBtn) {
          loadFsBtn.addEventListener("click", loadFromFileSystem);
        }

        // Settings Modal Event Listener - with safety check
        const openSettingsModalBtn = document.getElementById(
          "open-settings-modal-btn"
        );
        if (openSettingsModalBtn) {
          openSettingsModalBtn.addEventListener("click", () => {
            createModal(
              "Application Settings",
              getSettingsModalHTML(),
              (modal) => closeModal(modal),
              {
                widthClass: "w-11/12 md:w-2/3 max-w-2xl",
                saveButtonText: "Close",
                hideCancelButton: true,
                onInit: (modal) => {
                  // Attach event listeners for the modal's interactive elements
                  attachModalSettingsEventListeners(modal);
                  // Sync the file status indicators inside the modal
                  updateModalFileSystemStatus();
                },
              }
            );
          });
        }

        // The main startup logic is now at the top level of the async DOMContentLoaded listener.
        const permissionPrompt = document.getElementById("permission-prompt");
        const grantAccessBtn = document.getElementById("grant-access-btn");

        const initializeAndRunApp = async () => {
          // Step 1: Read the file from disk.
          const fileData = await fileService.readFile();

          // Step 2: Use the new central function to process the file data (or default state if no file).
          const finalData = loadAndMigrateData(fileData);

          // Step 3: Initialize the state manager ONLY with this final, correct data.
          window.stateManager = new StateManagementService(
            finalData,
            fileService
          );
          window.state = window.stateManager.state;

          // Step 4: Now that the state is safe, run the rest of the application.
          buildDataIndexes();

          // Initialize the search services with the loaded data
          caseSearchService = new NightingaleSearchService(window.state.cases, {
            keys: ["searchableText"],
          });
          personSearchService = new NightingaleSearchService(
            window.state.people,
            {
              keys: ["name"],
            }
          );
          organizationSearchService = new NightingaleSearchService(
            window.state.organizations,
            {
              keys: ["name", "address.city"],
            }
          );

          render();
          startSaveStatusDisplay();
          updateFileSystemStatus();
          permissionPrompt.classList.add("hidden");
          showToast("Application ready.", "success");

          // Restore the cross-tab communication listener
          channel.onmessage = (event) => {
            const { type, mcn, name } = event.data;

            if (type === "show_case" && mcn) {
              console.log(`Received command to show case with MCN: ${mcn}`);
              const caseToShow = window.state.cases.find(
                (c) => c.masterCaseNumber === mcn
              );
              if (caseToShow) {
                window.focus();
                closeAllModals();
                caseToShow.lastOpened = dateUtils.now();
                renderMasterCaseView(caseToShow.id);
                saveViewStateToLocalStorage();
                showToast(`Switched to Case ${mcn}`, "success");
                channel.postMessage({ type: "case_shown", mcn });
              } else {
                showToast(`Case with MCN ${mcn} not found.`, "error");
              }
            } else if (type === "create_case" && mcn && name) {
              console.log(
                `Received command to create case for MCN: ${mcn}, Name: ${name}`
              );
              if (window.state.cases.some((c) => c.masterCaseNumber === mcn)) {
                showToast(`Case with MCN ${mcn} already exists.`, "warning");
                channel.postMessage({ type: "show_case", mcn }); // Still try to show it
                return;
              }

              // 1. Create a new person
              const personPayload = {
                name: formatProperCase(name),
                livingArrangement: "Home",
              };
              const newPersonId = window.state.nextPersonId;
              createOrUpdateItem(
                window.state.people,
                personPayload,
                null,
                "id",
                "nextPersonId"
              );

              // 2. Create a new master case and link the person
              const casePayload = {
                masterCaseNumber: mcn,
                personId: newPersonId,
                appDetails: {
                  appDate: dateUtils.format(dateUtils.now(), "YYYY-MM-DD"),
                  caseType: "LTC",
                  applicationType: "Application",
                },
                createdAt: dateUtils.now(),
                lastOpened: dateUtils.now(),
                // Add missing required fields to prevent UI crashes
                financials: {
                  resources: [],
                  income: [],
                  expenses: []
                },
                notes: [],
                authorizedRepIds: [],
                retroStatus: false
              };
              const newCaseId = window.state.nextCaseId;
              createOrUpdateItem(
                window.state.cases,
                casePayload,
                null,
                "id",
                "nextCaseId"
              );

              showToast(`Placeholder case created for ${name}.`, "success");
              window.focus();
              closeAllModals();
              renderMasterCaseView(newCaseId);
              saveViewStateToLocalStorage();

              // 3. Acknowledge creation so other apps can refresh
              channel.postMessage({ type: "case_created", mcn });
            }
          };
        };

        if (fileService.isSupported()) {
          const { handle, permission } =
            await fileService.restoreLastDirectoryAccess();
          if (permission === "granted") {
            await initializeAndRunApp();
          } else {
            permissionPrompt.classList.remove("hidden");
            grantAccessBtn.onclick = async () => {
              const permissionGranted = await fileService.requestPermission();
              if (permissionGranted) await initializeAndRunApp();
            };
          }
        } else {
          // Fallback for unsupported browsers
          updateFileSystemStatus();
        }

        // The initializeFileAccess() call has been removed, as its logic is now at the top-level of the DOMContentLoaded listener.

        // Initialize file system status display
        updateFileSystemStatus();

        // Start memory management for long sessions
        startMemoryCleanupSchedule();

        // Initialize auto-refresh system for view state preservation
        setupAutoRefresh();

        // Save view state to localStorage to preserve context across reloads or when focus is lost
        function saveViewStateToLocalStorage() {
          // Don't save if state isn't initialized yet
          if (!state || !state.viewState) {
            console.warn("State not initialized, skipping viewState save");
            return;
          }
          
          // Use unique timer name to avoid conflicts
          const timerName = `ViewState Save ${Date.now()}`;
          console.time(timerName);
          const viewStateToSave = {
            currentTab: state.viewState.currentTab,
            currentCaseId: state.viewState.currentCaseId,
          };
          localStorage.setItem(
            "nightingaleViewState",
            JSON.stringify(viewStateToSave)
          );
          console.timeEnd(timerName);
        }

        // Save on blur (visibilitychange) and also on unload as a fallback
        document.addEventListener("visibilitychange", () => {
          if (document.hidden) {
            saveViewStateToLocalStorage();
          }
        });
        window.addEventListener("beforeunload", saveViewStateToLocalStorage);

        // Activate the global error handler
        setupGlobalErrorHandler();

        // Performance monitoring for development
        if (console.time) {
          console.time("Initial render complete");
          setTimeout(() => console.timeEnd("Initial render complete"), 100);
        }

        // =============================================================================
        // DEVELOPMENT & DEBUGGING UTILITIES
        // =============================================================================

        // Code Organization Summary (Phase 4 Complete - VR Generator Added)
        const codeOrganization = {
          totalLines: 3200,
          sections: 16,
          optimizations: [
            "Search Caching",
            "Data Indexing",
            "Memory Management",
            "Batch Operations",
          ],
          codeStructure:
            "Well-organized with clear section boundaries and logical grouping",
          features: [
            "Case Management",
            "Financial Tracking",
            "VR Generator",
            "Summary Generator",
          ],
        };

        // Expose useful functions for console debugging
        window.nightingaleDebug = {
          analyzeDataSize,
          suggestDataCleanup,
          performMemoryCleanup,
          buildDataIndexes,
          clearSearchCache,
          startBatchUpdate,
          endBatchUpdate,
          getDataIndexes: () => dataIndexes,
          getState: () => state,
          getSearchCache: () => searchCache,
          getCodeOrganization: () => codeOrganization,
          getStorageUsage: () => {
            if (navigator.storage && navigator.storage.estimate) {
              return navigator.storage.estimate().then((estimate) => ({
                used: (estimate.usage / (1024 * 1024)).toFixed(1) + "MB",
                quota: (estimate.quota / (1024 * 1024)).toFixed(0) + "MB",
                percent:
                  ((estimate.usage / estimate.quota) * 100).toFixed(1) + "%",
              }));
            }
          },
          // Data repair function for malformed cases
          repairMalformedCases: () => {
            console.log("🔧 Starting case repair process...");
            let repaired = 0;
            let removed = 0;
            
            // Create a copy of cases array to iterate over
            const casesToCheck = [...state.cases];
            
            casesToCheck.forEach((caseItem, index) => {
              // Check for critical missing fields
              const isMalformed = !caseItem.financials || 
                                 !caseItem.notes || 
                                 caseItem.authorizedRepIds === undefined ||
                                 caseItem.retroStatus === undefined ||
                                 !caseItem.personId;
              
              if (isMalformed) {
                console.log(`📋 Found malformed case: MCN ${caseItem.masterCaseNumber || caseItem.id}`);
                
                // Try to repair if it has basic structure
                if (caseItem.masterCaseNumber && caseItem.personId) {
                  console.log(`🛠️ Repairing case MCN: ${caseItem.masterCaseNumber}`);
                  
                  // Add missing fields
                  if (!caseItem.financials) {
                    caseItem.financials = { resources: [], income: [], expenses: [] };
                  }
                  if (!caseItem.notes) {
                    caseItem.notes = [];
                  }
                  if (caseItem.authorizedRepIds === undefined) {
                    caseItem.authorizedRepIds = [];
                  }
                  if (caseItem.retroStatus === undefined) {
                    caseItem.retroStatus = false;
                  }
                  if (!caseItem.appDetails) {
                    caseItem.appDetails = {
                      appDate: "",
                      caseType: "LTC",
                      applicationType: "Application"
                    };
                  }
                  if (!caseItem.createdAt) {
                    caseItem.createdAt = dateUtils.now();
                  }
                  if (!caseItem.lastOpened) {
                    caseItem.lastOpened = dateUtils.now();
                  }
                  
                  repaired++;
                } else {
                  // Remove completely broken cases
                  console.log(`🗑️ Removing irreparable case at index ${index}`);
                  const realIndex = state.cases.findIndex(c => c === caseItem);
                  if (realIndex !== -1) {
                    state.cases.splice(realIndex, 1);
                    removed++;
                  }
                }
              }
            });
            
            console.log(`✅ Repair complete: ${repaired} cases repaired, ${removed} cases removed`);
            
            // Rebuild indexes and refresh UI
            buildDataIndexes();
            clearSearchCache();
            
            // Force a re-render of the current view
            if (state.viewState.currentTab === 'caseManagement') {
              renderCaseManagementTab();
            }
            
            showToast(`Case repair complete: ${repaired} repaired, ${removed} removed`, 'success');
            
            return { repaired, removed };
          },
          // Debug functions for save triggers
          debugSaveTriggers: () => {
            console.log("🔍 Adding save trigger debugging...");
            
            // Intercept the state proxy setter to see what's changing
            const originalSetter = window.stateHandler.set;
            let lastChange = null;
            let changeCount = 0;
            
            window.stateHandler.set = function(target, property, value, receiver) {
              const now = Date.now();
              changeCount++;
              
              // Log rapid changes
              if (lastChange && (now - lastChange) < 100) {
                console.warn(`⚡ RAPID CHANGE #${changeCount}: ${property} changed within 100ms of last change`);
              }
              
              console.log(`🔄 State change #${changeCount}: ${property} =`, value);
              lastChange = now;
              
              return originalSetter.call(this, target, property, value, receiver);
            };
            
            console.log("✅ Save trigger debugging enabled");
          },
          checkSaveLocks: () => {
            console.log("🔒 Save Lock Status:");
            console.log(`Global lock: ${window._nightingaleGlobalSaveLock}`);
            console.log(`Instance lock: ${window.fileService?.isSaving}`);
            console.log(`Tab ID: ${window.fileService?.tabId}`);
            console.log(`Directory: ${window.fileService?.directoryHandle?.name}`);
          },
          checkSaveQueue: () => {
            console.log("⏱️ Save Queue Status:");
            console.log(`Debounced save pending: ${window.stateHandler?.debouncedSave ? 'Yes' : 'No'}`);
            console.log(`Last save timestamp: ${window.stateHandler?.lastSaveTimestamp}`);
            console.log(`Batch loading: ${window.stateHandler?.isBatchLoading}`);
          },
          // Testing utilities
          runDataIntegrityCheck: () => {
            console.log(
              "Data integrity check functionality not implemented in production version"
            );
            return {
              valid: true,
              message: "Production version - integrity checks disabled",
            };
          },
          performMemoryCleanup: () => {
            performMemoryCleanup();
            return "Memory cleanup completed";
          },
          analyzeDataSize: () => {
            return analyzeDataSize();
          },
        };

        console.log("📚 Access debug tools via window.nightingaleDebug");
      });
    </script>
  </body>
</html>
