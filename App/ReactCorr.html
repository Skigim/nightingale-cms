<!doctype html>
<html lang="en" class="h-full bg-gray-900 text-white">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nightingale Correspondence (React)</title>
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com;"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="lib/dayjs.min.js"></script>
    <script src="lib/dayjs-relativeTime.min.js"></script>
    <script src="lib/dayjs-customParseFormat.min.js"></script>
    <script>
      // Initialize Day.js plugins
      if (typeof dayjs !== "undefined") {
        dayjs.extend(window.dayjs_plugin_relativeTime);
        dayjs.extend(window.dayjs_plugin_customParseFormat);
      }
    </script>
    
    <script src="js/nightingale.utils.js"></script>
    <script src="js/nightingale.dayjs.js"></script>
    <script src="js/nightingale.parsers.js"></script>
    <script src="js/nightingale.fileservice.js"></script>
    <script src="lib/fuse.min.js"></script>
    <script src="js/nightingale.search.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      html { font-family: 'Inter', sans-serif; }
      /* Custom scrollbar */
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: #1f2937; }
      ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
      /* Softer focus ring */
      input:focus, select:focus, textarea:focus { --tw-ring-color: rgba(96, 165, 250, 0.5); }
      /* Toast notification styles */
      .toast {
          padding: 0.75rem 1.25rem; border-radius: 0.5rem; color: white;
          box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
          opacity: 0; transform: translateX(100%);
          transition: opacity 0.3s ease, transform 0.3s ease;
      }
      .toast.show { opacity: 1; transform: translateX(0); }
      .toast.success { background-color: #22c55e; } /* green-500 */
      .toast.error { background-color: #ef4444; } /* red-500 */
    </style>
  </head>
  <body class="h-full bg-gray-900 text-white">
    <div id="root"></div>
    <div
      id="toast-container"
      class="fixed bottom-6 right-6 z-[2000] flex flex-col gap-3"
    ></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
      const { useState, useEffect, useCallback, useMemo, useRef } = React;
      const e = React.createElement;

      const VERIFICATION_STATUS_COLORS = {
        "Needs VR": "bg-red-600 text-red-100",
        "AVS Pending": "bg-orange-500 text-orange-100",
        "VR Pending": "bg-yellow-600 text-yellow-100",
        Verified: "bg-green-600 text-green-100",
      };

      function StatusBadge({ status }) {
        const colorClass = VERIFICATION_STATUS_COLORS[status] || "bg-gray-600 text-gray-100";
        return e(
          "span",
          { className: `px-2 py-1 text-xs rounded-full ${colorClass}` },
          status || "Unknown"
        );
      }

      function FinancialsList({ items, selectedIds, onToggleItem }) {
        if (!items || items.length === 0) {
            return e("p", { className: "text-gray-500 text-center py-4" }, "No financial items found for this case.");
        }

        return e(
            "div",
            { className: "space-y-2 max-h-64 overflow-y-auto p-2 bg-gray-900/50 rounded-md" },
            items.map(item => e(
                "label",
                { key: item.id, className: "flex items-center p-2 bg-gray-700/50 rounded-md hover:bg-gray-700 cursor-pointer" },
                e("input", {
                    type: "checkbox",
                    className: "vr-financial-item-checkbox h-4 w-4 rounded border-gray-500 text-blue-500 focus:ring-blue-500/50 mr-3",
                    value: item.id,
                    checked: selectedIds.has(item.id),
                    onChange: () => onToggleItem(item.id)
                }),
                e(
                    "div",
                    { className: "flex-1" },
                    e(
                        "div",
                        { className: "flex items-center justify-between" },
                        e("div", { className: "font-medium" }, `${item.type} ${item.accountNumber ? `(${item.accountNumber})` : ''}`),
                        e(StatusBadge, { status: item.verificationStatus })
                    ),
                    e("div", { className: "text-sm text-gray-400" }, `${item.location} - $${(item.value || 0).toFixed(2)}`)
                )
            ))
        );
      }

      function CaseDetailsPanel({ activeCase, fullData, selectedFinItemIds, onFinancialItemToggle }) {
        const person = fullData.people.find(p => p.id === activeCase.personId);
        const allFinancials = [
            ...(activeCase.financials?.resources || []),
            ...(activeCase.financials?.income || []),
            ...(activeCase.financials?.expenses || []),
        ];

        return e(
            "div",
            { className: "space-y-4 mt-6" },
            e(
                "div",
                null,
                e("h3", { className: "text-lg font-semibold text-blue-400" }, "Client Info"),
                e(
                    "div",
                    { className: "bg-gray-900/50 p-3 rounded-md text-sm mt-2" },
                    e("p", null, e("strong", null, "Name: "), person?.name || "N/A"),
                    e("p", null, e("strong", null, "MCN: "), activeCase.masterCaseNumber || "N/A")
                )
            ),
            e(
                "div",
                null,
                e("h3", { className: "text-lg font-semibold text-blue-400" }, "Select Financial Items"),
                e(FinancialsList, { items: allFinancials, selectedIds: selectedFinItemIds, onToggleItem: onFinancialItemToggle })
            )
        );
      }

      // This is the core logic ported from the original app to handle template text generation.
      function processPlaceholders(templateContent, activeCase, fullData, customReplacements = {}) {
        if (!activeCase) return templateContent;
        const person = fullData.people.find(p => p.id === activeCase.personId);
        const appDetails = activeCase.appDetails || {};

        const organization = person?.organizationId ? fullData.organizations.find(o => o.id === person.organizationId) : null;
        const primaryContact = organization?.personnel?.find(p => p.title === "Administrator") || organization?.personnel?.[0] || null;

        const replacements = {
            ClientName: person?.name || "[CLIENT NAME]",
            MCN: activeCase?.masterCaseNumber || "[MCN]",
            ApplicationDate: dateUtils.format(appDetails.appDate),
            // Add other placeholders as needed from the original function
            ...customReplacements,
        };

        let processed = templateContent;
        Object.keys(replacements).forEach((key) => {
            const regex = new RegExp(`\\{${key}\\}`, "g");
            processed = processed.replace(regex, replacements[key]);
        });

        return processed;
      }

      function TemplateManagerModal({ isOpen, onClose, fullData }) {
        const templatesHTML = (fullData?.vrTemplates || []).length > 0
            ? (fullData.vrTemplates || []).map(template => e(
                "div",
                { key: template.id, className: "bg-gray-700/50 p-3 rounded-md flex items-center justify-between" },
                e(
                    "div", { className: "flex-1" },
                    e("div", { className: "font-medium" }, template.name),
                    e("div", { className: "text-sm text-gray-400" }, template.category)
                ),
                e(
                    "div", { className: "flex space-x-2" },
                    e("button", { className: "text-blue-400 hover:text-blue-300 p-1", title: "Edit" }, "Edit"),
                    e("button", { className: "text-red-400 hover:text-red-300 p-1", title: "Delete" }, "Delete")
                )
            ))
            : e("p", { className: "text-gray-500 text-center py-4" }, "No templates created yet.");

        const footer = e(
            "button",
            { onClick: onClose, className: "bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md" },
            "Close"
        );

        return e(
            Modal,
            { isOpen, onClose, title: "VR Template Manager", footerContent: footer },
            e(
                "div", { className: "space-y-6" },
                e(
                    "div", null,
                    e(
                        "div", { className: "flex justify-between items-center mb-4" },
                        e("h4", { className: "text-lg font-semibold text-blue-400" }, "VR Templates"),
                        e("button", { className: "bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md" }, "Add Template")
                    ),
                    e("div", { className: "space-y-2 max-h-64 overflow-y-auto" }, templatesHTML)
                ),
                e(
                    "div", null,
                    e("h4", { className: "text-lg font-semibold text-blue-400 mb-4" }, "Manage Categories"),
                    e("button", { className: "bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md" }, "Manage Categories")
                )
            )
        );
      }

      function VrBuilderPanel({ activeCase, fullData, selectedFinItemIds, onCreateVr, onComplete }) {
        const [selectedCategory, setSelectedCategory] = useState("");
        const [selectedTemplateId, setSelectedTemplateId] = useState("");
        const [finalContent, setFinalContent] = useState("");
        const [dueDays, setDueDays] = useState("15");

        const templates = useMemo(() => {
            if (!fullData?.vrTemplates) return [];
            if (!selectedCategory) return fullData.vrTemplates;
            return fullData.vrTemplates.filter(t => t.category === selectedCategory);
        }, [fullData, selectedCategory]);

        const handleAddToRequest = () => {
            if (!selectedTemplateId) return;
            const template = fullData.vrTemplates.find(t => t.id == selectedTemplateId);
            if (!template) return;

            const selectedIdsArray = Array.from(selectedFinItemIds);
            let processedContent = "";
            let toastMessage = "";

            if (selectedIdsArray.length > 0) {
                // Logic for when financial items ARE selected
                const allFinancials = [
                    ...(activeCase.financials?.resources || []),
                    ...(activeCase.financials?.income || []),
                    ...(activeCase.financials?.expenses || []),
                ];
                const selectedItems = selectedIdsArray.map(id => allFinancials.find(item => item.id === id)).filter(Boolean);
                
                processedContent = selectedItems.map(item => {
                    return processPlaceholders(template.content, activeCase, fullData, {
                        ItemName: item.type,
                        Location: item.location,
                        AccountNumber: item.accountNumber || "",
                        Value: `$${(item.value || 0).toFixed(2)}`,
                    });
                }).join("\n\n");
                toastMessage = `Added text for ${selectedItems.length} item(s) to the request.`;

            } else {
                // Logic for when NO financial items are selected
                processedContent = processPlaceholders(template.content, activeCase, fullData, {});
                toastMessage = "Added general template text to the request.";
            }

            setFinalContent(prevContent => 
                prevContent ? `${prevContent}\n\n${processedContent}` : processedContent
            );
            
            showToast(toastMessage, "success");
        };

        const handleCreateClick = () => {
            const success = onCreateVr(finalContent, parseInt(dueDays, 10));
            if (success) {
                setFinalContent("");
                onComplete(); // This clears the selected items in the App state
            }
        };

        if (!activeCase) {
            return e(
                "div",
                { className: "bg-gray-800 p-6 rounded-lg shadow-lg flex items-center justify-center h-full" },
                e("p", { className: "text-gray-500" }, "Select a case to begin building a VR.")
            );
        }

        return e(
            "div",
            { className: "bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col space-y-6 overflow-y-auto" },
            e("h2", { className: "text-2xl font-bold text-blue-300 border-b border-gray-700 pb-2" }, "Request Builder"),
             e(
                "div",
                { className: "space-y-4" },
                e("h3", { className: "text-lg font-semibold text-blue-400" }, "Template Selection"),
                e(
                    "div", { className: "grid grid-cols-1 md:grid-cols-2 gap-4" },
                    e("div", null,
                        e("label", { htmlFor: "vr-template-category-select", className: "block text-sm font-medium text-gray-400 mb-1" }, "Category"),
                        e("select", {
                            id: "vr-template-category-select",
                            className: "w-full bg-gray-700 rounded-md p-2",
                            value: selectedCategory,
                            onChange: e => setSelectedCategory(e.target.value)
                        },
                        e("option", { value: "" }, "All Categories"),
                        ...(fullData.vrCategories || []).map(cat => e("option", { key: cat, value: cat }, cat)))
                    ),
                    e("div", null,
                        e("label", { htmlFor: "vr-template-select", className: "block text-sm font-medium text-gray-400 mb-1" }, "Template"),
                        e("select", {
                            id: "vr-template-select",
                            className: "w-full bg-gray-700 rounded-md p-2",
                            value: selectedTemplateId,
                            onChange: e => setSelectedTemplateId(e.target.value),
                            disabled: templates.length === 0
                        },
                        e("option", { value: "" }, "Select a template..."),
                        ...templates.map(t => e("option", { key: t.id, value: t.id }, t.name)))
                    )
                )
            ),
            e(
                "div",
                { className: "space-y-4 flex-grow flex flex-col" },
                e("h3", { className: "text-lg font-semibold text-blue-400" }, "Final Request Content"),
                e("textarea", {
                    placeholder: "Your compiled verification request will appear here...",
                    className: "flex-grow w-full bg-gray-700 rounded-md p-3 text-sm font-mono",
                    value: finalContent,
                    onChange: e => setFinalContent(e.target.value)
                }),
                 e(
                    "div",
                    { className: "flex space-x-2 pt-2" },
                    e("button", { onClick: handleAddToRequest, className: "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md disabled:opacity-50", disabled: !selectedTemplateId }, "Add to Request"),
                    e("button", { onClick: () => setFinalContent(""), className: "bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-md" }, "Clear"),
                    e("button", { onClick: () => navigator.clipboard.writeText(finalContent), className: "bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md ml-auto" }, "Copy to Clipboard")
                )
            ),
             e(
                "div",
                { className: "space-y-4 border-t border-gray-700 pt-4" },
                e("h3", { className: "text-lg font-semibold text-blue-400" }, "Due Date & Create"),
                 e(
                    "div",
                    { className: "flex items-center justify-between" },
                     e(
                        "div",
                        { className: "flex space-x-4 items-center" },
                        e("label", { className: "flex items-center" },
                            e("input", { type: "radio", name: "vr-due-date", value: "15", checked: dueDays === "15", onChange: e => setDueDays(e.target.value), className: "h-4 w-4 text-blue-500 border-gray-500 mr-2" }),
                            e("span", null, "15 days")
                        ),
                        e("label", { className: "flex items-center" },
                            e("input", { type: "radio", name: "vr-due-date", value: "30", checked: dueDays === "30", onChange: e => setDueDays(e.target.value), className: "h-4 w-4 text-blue-500 border-gray-500 mr-2" }),
                            e("span", null, "30 days")
                        )
                     ),
                    e("button", { onClick: handleCreateClick, className: "bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md disabled:opacity-50", disabled: !finalContent.trim() }, "Create VR & Update Statuses")
                )
            )
        );
      }

      function CaseSelectionPanel({ cases, onDirectorySelect, onCaseSelect, activeCase, fullData, selectedFinItemIds, onFinancialItemToggle }) {
        const [searchTerm, setSearchTerm] = useState("");
        const caseSearchService = useMemo(() => new NightingaleSearchService(cases, {
            keys: ["masterCaseNumber", "name"],
            threshold: 0.2,
        }), [cases]);

        const handleSearch = () => {
            if (!searchTerm.trim()) {
                showToast("Please enter a Case Number or Client Name.", "error");
                return;
            }
            const results = caseSearchService.search(searchTerm);
            const foundCase = results.length > 0 ? results[0] : null; // Use the best match
            
            onCaseSelect(foundCase); // Pass the result (or null) up to the App component
        };

        const handleKeyDown = (e) => {
            if (e.key === 'Enter') {
                handleSearch();
            }
        };

        return e(
            "div",
            { className: "bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col space-y-6 overflow-y-auto" },
            e("h2", { className: "text-2xl font-bold text-blue-300 border-b border-gray-700 pb-2" }, "Case Data"),
            e(
                "div",
                { className: "space-y-4" },
                e("h3", { className: "text-lg font-semibold text-blue-400" }, "Load & Find Case"),
                e("div", null,
                    e("button", {
                        onClick: onDirectorySelect,
                        className: "w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200"
                    }, "Select New Data Directory")
                ),
                e(
                    "div",
                    { className: "flex items-center space-x-2" },
                    e("input", {
                        type: "text",
                        placeholder: "Enter Master Case Number...",
                        className: "flex-grow bg-gray-700 p-2 rounded-md",
                        value: searchTerm,
                        onChange: (ev) => setSearchTerm(ev.target.value),
                        onKeyDown: handleKeyDown
                    }),
                    e("button", {
                        onClick: handleSearch,
                        className: "bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md"
                    }, "Find")
                )
            ),
            activeCase && e(CaseDetailsPanel, { activeCase, fullData })
        );
      }

      // --- Reusable UI Components ---

      function Modal({ isOpen, onClose, title, children, footerContent }) {
        if (!isOpen) return null;

        return e(
          "div",
          {
            className: "fixed inset-0 bg-black bg-opacity-75 z-50 flex justify-center items-center",
            onClick: onClose,
          },
          e(
            "div",
            {
              className: "bg-gray-800 rounded-lg shadow-2xl flex flex-col w-11/12 md:w-2/3 max-w-4xl",
              onClick: (ev) => ev.stopPropagation(),
            },
            e(
              "div",
              {
                className: "bg-gray-900 p-3 flex justify-between items-center rounded-t-lg",
              },
              e("h3", { className: "font-bold text-lg text-blue-300" }, title),
              e(
                "button",
                {
                  onClick: onClose,
                  className: "text-gray-400 hover:text-white text-2xl leading-none",
                },
                "Ã—"
              )
            ),
            e(
              "div",
              {
                className: "p-6 overflow-y-auto",
                style: { maxHeight: "70vh" },
              },
              children
            ),
            footerContent &&
              e(
                "div",
                {
                  className: "bg-gray-900/50 p-3 flex justify-end space-x-3 rounded-b-lg",
                },
                footerContent
              )
          )
        );
      }

      // --- Main Application Component ---
      function App() {
        const [fullData, setFullData] = useState(null);
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [activeCase, setActiveCase] = useState(null);
        const [selectedFinItemIds, setSelectedFinItemIds] = useState(new Set());
        const [isTemplateManagerOpen, setTemplateManagerOpen] = useState(false);
        const [isDirty, setIsDirty] = useState(false);

        const handleSave = async () => {
            if (!fullData) return;
            const success = await fileService.writeFile(fullData);
            if (success) {
                setIsDirty(false);
                showToast("Data saved successfully.", "success");
            } else {
                showToast("Failed to save data.", "error");
            }
        };

        const handleFinancialItemToggle = useCallback((itemId) => {
            setSelectedFinItemIds(prevSelectedIds => {
                const newSelectedIds = new Set(prevSelectedIds);
                if (newSelectedIds.has(itemId)) {
                    newSelectedIds.delete(itemId);
                } else {
                    newSelectedIds.add(itemId);
                }
                return newSelectedIds;
            });
        }, []);

        const handleCreateVrRequest = useCallback((finalContent, dueDays) => {
            if (!activeCase || !finalContent.trim()) return;

            const newVrRequest = {
                id: fullData.nextVrRequestId++,
                caseId: activeCase.id,
                masterCaseNumber: activeCase.masterCaseNumber,
                clientName: fullData.people.find(p => p.id === activeCase.personId)?.name || "Unknown",
                content: finalContent,
                createdDate: dateUtils.now(),
                dueDate: dayjs().add(dueDays, "day").toISOString(),
                status: "Pending",
                financialItemIds: Array.from(selectedFinItemIds),
            };

            // Create a deep copy to modify
            const newData = JSON.parse(JSON.stringify(fullData));
            
            // Add the new request
            newData.vrRequests = newData.vrRequests || [];
            newData.vrRequests.push(newVrRequest);

            // Update the statuses of the financial items in the active case
            const caseToUpdate = newData.cases.find(c => c.id === activeCase.id);
            if (caseToUpdate) {
                const allFinancials = [
                    ...(caseToUpdate.financials?.resources || []),
                    ...(caseToUpdate.financials?.income || []),
                    ...(caseToUpdate.financials?.expenses || []),
                ];
                selectedFinItemIds.forEach(itemId => {
                    const itemToUpdate = allFinancials.find(item => item.id === itemId);
                    if (itemToUpdate) {
                        itemToUpdate.verificationStatus = "VR Pending";
                    }
                });
            }

            setFullData(newData);
            setIsDirty(true);
            showToast(`VR Request #${newVrRequest.id} created successfully!`, "success");

            // Return true to signal completion for UI cleanup
            return true;

        }, [activeCase, fullData, selectedFinItemIds]);
        
        const fileService = useMemo(
          () =>
            new FileSystemService({
              tabId: `corr-react-tab-${Date.now()}`,
              errorCallback: showToast,
              sanitizeFn: sanitize,
            }),
          []
        );

        const loadInitialData = useCallback(async () => {
          try {
            const { handle, permission } = await fileService.restoreLastDirectoryAccess();
            if (!handle || permission !== "granted") {
              setError("Please connect to your Nightingale data directory to use this app.");
              setLoading(false);
              return;
            }
            const data = await fileService.readFile();
            if (data) {
              setFullData(data);
            } else {
              setError("Could not find a valid nightingale-data.json file in the connected directory.");
            }
          } catch (err) {
            setError(`Failed to load data: ${err.message}`);
          } finally {
            setLoading(false);
          }
        }, [fileService]);

        useEffect(() => {
          loadInitialData();
        }, [loadInitialData]);

        const searchableCases = useMemo(() => {
            if (!fullData?.cases || !fullData?.people) return [];
            const peopleMap = new Map(fullData.people.map(p => [p.id, p.name]));
            return fullData.cases.map(c => ({
                ...c,
                name: peopleMap.get(c.personId) || "Unknown Person"
            }));
        }, [fullData]);

        const handleFindCase = (foundCase) => {
            setActiveCase(foundCase);
            if (foundCase) {
                const person = fullData.people.find(p => p.id === foundCase.personId);
                showToast(`Loaded Case: ${person?.name || 'Unknown'}`, 'success');
            } else {
                showToast("Case not found.", "error");
            }
        };
        
        const renderContent = () => {
          if (loading) {
            return e("p", { className: "text-center text-gray-400" }, "Loading data from directory...");
          }
          if (error) {
            return e("div", { className: "bg-red-800 border border-red-600 text-red-200 p-4 rounded-lg text-center" },
              e("h3", { className: "font-bold" }, "Connection Error"),
              e("p", null, error)
            );
          }
          if (!fullData) {
            return e("p", { className: "text-center text-gray-400" }, "No data loaded.");
          }

          return e("main", { className: "flex-grow p-6 bg-gray-900 overflow-auto grid grid-cols-1 lg:grid-cols-2 gap-6" },
            e(CaseSelectionPanel, {
              cases: searchableCases,
              onDirectorySelect: loadInitialData,
              onCaseSelect: handleFindCase,
              activeCase: activeCase,
              fullData: fullData,
              selectedFinItemIds: selectedFinItemIds,
              onFinancialItemToggle: handleFinancialItemToggle
            }),
            e(VrBuilderPanel, {
              activeCase: activeCase,
              fullData: fullData,
              selectedFinItemIds: selectedFinItemIds,
              onCreateVr: handleCreateVrRequest,
              onComplete: () => setSelectedFinItemIds(new Set()) // Function to clear selections
            })
          );
        };
        
        return e(
          "div",
          { className: "flex flex-col h-screen bg-gray-900 text-gray-200" },
          e(
            "div",
            {
              id: "title-bar",
              className: "flex items-center justify-between bg-gray-800 p-3 shadow-md flex-shrink-0",
            },
            e(
              "div",
              { className: "flex items-center" },
              e(
                "svg",
                {
                  xmlns: "http://www.w3.org/2000/svg",
                  className: "h-6 w-6 mr-2 text-blue-400",
                  fill: "none",
                  viewBox: "0 0 24 24",
                  stroke: "currentColor",
                },
                e("path", {
                  strokeLinecap: "round",
                  strokeLinejoin: "round",
                  strokeWidth: 2,
                  d: "M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z",
                })
              ),
              e("span", { className: "font-bold text-lg" }, "Standalone VR Generator")
            ),
            // Management buttons will be added here in a later step
            e(
              "div",
              { className: "flex items-center space-x-3" },
              e(
                "button",
                {
                  onClick: () => setTemplateManagerOpen(true),
                  className: "bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-3 rounded-md transition-colors duration-200 text-sm inline-flex items-center",
                  title: "Manage VR Templates",
                },
                e("svg", { xmlns: "http://www.w3.org/2000/svg", className: "h-4 w-4 inline mr-1", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor" },
                  e("path", { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" })
                ),
                "Templates"
              ),
              e(
                "button",
                {
                  // onClick will be added later
                  className: "bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-3 rounded-md transition-colors duration-200 text-sm inline-flex items-center",
                  title: "View VR Request History",
                },
                e("svg", { xmlns: "http://www.w3.org/2000/svg", className: "h-4 w-4 inline mr-1", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor" },
                  e("path", { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" })
                ),
                "History"
              ),
              e(
                "button",
                {
                  onClick: handleSave,
                  disabled: !isDirty,
                  className: "bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-3 rounded-md transition-colors duration-200 text-sm inline-flex items-center disabled:opacity-50 disabled:cursor-not-allowed",
                  title: "Save Data File",
                },
                e("svg", { xmlns: "http://www.w3.org/2000/svg", className: "h-4 w-4 inline mr-1", fill: "none", viewBox: "0 0 24 24", stroke: "currentColor" },
                  e("path", { strokeLinecap: "round", strokeLinejoin: "round", strokeWidth: 2, d: "M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" })
                ),
                "Save"
              )
            )
          ),
          renderContent(),
          isTemplateManagerOpen && e(TemplateManagerModal, {
            isOpen: isTemplateManagerOpen,
            onClose: () => setTemplateManagerOpen(false),
            fullData: fullData
          })
        );
      }

      // --- Global Utility Functions ---
      function showToast(message, type = "success") {
        const container = document.getElementById("toast-container");
        if (!container) return;
        const toastElement = document.createElement("div");
        toastElement.className = `toast ${type}`;
        toastElement.textContent = message;
        container.appendChild(toastElement);
        setTimeout(() => toastElement.classList.add("show"), 10);
        setTimeout(() => {
          toastElement.classList.remove("show");
          toastElement.addEventListener("transitionend", () =>
            toastElement.remove()
          );
        }, 3000);
      }

      // --- Mount the React Application ---
      const container = document.getElementById("root");
      const root = ReactDOM.createRoot(container);
      root.render(e(App));
    </script>
  </body>
</html>