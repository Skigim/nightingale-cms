<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nightingale CMS (React)</title>
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <style>
      * {
        box-sizing: border-box;
      }
      html,
      body,
      #root {
        margin: 0;
        padding: 0;
        height: 100%;
        width: 100%;
        overflow: hidden;
      }
    </style>

    <!-- Polyfill for DevTools compatibility in local files -->
    <script>
      (function () {
        // Check if we're in a local file environment
        if (window.location.protocol === 'file:') {
          // Monkey-patch fetch to handle DevTools file protocol rejections
          const originalFetch = window.fetch;
          window.fetch = function (url, options) {
            if (url.includes('devtools') || url.includes('chrome-extension')) {
              return Promise.reject(new Error('DevTools fetch blocked in file protocol'));
            }
            return originalFetch.apply(this, arguments);
          };

          // Also handle XMLHttpRequest rejections for DevTools
          const OriginalXHR = window.XMLHttpRequest;
          window.XMLHttpRequest = function () {
            const xhr = new OriginalXHR();
            const originalOpen = xhr.open;
            xhr.open = function (method, url, async, user, password) {
              if (url.includes('devtools') || url.includes('chrome-extension')) {
                // Simulate a network error for DevTools requests
                setTimeout(() => {
                  if (xhr.onerror) {
                    xhr.onerror(new Error('DevTools XHR blocked in file protocol'));
                  }
                }, 0);
                return;
              }
              return originalOpen.call(this, method, url, async, user, password);
            };
            return xhr;
          };

          // Suppress console errors for DevTools-related failures
          const originalConsoleError = console.error;
          console.error = function (...args) {
            const message = args.join(' ');
            if (
              message.includes('DevTools') ||
              message.includes('chrome-extension') ||
              message.includes('_generated_background_page.html') ||
              message.includes('Failed to load resource') ||
              message.includes('net::ERR_FAILED')
            ) {
              // Suppress DevTools-related errors in file protocol
              return;
            }
            return originalConsoleError.apply(this, args);
          };

          // Suppress unhandled promise rejections for DevTools
          window.addEventListener('unhandledrejection', function (e) {
            if (
              e.reason?.message?.includes('DevTools') ||
              e.reason?.message?.includes('chrome-extension') ||
              e.reason?.stack?.includes('devtools') ||
              e.reason?.stack?.includes('chrome-extension') ||
              e.reason?.stack?.includes('fileFetcher.js')
            ) {
              console.warn('🔇 Suppressed DevTools fetch rejection');
              e.preventDefault();
              return false;
            }
          });
        }
      })();
    </script>

    <!-- Tailwind CSS CDN - TODO: Replace with build-time compilation for production -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />

    <!-- React and Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Nightingale Core Utilities -->
    <script src="./src/services/core.js"></script>
    <script src="./src/services/ui.js"></script>
    <script src="./src/services/cms.js"></script>

    <!-- Unregister any existing service workers -->
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function (registrations) {
          for (let registration of registrations) {
            registration.unregister();
          }
        });
      }
    </script>

    <!-- Nightingale Service Initializer (loads services dynamically) -->
    <script src="./src/services/index.js"></script>

    <!-- Combined Autosave & File Service -->
    <script src="./src/services/nightingale.autosavefile.js"></script>

    <!-- Nightingale Component Library - Layered Architecture -->
    <script src="./src/components/index.js"></script>

    <!-- Components will be loaded automatically by the layered architecture:
         🎨 UI Layer: Button, Badge, DataTable, FormComponents, SearchBar, Modal, StepperModal, Stepper, Sidebar, Header, ErrorBoundary
         🏢 Business Layer: CaseCreationModal (with integrated steps), PersonCreationModal, OrganizationModal, CaseDetailsView, SettingsModal, NightingaleCMSApp
    -->

    <!-- Day.js for date management -->
    <script src="./src/assets/dayjs.min.js"></script>

    <!-- Development Tools -->
    <script>
      // Debug Tools for Development
      window.NightingaleDevTools = {
        // Data inspector
        inspectData: (data) => {
          console.group('📊 Data Inspector');
          console.log('Data Structure:', data);
          console.log('Data Type:', typeof data);
          console.log('Is Array:', Array.isArray(data));
          console.log('Keys:', data ? Object.keys(data) : 'No data');
          if (data?.cases) console.log('Cases:', data.cases.length);
          if (data?.people) console.log('People:', data.people.length);
          if (data?.organizations) console.log('Organizations:', data.organizations.length);
          if (data?.vrRequests) console.log('VR Requests:', data.vrRequests.length);
          console.groupEnd();
        },

        // Component state debugger
        debugComponent: (componentName, state) => {
          console.group(`🎯 Component Debug: ${componentName}`);
          console.log('State:', state);
          console.groupEnd();
        },

        // Data flow logger
        logDataFlow: (action, details) => {
          console.log(`📊 Data Flow: ${action}`);
          console.log('Timestamp:', new Date().toISOString());
          console.log('Data:', details);
        },

        // Connection checker
        checkDevToolsConnection: () => {
          console.group('🔌 React DevTools Connection Status');
          console.log('DevTools Hook Available:', !!window.__REACT_DEVTOOLS_GLOBAL_HOOK__);
          console.log('React Available:', !!window.React);
          console.log('ReactDOM Available:', !!window.ReactDOM);
          console.log('React Version:', window.React?.version || 'Unknown');
          console.log('File Protocol:', window.location.protocol === 'file:');
          console.log('DevTools Renderers:', window.__REACT_DEVTOOLS_GLOBAL_HOOK__?.renderers?.size || 0);
          console.log('DevTools Operations:', typeof window.__REACT_DEVTOOLS_GLOBAL_HOOK__?.onCommitFiberRoot);
          console.groupEnd();
        },

        // Quick debugging shortcuts
        debugCases: () => window.NightingaleDevTools.inspectData(window.nightingaleData?.cases),
        debugActiveView: () => console.log('Active View:', window.nightingaleActiveView),
      };
    </script>

    <!-- Application Initialization Service -->
    <script src="./src/services/app-init.js"></script>
  </head>

  <body>
    <div id="root"></div>

    <script type="text/babel">
      // Main app React hooks
      const { useState, useEffect, useMemo, useCallback, useRef } = React;
      const { createRoot } = ReactDOM;
      const e = React.createElement;

      // Component variables - will be assigned during initialization
      let PrimaryButton, SecondaryButton, Modal, SearchBar;
      // Note: DataTable is loaded separately from the component library

      // Global toast function for services (loaded from toast service)
      const showToast = window.showToast || function (message, type = 'info') {
        console.log(`Toast ${type}: ${message}`);
      };

      // The application will be initialized by the app-init.js service
      // All component functions have been extracted to separate files
      // and are loaded automatically by the component library system
    </script>
  </body>
</html>