<!doctype html>
<html
  lang="en"
  class="h-full bg-gray-900 text-white"
>
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0"
    />
    <title>Nightingale Reporting</title>
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com https://unpkg.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src https://fonts.gstatic.com;"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="../assets/dayjs.min.js"></script>
    <script src="../assets/dayjs-relativeTime.min.js"></script>
    <script src="../assets/dayjs-customParseFormat.min.js"></script>
    <script>
      // Initialize Day.js plugins
      if (typeof dayjs !== 'undefined') {
        dayjs.extend(window.dayjs_plugin_relativeTime);
        dayjs.extend(window.dayjs_plugin_customParseFormat);
      }
    </script>
    <script src="../services/core.js"></script>
    <script src="../services/ui.js"></script>
    <script src="../services/cms.js"></script>
    <script src="../services/nightingale.dayjs.js"></script>
    <script src="../services/nightingale.autosavefile.js"></script>
    <script src="../services/nightingale.toast.js"></script>
    <script src="../components/index.js"></script>

    <!-- Lodash for reliable utility functions -->
    <script src="https://unpkg.com/lodash@4.17.21/lodash.min.js"></script>

    <link
      rel="preconnect"
      href="https://fonts.googleapis.com"
    />
    <link
      rel="preconnect"
      href="https://fonts.gstatic.com"
      crossorigin
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      html {
        font-family: 'Inter', sans-serif;
      }
      /* Custom scrollbar */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #1f2937;
      }
      ::-webkit-scrollbar-thumb {
        background: #4b5563;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #6b7280;
      }
      /* Softer focus ring */
      input:focus,
      select:focus,
      textarea:focus {
        --tw-ring-color: rgba(96, 165, 250, 0.5);
      }

      /* Modal Styling */
      #modal-layer {
        pointer-events: none;
      }
      .modal {
        pointer-events: auto;
      }
      .drag-handle {
        cursor: move;
      }

      /* Toast notification styles */
      .toast {
        padding: 0.75rem 1.25rem;
        border-radius: 0.5rem;
        color: white;
        box-shadow:
          0 4px 6px -1px rgb(0 0 0 / 0.1),
          0 2px 4px -2px rgb(0 0 0 / 0.1);
        opacity: 0;
        transform: translateX(100%);
        transition:
          opacity 0.3s ease,
          transform 0.3s ease;
      }
      .toast.show {
        opacity: 1;
        transform: translateX(0);
      }
      .toast.success {
        background-color: #22c55e;
      } /* green-500 */
      .toast.error {
        background-color: #ef4444;
      } /* red-500 */

      /* Print-specific styles */
      @media print {
        body * {
          visibility: hidden;
        }
        #report-preview,
        #report-preview * {
          visibility: visible;
        }
        #report-preview {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
        }
        table {
          color: black !important;
          border-collapse: collapse;
        }
        th,
        td {
          border: 1px solid #ccc;
          padding: 8px;
        }
        th {
          background-color: #f2f2f2;
        }
      }
    </style>
  </head>
  <body class="h-full bg-gray-900 text-white">
    <div id="root"></div>
    <div
      id="toast-container"
      class="fixed bottom-6 right-6 z-[2000] flex flex-col gap-3"
    ></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="text/babel">
      // Since MUI doesn't have UMD builds, let's create a simpler custom table
      // that mimics MUI styling but uses basic React components

      // Custom Material-styled components
      const CustomTableContainer = ({ children, className = '' }) =>
        e(
          'div',
          {
            className: `${className} bg-gray-800 rounded-lg shadow-lg overflow-hidden border border-gray-700`,
          },
          children,
        );

      const CustomTable = ({ children, className = '' }) =>
        e(
          'table',
          {
            className: `${className} w-full text-left text-sm`,
          },
          children,
        );

      const CustomTableHead = ({ children, className = '' }) =>
        e(
          'thead',
          {
            className: `${className} bg-gray-700 text-xs uppercase sticky top-0`,
          },
          children,
        );

      const CustomTableBody = ({ children, className = '' }) => e('tbody', { className }, children);

      const CustomTableRow = ({ children, className = '', onClick, hover }) =>
        e(
          'tr',
          {
            className: `${className} ${hover ? 'hover:bg-gray-700/50' : ''} ${onClick ? 'cursor-pointer' : ''}`,
            onClick,
          },
          children,
        );

      const CustomTableCell = ({ children, className = '', padding, onClick, style }) => {
        const paddingClass = padding === 'checkbox' ? 'px-2 py-2' : 'px-4 py-2';
        const hoverClass = onClick ? 'hover:bg-gray-600 transition-colors duration-200' : '';
        return e(
          'td',
          {
            className: `${className} border-t border-gray-700 ${paddingClass} ${hoverClass}`,
            onClick,
            style,
          },
          children,
        );
      };

      const CustomTableHeaderCell = ({ children, className = '', onClick }) =>
        e(
          'th',
          {
            className: `${className} px-4 py-2 ${onClick ? 'cursor-pointer hover:bg-gray-600' : ''}`,
            onClick,
          },
          children,
        );

      const CustomCheckbox = ({ checked, onChange, className = '' }) =>
        e('input', {
          type: 'checkbox',
          checked,
          onChange,
          className: `${className} h-4 w-4 rounded border-gray-500 text-blue-500 focus:ring-blue-500 focus:ring-2`,
        });

      const CustomSortLabel = ({ children, active, direction, onClick }) => {
        const sortIcon = active ? (direction === 'asc' ? ' ▲' : ' ▼') : '';
        return e(
          'span',
          {
            className: 'select-none flex items-center space-x-1',
            onClick,
          },
          e('span', null, children),
          e(
            'span',
            {
              className: `text-blue-300 ${active ? 'text-blue-400' : 'text-gray-500'}`,
            },
            sortIcon,
          ),
        );
      };

      const CustomPagination = ({
        count,
        page,
        rowsPerPage,
        onPageChange,
        onRowsPerPageChange,
        rowsPerPageOptions = [10, 25, 50, 100],
      }) => {
        const totalPages = Math.ceil(count / rowsPerPage);
        const startItem = page * rowsPerPage + 1;
        const endItem = Math.min((page + 1) * rowsPerPage, count);

        return e(
          'div',
          {
            className: 'flex items-center justify-between px-4 py-2 bg-gray-750 border-t border-gray-700',
          },
          e(
            'div',
            { className: 'flex items-center space-x-2' },
            e('span', { className: 'text-sm text-gray-300' }, 'Rows per page:'),
            e(
              'select',
              {
                value: rowsPerPage,
                onChange: onRowsPerPageChange,
                className: 'ml-2 bg-gray-600 text-white border-gray-500 rounded px-2 py-1 text-sm',
              },
              rowsPerPageOptions.map((option) => e('option', { key: option, value: option }, option)),
            ),
          ),
          e(
            'div',
            { className: 'flex items-center space-x-4' },
            e('span', { className: 'text-sm text-gray-300' }, `${startItem}-${endItem} of ${count}`),
            e(
              'div',
              { className: 'flex items-center space-x-2' },
              e(
                'button',
                {
                  onClick: () => onPageChange(null, page - 1),
                  disabled: page === 0,
                  className:
                    'px-2 py-1 text-sm bg-gray-600 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-500',
                },
                '‹',
              ),
              e(
                'button',
                {
                  onClick: () => onPageChange(null, page + 1),
                  disabled: page >= totalPages - 1,
                  className:
                    'px-2 py-1 text-sm bg-gray-600 text-white rounded disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-500',
                },
                '›',
              ),
            ),
          ),
        );
      };

      const { useState, useEffect, useCallback, useMemo, useRef } = React;
      const e = React.createElement;

      // --- Utility Functions ---

      /**
       * Parses the raw text from a "List Position Alert" CSV report.
       * This function is ported from the original vanilla JS application.
       * @param {string} rawText The raw string content from the report file.
       * @returns {Array<Object>} An array of objects representing parsed alert records.
       */
      function parseAlertReport(rawText) {
        if (!rawText || typeof rawText !== 'string') return [];
        const records = [];
        const lines = rawText.split('\n').filter((line) => line.trim() !== '');
        const csvRegex = /(".*?"|[^",]+)(?=\s*,|\s*$)/g;

        for (const line of lines) {
          const columns = Array.from(line.matchAll(csvRegex), (match) => match[1]);
          if (columns.length >= 12) {
            const alertDate = columns[columns.length - 12]?.replace(/"/g, '').trim();
            const mcn = columns[columns.length - 11]?.replace(/"/g, '').trim();
            const name = columns[columns.length - 10]?.replace(/"/g, '').trim();
            const alertType = columns[columns.length - 7]?.replace(/"/g, '').trim();
            if (mcn && name && alertType && alertDate) {
              records.push({ mcn, name, alertType, alertDate });
            }
          }
        }
        return records;
      }

      // --- Application-Specific Components ---

      function CustomReportModal({ isOpen, onClose, onGenerate, cases }) {
        const [selectedStatuses, setSelectedStatuses] = useState([]);
        const [selectedColumns, setSelectedColumns] = useState(['status', 'appDate']);
        const uniqueStatuses = useMemo(() => [...new Set(cases.map((c) => c.status).filter(Boolean))].sort(), [cases]);

        useEffect(() => {
          if (isOpen) {
            setSelectedStatuses(uniqueStatuses.filter((s) => s !== 'Closed'));
          }
        }, [isOpen, uniqueStatuses]);

        const handleStatusChange = (status) =>
          setSelectedStatuses((prev) => (prev.includes(status) ? prev.filter((s) => s !== status) : [...prev, status]));
        const handleColumnChange = (column) =>
          setSelectedColumns((prev) => (prev.includes(column) ? prev.filter((c) => c !== column) : [...prev, column]));

        const columnOptions = [
          { key: 'status', label: 'Status' },
          { key: 'appDate', label: 'App Date' },
          { key: 'daysPending', label: 'Days Pending' },
          { key: 'lastWorked', label: 'Last Worked' },
          { key: 'caseType', label: 'Case Type' },
          { key: 'spouseName', label: 'Spouse Name' },
          { key: 'facilityName', label: 'Facility Name' },
          { key: 'vrsPending', label: 'Verifications' },
        ];

        const footer = e(
          React.Fragment,
          null,
          e(
            'button',
            {
              onClick: onClose,
              className: 'bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-md',
            },
            'Cancel',
          ),
          e(
            'button',
            {
              onClick: () =>
                onGenerate({
                  statuses: selectedStatuses,
                  columns: selectedColumns,
                }),
              className: 'bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md',
            },
            'Generate Report',
          ),
        );

        return e(
          Modal,
          {
            isOpen,
            onClose,
            title: 'Custom Case Report',
            footerContent: footer,
          },
          e(
            'div',
            { className: 'flex flex-col md:flex-row gap-6' },
            e(
              'div',
              { className: 'space-y-4 flex-1' },
              e('h3', { className: 'text-lg font-semibold text-blue-400' }, '1. Filter Cases by Status'),
              e(
                'div',
                { className: 'mt-2 space-y-2 text-sm' },
                uniqueStatuses.map((status) =>
                  e(
                    'label',
                    { key: status, className: 'flex items-center' },
                    e('input', {
                      type: 'checkbox',
                      value: status,
                      checked: selectedStatuses.includes(status),
                      onChange: () => handleStatusChange(status),
                      className: 'h-4 w-4 rounded border-gray-500 text-blue-500 mr-3',
                    }),
                    e('span', null, status),
                  ),
                ),
              ),
            ),
            e(
              'div',
              { className: 'space-y-4 flex-1' },
              e('h3', { className: 'text-lg font-semibold text-blue-400' }, '2. Select Columns'),
              e(
                'div',
                { className: 'space-y-2 text-sm grid grid-cols-2' },
                columnOptions.map((col) =>
                  e(
                    'label',
                    { key: col.key, className: 'flex items-center' },
                    e('input', {
                      type: 'checkbox',
                      value: col.key,
                      checked: selectedColumns.includes(col.key),
                      onChange: () => handleColumnChange(col.key),
                      className: 'h-4 w-4 rounded border-gray-500 text-blue-500 mr-3',
                    }),
                    e('span', null, col.label),
                  ),
                ),
              ),
            ),
          ),
        );
      }

      function VrDetailModal({ vr, fullData, onClose, onUpdate, onDelete }) {
        if (!vr) return null;

        const renderActions = () => {
          if (vr['Status'] === 'Pending') {
            return e(
              'button',
              {
                onClick: () => onUpdate(vr['ID'], 'Returned'),
                className: 'bg-yellow-600 hover:bg-yellow-700 text-white text-sm font-semibold py-1 px-3 rounded-md',
              },
              'Return',
            );
          }
          if (vr['Status'] === 'Returned') {
            return e(
              React.Fragment,
              null,
              e(
                'button',
                {
                  onClick: () => onUpdate(vr['ID'], 'Pending'),
                  className: 'bg-gray-500 hover:bg-gray-600 text-white text-sm font-semibold py-1 px-3 rounded-md',
                },
                'Reset',
              ),
              e(
                'div',
                { className: 'flex items-center gap-2 w-full' },
                e('input', {
                  type: 'text',
                  placeholder: 'Verification Source...',
                  id: `modal-vr-source-${vr['ID']}`,
                  className: 'bg-gray-600 text-sm p-2 rounded-md w-full',
                }),
                e(
                  'button',
                  {
                    onClick: () => {
                      const source = document.getElementById(`modal-vr-source-${vr['ID']}`).value;
                      if (!source.trim()) return showToast('Verification source is required.', 'error');
                      onUpdate(vr['ID'], 'Verified', source);
                    },
                    className: 'bg-green-600 hover:bg-green-700 text-white text-sm font-semibold py-1 px-3 rounded-md',
                  },
                  'Verify',
                ),
              ),
            );
          }
          return null;
        };

        const footer = e(
          React.Fragment,
          null,
          e(
            'button',
            {
              onClick: () => onDelete(vr['ID']),
              className: 'bg-red-600 hover:bg-red-700 text-white text-sm font-semibold py-1 px-3 rounded-md mr-auto',
            },
            'Delete',
          ),
          e(
            'button',
            {
              onClick: onClose,
              className: 'bg-gray-600 hover:bg-gray-700 text-white text-sm font-semibold py-1 px-3 rounded-md',
            },
            'Cancel',
          ),
          renderActions(),
        );

        // Find the full VR object to get the content
        const vrContent = fullData?.vrRequests?.find((r) => r.id === vr['ID'])?.content || 'Content not found.';

        return e(
          Modal,
          {
            isOpen: !!vr,
            onClose,
            title: `VR Details for ${vr['Name']} (${vr['MCN']})`,
            footerContent: footer,
          },
          e(
            'pre',
            {
              className:
                'text-sm text-gray-200 whitespace-pre-wrap font-mono leading-relaxed bg-gray-900/50 p-4 rounded-md',
            },
            vrContent,
          ),
        );
      }

      function SavedReportsModal({
        isOpen,
        onClose,
        onRunAlertReport,
        reportConfigs,
        onRunSavedReport,
        onDeleteReportConfig,
      }) {
        const fileInputRef = useRef(null);

        const handleFileSelected = (event) => {
          const file = event.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = (e) => onRunAlertReport(e.target.result);
          reader.readAsText(file);
          event.target.value = '';
        };

        const footer = e(
          'button',
          {
            onClick: onClose,
            className: 'bg-gray-600 hover:bg-gray-700 text-white text-sm font-semibold py-1 px-3 rounded-md',
          },
          'Close',
        );

        return e(
          Modal,
          { isOpen, onClose, title: 'Run a Report', footerContent: footer },
          e('input', {
            type: 'file',
            ref: fileInputRef,
            className: 'hidden',
            accept: '.csv,.txt',
            onChange: handleFileSelected,
          }),
          e(
            'div',
            { className: 'space-y-6' },
            e(
              'div',
              null,
              e('h3', { className: 'text-lg font-semibold text-blue-400 mb-3' }, 'My Saved Reports'),
              e(
                'div',
                { className: 'space-y-2' },
                reportConfigs && reportConfigs.length > 0
                  ? reportConfigs.map((config) =>
                      e(
                        'div',
                        {
                          key: config.id,
                          className: 'bg-gray-700/50 p-3 rounded-md flex items-center justify-between',
                        },
                        e('span', { className: 'font-medium' }, config.name),
                        e(
                          'div',
                          { className: 'flex items-center gap-2' },
                          e(
                            'button',
                            {
                              onClick: () => onDeleteReportConfig(config.id),
                              className:
                                'bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-2 rounded-md text-xs',
                            },
                            'Delete',
                          ),
                          e(
                            'button',
                            {
                              onClick: () => onRunSavedReport(config),
                              className:
                                'bg-blue-600 hover:bg-blue-700 text-white font-bold py-1 px-2 rounded-md text-xs',
                            },
                            'Run',
                          ),
                        ),
                      ),
                    )
                  : e('p', { className: 'text-gray-500' }, 'You have no saved reports.'),
              ),
            ),
            e(
              'div',
              null,
              e('h3', { className: 'text-lg font-semibold text-blue-400 mb-3' }, 'Preset Reports'),
              e(
                'div',
                { className: 'space-y-2' },
                e(
                  'div',
                  {
                    className: 'bg-gray-700/50 p-3 rounded-md flex items-center justify-between',
                  },
                  e(
                    'div',
                    null,
                    e('div', { className: 'font-medium text-teal-300' }, 'Alerts Report'),
                    e('div', { className: 'text-sm text-gray-400' }, 'Parse a List Position Alert .CSV file'),
                  ),
                  e(
                    'button',
                    {
                      onClick: () => fileInputRef.current.click(),
                      className: 'bg-teal-600 hover:bg-teal-700 text-white font-bold py-1 px-2 rounded-md text-xs',
                    },
                    'Run',
                  ),
                ),
              ),
            ),
          ),
        );
      }

      function App() {
        const [fullData, setFullData] = useState(null);
        const [reportData, setReportData] = useState([]);
        const [sortState, setSortState] = useState({
          key: 'Name',
          direction: 'asc',
        });
        const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
        const [isCustomReportModalOpen, setCustomReportModalOpen] = useState(false);
        const [isSavedReportsModalOpen, setSavedReportsModalOpen] = useState(false);
        const [viewingVr, setViewingVr] = useState(null);
        const [currentReportConfig, setCurrentReportConfig] = useState(null);
        const [selectedRows, setSelectedRows] = useState(new Set()); // Add this line for checkbox state

        const fileService = useMemo(
          () =>
            new AutosaveFileService({
              tabId: `reports-react-tab-${Date.now()}`,
              errorCallback: showToast,
              sanitizeFn: sanitize,
            }),
          [],
        );

        const loadInitialData = useCallback(async () => {
          try {
            const { handle, permission } = await fileService.restoreLastDirectoryAccess();
            if (!handle || permission !== 'granted') {
              setError('Please connect to your Nightingale data directory to use the reporting app.');
              setLoading(false);
              return;
            }
            const data = await fileService.readFile();
            if (data && data.cases) {
              // Ensure the reportConfigs array exists for storing user-saved reports.
              data.reportConfigs = data.reportConfigs || [];
              setFullData(data);
            } else {
              setError('Could not find valid data in the connected directory.');
            }
          } catch (err) {
            setError(`Failed to load data: ${err.message}`);
          } finally {
            setLoading(false);
          }
        }, [fileService]);

        useEffect(() => {
          loadInitialData().then(() => showToast('Data loaded successfully.', 'success'));
        }, [loadInitialData]);

        const handleDataUpdate = async (updatedData) => {
          const success = await fileService.writeFile(updatedData);
          if (success) {
            setFullData(updatedData);
            showToast('Data file updated successfully.', 'success');
            return true;
          } else {
            showToast('Failed to save updated data file.', 'error');
            return false;
          }
        };

        const handleVrUpdate = async (vrId, newStatus, source = '') => {
          const newData = _.cloneDeep(fullData);
          const vrRequest = newData.vrRequests.find((vr) => vr.id === vrId);
          if (!vrRequest) return;

          vrRequest.status = newStatus;
          const caseData = newData.cases.find((c) => c.id === vrRequest.caseId);
          if (!caseData) return;

          const allCaseFinancials = [
            ...(caseData.financials?.resources || []),
            ...(caseData.financials?.income || []),
            ...(caseData.financials?.expenses || []),
          ];

          vrRequest.financialItemIds.forEach((itemId) => {
            const item = allCaseFinancials.find((i) => i.id === itemId);
            if (item) {
              if (newStatus === 'Returned' && item.verificationStatus === 'VR Pending') {
                item.verificationStatus = 'AVS Pending';
              } else if (newStatus === 'Verified' && item.verificationStatus === 'AVS Pending') {
                item.verificationStatus = 'Verified';
                item.source = source;
              } else if (newStatus === 'Pending' && item.verificationStatus === 'AVS Pending') {
                item.verificationStatus = 'VR Pending'; // Add this logic to handle the reset
              }
            }
          });

          if (await handleDataUpdate(newData)) {
            setViewingVr(null); // Close the modal
            handleGenerateVrReport(); // Refresh the report view
          }
        };

        const handleVrDelete = async (vrId) => {
          const newData = _.cloneDeep(fullData);
          newData.vrRequests = newData.vrRequests.filter((vr) => vr.id !== vrId);
          if (await handleDataUpdate(newData)) {
            setViewingVr(null); // Close the modal
            handleGenerateVrReport();
          }
        };

        const handleGenerateCustomReport = useCallback(
          (options) => {
            if (!fullData) return;
            const { statuses, columns } = options;
            const filteredCases = fullData.cases.filter((c) => statuses.length === 0 || statuses.includes(c.status));

            const newReportData = filteredCases.map((c) => {
              const person = fullData.people.find((p) => p.id === parseInt(c.personId)) || {};
              const row = {
                MCN: c.mcn || 'N/A',
                Name: person.name || 'N/A',
              };
              columns.forEach((colKey) => {
                switch (colKey) {
                  case 'status':
                    row['Status'] = c.status || 'N/A';
                    break;
                  case 'appDate':
                    row['Application Date'] = dateUtils.format(c.appDetails?.appDate);
                    break;
                  case 'caseType':
                    row['Case Type'] = c.appDetails?.caseType || 'N/A';
                    break;
                  case 'spouseName':
                    const spouse = person.spouseId ? fullData.people.find((p) => p.id === person.spouseId) : null;
                    row['Spouse Name'] = spouse ? spouse.name : 'N/A';
                    break;
                  case 'facilityName':
                    const org = person.organizationId
                      ? fullData.organizations.find((o) => o.id === person.organizationId)
                      : null;
                    row['Facility Name'] = org ? org.name : 'N/A';
                    break;
                  case 'daysPending':
                    if (['Active', 'Closed'].includes(c.status) || !c.appDetails?.appDate) {
                      row['Days Pending'] = 'N/A';
                    } else {
                      row['Days Pending'] = dayjs().diff(dayjs(c.appDetails.appDate), 'day');
                    }
                    break;
                  case 'lastWorked':
                    row['Last Worked'] = dateUtils.format(c.lastOpened);
                    break;
                  case 'vrsPending':
                    // Count pending and overdue VR requests for this case
                    if (fullData.vrRequests) {
                      const caseVrs = fullData.vrRequests.filter((vr) => vr.caseId === c.id && vr.status === 'Pending');
                      const totalPending = caseVrs.length;

                      // Count overdue VRs (due date is in the past)
                      const today = dayjs();
                      const overdue = caseVrs.filter((vr) => {
                        if (!vr.dueDate) return false;
                        return dayjs(vr.dueDate).isBefore(today, 'day');
                      }).length;

                      // Format as "#Pending (#Due)" or just "#Pending" if no overdue
                      if (overdue > 0) {
                        row['Verifications'] = `${totalPending} (${overdue} due)`;
                      } else {
                        row['Verifications'] = totalPending.toString();
                      }
                    } else {
                      row['Verifications'] = '0';
                    }
                    break;
                }
              });
              return row;
            });
            setReportData(newReportData);
            setSortState({ key: 'Name', direction: 'asc' });
            setCurrentReportConfig(options); // Remember the settings for the generated report
            setCustomReportModalOpen(false);
            showToast(`Generated a report with ${newReportData.length} cases.`, 'success');
          },
          [fullData],
        );

        const handleSaveReportConfig = async () => {
          if (!currentReportConfig) {
            showToast('Please generate a report before saving its configuration.', 'error');
            return;
          }

          const reportName = prompt('Please enter a name for this report configuration:');
          if (!reportName || !reportName.trim()) {
            showToast('Save cancelled: A name is required.', 'warning');
            return;
          }

          const newConfig = {
            id: `report-${Date.now()}`,
            name: reportName.trim(),
            ...currentReportConfig,
          };

          const newData = _.cloneDeep(fullData);
          newData.reportConfigs.push(newConfig);

          await handleDataUpdate(newData);
        };

        const handleRunSavedReport = (config) => {
          // We can reuse the existing custom report handler
          handleGenerateCustomReport(config);
          setSavedReportsModalOpen(false); // Close the modal after running
        };

        const handleDeleteReportConfig = async (configId) => {
          if (!confirm('Are you sure you want to delete this saved report?')) return;

          const newData = _.cloneDeep(fullData);
          newData.reportConfigs = newData.reportConfigs.filter((rc) => rc.id !== configId);

          await handleDataUpdate(newData);
        };

        const handleAddToTodo = async () => {
          if (selectedRows.size === 0) {
            showToast('No rows selected.', 'error');
            return;
          }

          // Read the latest data file to avoid overwriting concurrent changes
          const currentData = await fileService.readFile();
          if (!currentData) {
            showToast('Could not read data file. Action cancelled.', 'error');
            return;
          }

          currentData.todos = currentData.todos || [];
          const todaysDate = dateUtils.formatToday('M/D/YYYY');

          let parentTask = currentData.todos.find((task) => task.text === todaysDate && task.type === 'multi');

          if (!parentTask) {
            parentTask = {
              id: `task-${Date.now()}`,
              text: todaysDate,
              createdAt: dateUtils.now(),
              type: 'multi',
              subtasks: [],
              isCollapsed: false,
              notes: 'Auto-generated from Reporting App',
            };
            currentData.todos.unshift(parentTask);
          }

          const existingSubtaskTexts = new Set(parentTask.subtasks.map((s) => s.text));
          let newSubtasksCount = 0;

          selectedRows.forEach((mcn) => {
            const rowData = reportData.find((r) => r['MCN'] === mcn);
            if (rowData) {
              const subtaskText = `${rowData['MCN']} - ${rowData['Name']}`;
              if (!existingSubtaskTexts.has(subtaskText)) {
                parentTask.subtasks.push({
                  id: `subtask-${Date.now()}-${Math.random()}`,
                  text: subtaskText,
                  completed: false,
                  notes: '',
                });
                newSubtasksCount++;
              }
            }
          });

          if (newSubtasksCount === 0) {
            showToast("All selected items already exist in today's task list.", 'success');
            return;
          }

          if (await handleDataUpdate(currentData)) {
            showToast(`${newSubtasksCount} new task(s) added to '${todaysDate}'.`, 'success');
            setSelectedRows(new Set()); // Clear selection
          }
        };

        const handleGenerateVrReport = useCallback(() => {
          if (!fullData || !fullData.vrRequests) {
            showToast('No VR requests found in the data file.', 'error');
            return;
          }
          const newReportData = fullData.vrRequests.map((vr) => {
            const caseData = fullData.cases.find((c) => c.id === vr.caseId) || {};
            const person = fullData.people.find((p) => p.id === parseInt(caseData.personId)) || {};
            return {
              MCN: vr.mcn || 'N/A',
              Name: person.name || 'N/A',
              Status: vr.status,
              'Due Date': dateUtils.format(vr.dueDate),
            };
          });
          setReportData(newReportData);
          setSortState({ key: 'Due Date', direction: 'asc' });
          setSavedReportsModalOpen(false);
          showToast(`Generated a report with ${newReportData.length} VRs.`, 'success');
        }, [fullData]);

        const handleParseAlertReport = useCallback((rawText) => {
          const parsedRecords = parseAlertReport(rawText);
          if (parsedRecords.length === 0) {
            showToast('Could not find any valid records in the file.', 'error');
            return;
          }
          const newReportData = parsedRecords.map((r) => ({
            MCN: r.mcn,
            Name: r.name,
            'Alert Type': r.alertType,
            'Alert Date': r.alertDate,
          }));
          setReportData(newReportData);
          setSortState({ key: 'Name', direction: 'asc' });
          setSavedReportsModalOpen(false);
          showToast(`Successfully parsed ${newReportData.length} records.`, 'success');
        }, []);

        return e(
          'div',
          { className: 'flex flex-col h-screen bg-gray-900 text-gray-200' },
          e(Header),
          e(
            'main',
            {
              className: 'flex-grow p-6 bg-gray-900 flex flex-col gap-6 overflow-hidden',
            },
            loading && e('p', { className: 'text-center' }, 'Loading and connecting to data...'),
            error &&
              e(
                'div',
                {
                  className: 'bg-red-800 border border-red-600 text-red-200 p-4 rounded-lg',
                },
                e('h3', { className: 'font-bold' }, 'Connection Error'),
                e('p', null, error),
              ),
            !loading &&
              !error &&
              e(
                React.Fragment,
                null,
                e(ReportControls, {
                  onCustomReportClick: () => setCustomReportModalOpen(true),
                  onSavedReportsClick: () => setSavedReportsModalOpen(true),
                }),
                e(ReportPreview, {
                  reportData,
                  sortState,
                  setSortState,
                  onViewVr: setViewingVr,
                  onSaveConfig: handleSaveReportConfig,
                  selectedRows: selectedRows,
                  setSelectedRows: setSelectedRows,
                  onAddToTodo: handleAddToTodo,
                }),
                e(CustomReportModal, {
                  isOpen: isCustomReportModalOpen,
                  onClose: () => setCustomReportModalOpen(false),
                  onGenerate: handleGenerateCustomReport,
                  cases: fullData ? fullData.cases : [],
                }),
                e(SavedReportsModal, {
                  isOpen: isSavedReportsModalOpen,
                  onClose: () => setSavedReportsModalOpen(false),
                  onRunAlertReport: handleParseAlertReport,
                  reportConfigs: fullData ? fullData.reportConfigs : [],
                  onRunSavedReport: handleRunSavedReport,
                  onDeleteReportConfig: handleDeleteReportConfig,
                }),
                viewingVr &&
                  e(VrDetailModal, {
                    vr: viewingVr,
                    fullData: fullData, // Pass the fullData state down as a prop
                    onClose: () => setViewingVr(null),
                    onUpdate: handleVrUpdate,
                    onDelete: handleVrDelete,
                  }),
              ),
          ),
        );
      }

      function Header() {
        return e(
          'div',
          {
            id: 'title-bar',
            className: 'flex items-center justify-between bg-gray-800 p-3 shadow-md flex-shrink-0',
          },
          e(
            'div',
            { className: 'flex items-center' },
            e(
              'svg',
              {
                xmlns: 'http://www.w3.org/2000/svg',
                className: 'h-6 w-6 mr-2 text-blue-400',
                fill: 'none',
                viewBox: '0 0 24 24',
                stroke: 'currentColor',
              },
              e('path', {
                strokeLinecap: 'round',
                strokeLinejoin: 'round',
                strokeWidth: 2,
                d: 'M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z',
              }),
            ),
            e('span', { className: 'font-bold text-lg' }, 'Nightingale Reporting (React)'),
          ),
        );
      }

      function ReportControls({ onCustomReportClick, onSavedReportsClick }) {
        return e(
          'div',
          {
            id: 'report-header',
            className: 'flex-shrink-0 bg-gray-800 p-4 rounded-lg shadow-lg flex items-center justify-between',
          },
          e('h2', { className: 'text-2xl font-bold text-blue-300' }, 'Reports'),
          e(
            'div',
            { className: 'flex items-center space-x-3' },
            e(
              'button',
              {
                onClick: onCustomReportClick,
                className:
                  'bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200',
              },
              'Custom Report',
            ),
            e(
              'button',
              {
                onClick: onSavedReportsClick,
                className:
                  'bg-gray-600 text-white font-bold py-2 px-4 rounded-md shadow-md transition-all duration-200',
              },
              'Saved Reports',
            ),
          ),
        );
      }

      function ReportPreview({
        reportData,
        sortState,
        setSortState,
        onViewVr,
        onSaveConfig,
        selectedRows,
        setSelectedRows,
        onAddToTodo,
      }) {
        const isVrReport = useMemo(
          () => reportData.length > 0 && reportData[0].hasOwnProperty('Due Date'),
          [reportData],
        );
        const isCustomReport = reportData.length > 0 && !isVrReport;

        const headers = useMemo(() => {
          if (reportData.length === 0) return [];
          return Object.keys(reportData[0]);
        }, [reportData]);

        const sortedData = useMemo(() => {
          if (reportData.length === 0) return [];
          const { key, direction } = sortState;
          return [...reportData].sort((a, b) => {
            const valA = a[key] ?? '';
            const valB = b[key] ?? '';
            if (key === 'Days Pending') {
              const numA = valA === 'N/A' ? -Infinity : valA;
              const numB = valB === 'N/A' ? -Infinity : valB;
              return (numA - numB) * (direction === 'asc' ? 1 : -1);
            }
            return valA.toString().localeCompare(valB.toString()) * (direction === 'asc' ? 1 : -1);
          });
        }, [reportData, sortState]);

        // Pagination state
        const [page, setPage] = useState(0);
        const [rowsPerPage, setRowsPerPage] = useState(25);

        // Reset page when data changes
        useEffect(() => {
          setPage(0);
        }, [reportData]);

        // Paginated data
        const paginatedData = useMemo(() => {
          const startIndex = page * rowsPerPage;
          return sortedData.slice(startIndex, startIndex + rowsPerPage);
        }, [sortedData, page, rowsPerPage]);

        const handleChangePage = (event, newPage) => {
          setPage(newPage);
        };

        const handleChangeRowsPerPage = (event) => {
          setRowsPerPage(parseInt(event.target.value, 10));
          setPage(0);
        };

        const handleSort = (key) => {
          setSortState((prev) => ({
            key,
            direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc',
          }));
        };

        const handleSelectAll = (e) => {
          if (e.target.checked) {
            // Select all MCNs from the entire sorted dataset, not just current page
            const allMcns = new Set(sortedData.map((r) => r['MCN']).filter(Boolean));
            setSelectedRows(allMcns);
          } else {
            setSelectedRows(new Set());
          }
        };

        const handleSelectRow = (mcn) => {
          setSelectedRows((prev) => {
            const newSet = new Set(prev);
            if (newSet.has(mcn)) {
              newSet.delete(mcn);
            } else {
              newSet.add(mcn);
            }
            return newSet;
          });
        };

        // Broadcast channel for CMS communication
        const broadcastChannel = useMemo(() => new BroadcastChannel('nightingale_suite'), []);

        const handleMcnClick = useCallback(
          (mcn, event) => {
            event.stopPropagation();

            if (!mcn || mcn === 'N/A') {
              showToast('MCN not available for this record', 'error');
              return;
            }

            // Send broadcast to load case in CMS (copied from todo app)
            showToast(`Opening case ${mcn} in CMS...`);

            let fallbackTimeout;
            const acknowledgementListener = (event) => {
              if (event.data.type === 'case_shown' && event.data.mcn === mcn) {
                clearTimeout(fallbackTimeout);
                broadcastChannel.removeEventListener('message', acknowledgementListener);
              }
            };

            broadcastChannel.addEventListener('message', acknowledgementListener);
            broadcastChannel.postMessage({ type: 'show_case', mcn });

            fallbackTimeout = setTimeout(() => {
              window.open(`NightingaleCMS.html?mcn=${encodeURL(mcn)}`, '_blank');
              broadcastChannel.removeEventListener('message', acknowledgementListener);
            }, 300);
          },
          [broadcastChannel],
        );

        const handleNameClick = useCallback((name, event) => {
          event.stopPropagation();

          if (!name || name === 'N/A') {
            showToast('Person name not available for this record', 'error');
            return;
          }

          // Placeholder for person loading in CMS (after React refactor)
          showToast('Person loading in CMS - Feature coming after CMS React refactor', 'info');
        }, []);

        const handleVrClick = useCallback((row, header, event) => {
          event.stopPropagation();

          const mcn = row['MCN'];
          if (!mcn || mcn === 'N/A') {
            showToast('MCN not available for this record', 'error');
            return;
          }

          // Load case in Correspondence app for VR management
          showToast(`Opening VR management for case ${mcn}...`);
          window.open(`NightingaleCorrespondence.html?mcn=${encodeURL(mcn)}`, '_blank');
        }, []);

        const handleAppDateClick = useCallback(
          (row, event) => {
            event.stopPropagation();

            const mcn = row['MCN'];
            if (!mcn || mcn === 'N/A') {
              showToast('MCN not available for this record', 'error');
              return;
            }

            // Send broadcast to load case in CMS with Application Details tab
            // Note: CMS will need updates to support tab parameter after React refactor
            showToast(`Opening case ${mcn} with Application Details...`);

            let fallbackTimeout;
            const acknowledgementListener = (event) => {
              if (event.data.type === 'case_shown' && event.data.mcn === mcn) {
                clearTimeout(fallbackTimeout);
                broadcastChannel.removeEventListener('message', acknowledgementListener);
              }
            };

            broadcastChannel.addEventListener('message', acknowledgementListener);
            broadcastChannel.postMessage({
              type: 'show_case',
              mcn,
              tab: 'application_details', // Future enhancement for CMS
            });

            fallbackTimeout = setTimeout(() => {
              window.open(`NightingaleCMS.html?mcn=${encodeURL(mcn)}&tab=application_details`, '_blank');
              broadcastChannel.removeEventListener('message', acknowledgementListener);
            }, 300);
          },
          [broadcastChannel],
        );

        const isAllSelected = sortedData.length > 0 && selectedRows.size === sortedData.filter((r) => r['MCN']).length;

        return e(
          'div',
          {
            id: 'report-preview-container',
            className: 'flex-grow bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col min-h-0',
          },
          e(
            'div',
            {
              className: 'flex justify-between items-center border-b border-gray-700 pb-2 mb-4',
            },
            e('h2', { className: 'text-2xl font-bold text-blue-300' }, 'Report Preview'),
            e(
              'div',
              { className: 'flex items-center space-x-2' },
              isCustomReport &&
                e(
                  'button',
                  {
                    onClick: onSaveConfig,
                    className: 'text-sm bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-3 rounded-md',
                  },
                  'Save Configuration',
                ),
              isCustomReport &&
                e(
                  'button',
                  {
                    onClick: onAddToTodo,
                    disabled: selectedRows.size === 0,
                    className:
                      'text-sm bg-purple-600 hover:bg-purple-700 text-white font-semibold py-1 px-3 rounded-md disabled:opacity-50',
                  },
                  `Add to todo (${selectedRows.size})`,
                ),
            ),
          ),
          sortedData.length > 0 &&
            e(
              'div',
              { className: 'text-sm text-gray-400 mb-2' },
              `Total: ${sortedData.length} records` +
                (selectedRows.size > 0 ? ` | Selected: ${selectedRows.size}` : ''),
            ),
          e(
            'div',
            { id: 'report-preview', className: 'flex-grow overflow-auto' },
            reportData.length === 0
              ? e('p', { className: 'text-center text-gray-500 mt-10' }, 'Generate a report to see the results.')
              : e(
                  CustomTableContainer,
                  { className: 'flex-grow' },
                  e(
                    CustomTable,
                    null,
                    e(
                      CustomTableHead,
                      null,
                      e(
                        CustomTableRow,
                        null,
                        isCustomReport &&
                          e(
                            CustomTableHeaderCell,
                            { className: 'w-10' },
                            e(CustomCheckbox, {
                              checked: isAllSelected,
                              onChange: handleSelectAll,
                            }),
                          ),
                        headers.map((header) =>
                          e(
                            CustomTableHeaderCell,
                            {
                              key: header,
                              onClick: () => handleSort(header),
                            },
                            e(
                              CustomSortLabel,
                              {
                                active: sortState.key === header,
                                direction: sortState.key === header ? sortState.direction : 'asc',
                                onClick: () => handleSort(header),
                              },
                              header,
                            ),
                          ),
                        ),
                      ),
                    ),
                    e(
                      CustomTableBody,
                      null,
                      paginatedData.map((row, index) =>
                        e(
                          CustomTableRow,
                          {
                            key: row['MCN'] || index,
                            hover: true,
                          },
                          isCustomReport &&
                            e(
                              CustomTableCell,
                              { padding: 'checkbox' },
                              e(CustomCheckbox, {
                                checked: selectedRows.has(row['MCN']),
                                onChange: () => handleSelectRow(row['MCN']),
                              }),
                            ),
                          headers.map((header) => {
                            let cellProps = { key: header };
                            let cellContent = row[header];

                            // Add click handlers for specific columns with subtle hover states
                            if (header === 'MCN' && row[header] && row[header] !== 'N/A') {
                              cellProps.onClick = (event) => handleMcnClick(row[header], event);
                              cellProps.style = {
                                cursor: 'pointer',
                              };
                              cellProps.title = 'Click to open case in CMS';
                            } else if (header === 'Name' && row[header] && row[header] !== 'N/A') {
                              cellProps.onClick = (event) => handleNameClick(row[header], event);
                              cellProps.style = {
                                cursor: 'pointer',
                              };
                              cellProps.title = 'Click to view person details';
                            } else if (
                              header === 'Verifications' &&
                              row[header] !== undefined &&
                              row[header] !== 'N/A' &&
                              row[header] !== ''
                            ) {
                              cellProps.onClick = (event) => handleVrClick(row, header, event);
                              cellProps.style = {
                                cursor: 'pointer',
                              };
                              cellProps.title = 'Click to manage VRs in Correspondence app';
                            } else if (
                              header === 'Application Date' &&
                              row[header] &&
                              row[header] !== 'N/A' &&
                              row[header] !== ''
                            ) {
                              cellProps.onClick = (event) => handleAppDateClick(row, event);
                              cellProps.style = {
                                cursor: 'pointer',
                              };
                              cellProps.title = 'Click to open case with Application Details';
                            } else if (
                              header.includes('VR') &&
                              header !== 'Verifications' &&
                              row[header] &&
                              row[header] !== 'N/A' &&
                              row[header] !== '' &&
                              row[header] !== 0
                            ) {
                              cellProps.onClick = (event) => handleVrClick(row, header, event);
                              cellProps.style = {
                                cursor: 'pointer',
                              };
                              cellProps.title = 'Click to manage VRs in Correspondence app';
                            }

                            return e(CustomTableCell, cellProps, cellContent);
                          }),
                        ),
                      ),
                    ),
                  ),
                  e(CustomPagination, {
                    count: sortedData.length,
                    page: page,
                    onPageChange: handleChangePage,
                    rowsPerPage: rowsPerPage,
                    onRowsPerPageChange: handleChangeRowsPerPage,
                    rowsPerPageOptions: [10, 25, 50, 100],
                  }),
                ),
          ),
        );
      }

      // Mount the React application
      const container = document.getElementById('root');
      const root = ReactDOM.createRoot(container);
      root.render(e(App));
    </script>
  </body>
</html>
