<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nightingale CMS Data Migration Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 800px;
            width: 100%;
        }
        
        h1 {
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 28px;
            font-weight: 700;
        }
        
        .subtitle {
            color: #718096;
            margin-bottom: 32px;
            font-size: 16px;
        }
        
        .upload-area {
            border: 3px dashed #cbd5e0;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-bottom: 24px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #667eea;
            background-color: #f7fafc;
        }
        
        .upload-area.dragover {
            border-color: #667eea;
            background-color: #ebf8ff;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-text {
            color: #4a5568;
            font-size: 18px;
            margin-bottom: 8px;
        }
        
        .upload-subtext {
            color: #a0aec0;
            font-size: 14px;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 8px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .results {
            margin-top: 24px;
            padding: 20px;
            background-color: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }
        
        .results h3 {
            color: #2d3748;
            margin-bottom: 12px;
        }
        
        .migration-log {
            background: #1a202c;
            color: #e2e8f0;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            margin: 16px 0;
            white-space: pre-wrap;
        }
        
        .success {
            color: #38a169;
            font-weight: 600;
        }
        
        .error {
            color: #e53e3e;
            font-weight: 600;
        }
        
        .warning {
            color: #d69e2e;
            font-weight: 600;
        }
        
        .download-link {
            display: inline-block;
            margin-top: 16px;
            padding: 12px 24px;
            background: #38a169;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .download-link:hover {
            background: #2f855a;
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü©∫ Nightingale CMS Data Migration Tool</h1>
        <p class="subtitle">Migrate legacy case data to the current format</p>
        
        <div class="upload-area" id="uploadArea">
            <div class="upload-text">üìÅ Drop your nightingale-data.json file here</div>
            <div class="upload-subtext">or click to browse</div>
            <input type="file" id="fileInput" class="file-input" accept=".json">
        </div>
        
        <div style="text-align: center; margin-bottom: 24px;">
            <button class="btn" onclick="document.getElementById('fileInput').click()">
                Choose File
            </button>
        </div>
        
        <div style="background: #f7fafc; padding: 20px; border-radius: 8px; margin-bottom: 24px;" id="optionsPanel" style="display: none;">
            <h3 style="color: #2d3748; margin-bottom: 16px;">Migration Options</h3>
            
            <label style="display: flex; align-items: center; margin-bottom: 12px; cursor: pointer;">
                <input type="checkbox" id="anonymizeData" style="margin-right: 8px; transform: scale(1.2);">
                <span style="color: #4a5568; font-weight: 600;">üîí Anonymize Personal Data</span>
            </label>
            <p style="color: #718096; font-size: 14px; margin-left: 28px; margin-bottom: 16px;">
                Replace names, addresses, phone numbers, emails, and SSNs with realistic fake data
            </p>
            
            <label style="display: flex; align-items: center; margin-bottom: 12px; cursor: pointer;">
                <input type="checkbox" id="preserveRelationships" checked style="margin-right: 8px; transform: scale(1.2);">
                <span style="color: #4a5568; font-weight: 600;">üîó Preserve Data Relationships</span>
            </label>
            <p style="color: #718096; font-size: 14px; margin-left: 28px;">
                Keep case-to-person and other ID relationships intact during anonymization
            </p>
        </div>
        
        <div style="text-align: center;">
            <button class="btn" id="migrateBtn" onclick="migrateData()" disabled>
                üîÑ Migrate Data
            </button>
        </div>
        
        <div id="results" class="results" style="display: none;">
            <h3>Migration Results</h3>
            <div id="migrationLog" class="migration-log"></div>
            <div id="downloadSection" style="display: none;">
                <a id="downloadLink" class="download-link" download="nightingale-data-migrated.json">
                    üì• Download Migrated Data
                </a>
            </div>
        </div>
    </div>

    <script>
        let rawData = null;
        let migratedData = null;
        let migrationLog = [];

        // Anonymization data sets
        const FAKE_DATA = {
            firstNames: [
                'James', 'Mary', 'John', 'Patricia', 'Robert', 'Jennifer', 'Michael', 'Linda',
                'William', 'Elizabeth', 'David', 'Barbara', 'Richard', 'Susan', 'Joseph', 'Jessica',
                'Thomas', 'Sarah', 'Christopher', 'Karen', 'Charles', 'Nancy', 'Daniel', 'Lisa',
                'Matthew', 'Betty', 'Anthony', 'Helen', 'Mark', 'Sandra', 'Donald', 'Donna',
                'Steven', 'Carol', 'Paul', 'Ruth', 'Andrew', 'Sharon', 'Joshua', 'Michelle'
            ],
            lastNames: [
                'Smith', 'Johnson', 'Williams', 'Brown', 'Jones', 'Garcia', 'Miller', 'Davis',
                'Rodriguez', 'Martinez', 'Hernandez', 'Lopez', 'Gonzalez', 'Wilson', 'Anderson', 'Thomas',
                'Taylor', 'Moore', 'Jackson', 'Martin', 'Lee', 'Perez', 'Thompson', 'White',
                'Harris', 'Sanchez', 'Clark', 'Ramirez', 'Lewis', 'Robinson', 'Walker', 'Young',
                'Allen', 'King', 'Wright', 'Scott', 'Torres', 'Nguyen', 'Hill', 'Flores'
            ],
            streets: [
                'Main St', 'Oak Ave', 'Pine St', 'Maple Dr', 'Cedar Ln', 'Elm St', 'Park Ave',
                'Washington St', 'First St', 'Second St', 'Third St', 'Lincoln Ave', 'Church St',
                'Mill St', 'School St', 'Spring St', 'High St', 'Court St', 'Franklin St', 'Jefferson Ave'
            ],
            cities: [
                'Springfield', 'Franklin', 'Georgetown', 'Madison', 'Washington', 'Arlington', 'Fairview',
                'Salem', 'Bristol', 'Clinton', 'Greenville', 'Manchester', 'Oxford', 'Plymouth',
                'Richmond', 'Riverside', 'Kingston', 'Newport', 'Auburn', 'Centerville'
            ],
            organizations: [
                'Sunset Care Center', 'Meadowbrook Manor', 'Golden Years Facility', 'Harmony House',
                'Peaceful Gardens', 'Riverside Care', 'Oak Hill Center', 'Pine Valley Manor',
                'Maplewood Care', 'Serenity Springs', 'Garden View Center', 'Willow Creek Manor'
            ]
        };

        // Anonymization helper functions
        function getRandomItem(array) {
            return array[Math.floor(Math.random() * array.length)];
        }

        function generateFakeSSN() {
            // Generate fake SSN in XXX-XX-XXXX format (avoiding real ranges)
            const area = Math.floor(Math.random() * 99) + 900; // 900-999 (invalid range)
            const group = Math.floor(Math.random() * 99) + 1;
            const serial = Math.floor(Math.random() * 9999) + 1;
            return `${area}-${group.toString().padStart(2, '0')}-${serial.toString().padStart(4, '0')}`;
        }

        function generateFakePhone() {
            // Generate fake phone in (XXX)XXX-XXXX format
            const area = Math.floor(Math.random() * 800) + 200; // 200-999
            const exchange = Math.floor(Math.random() * 800) + 200;
            const number = Math.floor(Math.random() * 10000);
            return `(${area})${exchange}-${number.toString().padStart(4, '0')}`;
        }

        function generateFakeEmail(firstName, lastName) {
            const domains = ['example.com', 'test.org', 'sample.net', 'demo.com'];
            const domain = getRandomItem(domains);
            return `${firstName.toLowerCase()}.${lastName.toLowerCase()}@${domain}`;
        }

        function generateFakeAddress() {
            const number = Math.floor(Math.random() * 9999) + 1;
            const street = getRandomItem(FAKE_DATA.streets);
            const city = getRandomItem(FAKE_DATA.cities);
            const states = ['NE', 'IA', 'KS', 'CO', 'WY', 'SD', 'ND', 'MO', 'OK'];
            const state = getRandomItem(states);
            const zip = Math.floor(Math.random() * 90000) + 10000;
            
            return {
                street: `${number} ${street}`,
                city: city,
                state: state,
                zip: zip.toString()
            };
        }

        // Main anonymization function
        function anonymizeData(data, preserveRelationships = true) {
            if (!data) return data;
            
            log('üîí Starting data anonymization...', 'info');
            const anonymizedData = JSON.parse(JSON.stringify(data));
            
            // Create mapping for consistent anonymization
            const personNameMap = new Map();
            const organizationNameMap = new Map();
            
            // Anonymize people
            if (anonymizedData.people) {
                log(`üë• Anonymizing ${anonymizedData.people.length} people...`, 'info');
                
                anonymizedData.people = anonymizedData.people.map((person, index) => {
                    const anonymizedPerson = { ...person };
                    
                    // Generate consistent fake name
                    const firstName = getRandomItem(FAKE_DATA.firstNames);
                    const lastName = getRandomItem(FAKE_DATA.lastNames);
                    const fullName = `${firstName} ${lastName}`;
                    
                    if (preserveRelationships && person.name) {
                        personNameMap.set(person.name, fullName);
                    }
                    
                    anonymizedPerson.name = fullName;
                    
                    // Anonymize sensitive fields
                    if (person.ssn) {
                        anonymizedPerson.ssn = generateFakeSSN();
                    }
                    
                    if (person.phone) {
                        anonymizedPerson.phone = generateFakePhone();
                    }
                    
                    if (person.email) {
                        anonymizedPerson.email = generateFakeEmail(firstName, lastName);
                    }
                    
                    // Anonymize addresses
                    if (person.address) {
                        anonymizedPerson.address = generateFakeAddress();
                    }
                    
                    if (person.mailingAddress && !person.mailingAddress.sameAsPhysical) {
                        anonymizedPerson.mailingAddress = generateFakeAddress();
                    } else if (person.mailingAddress && person.mailingAddress.sameAsPhysical) {
                        anonymizedPerson.mailingAddress = {
                            ...anonymizedPerson.address,
                            sameAsPhysical: true
                        };
                    }
                    
                    return anonymizedPerson;
                });
                
                log(`‚úÖ Anonymized ${anonymizedData.people.length} people`, 'success');
            }
            
            // Anonymize organizations
            if (anonymizedData.organizations) {
                log(`üè¢ Anonymizing ${anonymizedData.organizations.length} organizations...`, 'info');
                
                anonymizedData.organizations = anonymizedData.organizations.map((org) => {
                    const anonymizedOrg = { ...org };
                    
                    const fakeName = getRandomItem(FAKE_DATA.organizations);
                    
                    if (preserveRelationships && org.name) {
                        organizationNameMap.set(org.name, fakeName);
                    }
                    
                    anonymizedOrg.name = fakeName;
                    
                    if (org.email) {
                        anonymizedOrg.email = `info@${fakeName.toLowerCase().replace(/\s+/g, '')}.example.com`;
                    }
                    
                    if (org.phone) {
                        anonymizedOrg.phone = generateFakePhone();
                    }
                    
                    if (org.address) {
                        anonymizedOrg.address = generateFakeAddress();
                    }
                    
                    return anonymizedOrg;
                });
                
                log(`‚úÖ Anonymized ${anonymizedData.organizations.length} organizations`, 'success');
            }
            
            // Anonymize case notes and descriptions (remove potentially identifying info)
            if (anonymizedData.cases) {
                log(`üìã Anonymizing case data...`, 'info');
                
                anonymizedData.cases = anonymizedData.cases.map((caseItem) => {
                    const anonymizedCase = { ...caseItem };
                    
                    // Clear description and notes that might contain personal info
                    if (anonymizedCase.description) {
                        anonymizedCase.description = '';
                    }
                    
                    if (anonymizedCase.notes && Array.isArray(anonymizedCase.notes)) {
                        anonymizedCase.notes = anonymizedCase.notes.map(note => ({
                            ...note,
                            content: '[ANONYMIZED NOTE CONTENT]',
                            title: note.title ? '[ANONYMIZED NOTE TITLE]' : ''
                        }));
                    }
                    
                    // Anonymize financial item descriptions that might be identifying
                    if (anonymizedCase.financials) {
                        ['resources', 'income', 'expenses'].forEach(type => {
                            if (anonymizedCase.financials[type]) {
                                anonymizedCase.financials[type] = anonymizedCase.financials[type].map(item => ({
                                    ...item,
                                    notes: item.notes ? '[ANONYMIZED]' : '',
                                    location: item.location ? 'Anonymous Bank' : '',
                                    accountNumber: item.accountNumber ? '****' : ''
                                }));
                            }
                        });
                    }
                    
                    return anonymizedCase;
                });
                
                log(`‚úÖ Anonymized case data`, 'success');
            }
            
            log(`üéâ Data anonymization completed!`, 'success');
            log(`üìä Anonymized: ${anonymizedData.people?.length || 0} people, ${anonymizedData.organizations?.length || 0} organizations`, 'info');
            
            return anonymizedData;
        }

        // Utility function to generate secure IDs
        function generateSecureId(prefix = 'item') {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                return `${prefix}-${crypto.randomUUID()}`;
            }

            if (typeof crypto !== 'undefined' && crypto.getRandomValues) {
                const array = new Uint32Array(3);
                crypto.getRandomValues(array);
                const timestamp = Date.now().toString(36);
                const randomPart = Array.from(array, (x) => x.toString(36)).join('');
                return `${prefix}-${timestamp}-${randomPart}`;
            }

            console.warn('üîí Using non-cryptographic ID generation - consider updating browser');
            const timestamp = Date.now().toString(36);
            const randomPart = Math.random().toString(36).substring(2, 8);
            return `${prefix}-${timestamp}-${randomPart}`;
        }

        // Main migration function
        async function normalizeDataMigrations(data) {
            if (!data) return data;

            log('üîÑ Running data migrations for CMS React compatibility...');
            const normalizedData = JSON.parse(JSON.stringify(data));

            // Normalize case data structure
            if (normalizedData.cases) {
                log(`üì¶ Processing ${normalizedData.cases.length} cases...`);
                
                normalizedData.cases = normalizedData.cases.map((caseItem, index) => {
                    const normalizedCase = { ...caseItem };

                    // Ensure every case has a proper ID with secure generation
                    if (!normalizedCase.id || normalizedCase.id === null) {
                        normalizedCase.id = generateSecureId('case');
                        log(`üÜî Generated new case ID: ${normalizedCase.id} for MCN: ${normalizedCase.mcn || normalizedCase.masterCaseNumber}`, 'success');
                    }

                    // Legacy field migration: masterCaseNumber -> mcn
                    if (caseItem.masterCaseNumber && !caseItem.mcn) {
                        normalizedCase.mcn = caseItem.masterCaseNumber;
                        log(`üè∑Ô∏è Migrated masterCaseNumber "${caseItem.masterCaseNumber}" ‚Üí mcn`, 'success');
                    }

                    // Map appDetails.appDate to applicationDate
                    if (caseItem.appDetails?.appDate && !caseItem.applicationDate) {
                        normalizedCase.applicationDate = caseItem.appDetails.appDate;
                        log(`üìÖ Migrated appDetails.appDate ‚Üí applicationDate`, 'success');
                    }

                    // Map appDetails.caseType to caseType if missing
                    if (caseItem.appDetails?.caseType && !caseItem.caseType) {
                        normalizedCase.caseType = caseItem.appDetails.caseType;
                        log(`üìã Migrated appDetails.caseType "${caseItem.appDetails.caseType}" ‚Üí caseType`, 'success');
                    }

                    // Convert legacy createdAt to createdDate
                    if (caseItem.createdAt && !caseItem.createdDate) {
                        normalizedCase.createdDate = caseItem.createdAt;
                        log(`üïí Migrated createdAt ‚Üí createdDate`, 'success');
                    }

                    // Ensure personId is a string (legacy uses numbers)
                    if (normalizedCase.personId && typeof normalizedCase.personId === 'number') {
                        normalizedCase.personId = normalizedCase.personId.toString();
                        log(`üî¢ Converted personId ${normalizedCase.personId} to string format`, 'success');
                    }

                    // Add required fields with defaults for legacy cases
                    const defaults = [
                        { field: 'status', value: 'Pending' },
                        { field: 'description', value: '' },
                        { field: 'priority', value: false },
                        { field: 'withWaiver', value: false },
                        { field: 'authorizedReps', value: [] },
                        { field: 'retroRequested', value: 'No' },
                        { field: 'livingArrangement', value: 'Not specified' },
                        { field: 'organizationAddress', value: 'Not specified' }
                    ];

                    defaults.forEach(({ field, value }) => {
                        if (!normalizedCase[field]) {
                            normalizedCase[field] = value;
                        }
                    });

                    // Ensure financials structure exists
                    if (!normalizedCase.financials) {
                        normalizedCase.financials = {
                            resources: [],
                            income: [],
                            expenses: []
                        };
                        log(`üí∞ Initialized financials structure for case ${normalizedCase.mcn}`, 'success');
                    }

                    // Financial items migration
                    if (normalizedCase.financials) {
                        ['resources', 'income', 'expenses'].forEach((financialType) => {
                            if (normalizedCase.financials[financialType]) {
                                normalizedCase.financials[financialType] = normalizedCase.financials[financialType].map((item) => {
                                    const migratedItem = { ...item };

                                    if (item.type && !item.description) {
                                        migratedItem.description = item.type;
                                        log(`üè∑Ô∏è Migrated financial item type "${item.type}" ‚Üí description`, 'success');
                                    }

                                    if (item.value !== undefined && item.amount === undefined) {
                                        migratedItem.amount = item.value;
                                        log(`üí∞ Migrated financial item value ${item.value} ‚Üí amount`, 'success');
                                    }

                                    // Ensure backward compatibility
                                    if (item.description && !item.type) {
                                        migratedItem.type = item.description;
                                    }
                                    if (item.amount !== undefined && item.value === undefined) {
                                        migratedItem.value = item.amount;
                                    }

                                    if (!migratedItem.frequency) {
                                        migratedItem.frequency = 'monthly';
                                    }

                                    if (!migratedItem.dateAdded) {
                                        migratedItem.dateAdded = new Date().toISOString();
                                    }

                                    if (item.source && !item.verificationSource) {
                                        migratedItem.verificationSource = item.source;
                                    }

                                    return migratedItem;
                                });
                            }
                        });
                    }

                    return normalizedCase;
                });

                log(`‚úÖ Completed case migrations for ${normalizedData.cases.length} cases`, 'success');
            }

            // Normalize people data structure
            if (normalizedData.people) {
                log(`üë• Processing ${normalizedData.people.length} people...`);
                
                normalizedData.people = normalizedData.people.map((person) => {
                    const normalizedPerson = { ...person };

                    if (!normalizedPerson.id) {
                        normalizedPerson.id = generateSecureId('person');
                        log(`üÜî Generated person ID: ${normalizedPerson.id} for ${normalizedPerson.name}`, 'success');
                    }

                    const defaults = [
                        { field: 'name', value: 'Unknown Person' },
                        { field: 'status', value: 'active' },
                        { field: 'dateAdded', value: new Date().toISOString() }
                    ];

                    defaults.forEach(({ field, value }) => {
                        if (!normalizedPerson[field]) {
                            normalizedPerson[field] = value;
                        }
                    });

                    return normalizedPerson;
                });

                // Resolve duplicate person IDs
                const seenPersonIds = new Set();
                normalizedData.people = normalizedData.people.map((person) => {
                    if (seenPersonIds.has(person.id)) {
                        const oldId = person.id;
                        person.id = generateSecureId('person');
                        log(`üîÑ Resolved duplicate person ID: ${oldId} ‚Üí ${person.id} for ${person.name}`, 'warning');
                    }
                    seenPersonIds.add(person.id);
                    return person;
                });

                log(`‚úÖ Completed people migrations for ${normalizedData.people.length} people`, 'success');
            }

            // Normalize organizations data structure
            if (normalizedData.organizations) {
                log(`üè¢ Processing ${normalizedData.organizations.length} organizations...`);
                
                normalizedData.organizations = normalizedData.organizations.map((org) => {
                    const normalizedOrg = { ...org };

                    if (!normalizedOrg.id) {
                        normalizedOrg.id = generateSecureId('org');
                        log(`üÜî Generated organization ID: ${normalizedOrg.id} for ${normalizedOrg.name}`, 'success');
                    }

                    const defaults = [
                        { field: 'name', value: 'Unknown Organization' },
                        { field: 'status', value: 'active' },
                        { field: 'dateAdded', value: new Date().toISOString() }
                    ];

                    defaults.forEach(({ field, value }) => {
                        if (!normalizedOrg[field]) {
                            normalizedOrg[field] = value;
                        }
                    });

                    return normalizedOrg;
                });

                log(`‚úÖ Completed organization migrations for ${normalizedData.organizations.length} organizations`, 'success');
            }

            log('üéâ Data migration completed successfully!', 'success');
            return normalizedData;
        }

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            migrationLog.push({ message: logEntry, type });
            
            if (document.getElementById('migrationLog')) {
                updateLogDisplay();
            }
            
            console.log(logEntry);
        }

        function updateLogDisplay() {
            const logElement = document.getElementById('migrationLog');
            logElement.innerHTML = migrationLog.map(entry => {
                let className = '';
                switch (entry.type) {
                    case 'success': className = 'success'; break;
                    case 'error': className = 'error'; break;
                    case 'warning': className = 'warning'; break;
                }
                return `<span class="${className}">${entry.message}</span>`;
            }).join('\n');
            logElement.scrollTop = logElement.scrollHeight;
        }

        // File handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const migrateBtn = document.getElementById('migrateBtn');

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            if (files.length === 0) return;
            
            const file = files[0];
            if (!file.name.endsWith('.json')) {
                alert('Please select a JSON file');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    rawData = JSON.parse(e.target.result);
                    log(`üìÅ Loaded file: ${file.name} (${(file.size / 1024).toFixed(1)} KB)`, 'success');
                    log(`üìä Found: ${rawData.cases?.length || 0} cases, ${rawData.people?.length || 0} people, ${rawData.organizations?.length || 0} organizations`);
                    migrateBtn.disabled = false;
                    uploadArea.innerHTML = `<div class="upload-text success">‚úÖ ${file.name} loaded successfully</div>`;
                    
                    // Show options panel
                    document.getElementById('optionsPanel').style.display = 'block';
                    
                } catch (error) {
                    log(`‚ùå Error parsing JSON: ${error.message}`, 'error');
                    alert('Invalid JSON file');
                }
            };
            reader.readAsText(file);
        }

        async function migrateData() {
            if (!rawData) {
                alert('Please load a data file first');
                return;
            }

            migrationLog = [];
            document.getElementById('results').style.display = 'block';
            migrateBtn.disabled = true;
            migrateBtn.textContent = 'üîÑ Migrating...';

            try {
                // First, apply data migrations
                log('üîÑ Starting data migration process...', 'info');
                migratedData = await normalizeDataMigrations(rawData);
                
                // Then, apply anonymization if requested
                const shouldAnonymize = document.getElementById('anonymizeData').checked;
                const preserveRelationships = document.getElementById('preserveRelationships').checked;
                
                if (shouldAnonymize) {
                    log('üîí Applying anonymization...', 'info');
                    migratedData = anonymizeData(migratedData, preserveRelationships);
                }
                
                // Create download link with appropriate filename
                const timestamp = new Date().toISOString().split('T')[0];
                const filename = shouldAnonymize 
                    ? `nightingale-data-migrated-anonymized-${timestamp}.json`
                    : `nightingale-data-migrated-${timestamp}.json`;
                
                const dataStr = JSON.stringify(migratedData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const downloadLink = document.getElementById('downloadLink');
                downloadLink.href = url;
                downloadLink.download = filename;
                downloadLink.style.display = 'inline-block';
                document.getElementById('downloadSection').style.display = 'block';
                
                const processType = shouldAnonymize ? 'Migration and anonymization' : 'Migration';
                log(`üéâ ${processType} completed! File is ready for download.`, 'success');
                
            } catch (error) {
                log(`‚ùå Process failed: ${error.message}`, 'error');
                console.error(error);
            } finally {
                migrateBtn.disabled = false;
                migrateBtn.textContent = 'üîÑ Migrate Data';
            }
        }
    </script>
</body>
</html>
