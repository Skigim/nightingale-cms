<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: services/nightingale.utils.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: services/nightingale.utils.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Nightingale Application Suite - Shared Utility Functions
 *
 * This file contains common, reusable helper functions for data formatting,
 * validation, and security that are shared across all applications in the suite.
 * By centralizing this logic, we ensure consistency and improve maintainability.
 */

/**
 * Legacy sanitization function for simple text escaping.
 * Converts special characters to HTML entities.
 * @param {string} str The string to sanitize.
 * @returns {string} The sanitized string.
 */
function sanitize(str) {
  if (!str) return '';
  return str
    .toString()
    .replace(/&amp;/g, '&amp;amp;')
    .replace(/&lt;/g, '&amp;lt;')
    .replace(/>/g, '&amp;gt;')
    .replace(/"/g, '&amp;quot;')
    .replace(/'/g, '&amp;#039;');
}

/**
 * Securely sets the inner HTML of an element using the DOMParser API to mitigate XSS risks.
 * This function parses HTML content in a safe environment, automatically neutralizing
 * script execution and other dangerous content while preserving safe HTML structure.
 *
 * @param {HTMLElement} element - The target element to set content on
 * @param {string} htmlString - The HTML string to safely render
 * @returns {void}
 */
function setSanitizedInnerHTML(element, htmlString) {
  if (!element || typeof htmlString !== 'string') return;

  // Use DOMParser to safely parse the string into a document fragment
  const parser = new DOMParser();
  const doc = parser.parseFromString(htmlString, 'text/html');

  // Clear the existing element's content
  element.innerHTML = '';

  // Append the nodes from the parsed body. This process neutralizes executable scripts.
  Array.from(doc.body.childNodes).forEach((node) => {
    element.appendChild(node);
  });
}

/**
 * Safely encodes a value for use in URLs to prevent URL injection attacks.
 * This function ensures that user input cannot break out of URL parameters
 * or inject malicious URLs.
 *
 * @param {string} value - The value to encode for URL usage
 * @returns {string} - The URL-encoded value
 */
function encodeURL(value) {
  if (typeof value !== 'string' &amp;&amp; typeof value !== 'number') return '';
  return encodeURIComponent(String(value));
}

/**
 * Safely sanitizes HTML content and returns it as a string.
 * Uses DOMParser to parse and clean the HTML, removing script execution
 * while preserving safe HTML structure and formatting.
 *
 * @param {string} htmlString - The HTML string to sanitize
 * @returns {string} - The sanitized HTML string
 */
function sanitizeHTML(htmlString) {
  if (typeof htmlString !== 'string') return '';

  // Use DOMParser to safely parse the HTML
  const parser = new DOMParser();
  const doc = parser.parseFromString(htmlString, 'text/html');

  // Return the cleaned HTML content
  return doc.body.innerHTML;
}

/**
 * Formats a date string (e.g., ISO format) into a user-friendly MM/DD/YYYY format.
 * Includes a timezone offset correction to prevent date changes.
 * @param {string} dateString The date string to format.
 * @returns {string} The formatted date, or "N/A" if the input is invalid.
 */
function formatDate(dateString) {
  if (!dateString) return 'N/A';
  const date = new Date(dateString);
  if (isNaN(date.getTime())) return 'N/A';
  // Adjust for timezone offset to prevent the date from changing
  const adjustedDate = new Date(
    date.getTime() + date.getTimezoneOffset() * 60000
  );
  return adjustedDate.toLocaleDateString('en-US', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
  });
}

/**
 * Formats a date string into the YYYY-MM-DD format required by HTML &lt;input type="date"> elements.
 * @param {string} dateString The date string to format.
 * @returns {string} The date in YYYY-MM-DD format, or an empty string if invalid.
 */
function toInputDateFormat(dateString) {
  if (!dateString) return '';
  const date = new Date(dateString);
  if (isNaN(date.getTime())) return '';
  // Adjust for timezone offset
  const adjustedDate = new Date(
    date.getTime() + date.getTimezoneOffset() * 60000
  );
  return adjustedDate.toISOString().substring(0, 10);
}

/**
 * Formats a string of numbers into a standard (XXX) XXX-XXXX phone number format.
 * @param {string} value The raw phone number string.
 * @returns {string} The formatted phone number.
 */
function formatPhoneNumber(value) {
  if (!value) return '';
  const phoneNumber = value.replace(/[^\d]/g, '');
  const phoneNumberLength = phoneNumber.length;
  if (phoneNumberLength &lt; 4) return phoneNumber;
  if (phoneNumberLength &lt; 7)
    return `(${phoneNumber.slice(0, 3)}) ${phoneNumber.slice(3)}`;
  return `(${phoneNumber.slice(0, 3)}) ${phoneNumber.slice(3, 6)}-${phoneNumber.slice(6, 10)}`;
}

/**
 * Converts a name string into proper "Firstname Lastname" case.
 * It can handle inputs like "LASTNAME, FIRSTNAME" or "JOHN DOE".
 * @param {string} name The name string to format.
 * @returns {string} The name in proper case.
 */
function formatProperCase(name) {
  if (!name || typeof name !== 'string') return '';
  let processedName = name.trim();

  // Handle "Last, First" format
  if (processedName.includes(',')) {
    const parts = processedName.split(',').map((p) => p.trim());
    processedName = `${parts[1] || ''} ${parts[0] || ''}`.trim();
  }

  // Capitalize each word
  return processedName
    .toLowerCase()
    .split(' ')
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
}

/**
 * Formats a name into "Lastname, Firstname" format for display.
 * @param {string} name The name string to format.
 * @returns {string} The name in "Lastname, Firstname" format.
 */
function formatPersonName(name) {
  if (!name || typeof name !== 'string') return '';
  const trimmedName = name.trim();
  if (!trimmedName) return '';

  // If name is already in "Last, First" format, return it as-is
  if (trimmedName.includes(',')) {
    return trimmedName;
  }

  const nameParts = trimmedName.split(/\s+/);
  if (nameParts.length &lt; 2) return trimmedName;

  const lastName = nameParts[nameParts.length - 1];
  const firstMiddleNames = nameParts.slice(0, -1).join(' ');
  return `${lastName}, ${firstMiddleNames}`;
}

/**
 * An object containing a collection of reusable validation functions for forms.
 * Each validator returns an object with { isValid, message, sanitizedValue }.
 */
const Validators = {
  required:
    (message = 'This field is required.') =>
    (value) => ({
      isValid: value &amp;&amp; value.toString().trim() !== '',
      message,
      sanitizedValue: value ? value.toString().trim() : '',
    }),

  email:
    (message = 'Please enter a valid email address.') =>
    (value) => ({
      isValid: !value || /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(value.trim()),
      message,
      sanitizedValue: value ? value.toString().trim().toLowerCase() : '',
    }),

  phone:
    (message = 'Please enter a valid phone number.') =>
    (value) => {
      const cleaned = value ? value.replace(/\D/g, '') : '';
      return {
        isValid: !value || /^\d{10,}$/.test(cleaned),
        message,
        sanitizedValue: cleaned,
      };
    },

  mcn:
    (message = 'Please enter a valid Master Case Number.') =>
    (value) => {
      const cleaned = value ? value.toString().trim().toUpperCase() : '';
      return {
        isValid: !value || /^[A-Z0-9\-_]{3,}$/.test(cleaned),
        message,
        sanitizedValue: cleaned,
      };
    },

  minLength:
    (length, message = `Must be at least ${length} characters.`) =>
    (value) => ({
      isValid: !value || value.trim().length >= length,
      message,
      sanitizedValue: value.trim(),
    }),

  maxLength:
    (length, message = `Must be no more than ${length} characters.`) =>
    (value) => ({
      isValid: !value || value.trim().length &lt;= length,
      message,
      sanitizedValue: value.trim(),
    }),
};

/**
 * Flattens all financial items (resources, income, expenses) from a case object
 * into a single array.
 * @param {object} caseObject The case object containing the financials property.
 * @returns {object[]} A single array containing all financial items.
 */
function getFlatFinancials(caseObject) {
  if (!caseObject || !caseObject.financials) return [];
  return [
    ...(caseObject.financials.resources || []),
    ...(caseObject.financials.income || []),
    ...(caseObject.financials.expenses || []),
  ];
}

/**
 * Calculates the next available sequential ID from an array of items.
 * @param {object[]} items An array of objects, each with an 'id' property.
 * @returns {number} The next highest ID.
 */
function getNextId(items) {
  if (!items || items.length === 0) return 1;
  return Math.max(1, ...items.map((item) => item.id || 0)) + 1;
}

/**
 * Determines the correct label for the application date field based on the application type.
 * @param {string} applicationType The type of application (e.g., "Application" or "Renewal").
 * @returns {string} The appropriate label.
 */
function getAppDateLabel(applicationType) {
  return applicationType === 'Renewal' ? 'Renewal Due' : 'Application Date';
}

/**
 * Returns a new, default object for application details.
 * @returns {object} The default appDetails object.
 */
function getDefaultAppDetails() {
  return {
    appDate: '',
    caseType: 'LTC',
    applicationType: 'Application',
    avsConsentDate: '',
    admissionDate: '',
    medicareAExpDate: '',
  };
}

/**
 * Extracts a unique, sorted list of note categories from all cases.
 * @param {object[]} cases The array of case objects.
 * @returns {string[]} A sorted array of unique note category strings.
 */
function getUniqueNoteCategories(cases) {
  if (!cases) return [];
  const allNotes = cases.flatMap((c) => c.notes || []);
  return [...new Set(allNotes.map((n) => n.category).filter(Boolean))].sort();
}

/**
 * NightingaleSearchService - Fuse.js wrapper for consistent search functionality
 *
 * Provides a standardized search interface using Fuse.js for fuzzy search capabilities.
 * Used by the SearchBar component and other search features throughout the suite.
 */
class NightingaleSearchService {
  /**
   * Creates a new search service instance
   * @param {Array} data - Array of objects to search through
   * @param {Object} options - Fuse.js options object
   */
  constructor(data, options = {}) {
    if (typeof Fuse === 'undefined') {
      console.error('NightingaleSearchService: Fuse.js is not available');
      this.fuse = null;
      return;
    }

    const defaultOptions = {
      includeScore: false,
      threshold: 0.3,
      ignoreLocation: true,
      minMatchCharLength: 1,
      shouldSort: true,
      ...options,
    };

    try {
      this.fuse = new Fuse(data, defaultOptions);
      this.data = data;
      this.options = defaultOptions;
    } catch (error) {
      console.error(
        'NightingaleSearchService: Error initializing Fuse.js:',
        error
      );
      this.fuse = null;
    }
  }

  /**
   * Performs a fuzzy search on the data
   * @param {string} query - Search query string
   * @returns {Array} Array of search results
   */
  search(query) {
    if (!this.fuse || !query || typeof query !== 'string') {
      return [];
    }

    try {
      const results = this.fuse.search(query.trim());
      // Return the items directly (not wrapped in Fuse result objects)
      return results.map((result) => result.item || result);
    } catch (error) {
      console.error('NightingaleSearchService: Search error:', error);
      return [];
    }
  }

  /**
   * Updates the search data
   * @param {Array} newData - New array of objects to search through
   */
  setData(newData) {
    if (!Array.isArray(newData)) {
      console.warn('NightingaleSearchService: setData expects an array');
      return;
    }

    try {
      this.data = newData;
      if (this.fuse) {
        this.fuse.setCollection(newData);
      }
    } catch (error) {
      console.error('NightingaleSearchService: Error updating data:', error);
    }
  }

  /**
   * Gets the current search options
   * @returns {Object} Current Fuse.js options
   */
  getOptions() {
    return { ...this.options };
  }

  /**
   * Updates search options
   * @param {Object} newOptions - New Fuse.js options to merge
   */
  setOptions(newOptions) {
    if (!newOptions || typeof newOptions !== 'object') {
      console.warn('NightingaleSearchService: setOptions expects an object');
      return;
    }

    try {
      this.options = { ...this.options, ...newOptions };
      if (this.data &amp;&amp; this.data.length > 0) {
        this.fuse = new Fuse(this.data, this.options);
      }
    } catch (error) {
      console.error('NightingaleSearchService: Error updating options:', error);
    }
  }

  /**
   * Checks if the search service is properly initialized
   * @returns {boolean} True if service is ready to use
   */
  isReady() {
    return this.fuse !== null &amp;&amp; typeof Fuse !== 'undefined';
  }
}

// Make NightingaleSearchService globally available
if (typeof window !== 'undefined') {
  window.NightingaleSearchService = NightingaleSearchService;

  // Make all utility functions globally available
  window.sanitize = sanitize;
  window.setSanitizedInnerHTML = setSanitizedInnerHTML;
  window.encodeURL = encodeURL;
  window.sanitizeHTML = sanitizeHTML;
  window.formatDate = formatDate;
  window.toInputDateFormat = toInputDateFormat;
  window.formatPhoneNumber = formatPhoneNumber;
  window.formatProperCase = formatProperCase;
  window.formatPersonName = formatPersonName;
  window.Validators = Validators;
  window.getFlatFinancials = getFlatFinancials;
  window.getNextId = getNextId;
  window.getAppDateLabel = getAppDateLabel;
  window.getDefaultAppDetails = getDefaultAppDetails;
  window.getUniqueNoteCategories = getUniqueNoteCategories;
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="FileSystemService.html">FileSystemService</a></li><li><a href="NightingaleSearchService.html">NightingaleSearchService</a></li><li><a href="ToastQueue.html">ToastQueue</a></li></ul><h3>Global</h3><ul><li><a href="global.html#Badge">Badge</a></li><li><a href="global.html#Button">Button</a></li><li><a href="global.html#Card">Card</a></li><li><a href="global.html#CardActions">CardActions</a></li><li><a href="global.html#CardField">CardField</a></li><li><a href="global.html#CardGrid">CardGrid</a></li><li><a href="global.html#CardList">CardList</a></li><li><a href="global.html#Checkbox">Checkbox</a></li><li><a href="global.html#ConfirmationModal">ConfirmationModal</a></li><li><a href="global.html#CountBadge">CountBadge</a></li><li><a href="global.html#DataTable">DataTable</a></li><li><a href="global.html#DateInput">DateInput</a></li><li><a href="global.html#FinancialItemCard">FinancialItemCard</a></li><li><a href="global.html#FinancialItemGrid">FinancialItemGrid</a></li><li><a href="global.html#FinancialItemList">FinancialItemList</a></li><li><a href="global.html#FormField">FormField</a></li><li><a href="global.html#FormModal">FormModal</a></li><li><a href="global.html#Modal">Modal</a></li><li><a href="global.html#MultiBadge">MultiBadge</a></li><li><a href="global.html#NotesModal">NotesModal</a></li><li><a href="global.html#PersonCreationModal">PersonCreationModal</a></li><li><a href="global.html#ProgressBadge">ProgressBadge</a></li><li><a href="global.html#SearchBar">SearchBar</a></li><li><a href="global.html#Select">Select</a></li><li><a href="global.html#StepperModal">StepperModal</a></li><li><a href="global.html#TOAST_CONFIG">TOAST_CONFIG</a></li><li><a href="global.html#TextInput">TextInput</a></li><li><a href="global.html#Textarea">Textarea</a></li><li><a href="global.html#Validators">Validators</a></li><li><a href="global.html#clearAllToasts">clearAllToasts</a></li><li><a href="global.html#encodeURL">encodeURL</a></li><li><a href="global.html#formatDate">formatDate</a></li><li><a href="global.html#formatPersonName">formatPersonName</a></li><li><a href="global.html#formatPhoneNumber">formatPhoneNumber</a></li><li><a href="global.html#formatProperCase">formatProperCase</a></li><li><a href="global.html#getActiveToastCount">getActiveToastCount</a></li><li><a href="global.html#getAppDateLabel">getAppDateLabel</a></li><li><a href="global.html#getDefaultAppDetails">getDefaultAppDetails</a></li><li><a href="global.html#getFlatFinancials">getFlatFinancials</a></li><li><a href="global.html#getNextId">getNextId</a></li><li><a href="global.html#getUniqueNoteCategories">getUniqueNoteCategories</a></li><li><a href="global.html#initializeToastSystem">initializeToastSystem</a></li><li><a href="global.html#loadBusinessComponents">loadBusinessComponents</a></li><li><a href="global.html#loadComponentLayers">loadComponentLayers</a></li><li><a href="global.html#loadUIComponents">loadUIComponents</a></li><li><a href="global.html#parseAvsAccountBlock">parseAvsAccountBlock</a></li><li><a href="global.html#parseAvsData">parseAvsData</a></li><li><a href="global.html#sanitize">sanitize</a></li><li><a href="global.html#sanitizeHTML">sanitizeHTML</a></li><li><a href="global.html#setSanitizedInnerHTML">setSanitizedInnerHTML</a></li><li><a href="global.html#showSuccessToast">showSuccessToast</a></li><li><a href="global.html#showToast">showToast</a></li><li><a href="global.html#toInputDateFormat">toInputDateFormat</a></li><li><a href="global.html#updateToastConfig">updateToastConfig</a></li><li><a href="global.html#waitForUIComponents">waitForUIComponents</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.4</a> on Wed Aug 20 2025 13:57:37 GMT+0000 (Coordinated Universal Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
